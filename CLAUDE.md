# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Portfolio Compass is a full-stack web application for AI-powered stock portfolio analysis. It's a PWA built with vanilla JavaScript (no build step, no bundler), Node.js serverless APIs on Vercel, and a Neon PostgreSQL backend.

**Production URL:** https://pcompass.vercel.app

## Development & Deployment

- **No build step** — pure vanilla JS served as static files
- **No test framework** — no automated tests exist
- **Package manager:** npm (`npm install` for dependencies)
- **Deployment:** Vercel serverless (auto-deploys from git)
- **Local dev:** `npx vercel dev` to run locally with serverless function emulation
- **ES modules:** `"type": "module"` in package.json — all files use `import`/`export`

## Architecture

### Frontend (Single-Page App)

`public/index.html` — the entire frontend is a single ~3700-line HTML file containing all markup, CSS, and JavaScript inline. There is no component framework or templating.

`public/data.js` — static stock database, sector colors, example portfolios, correlated pairs, and risk configuration. Imported by the frontend.

`public/sw.js` — service worker for PWA offline support.

### Backend (Vercel Serverless Functions)

All API endpoints live in `api/` as individual JS files. Each exports a default async handler `(req, res)`.

| Endpoint | Purpose |
|----------|---------|
| `api/claude.js` | Claude AI analysis & screenshot OCR (vision). Rate-limited. |
| `api/auth.js` | Google OAuth token verification + user creation |
| `api/portfolios.js` | Cloud portfolio CRUD (Pro only) |
| `api/verify-pro.js` | Pro subscription status check, issues HMAC tokens |
| `api/market-data.js` | Stock prices via Yahoo Finance scraping |
| `api/stripe-webhook.js` | Stripe payment webhook with signature verification |
| `api/db-setup.js` | PostgreSQL schema initialization |
| `api/validate-token.js` | Supabase token validation |

### Database

Neon PostgreSQL accessed via direct HTTP API (not a driver library). Tables: `users`, `portfolios`, `pro_licenses`.

### Authentication & Authorization

- **Pro tokens:** HMAC-SHA256 signed tokens (email + timestamp, 24hr expiry) generated by `verify-pro.js`, verified in `claude.js` and `portfolios.js`
- **Rate limiting:** In-memory Map in `claude.js` — 3 req/hr free, 50 req/hr Pro
- **AI model tier:** Claude Haiku 4.5 for free users, Claude 3.5 Sonnet for Pro

### Environment Variables (set in Vercel)

`ANTHROPIC_API_KEY`, `POSTGRES_URL`, `PRO_TOKEN_SECRET`, `STRIPE_WEBHOOK_SECRET`, `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`

## Key Patterns

- Database queries use raw SQL via `fetch()` to the Neon HTTP endpoint — there is no ORM
- Function timeout config is in `public/vercel.json` (30s for claude/db-setup, 10s for others)
- Edge caching headers are configured per-route in `public/vercel.json`
- Client-side portfolio data is cached in localStorage
