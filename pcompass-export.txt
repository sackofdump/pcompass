========== FILE: public/app.js ==========
// â”€â”€ HEADER â€” always compact (set via class in HTML) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function escapeHTML(str) {
  if (typeof str !== 'string') return String(str);
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// â”€â”€ AI DATA-SHARING CONSENT (Apple Guideline 5.1.2(i)) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Must obtain explicit consent before sending data to Anthropic (Claude AI)
function hasAIConsent() {
  return localStorage.getItem('pc_ai_consent') === 'yes';
}

function showAIConsentDialog() {
  return new Promise(function(resolve) {
    var overlay = document.createElement('div');
    overlay.id = 'aiConsentOverlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:100000;padding:16px;';
    overlay.innerHTML =
      '<div style="background:#131720;border:1px solid #2a3040;border-radius:14px;max-width:380px;width:100%;padding:24px;text-align:center;">' +
        '<div style="font-size:32px;margin-bottom:12px;">ðŸ¤–</div>' +
        '<h3 style="color:#fff;font-family:\'DM Sans\',sans-serif;font-size:17px;margin:0 0 8px;">AI Data Disclosure</h3>' +
        '<p style="color:#8a9ab8;font-family:\'DM Sans\',sans-serif;font-size:13px;line-height:1.5;margin:0 0 6px;">' +
          'Portfolio Compass uses <strong style="color:#c5cee0;">Anthropic (Claude AI)</strong> to analyze your portfolio.' +
        '</p>' +
        '<p style="color:#8a9ab8;font-family:\'DM Sans\',sans-serif;font-size:13px;line-height:1.5;margin:0 0 16px;">' +
          'Your stock holdings and portfolio data will be sent to Anthropic\'s servers for analysis. ' +
          'Anthropic does not use this data for model training. ' +
          '<a href="/privacy.html" target="_blank" style="color:#6c63ff;">Privacy Policy</a>' +
        '</p>' +
        '<div style="display:flex;gap:10px;">' +
          '<button id="aiConsentDecline" style="flex:1;padding:10px;border-radius:8px;border:1px solid #2a3040;background:none;color:#8a9ab8;font-family:\'DM Sans\',sans-serif;font-size:13px;font-weight:600;cursor:pointer;">Decline</button>' +
          '<button id="aiConsentAccept" style="flex:1;padding:10px;border-radius:8px;border:none;background:#6c63ff;color:#fff;font-family:\'DM Sans\',sans-serif;font-size:13px;font-weight:600;cursor:pointer;">Allow</button>' +
        '</div>' +
      '</div>';
    document.body.appendChild(overlay);
    document.getElementById('aiConsentAccept').onclick = function() {
      localStorage.setItem('pc_ai_consent', 'yes');
      overlay.remove();
      resolve(true);
    };
    document.getElementById('aiConsentDecline').onclick = function() {
      overlay.remove();
      resolve(false);
    };
  });
}

// â”€â”€ CLAUDE API HELPER (defined first so all functions can use it) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Sends pro token + email + timestamp so server can verify Pro server-side
async function callClaudeAPI(body) {
  // Check AI consent before sending any data to Anthropic
  if (!hasAIConsent()) {
    var consented = await showAIConsentDialog();
    if (!consented) {
      throw new Error('AI_CONSENT_DECLINED');
    }
  }
  return fetch('/api/claude', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
}


// â”€â”€ PRO FEATURE CHECK HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Calls /api/check-feature to verify Pro status server-side
// Returns: 'allowed', 'denied', or 'auth_expired'
async function callCheckFeature(feature) {
  try {
    const res = await fetch('/api/check-feature', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ feature }),
    });
    if (res.status === 401) return 'auth_expired';
    if (!res.ok) return 'denied';
    const data = await res.json();
    return data.allowed === true ? 'allowed' : 'denied';
  } catch (e) {
    console.warn('[check-feature] request failed:', e.message);
    return 'denied'; // fail closed
  }
}

// â”€â”€ PRO PICKS FETCH HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetches extended stock/ETF picks from /api/pro-picks (Pro only)
let _proPicksCache = null;
async function fetchProPicks() {
  if (_proPicksCache) return _proPicksCache;
  try {
    const res = await fetch('/api/pro-picks');
    if (!res.ok) return null;
    const data = await res.json();
    _proPicksCache = data;
    return data;
  } catch (e) {
    console.warn('[pro-picks] fetch failed:', e.message);
    return null;
  }
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let holdings = [];
let previewHoldings = [];
let _activePortfolioIdx = -1;
let _activePortfolioSnapshot = null;
let _holdingsView = 'chart';

// â”€â”€ HOLDINGS LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function totalAllocation() {
  return Math.round(holdings.reduce((s, h) => s + h.pct, 0) * 10) / 10;
}

function addStock() {
  const ticker = document.getElementById('tickerInput').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  const pct = parseFloat(document.getElementById('pctInput').value);
  const err = document.getElementById('errorMsg');
  err.textContent = '';
  if (!ticker) { err.textContent = 'Enter a ticker symbol.'; return; }
  if (!pct || pct <= 0) { err.textContent = 'Enter a valid percentage.'; return; }
  if (holdings.find(h => h.ticker === ticker)) { err.textContent = ticker + ' already added.'; return; }
  if (totalAllocation() + pct > 100.05) { err.textContent = 'Total exceeds 100%.'; return; }
  const info = STOCK_DB[ticker] || {name:ticker, sector:'Other', beta:1.0, cap:'unknown'};
  holdings.push({ticker, pct, ...info});
  document.getElementById('tickerInput').value = '';
  document.getElementById('pctInput').value = '';
  renderHoldings();
}

function removeStock(ticker) {
  holdings = holdings.filter(h => h.ticker !== ticker);
  renderHoldings();
}

function editCardAlloc(ticker, el) {
  var h = holdings.find(function(x) { return x.ticker === ticker; });
  if (!h) return;
  var orig = h.pct;
  var input = document.createElement('input');
  input.type = 'number';
  input.className = 'spark-card-alloc-input';
  input.value = orig;
  input.min = '0.1';
  input.max = '100';
  input.step = '0.1';
  el.replaceWith(input);
  input.focus();
  input.select();
  function commit() {
    var val = parseFloat(input.value);
    if (!val || val <= 0 || val > 100) val = orig;
    var otherTotal = totalAllocation() - h.pct;
    if (otherTotal + val > 100.05) val = Math.round((100 - otherTotal) * 10) / 10;
    h.pct = Math.round(val * 10) / 10;
    renderHoldings();
    if (_holdingsView === 'chart' && holdings.length >= 3) fetchAndRenderSparklines();
  }
  input.addEventListener('blur', commit);
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { h.pct = orig; input.blur(); }
  });
}

function setHoldingsView(view) {
  _holdingsView = view;
  document.querySelectorAll('.view-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
  renderHoldings();
  if (view === 'chart' && holdings.length > 0) {
    fetchAndRenderSparklines();
  }
}

function expandUploadZone(trigger) {
  var expanded = document.getElementById('uploadExpanded');
  if (!expanded) return;
  trigger.classList.toggle('expanded');
  expanded.classList.toggle('expanded');
}

function renderHoldings() {
  const list = document.getElementById('stockList');
  const chip = document.getElementById('summaryChip');
  const btn  = document.getElementById('analyzeBtn');
  const total = totalAllocation();

  // Show/hide view toggle for 3+ holdings
  const viewToggle = document.getElementById('holdingsViewToggle');
  if (viewToggle) {
    viewToggle.style.display = holdings.length >= 3 ? 'flex' : 'none';
    if (holdings.length < 3 && _holdingsView !== 'list') _holdingsView = 'list';
  }

  if (_holdingsView === 'chart' && holdings.length >= 3) {
    list.className = 'sparkline-grid';
    list.innerHTML = holdings.map(h => {
      const dbEntry = STOCK_DB[h.ticker] || {};
      const companyName = dbEntry.name || h.ticker;
      const sectorColor = SECTOR_COLORS[h.sector] || SECTOR_COLORS['Other'] || '#475569';
      return `<div class="sparkline-card" onclick="showExpandedChart('${escapeHTML(h.ticker)}')" id="spark-card-${escapeHTML(h.ticker)}">
        <button class="spark-card-remove" onclick="event.stopPropagation();removeStock('${escapeHTML(h.ticker)}')" title="Remove">\u00d7</button>
        <div class="spark-card-header">
          <span class="spark-card-ticker">${escapeHTML(h.ticker)}</span>
          <span class="spark-card-alloc" onclick="event.stopPropagation();editCardAlloc('${escapeHTML(h.ticker)}',this)">${h.pct}%</span>
        </div>
        <div class="spark-name">${escapeHTML(companyName)}</div>
        <div class="spark-chart" id="spark-svg-${escapeHTML(h.ticker)}">
          <div class="spark-shimmer"></div>
        </div>
        <div class="spark-card-footer">
          <span class="spark-price" id="spark-price-${escapeHTML(h.ticker)}">--</span>
          <span class="spark-change" id="spark-change-${escapeHTML(h.ticker)}"></span>
        </div>
        <div class="spark-sector-dot" style="background:${sectorColor}"></div>
      </div>`;
    }).join('');
  } else {
    list.className = 'stock-list';
    list.innerHTML = holdings.map((h, i) => {
      const dbEntry = STOCK_DB[h.ticker] || {};
      const companyName = dbEntry.name || '';
      return `
      <div class="stock-item">
        <div class="stock-item-top">
          <div class="stock-info">
            <span class="stock-ticker">${escapeHTML(h.ticker)}</span>${companyName ? `<span class="stock-company">${escapeHTML(companyName)}</span>` : ''}
            <span class="stock-sector">${escapeHTML(h.sector)}</span>
          </div>
          <button class="btn-remove" onclick="removeStock('${escapeHTML(h.ticker)}')">Ã—</button>
        </div>
        <div class="stock-slider-row">
          <input type="range" class="stock-slider" id="slider-${i}" min="0.1" max="${Math.min(100, h.pct + (100 - total))}" step="0.1"
            value="${h.pct}" oninput="updateSlider(${i}, this.value)" />
          <span class="slider-pct" id="slider-pct-${i}">${h.pct}%</span>
        </div>
      </div>`;
    }).join('');
  }

  chip.textContent = total + '% allocated';
  btn.disabled = holdings.length === 0;

  // Hide onboarding when user has holdings OR has saved portfolios
  const ob = document.getElementById('onboardingBanner');
  if (ob) {
    const hasSaved = getSavedPortfolios().length > 0;
    ob.style.display = (holdings.length > 0 || hasSaved) ? 'none' : 'block';
  }

  // Show/hide what-if simulator
  const wiPanel = document.getElementById('whatifPanel');
  if (wiPanel) wiPanel.style.display = holdings.length > 0 ? 'block' : 'none';

  updateRiskScore();
  updateCorrelationWarnings();
  updateWhatIfPanel();

  // Show/hide quick save button
  const quickSave = document.getElementById('btnQuickSave');
  if (quickSave) quickSave.style.display = holdings.length > 0 ? 'inline-block' : 'none';

  // Show/hide clear all button
  const clearBtn = document.getElementById('btnClearAll');
  if (clearBtn) clearBtn.style.display = holdings.length > 0 ? 'inline-block' : 'none';
}

function toggleHoldingsBody() {
  const body = document.getElementById('holdingsBody');
  if (!body) return;
  if (body.classList.contains('collapsed')) {
    expandHoldingsPanel();
  } else {
    collapseHoldingsPanel();
  }
}

function clearAllHoldings() {
  if (holdings.length === 0) return;

  // If a saved portfolio is active, delete it permanently
  if (_activePortfolioIdx >= 0) {
    var portfolios = getSavedPortfolios();
    var name = portfolios[_activePortfolioIdx] ? portfolios[_activePortfolioIdx].name : 'this portfolio';
    if (!confirm('Delete "' + name + '" permanently?')) return;
    portfolios.splice(_activePortfolioIdx, 1);
    localStorage.setItem('pc_portfolios', JSON.stringify(portfolios));
  } else {
    if (!confirm('Clear all holdings?')) return;
  }

  holdings.length = 0;
  _activePortfolioIdx = -1;
  _activePortfolioSnapshot = null;
  document.getElementById('resultsPanel').innerHTML = '<div class="empty-state"><div class="empty-compass"><div class="empty-compass-ring"></div><div class="empty-compass-needle"></div><div class="empty-compass-center"></div></div><div class="empty-state-title">Ready to analyze</div><div class="empty-state-hint">Add your US stock holdings on the left, then click<br><strong>Analyze</strong></div></div>';
  renderHoldings();
  expandInputSections();
  if (typeof expandHoldingsPanel === 'function') expandHoldingsPanel();
  closeSidebar();
  // Re-render the portfolio strip to remove the deleted portfolio
  if (typeof renderPortfolioStrip === 'function') renderPortfolioStrip(null);
  // Re-enable sticky button visibility for next portfolio
  const stickyBtn = document.querySelector('.btn-analyze-sticky');
  if (stickyBtn) stickyBtn.dataset.analyzed = '';
}

function updateSlider(i, val) {
  const newPct = parseFloat(val);
  const oldPct = holdings[i].pct;
  const otherTotal = totalAllocation() - oldPct;
  if (otherTotal + newPct > 100.05) return;
  holdings[i].pct = Math.round(newPct * 10) / 10;
  document.getElementById('slider-pct-' + i).textContent = holdings[i].pct + '%';
  const total = totalAllocation();
  const chip = document.getElementById('summaryChip');
  if (chip) chip.textContent = total + '% allocated';
  // Update all slider max values so they can't exceed 100% total
  holdings.forEach((h, j) => {
    const sl = document.getElementById('slider-' + j);
    if (sl) sl.max = Math.min(100, h.pct + (100 - total));
  });
  updateRiskScore();
  updateCorrelationWarnings();
}

function getPortfolioProfile() {
  const sectors = {};
  let beta = 0;
  holdings.forEach(h => {
    sectors[h.sector] = (sectors[h.sector] || 0) + h.pct;
    beta += (h.beta || 1.0) * h.pct;
  });
  const total = totalAllocation() || 1;
  Object.keys(sectors).forEach(s => { sectors[s] = Math.round((sectors[s]/total)*100); });
  return {sectors, beta: Math.round((beta/total)*100)/100};
}

// â”€â”€ STRATEGY LEGEND HOVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pinnedStrategy = null;

function showStrategy(s) {
  if (pinnedStrategy) return;
  const el = document.getElementById('sectorBarsEl');
  if (el) el.classList.add('show-' + s);
  document.querySelectorAll('.legend-item.hoverable').forEach(e => e.classList.remove('active'));
  document.querySelector('[data-strategy="' + s + '"]')?.classList.add('active');
}

function hideStrategy(s) {
  if (pinnedStrategy) return;
  const el = document.getElementById('sectorBarsEl');
  if (el) el.classList.remove('show-' + s);
  document.querySelector('[data-strategy="' + s + '"]')?.classList.remove('active');
}

function toggleStrategy(s) {
  const el = document.getElementById('sectorBarsEl');
  if (!el) return;
  if (pinnedStrategy === s) {
    pinnedStrategy = null;
    el.classList.remove('show-agg','show-mod','show-con');
    document.querySelectorAll('.legend-item.hoverable').forEach(e => e.classList.remove('active','active-agg','active-mod','active-con'));
  } else {
    pinnedStrategy = s;
    el.classList.remove('show-agg','show-mod','show-con');
    el.classList.add('show-' + s);
    document.querySelectorAll('.legend-item.hoverable').forEach(e => e.classList.remove('active','active-agg','active-mod','active-con'));
    const item = document.querySelector('[data-strategy="' + s + '"]');
    if (item) item.classList.add('active','active-' + s);
  }
}

// â”€â”€ POSITION SIZING HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastMarketDataCache = null;

function buildPositionTable(amount, marketData) {
  if (!holdings.length) return '';
  let rows = '';
  holdings.forEach(h => {
    const alloc = h.pct;
    const dollarAmt = (amount * alloc / 100);
    const md = marketData && marketData[h.ticker];
    const price = md ? md.price : null;
    const shares = price ? (dollarAmt / price) : null;
    rows += '<tr>' +
      '<td><span class="ticker-cell">' + escapeHTML(h.ticker) + '</span><br><span class="sector-cell">' + escapeHTML(h.sector || '') + '</span></td>' +
      '<td>' + alloc + '%</td>' +
      '<td class="amount-cell">$' + Math.round(dollarAmt).toLocaleString() + '</td>' +
      '<td class="shares-cell">' + (shares != null ? shares.toFixed(1) : 'â€”') + '</td>' +
      '</tr>';
  });
  return '<table><thead><tr><th>Holdings</th><th>Alloc</th><th>$ Amount</th><th>Est. Shares</th></tr></thead><tbody>' + rows + '</tbody></table>';
}

function calcPositionSizing() {
  const input = document.getElementById('positionAmountInput');
  const amount = parseFloat(input?.value) || 0;
  if (amount <= 0) return;
  const tableEl = document.getElementById('positionTableEl');
  if (tableEl) tableEl.innerHTML = buildPositionTable(amount, lastMarketDataCache);
}

// Attach enter key listener after render
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.target.id === 'positionAmountInput') calcPositionSizing();
});

// â”€â”€ ANALYZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scoreETF(etf, profile) {
  let score = 70;
  if (etf.sectors.includes('all')) {
    score += 5;
  } else {
    etf.sectors.forEach(s => {
      if (profile.sectors[s] && profile.sectors[s] > 30) score -= 10;
      if (profile.sectors[s] && profile.sectors[s] < 10) score += 8;
      if (!profile.sectors[s]) score += 12;
    });
  }
  return Math.min(99, Math.max(50, score));
}

function getTopETFs(category, profile, n) {
  const owned = holdings.map(h => h.ticker);
  return ETF_DB[category]
    .filter(e => !owned.includes(e.ticker))
    .map(e => ({...e, score:scoreETF(e, profile)}))
    .sort((a,b) => b.score - a.score)
    .slice(0, n);
}

function matchLabel(score) {
  if (score >= 85) return '<span class="match-score match-high">âœ¦ Great fit</span>';
  return '<span class="match-score match-med">â—ˆ Good fit</span>';
}

function analyze() {
  pinnedStrategy = null;
  document.querySelectorAll('.legend-item.hoverable').forEach(e => e.classList.remove('active','active-agg','active-mod','active-con'));
  const profile = getPortfolioProfile();
  const {sectors} = profile;

  const aggressiveETFs = getTopETFs('aggressive', profile, 3);
  const moderateETFs   = getTopETFs('moderate',   profile, 3);
  const conservativeETFs = getTopETFs('conservative', profile, 3);

  // Sector bars
  const heldSectors = Object.entries(sectors).filter(([,v]) => v > 0).sort((a,b) => b[1]-a[1]);
  const missingSectors = Object.entries(SECTOR_TARGETS)
    .filter(([name, t]) => !(sectors[name] > 0) && (t.agg >= 3 || t.mod >= 3 || t.con >= 3))
    .sort((a,b) => Math.max(b[1].agg,b[1].mod,b[1].con) - Math.max(a[1].agg,a[1].mod,a[1].con))
    .slice(0, 8);

  const maxVal = Math.max(...heldSectors.map(([,v]) => v), 1);
  const capVal = Math.min(maxVal, 35); // cap so bars look fuller even with small %
  const scale = v => Math.min(100, Math.round((v/capVal)*100));

  const makeBar = (name, cur, isMissing) => {
    const t = SECTOR_TARGETS[name] || {agg:0,mod:0,con:0};
    const color = SECTOR_COLORS[name] || '#64748b';
    const icon  = SECTOR_ICONS[name]  || 'â—†';
    return '<div class="sector-row' + (isMissing?' missing':'') + '">' +
      '<span class="sector-name">' + icon + ' ' + name + '</span>' +
      '<div class="sector-bar-track' + (isMissing?' empty':'') + '">' +
      (!isMissing ? '<div class="sector-bar-fill" style="width:' + scale(cur) + '%;background:' + color + '"></div>' : '') +
      '<div class="sector-tick agg" style="left:' + scale(t.agg) + '%"></div>' +
      '<div class="sector-tick mod" style="left:' + scale(t.mod) + '%"></div>' +
      '<div class="sector-tick con" style="left:' + scale(t.con) + '%"></div>' +
      '</div>' +
      '<span class="sector-pct">' + (isMissing ? 'â€”' : cur + '%') + '</span>' +
      '</div>';
  };

  const sectorBars = heldSectors.map(([n,v]) => makeBar(n,v,false)).join('') +
    (missingSectors.length > 0 ? '<div class="sector-divider"><span>Not in your portfolio</span></div>' + missingSectors.map(([n]) => makeBar(n,0,true)).join('') : '');

  // Stock picks per strategy
  const ownedTickers = holdings.map(h => h.ticker);
  const ownedSectors = Object.keys(sectors).filter(s => (sectors[s]||0) > 5);
  const safeStr = s => s.replace(/'/g,"\\'").replace(/"/g,'&quot;');

  function getScoredPicks(strategyKey, marketData) {
    const riskAllowed = {
      aggressive:['High','Very High','Medium'],
      moderate:['Medium','Low','High'],
      conservative:['Low','Medium'],
    }[strategyKey] || ['Medium'];
    return STOCK_PICKS
      .filter(p => !ownedTickers.includes(p.ticker) && !p.avoidIfHeld.some(t => ownedTickers.includes(t)) && riskAllowed.includes(p.risk))
      .map(p => {
        let score = 50;
        if (!ownedSectors.includes(p.sector)) score += 28;
        else if ((sectors[p.sector]||0) < 10) score += 14;
        if (p.risk === 'Low') score += 6;
        if (p.risk === 'Very High') score -= 8;
        // Boost/penalise with live momentum (Â±15 pts max)
        const md = marketData && marketData[p.ticker];
        if (md) score += Math.round((md.momentum - 50) * 0.3);
        return {...p, score, isStock:true};
      })
      .sort((a,b) => b.score - a.score)
      .slice(0,8);
  }

  // â”€â”€ Market data badge HTML helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Returns compact inline badge: "$123.45 â–² +1.23%"
  function marketBadgeHTML(ticker, marketData) {
    if (!marketData) return '';
    const md = marketData[ticker];
    if (!md || md.price == null || md.changePct == null) return '';
    const dir   = md.changePct > 0.05 ? 'up' : md.changePct < -0.05 ? 'down' : 'flat';
    const arrow = dir === 'up' ? 'â–²' : dir === 'down' ? 'â–¼' : 'â€”';
    const sign  = md.changePct > 0 ? '+' : '';
    const { isOpen } = getMarketStatus();
    const closeLabel = !isOpen ? '<span class="market-close-label">at close</span>' : '';
    return '<span class="market-inline">' +
      '<span class="market-inline-price"><span class="currency">$</span>' + md.price.toFixed(2) + '</span>' +
      '<span class="market-badge ' + dir + '">' + arrow + ' ' + sign + md.changePct.toFixed(2) + '%</span>' +
      closeLabel +
      '</span>';
  }

  function buildItemHTML(item, type, marketData) {
    const eTicker = escapeHTML(item.ticker);
    const eName = escapeHTML(item.name);
    const eDesc = escapeHTML(item.desc);
    const id = 'item-' + eTicker + '-' + type;
    if (!item.isStock) {
      return '<div class="etf-item etf-type-etf" id="' + id + '" onclick="toggleDrawer(\'' + eTicker + '\',\'' + type + '\',\'' + safeStr(item.name) + '\',\'' + safeStr(item.desc) + '\',false)">' +
        '<div class="etf-item-header"><div class="ticker-name-group"><div class="ticker-with-tag">' +
        '<span class="etf-ticker">' + eTicker + '</span><span class="item-type-tag tag-etf">ETF</span></div>' +
        '<div class="etf-details"><h4>' + eName + ' ' + marketBadgeHTML(item.ticker, marketData) + '</h4><p>' + eDesc + '</p></div></div>' +
        '<div class="etf-meta"><div class="pick-sector-tag">' + escapeHTML(item.sectors[0] === 'all' ? 'Broad Market' : item.sectors[0]) + '</div>' + matchLabel(item.score) + '</div></div>' +
        '<div class="pick-hint">âœ¦ Why this for my portfolio?</div>' +
        '<div class="etf-drawer" id="drawer-' + id + '"><div class="etf-drawer-inner">' +
        '<div class="etf-drawer-label">â—ˆ Why this pick?</div>' +
        '<div class="etf-drawer-text" id="drawer-text-' + id + '"></div></div></div></div>';
    } else {
      return '<div class="etf-item etf-type-stock" id="' + id + '" onclick="toggleDrawer(\'' + eTicker + '\',\'' + type + '\',\'' + safeStr(item.name) + '\',\'' + safeStr(item.desc) + '\',true)">' +
        '<div class="etf-item-header"><div class="ticker-name-group"><div class="ticker-with-tag">' +
        '<span class="pick-ticker">' + eTicker + '</span><span class="item-type-tag tag-stock">STOCK</span></div>' +
        '<div class="pick-details"><h4>' + eName + ' ' + marketBadgeHTML(item.ticker, marketData) + '</h4><p>' + eDesc + '</p></div></div>' +
        '<div class="pick-meta"><div class="pick-sector-tag">' + escapeHTML(item.sector) + '</div>' +
        '<div class="pick-risk" style="color:' + (RISK_COLORS[item.risk]||'#888') + '">' + escapeHTML(item.risk) + ' Risk</div></div></div>' +
        '<div class="pick-hint">âœ¦ Why this for my portfolio?</div>' +
        '<div class="pick-drawer" id="drawer-' + id + '"><div class="pick-drawer-inner">' +
        '<div class="pick-drawer-label">â—ˆ Why this pick?</div>' +
        '<div class="pick-drawer-text" id="drawer-text-' + id + '"></div></div></div></div>';
    }
  }

  function strategyCard(type, label, desc, etfs, marketData) {
    const picks = getScoredPicks(type, marketData);
    const sortedEtfs = etfs.map(e => ({...e,isStock:false})).sort((a,b) => {
      const ma = marketData && marketData[a.ticker];
      const mb = marketData && marketData[b.ticker];
      const aS = a.score + (ma ? Math.round((ma.momentum - 50) * 0.3) : 0);
      const bS = b.score + (mb ? Math.round((mb.momentum - 50) * 0.3) : 0);
      return bS - aS;
    });

    // All items combined: ETFs first, then stocks
    const allItems = [...sortedEtfs.map(e => ({...e,isStock:false})), ...picks];

    // Primary: first 5 (from truncated free data)
    const primaryItems = allItems.slice(0,5);
    const primaryHTML = primaryItems.map(item => buildItemHTML(item, type, marketData)).join('');

    // Expose buildItemHTML and marketData for dynamic pro pick rendering
    _lastBuildItemHTML = buildItemHTML;
    _lastMarketData = marketData;

    // Show-more container â€” available to all users (static data, no API cost)
    const extraHTML =
      '<div class="show-more-items" id="show-more-' + type + '"></div>' +
      '<button class="btn-show-more" id="show-more-btn-' + type + '" onclick="toggleShowMore(\'' + type + '\')" data-shown="0">' +
        'âœ¦ See more stocks' +
      '</button>';

    return '<div class="strategy-card"><div class="strategy-header strategy-toggle" onclick="toggleStrategyCard(this)">' +
      '<div class="strategy-label">' +
      '<span class="strategy-badge badge-' + type + '">' + label + '</span>' +
      '<span class="strategy-best-match-slot"></span>' +
      '<span class="strategy-chevron">&#9662;</span><span class="strategy-expand-hint">tap to expand</span></div>' +
      '<span class="strategy-desc">' + desc + '</span></div>' +
      '<div class="etf-list strategy-collapsed">' + primaryHTML + extraHTML + '</div></div>';
  }

  function renderResultsPanel(marketData) {
    const refreshTime = marketData ? new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : null;
    const sampleState = marketData && Object.values(marketData)[0]?.marketState;
    const isLiveNow   = sampleState === 'REGULAR';
    const stateLabel  = sampleState === 'PRE'  ? 'Pre-Market' :
                        sampleState === 'POST' ? 'After Hours' :
                        sampleState === 'REGULAR' ? 'Live' : 'At Close';
    const statusHTML = marketData
      ? '<span class="market-status ' + (isLiveNow ? 'live' : '') + '">&#9679; ' + stateLabel + ' &mdash; updated ' + refreshTime + '</span>'
      : '<span class="market-status error">&#9888; Market data unavailable</span>';

    // â”€â”€ Portfolio Health Panel â”€â”€
    const sectorEntries = Object.entries(profile.sectors).filter(([,v]) => v > 0).sort((a,b) => b[1] - a[1]);
    const topSectorPct = sectorEntries.length > 0 ? sectorEntries[0][1] : 0;
    const topSectorName = sectorEntries.length > 0 ? sectorEntries[0][0] : 'â€”';
    const numSectors = sectorEntries.length;
    const largestHolding = holdings.reduce((a,b) => a.pct > b.pct ? a : b, holdings[0]);

    // Risk level label
    const riskLabel = profile.beta >= 1.3 ? 'Aggressive' : profile.beta >= 0.85 ? 'Moderate' : 'Conservative';
    const riskClass = riskLabel.toLowerCase();
    const riskDesc = riskLabel === 'Aggressive' ? 'High growth, high risk' : riskLabel === 'Moderate' ? 'Growth with stability' : 'Low risk, steady returns';
    const riskBarColor = riskLabel === 'Aggressive' ? 'var(--aggressive)' : riskLabel === 'Moderate' ? 'var(--moderate)' : 'var(--conservative)';
    const riskBarPct = Math.min(100, Math.round(profile.beta * 60));

    // Diversification score (0â€“100)
    const divScore = Math.min(100, Math.round(
      (numSectors >= 8 ? 30 : numSectors * 3.5) +
      (topSectorPct <= 20 ? 30 : topSectorPct <= 30 ? 20 : topSectorPct <= 40 ? 10 : 0) +
      (holdings.length >= 10 ? 20 : holdings.length * 2) +
      (largestHolding && largestHolding.pct <= 10 ? 20 : largestHolding && largestHolding.pct <= 15 ? 15 : largestHolding && largestHolding.pct <= 20 ? 10 : 5)
    ));
    const divLabel = divScore >= 75 ? 'Well diversified' : divScore >= 50 ? 'Moderate' : 'Concentrated';
    const divClass = divScore >= 75 ? 'conservative' : divScore >= 50 ? 'moderate' : 'aggressive';

    // Alert
    const alertHTML = topSectorPct >= 30
      ? '<div class="health-alert">&#9888; ' + topSectorName + ' makes up ' + Math.round(topSectorPct) + '% of your portfolio â€” watch for sector-specific volatility.</div>'
      : '';

    // VS S&P 500 comparisons
    const spyBeta = 1.0;
    const spyTopSector = 28;
    const spyTopHolding = 7;
    const betaDiff = (profile.beta - spyBeta).toFixed(2);
    const sectorDiff = Math.round(topSectorPct - spyTopSector);
    const holdDiff = Math.round((largestHolding ? largestHolding.pct : 0) - spyTopHolding);
    const diffBadge = (val, suffix, invert) => {
      const num = typeof val === 'string' ? parseFloat(val) : val;
      const abs = Math.abs(num);
      const cls = (invert ? num <= 0 : num >= 0) ? (abs > 8 ? 'bad' : 'warn') : 'good';
      return '<span class="health-compare-diff ' + cls + '">' + (num > 0 ? '+' : '') + val + suffix + '</span>';
    };

    const healthHTML =
      '<div class="health-panel">' +
        '<div class="panel-header panel-toggle" onclick="togglePanel(this)"><h2 class="section-title">Portfolio Health</h2><span class="panel-chevron panel-chevron-open">&#9662;</span><span class="panel-expand-hint">tap to collapse</span></div>' +
        '<div class="panel-body">' +
        alertHTML +
        '<div class="health-cards">' +
          '<div class="health-card">' +
            '<div class="health-card-label">Risk Level</div>' +
            '<div class="health-card-value ' + riskClass + '">' + riskLabel + '</div>' +
            '<div class="health-card-sub">' + riskDesc + '</div>' +
            '<div class="health-card-sub" style="opacity:0.5;margin-top:2px">Beta ' + profile.beta.toFixed(2) + '</div>' +
            '<div class="health-card-bar"><div class="health-card-bar-fill" style="width:' + riskBarPct + '%;background:' + riskBarColor + '"></div></div>' +
          '</div>' +
          '<div class="health-card">' +
            '<div class="health-card-label">Diversification</div>' +
            '<div class="health-card-value ' + divClass + '">' + divScore + '<span style="font-size:14px;color:var(--muted)">/100</span></div>' +
            '<div class="health-card-sub">' + divLabel + '</div>' +
            '<div class="health-card-sub" style="margin-top:2px">' + numSectors + ' sectors &middot; top: ' + Math.round(topSectorPct) + '%</div>' +
          '</div>' +
        '</div>' +
        '<div class="health-compare">' +
          '<div class="health-compare-title">vs S&amp;P 500 (SPY)</div>' +
          '<div class="health-compare-row">' +
            '<span class="health-compare-label">Portfolio Beta</span>' +
            '<span class="health-compare-val">' + profile.beta.toFixed(2) + '</span>' +
            '<span class="health-compare-spy">SPY 1.0</span>' +
            diffBadge(betaDiff, '', true) +
          '</div>' +
          '<div class="health-compare-row">' +
            '<span class="health-compare-label">Top Sector</span>' +
            '<span class="health-compare-val">' + Math.round(topSectorPct) + '%</span>' +
            '<span class="health-compare-spy">SPY ~28%</span>' +
            diffBadge(sectorDiff, '%', true) +
          '</div>' +
          '<div class="health-compare-row">' +
            '<span class="health-compare-label">Largest Holding</span>' +
            '<span class="health-compare-val">' + (largestHolding ? largestHolding.ticker + ' ' + Math.round(largestHolding.pct) + '%' : 'â€”') + '</span>' +
            '<span class="health-compare-spy">SPY top ~7%</span>' +
            diffBadge(holdDiff, '%', true) +
          '</div>' +
        '</div>' +
      '</div>' +
      '</div>';

    // â”€â”€ Rebalancing Suggestions â”€â”€
    const missingSectorsSugg = Object.entries(SECTOR_TARGETS)
      .filter(([name, t]) => !(profile.sectors[name] > 0) && (t.mod >= 5 || t.agg >= 5))
      .sort((a,b) => Math.max(b[1].agg,b[1].mod,b[1].con) - Math.max(a[1].agg,a[1].mod,a[1].con))
      .slice(0, 4);
    let rebalanceHTML = '';
    if (missingSectorsSugg.length > 0) {
      const items = missingSectorsSugg.map(([name, t]) => {
        const target = Math.max(t.agg, t.mod, t.con);
        return '<div class="rebalance-item">' +
          '<span style="color:var(--accent)">&#9656;</span> ' +
          '<span><span class="sector-link">' + name + '</span> ' +
          '<span class="rebalance-note">â€” not in your portfolio, moderate target ~' + t.mod + '%</span></span>' +
          '</div>';
      }).join('');
      rebalanceHTML =
        '<div class="rebalance-panel">' +
          '<div class="panel-header panel-toggle" onclick="togglePanel(this)"><h2 class="section-title">Rebalancing Suggestions</h2><span class="panel-chevron panel-chevron-open">&#9662;</span><span class="panel-expand-hint">tap to collapse</span></div>' +
          '<div class="panel-body"><div class="rebalance-list">' + items + '</div></div>' +
        '</div>';
    }

    // â”€â”€ Position Sizing â”€â”€
    const positionHTML =
      '<div class="position-panel">' +
        '<div class="panel-header panel-toggle" onclick="togglePanel(this)"><h2 class="section-title">Position Sizing</h2><span class="panel-chevron panel-chevron-open">&#9662;</span><span class="panel-expand-hint">tap to collapse</span></div>' +
        '<div class="panel-body">' +
        '<div class="position-input-row">' +
          '<label>$</label>' +
          '<input type="number" id="positionAmountInput" value="" min="1" placeholder="Enter your budget">' +
          '<button class="btn-calc" onclick="calcPositionSizing()" title="Calculate">&#8862;</button>' +
        '</div>' +
        '<div class="position-table" id="positionTableEl">' +
        '</div>' +
        '</div>' +
      '</div>';

    document.getElementById('resultsPanel').innerHTML =
      healthHTML +
      rebalanceHTML +
      '<div class="share-export-row">' +
        '<button class="btn-share" onclick="sharePortfolio()">ðŸ”— Share Portfolio</button>' +
        '<button class="btn-export-pdf" onclick="exportPDF()">ðŸ“„ Download PDF Report</button>' +
      '</div>' +
      '<div class="analysis-bar">' +
        '<div class="analysis-bar-header panel-toggle" onclick="togglePanel(this)">' +
          '<h2 class="section-title">Portfolio Breakdown &amp; Strategies</h2>' +
          '<span class="panel-expand-hint">tap to collapse</span><span class="panel-chevron panel-chevron-open">&#9662;</span>' +
        '</div>' +
        '<div class="panel-body">' +
        '<div class="breakdown-legend">' +
            '<div class="legend-item"><div class="legend-dot legend-dot-current"></div>You Own</div>' +
            '<div class="legend-hint">tap to show</div>' +
            '<div class="legend-item hoverable" data-strategy="agg">' +
              '<div class="legend-tick legend-tick-agg"></div>Aggressive' +
              '<div class="strategy-tooltip"><div class="tooltip-label agg">&#9889; Aggressive</div>' +
              '<div class="tooltip-body">High-growth sectors with above-average volatility. Heavy tech, AI, semis, and emerging markets. Expects significant drawdowns but maximum long-term upside.</div>' +
              '<div class="tooltip-note">Best for: 10+ year horizon, high risk tolerance, can stomach 40%+ drops without panic selling.</div></div>' +
            '</div>' +
            '<div class="legend-item hoverable" data-strategy="mod">' +
              '<div class="legend-tick legend-tick-mod"></div>Moderate' +
              '<div class="strategy-tooltip"><div class="tooltip-label mod">&#9670; Moderate</div>' +
              '<div class="tooltip-body">Mix of growth and defensive sectors. Spreads risk across tech, financials, healthcare, and staples. Aims for steady compounding with manageable volatility.</div>' +
              '<div class="tooltip-note">Best for: 5-10 year horizon, moderate risk tolerance. The S&P 500 is basically this, proven over decades.</div></div>' +
            '</div>' +
            '<div class="legend-item hoverable" data-strategy="con">' +
              '<div class="legend-tick legend-tick-con"></div>Conservative' +
              '<div class="strategy-tooltip"><div class="tooltip-label con">&#9632; Conservative</div>' +
              '<div class="tooltip-body">Defensive, income-focused sectors: bonds, utilities, healthcare, dividends, real estate. Prioritizes capital preservation over growth. Lower highs, but also lower lows.</div>' +
              '<div class="tooltip-note">Best for: near retirement, income needs, or simply sleeping well at night. Boring is underrated.</div></div>' +
            '</div>' +
          '</div>' +
        '<div class="sector-bars" id="sectorBarsEl">' + sectorBars + '</div>' +
        '</div>' +
      '</div>' +
      positionHTML +
      '<div class="panel-header" style="border:none;padding:20px 0 8px;display:flex;align-items:center;justify-content:space-between;"><h2 class="section-title">Recommended Stocks</h2>' + statusHTML + '</div>' +
      strategyCard('aggressive','Aggressive','High growth, high risk', aggressiveETFs, marketData) +
      strategyCard('moderate','Moderate','Growth with stability', moderateETFs, marketData) +
      strategyCard('conservative','Conservative','Capital preservation', conservativeETFs, marketData) +
      '<div class="disclaimer-footer">&#9432; For informational purposes only. Not financial advice. Past performance does not guarantee future results. Always consult a qualified financial advisor before making investment decisions.<br><span style="opacity:0.6">Prices from FMP &middot; Ranked by portfolio fit + live momentum.</span></div>';

    // Re-attach strategy legend listeners
    document.querySelectorAll('.legend-item.hoverable').forEach(el => {
      const s = el.dataset.strategy;
      if (!s) return;
      el.addEventListener('mouseenter', () => showStrategy(s));
      el.addEventListener('mouseleave', () => hideStrategy(s));
      el.addEventListener('click',      () => toggleStrategy(s));
    });

    // Add "Best match" badge below strategy badge for the matching card
    (function() {
      var matchType = profile.beta >= 1.3 ? 'aggressive' : profile.beta >= 0.85 ? 'moderate' : 'conservative';
      var cards = document.querySelectorAll('.strategy-card');
      cards.forEach(function(card) {
        var badge = card.querySelector('.strategy-badge');
        var slot = card.querySelector('.strategy-best-match-slot');
        if (badge && slot && badge.classList.contains('badge-' + matchType)) {
          slot.innerHTML = '<span class="strategy-best-match">Best match for you</span>';
        }
      });
    })();
  }

  // Collect only the tickers actually rendered (max ~15)
  const renderedTickers = [];
  [aggressiveETFs, moderateETFs, conservativeETFs].forEach(etfs => {
    etfs.slice(0,3).forEach(e => renderedTickers.push(e.ticker));
  });
  [getScoredPicks('aggressive',null), getScoredPicks('moderate',null), getScoredPicks('conservative',null)]
    .forEach(picks => picks.forEach(p => renderedTickers.push(p.ticker)));
  const tickersToFetch = [...new Set(renderedTickers)];

  // Render immediately with loading placeholders
  renderResultsPanel(null);

  // Scroll so Portfolio Health is visible with Analyze button just above fold
  setTimeout(function() {
    var healthEl = document.querySelector('.health-panel');
    if (healthEl) {
      var rect = healthEl.getBoundingClientRect();
      var offset = rect.top + window.pageYOffset - 60;
      window.scrollTo({ top: offset, behavior: 'smooth' });
    }
  }, 100);

  // Hide sticky analyze button after results show
  setTimeout(() => {
    const stickyBtn = document.querySelector('.btn-analyze-sticky');
    if (stickyBtn) stickyBtn.classList.remove('visible');
  }, 150);

  // Fetch market data â€” checks localStorage cache first (1hr TTL) before hitting API
  (async function fetchMarketDataCachedCall() {
    const marketData = await fetchMarketDataCached(tickersToFetch);
    lastMarketFetch = Date.now();
    lastMarketDataCache = marketData;
    renderResultsPanel(marketData);
    updateRefreshBtn();
  })();
}

// â”€â”€ LIVE BADGE PATCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Updates a single ticker's badge across all strategy cards without full re-render
function patchMarketBadge(ticker, md) {
  if (!md || md.price == null || md.changePct == null) return;
  const dir   = md.changePct > 0.05 ? 'up' : md.changePct < -0.05 ? 'down' : 'flat';
  const arrow = dir === 'up' ? 'â–²' : dir === 'down' ? 'â–¼' : 'â€”';
  const sign  = md.changePct > 0 ? '+' : '';
  const html  =
    '<span class="market-inline">' +
    '<span class="market-inline-price">$' + md.price.toFixed(2) + '</span>' +
    '<span class="market-badge ' + dir + '">' + arrow + ' ' + sign + md.changePct.toFixed(2) + '%</span>' +
    '</span>';

  // Each ticker can appear in multiple strategy cards â€” patch all of them
  document.querySelectorAll('.etf-item').forEach(el => {
    const tickerEl = el.querySelector('.etf-ticker, .pick-ticker');
    if (tickerEl && tickerEl.textContent.trim() === ticker) {
      const nameEl = el.querySelector('.etf-details h4, .pick-details h4');
      if (nameEl) {
        // Remove any existing market-inline span
        const existing = nameEl.querySelector('.market-inline, .market-badge');
        if (existing) existing.remove();
        nameEl.insertAdjacentHTML('beforeend', html);
      }
    }
  });
}

// â”€â”€ MARKET HOURS DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMarketStatus() {
  // NYSE hours: Monâ€“Fri 9:30amâ€“4:00pm ET
  const now = new Date();
  const etOffset = -5; // EST (UTC-5); EDT is UTC-4
  // Detect DST: second Sunday of March to first Sunday of November
  const jan = new Date(now.getFullYear(), 0, 1);
  const jul = new Date(now.getFullYear(), 6, 1);
  const stdOffset = Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
  const isDST = now.getTimezoneOffset() < stdOffset;
  const etHour = now.getUTCHours() + (isDST ? -4 : -5);
  const etMin  = now.getUTCMinutes();
  const etTime = etHour + etMin / 60; // decimal hours in ET
  const day    = now.getUTCDay();     // 0=Sun, 6=Sat

  // Adjust day for ET offset crossing midnight
  const utcMidnightET = isDST ? 4 : 5;
  const etDay = now.getUTCHours() < utcMidnightET
    ? (day === 0 ? 6 : day - 1)
    : day;

  const isWeekday  = etDay >= 1 && etDay <= 5;
  const isOpen     = isWeekday && etTime >= 9.5 && etTime < 16;
  const isPrePost  = isWeekday && (
    (etTime >= 4 && etTime < 9.5) || (etTime >= 16 && etTime < 20)
  );

  return { isOpen, isPrePost, isWeekday };
}

// â”€â”€ MARKET DATA MANUAL REFRESH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lastMarketFetch = 0;

function getMarketCacheMs() {
  // During market hours: refresh every 2 hours
  // Outside hours: no point refreshing (data is end-of-day)
  return getMarketStatus().isOpen
    ? 2 * 60 * 60 * 1000   // 2 hours during trading
    : 8 * 60 * 60 * 1000;  // 8 hours outside (basically don't auto-refresh)
}

function updateRefreshBtn() {
  const btn = document.getElementById('refreshMarketBtn');
  const status = document.querySelector('.market-status');
  if (!btn) return;

  const { isOpen, isPrePost, isWeekday } = getMarketStatus();
  const now = Date.now();
  const cacheMs = getMarketCacheMs();
  const elapsed = now - lastMarketFetch;
  const onCooldown = lastMarketFetch && elapsed < cacheMs;

  if (!isOpen) {
    btn.disabled = true;
    btn.style.opacity = '0.35';
    btn.style.cursor = 'not-allowed';
    btn.title = isPrePost
      ? 'Pre/post market â€” prices update at next open'
      : !isWeekday
        ? 'Market closed (weekend)'
        : 'Market closed';
    if (status) {
      status.className = 'market-status';
      status.innerHTML = isPrePost ? '&#9679; Pre/Post Market' : '&#9679; Market Closed';
    }
  } else if (onCooldown) {
    btn.disabled = true;
    btn.style.opacity = '0.35';
    btn.style.cursor = 'not-allowed';
    const remaining = Math.ceil((cacheMs - elapsed) / 60000);
    btn.title = 'Next refresh available in ~' + remaining + ' min';
  } else {
    btn.disabled = false;
    btn.style.opacity = '';
    btn.style.cursor = '';
    btn.title = '';
  }
}

function refreshMarketData() {
  const { isOpen } = getMarketStatus();
  const now = Date.now();
  const cacheMs = getMarketCacheMs();
  const onCooldown = lastMarketFetch && (now - lastMarketFetch) < cacheMs;

  if (!isOpen || onCooldown) {
    updateRefreshBtn();
    return;
  }

  // Re-run analyze() which will re-render and re-stream fresh badge data
  const btn = document.getElementById('refreshMarketBtn');
  if (btn) btn.classList.add('spinning');
  clearMarketCache(); // clear localStorage so fresh data is fetched
  analyze();
}

// â”€â”€ DRAWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const drawerCache = {};

async function toggleDrawer(ticker, strategy, name, desc, isStock) {
  const id = 'item-' + ticker + '-' + strategy;
  const itemEl = document.getElementById(id);
  const textEl = document.getElementById('drawer-text-' + id);
  if (!itemEl || !textEl) return;
  const isOpen = itemEl.classList.contains('open');
  document.querySelectorAll('.etf-item.open').forEach(e => e.classList.remove('open'));
  if (isOpen) return;
  itemEl.classList.add('open');
  const cacheKey = id;
  if (drawerCache[cacheKey]) { textEl.textContent = drawerCache[cacheKey]; return; }
  const holdingSummary = holdings.map(h => h.ticker + ' (' + h.pct + '% â€” ' + h.sector + ')').join(', ');
  const profile = getPortfolioProfile();
  const sectorSummary = Object.entries(profile.sectors).sort((a,b) => b[1]-a[1]).map(([s,p]) => s + ': ' + p + '%').join(', ');
  textEl.innerHTML = '<div class="etf-drawer-loading"><div class="mini-spinner"></div> Analyzing your portfolio...</div>';
  try {
    const res = await callClaudeAPI({
      messages:[{role:'user',content:'Portfolio: ' + holdingSummary + '. Sector exposure: ' + sectorSummary + '.\n\nWhy would ' + ticker + ' (' + name + ' â€” ' + desc + ') be a great ' + (isStock ? 'individual stock pick' : 'ETF') + ' to complement THIS specific portfolio? Reference their actual holdings and what sector gap it fills. Be direct, specific, 2-3 sentences, under 55 words. No bullet points.'}]
    });
    const rawText = await res.text();
    if (res.status === 429) {
      showPaywall('ai');
      return;
    }
    if (!res.ok) {
      console.error('[claude] HTTP ' + res.status + ':', rawText);
      textEl.textContent = 'Server error ' + res.status + ': ' + rawText.slice(0, 200);
      return;
    }
    let data;
    try { data = JSON.parse(rawText); }
    catch(e) { textEl.textContent = 'Bad response from server: ' + rawText.slice(0, 200); return; }
    const text = (data.content||[]).map(b => b.text||'').join('').trim();
    if (!text) { textEl.textContent = 'Empty response from AI. Raw: ' + rawText.slice(0, 200); return; }
    drawerCache[cacheKey] = text;
    textEl.textContent = text;
  } catch(e) {
    if (e.message === 'AI_CONSENT_DECLINED') { itemEl.classList.remove('open'); return; }
    console.error('[claude] drawer error:', e);
    textEl.textContent = 'Fetch failed: ' + (e.message || 'unknown');
  }
}

// â”€â”€ SCREENSHOT IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uploadZone = document.getElementById('uploadZone');
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) processImageFile(file);
});

async function handleScreenshot(event) {
  const files = Array.from(event.target.files);
  if (!files.length) return;

  const overlay = document.getElementById('scanningOverlay');
  const scanText = document.getElementById('scanText');
  const preview = document.getElementById('importPreview');
  preview.classList.remove('visible');
  overlay.classList.add('active');

  const allHoldings = [];
  let errors = [];

  for (let i = 0; i < files.length; i++) {
    scanText.textContent = files.length > 1
      ? 'Scanning screenshot ' + (i + 1) + ' of ' + files.length + '...'
      : 'Scanning portfolio...';
    try {
      const result = await processImageFile(files[i]);
      if (result && result.length > 0) {
        console.log('[screenshot ' + (i+1) + '] detected:', result.map(h => h.ticker + ':' + h.shares).join(', '));
        result.forEach(h => {
          // Merge: skip duplicates from earlier screenshots
          const existing = allHoldings.find(e => e.ticker === h.ticker);
          if (!existing) {
            allHoldings.push(h);
          } else {
            console.log('[dedup] skipping ' + h.ticker + ' (already found in earlier screenshot)');
          }
        });
      }
    } catch(err) {
      errors.push('Screenshot ' + (i + 1) + ': ' + err.message);
    }
  }

  overlay.classList.remove('active');
  event.target.value = '';

  if (allHoldings.length === 0) {
    alert('Could not detect holdings.' + (errors.length ? '\n\n' + errors.join('\n') : '') + '\n\nTip: Try clearer screenshots showing ticker symbols and values.');
    return;
  }

  // Convert shares to dollar values using LIVE prices from market data API
  const tickers = allHoldings.map(h => h.ticker);
  scanText.textContent = 'Fetching live prices...';
  overlay.classList.add('active');

  let livePrices = {};
  try {
    const priceRes = await fetch('/api/market-data?tickers=' + tickers.join(','));
    const priceData = await priceRes.json();
    for (const [ticker, val] of Object.entries(priceData)) {
      if (val && val.price) livePrices[ticker] = Number(val.price);
    }
    console.log('[live prices]', livePrices);
  } catch(e) {
    console.warn('[live prices] fetch failed, using fallback estimates:', e.message);
  }

  overlay.classList.remove('active');

  const holdingsWithValues = allHoldings.map(h => {
    const price = livePrices[h.ticker] || APPROX_PRICES[h.ticker] || 50;
    const dollarValue = (h.shares || 0) * price;
    console.log('[calc]', h.ticker, h.shares, 'shares Ã—', '$' + price, '=', '$' + dollarValue.toFixed(2));
    return { ...h, dollarValue };
  });

  const totalValue = holdingsWithValues.reduce((s, h) => s + h.dollarValue, 0);
  console.log('[calc] total portfolio value: $' + totalValue.toFixed(2));

  previewHoldings = holdingsWithValues.map(h => ({
    ticker: h.ticker,
    pct: totalValue > 0 ? Math.round((h.dollarValue / totalValue) * 100 * 10) / 10 : Math.round(100 / allHoldings.length * 10) / 10,
    name: h.name || h.ticker,
    shares: h.shares || 0
  })).sort((a, b) => b.pct - a.pct);

  renderPreview();
  if (errors.length > 0 && allHoldings.length > 0) {
    document.getElementById('importNote').textContent += ' Â· ' + errors.length + ' screenshot(s) had issues';
  }
}

async function processImageFile(file) {
  const base64 = await fileToBase64(file);
  const mediaType = file.type || 'image/png';
  var response;
  try {
    response = await callClaudeAPI({
      messages:[{role:'user',content:[
        {type:'image',source:{type:'base64',media_type:mediaType,data:base64}},
        {type:'text',text:'This is a screenshot from a stock brokerage app (likely Robinhood). It shows stock holdings with share counts.\n\nRead EVERY ticker and its EXACT share count as shown on screen. Be precise with decimal shares (e.g. 0.811746, 0.098814, 51.58).\n\nRespond ONLY with JSON, no other text:\n{\"holdings\":[{\"ticker\":\"HOOD\",\"shares\":51.58,\"name\":\"Robinhood Markets\"},{\"ticker\":\"QQQ\",\"shares\":1.40,\"name\":\"Invesco QQQ\"}]}\n\nRules:\n- ticker = uppercase symbol exactly as shown\n- shares = exact number shown (keep all decimals)\n- name = company name if you know it, otherwise ticker\n- Skip cash, buying power, or any non-stock items\n- If nothing detected: {\"holdings\":[],\"error\":\"Could not detect holdings\"}'}
      ]}]
    });
  } catch(e) {
    if (e.message === 'AI_CONSENT_DECLINED') return;
    throw e;
  }
  if (response.status === 429) {
    const errData = await response.json();
    document.getElementById('scanningOverlay').style.display = 'none';
    document.getElementById('errorMsg').textContent = errData.message || 'Too many requests. Please wait.';
    return;
  }
  const data = await response.json();
  const text = (data.content||[]).map(b => b.text||'').join('');
  // Extract JSON from response â€” model may include preamble text
  let clean = text.replace(/```json|```/g,'').trim();
  const jsonMatch = clean.match(/\{[\s\S]*"holdings"[\s\S]*\}/);
  if (!jsonMatch) throw new Error('No valid response received.');
  const parsed = JSON.parse(jsonMatch[0]);
  if (!parsed.holdings || parsed.holdings.length === 0) throw new Error(parsed.error || 'No holdings detected.');
  return parsed.holdings.map(h => ({
    ticker: (h.ticker||'').toUpperCase().replace(/[^A-Z0-9]/g,''),
    shares: h.shares || h.pct || 0,
    name: h.name || h.ticker
  })).filter(h => h.ticker.length >= 1 && h.ticker.length <= 6);
}


function fileToBase64(file) {
  return new Promise((resolve,reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsDataURL(file);
  });
}

function renderPreview() {
  const preview   = document.getElementById('importPreview');
  const container = document.getElementById('previewItems');
  const note      = document.getElementById('importNote');
  if (previewHoldings.length === 0) { preview.classList.remove('visible'); return; }
  const totalPct = previewHoldings.reduce((s,h) => s + h.pct, 0);
  container.innerHTML = previewHoldings.map((h,i) =>
    '<div class="preview-item" style="grid-template-columns:52px 1fr auto 70px 20px;">' +
    '<span class="preview-ticker">' + escapeHTML(h.ticker) + '</span>' +
    '<span class="preview-name">' + escapeHTML(h.name) + '</span>' +
    '<span style="font-family:\'Space Mono\',monospace;font-size:10px;color:var(--muted);white-space:nowrap;">' + (h.shares ? h.shares.toLocaleString(undefined,{maximumFractionDigits:2}) + ' sh' : '') + '</span>' +
    '<div class="preview-pct-wrapper"><input class="preview-pct-input" type="number" value="' + h.pct + '" min="0.1" max="100" step="0.1" onchange="updatePreviewPct(' + i + ',this.value)" /><span class="preview-pct-symbol">%</span></div>' +
    '<button class="btn-preview-remove" onclick="removePreviewItem(' + i + ')">Ã—</button>' +
    '</div>'
  ).join('');
  note.textContent = previewHoldings.length + ' holdings detected Â· Total: ' + totalPct.toFixed(1) + '% Â· Adjust if needed';
  preview.classList.add('visible');
}

function updatePreviewPct(i, val) {
  previewHoldings[i].pct = parseFloat(val)||0;
  const total = previewHoldings.reduce((s,h) => s+h.pct, 0);
  document.getElementById('importNote').textContent = previewHoldings.length + ' holdings Â· Total: ' + total.toFixed(1) + '%';
}

function removePreviewItem(i) {
  previewHoldings.splice(i,1);
  renderPreview();
}

function importAll() {
  // Clear existing holdings when importing a full portfolio from screenshots
  if (previewHoldings.length >= 3) {
    holdings.length = 0;
  }
  let skipped = [];
  previewHoldings.forEach(h => {
    if (!h.ticker) return;
    if (h.pct <= 0) { h.pct = 0.1; } // give tiny positions a minimum
    if (holdings.find(e => e.ticker === h.ticker)) { skipped.push(h.ticker); return; }
    const info = STOCK_DB[h.ticker] || {name:h.name||h.ticker, sector:'Other', beta:1.0, cap:'unknown'};
    holdings.push({ticker:h.ticker, pct:h.pct, ...info});
  });
  // Normalize to 100% if rounding caused drift
  const total = holdings.reduce((s, h) => s + h.pct, 0);
  if (total > 0 && Math.abs(total - 100) > 0.5) {
    holdings.forEach(h => { h.pct = Math.round((h.pct / total) * 100 * 10) / 10; });
  }
  previewHoldings = [];
  document.getElementById('importPreview').classList.remove('visible');
  renderHoldings();
  if (skipped.length > 0) document.getElementById('errorMsg').textContent = 'Duplicates skipped: ' + skipped.join(', ');
}

// â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  const el = document.getElementById('themeLabel');
  if (el) el.textContent = isLight ? 'LIGHT' : 'DARK';
  localStorage.setItem('pc_theme', isLight ? 'light' : 'dark');
}

// Init theme from localStorage
(function() {
  if (localStorage.getItem('pc_theme') === 'light') {
    document.body.classList.add('light');
    document.addEventListener('DOMContentLoaded', () => {
      const label = document.getElementById('themeLabel');
      if (label) label.textContent = 'LIGHT';
    });
  }
})();


// â”€â”€ RISK SCORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRiskScore() {
  const bar = document.getElementById('riskScoreBar');
  const fill = document.getElementById('riskScoreFill');
  const num  = document.getElementById('riskScoreNum');
  if (!bar || holdings.length === 0) { if(bar) bar.style.display='none'; return; }
  const profile = getPortfolioProfile();
  const beta = profile.beta;
  const score = Math.round(Math.min(100, Math.max(0, (beta / 2.0) * 100)));
  const color = score < 35 ? 'var(--conservative)' : score < 65 ? 'var(--moderate)' : 'var(--aggressive)';
  const label = score < 35 ? 'Conservative' : score < 65 ? 'Moderate' : score < 85 ? 'Aggressive' : 'Very High Risk';
  bar.style.display = 'flex';
  fill.style.width = score + '%';
  fill.style.background = color;
  num.textContent = label;
  num.style.color = color;
}


function updateCorrelationWarnings() {
  const el = document.getElementById('corrWarnings');
  if (!el) return;
  const tickers = holdings.map(h => h.ticker);
  const warnings = [];
  for (const [stocks, etfs, msg] of CORRELATED_PAIRS) {
    const hs = stocks.filter(t => tickers.includes(t));
    const he = etfs.filter(t => tickers.includes(t));
    if (hs.length >= 1 && he.length >= 1) {
      warnings.push(msg.replace('{stocks}', hs.join(', ')).replace('{etf}', he.join(' & ')));
    }
  }
  el.innerHTML = warnings.map(w =>
    '<div class="corr-warn"><span class="corr-icon">âš </span><span class="corr-text">' + escapeHTML(w) + '</span></div>'
  ).join('');
}

// â”€â”€ WHAT-IF SIMULATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleWhatIf() {
  const body = document.getElementById('whatifBody');
  const icon = document.getElementById('whatifToggleIcon');
  const open = body.classList.toggle('open');
  icon.textContent = open ? 'â–¾ collapse' : 'â–¸ expand';
  if (open) document.getElementById('whatifTicker').focus();
}

function updateWhatIfPanel() {
  const panel = document.getElementById('whatifPanel');
  if (panel) panel.style.display = holdings.length > 0 ? 'block' : 'none';
}

function runWhatIf() {
  const wiTicker = document.getElementById('whatifTicker');
  const wiPct    = document.getElementById('whatifPct');
  const result   = document.getElementById('whatifResult');
  if (!wiTicker || !wiPct || !result) return;
  const ticker = wiTicker.value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  const pct    = parseFloat(wiPct.value) || 0;
  if (!ticker || pct <= 0) { result.innerHTML = 'Enter a ticker to preview its impact on your portfolio.'; return; }
  const info = STOCK_DB[ticker] || {name:ticker, sector:'Other', beta:1.0};
  const currentTotal = totalAllocation();
  const remaining = Math.round((100 - currentTotal) * 10) / 10;
  if (holdings.find(h => h.ticker === ticker)) {
    result.innerHTML = '<strong style="color:var(--aggressive)">' + ticker + '</strong> is already in your portfolio.'; return;
  }
  if (currentTotal + pct > 100.05) {
    result.innerHTML = 'Only <strong class="wi-new">' + remaining + '%</strong> remaining â€” reduce or remove a holding first.'; return;
  }
  const simHoldings = [...holdings, {ticker, pct, ...info}];
  const simTotal = simHoldings.reduce((s,h) => s+h.pct, 0);
  let simBeta = 0; const simSectors = {};
  simHoldings.forEach(h => { simBeta += (h.beta||1)*h.pct; simSectors[h.sector]=(simSectors[h.sector]||0)+h.pct; });
  simBeta = Math.round((simBeta/simTotal)*100)/100;
  const currentBeta = getPortfolioProfile().beta;
  const betaDelta = Math.round((simBeta - currentBeta)*100)/100;
  const betaDir = betaDelta > 0 ? 'â–²' : betaDelta < 0 ? 'â–¼' : 'â€”';
  result.innerHTML =
    'Adding <strong>' + escapeHTML(ticker) + '</strong> (' + escapeHTML(info.name) + ') at <strong class="wi-new">' + pct + '%</strong>:<br>' +
    '&middot; <strong>' + escapeHTML(info.sector) + '</strong> exposure &rarr; <strong class="wi-new">' + Math.round((simSectors[info.sector]||0)/simTotal*100) + '%</strong> of portfolio<br>' +
    '&middot; Beta shift <strong class="wi-new">' + betaDir + ' ' + Math.abs(betaDelta) + '</strong> &rarr; new beta: <strong class="wi-new">' + simBeta + '</strong><br>' +
    '&middot; <strong class="wi-new">' + Math.round((100-simTotal)*10)/10 + '%</strong> remaining unallocated' +
    '<br><button class="btn-whatif-add" onclick="addFromWhatIf()">+ Add ' + escapeHTML(ticker) + ' to Portfolio</button>';
}

function addFromWhatIf() {
  const wiTicker = document.getElementById('whatifTicker');
  const wiPct = document.getElementById('whatifPct');
  if (!wiTicker || !wiPct) return;
  const ticker = wiTicker.value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'');
  const pct = parseFloat(wiPct.value) || 0;
  if (!ticker || pct <= 0) return;
  if (holdings.find(h => h.ticker === ticker)) return;
  if (totalAllocation() + pct > 100.05) return;
  const info = STOCK_DB[ticker] || {name:ticker, sector:'Other', beta:1.0};
  holdings.push({ticker, pct: Math.round(pct*10)/10, sector: info.sector, beta: info.beta});
  renderHoldings();
  wiTicker.value = '';
  wiPct.value = '';
  document.getElementById('whatifResult').innerHTML = 'Enter a ticker to preview its impact on your portfolio.';
}

(function() {
  let whatifTimer = null;
  function debouncedWhatIf() { clearTimeout(whatifTimer); whatifTimer = setTimeout(runWhatIf, 300); }
  const wt = document.getElementById('whatifTicker');
  const wp = document.getElementById('whatifPct');
  if (wt) wt.addEventListener('input', debouncedWhatIf);
  if (wp) wp.addEventListener('input', debouncedWhatIf);
})();

// â”€â”€ WHAT-IF AUTOCOMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initWhatifAutocomplete() {
  const input = document.getElementById('whatifTicker');
  const dd = document.getElementById('whatifAutocompleteDropdown');
  if (!input || !dd) return;
  const dbEntries = Object.entries(STOCK_DB);

  input.addEventListener('input', function() {
    const q = this.value.trim().toUpperCase();
    if (q.length === 0) { dd.classList.remove('open'); return; }
    const matches = dbEntries
      .filter(([ticker, info]) => ticker.startsWith(q) || info.name.toUpperCase().includes(q))
      .slice(0, 8);
    if (matches.length === 0) { dd.classList.remove('open'); return; }
    dd.innerHTML = matches.map(([ticker, info]) =>
      '<div class="autocomplete-item" data-ticker="' + escapeHTML(ticker) + '">' +
      '<span class="autocomplete-item-ticker">' + escapeHTML(ticker) + '</span>' +
      '<span class="autocomplete-item-name">' + escapeHTML(info.name) + '</span>' +
      '</div>'
    ).join('');
    dd.classList.add('open');
  });

  dd.addEventListener('click', function(e) {
    const item = e.target.closest('.autocomplete-item');
    if (item && item.dataset.ticker) {
      input.value = item.dataset.ticker;
      dd.classList.remove('open');
      document.getElementById('whatifPct').focus();
      runWhatIf();
    }
  });

  input.addEventListener('keydown', function(e) {
    const items = dd.querySelectorAll('.autocomplete-item');
    const selIdx = [...items].findIndex(i => i.classList.contains('selected'));
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      items.forEach(i => i.classList.remove('selected'));
      const next = Math.min(selIdx + 1, items.length - 1);
      if (items[next]) { items[next].classList.add('selected'); items[next].scrollIntoView({block:'nearest'}); }
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      items.forEach(i => i.classList.remove('selected'));
      const prev = Math.max(selIdx - 1, 0);
      if (items[prev]) { items[prev].classList.add('selected'); items[prev].scrollIntoView({block:'nearest'}); }
    } else if (e.key === 'Enter') {
      const sel = dd.querySelector('.autocomplete-item.selected');
      if (sel && dd.classList.contains('open')) {
        e.preventDefault();
        input.value = sel.dataset.ticker;
        dd.classList.remove('open');
        document.getElementById('whatifPct').focus();
        runWhatIf();
      }
    } else if (e.key === 'Escape') {
      dd.classList.remove('open');
    }
  });

  document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-wrapper')) dd.classList.remove('open');
  });
})();

// â”€â”€ PORTFOLIO SAVE/LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAX_SLOTS = 3;
function getSavedPortfolios() { try { return JSON.parse(localStorage.getItem('pc_portfolios') || '[]'); } catch { return []; } }
function savePortfoliosLS(p) { localStorage.setItem('pc_portfolios', JSON.stringify(p)); }

// â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openSidebar() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarBackdrop').classList.add('open');
  renderSidebarContent();
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarBackdrop').classList.remove('open');
}

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  if (sidebar.classList.contains('open')) closeSidebar();
  else openSidebar();
}

// Close sidebar on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeSidebar();
});

function renderSidebarContent() {
  renderSidebarUser();
  renderSidebarSettings();
  renderSidebarAccount();
}

function renderSidebarUser() {
  const el = document.getElementById('sidebarUser');
  if (!el) return;
  if (typeof currentUser !== 'undefined' && currentUser) {
    const name = currentUser.name || currentUser.email.split('@')[0];
    const email = currentUser.email || '';
    let avatarHTML;
    if (currentUser.picture) {
      avatarHTML = '<img class="sidebar-user-avatar" src="' + escapeHTML(currentUser.picture) + '" onerror="this.style.display=\'none\'" />';
    } else {
      const initial = (name || email || '?')[0].toUpperCase();
      avatarHTML = '<div class="sidebar-user-avatar initials">' + initial + '</div>';
    }
    const proBadge = isProUser() ? '<div class="sidebar-pro-badge">âœ¦ Pro Member</div>' : '';
    el.innerHTML =
      '<div class="sidebar-user-info">' +
        avatarHTML +
        '<div class="sidebar-user-details">' +
          '<div class="sidebar-user-name">' + escapeHTML(name) + '</div>' +
          '<div class="sidebar-user-email">' + escapeHTML(email) + '</div>' +
        '</div>' +
      '</div>' +
      proBadge;
  } else {
    el.innerHTML =
      '<div class="sidebar-user-name" style="margin-bottom:4px;">Guest</div>' +
      '<button class="sidebar-signin-btn" onclick="closeSidebar();showAuthModalOptimized();">' +
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5zm0 2c-3.3 0-10 1.7-10 5v2h20v-2c0-3.3-6.7-5-10-5z" fill="currentColor"/></svg>' +
        'Sign In' +
      '</button>';
  }
}

function getPortfolioRiskColor(holdingsArr) {
  if (!holdingsArr || holdingsArr.length === 0) return 'var(--muted)';
  let beta = 0, total = 0;
  holdingsArr.forEach(h => { beta += (h.beta || (STOCK_DB[h.ticker]||{}).beta || 1.0) * h.pct; total += h.pct; });
  if (total === 0) return 'var(--muted)';
  const score = Math.round(Math.min(100, Math.max(0, ((beta / total) / 2.0) * 100)));
  return score < 35 ? 'var(--conservative)' : score < 65 ? 'var(--moderate)' : 'var(--aggressive)';
}

function renderSidebarPortfolios() {
  const el = document.getElementById('sidebarPortfolios');
  const actionsEl = document.getElementById('sidebarPortfolioActions');
  if (!el) return;
  const portfolios = getSavedPortfolios();

  if (portfolios.length === 0) {
    el.innerHTML = '<div class="sidebar-empty">No saved portfolios</div>';
  } else {
    el.innerHTML = portfolios.map((p, i) => {
      const riskColor = getPortfolioRiskColor(p.holdings);
      return '<div class="sidebar-slot' + (i === _activePortfolioIdx ? ' active' : '') + '" id="sb-slot-' + i + '" onclick="loadPortfolio(' + i + ')" style="border-left:3px solid ' + riskColor + ';">' +
      '<span class="slot-name" id="sb-slot-name-' + i + '">' + escapeHTML(p.name) + '</span>' +
      '<span class="slot-count">' + p.holdings.length + '</span>' +
      '<div class="slot-actions">' +
      '<button class="slot-btn" onclick="event.stopPropagation();startRenameSlot(' + i + ',\'sb-\')" title="Rename">âœŽ</button>' +
      '<button class="slot-btn danger" onclick="event.stopPropagation();deletePortfolio(' + i + ')" title="Delete">&times;</button>' +
      '</div></div>';
    }).join('');
  }

  if (actionsEl) {
    let html = portfolios.length >= MAX_SLOTS ? '' : '<button class="sidebar-btn" onclick="savePortfolio()">ï¼‹ Save Current</button>';
    actionsEl.innerHTML = html;
  }
}

function renderSidebarSettings() {
  const el = document.getElementById('sidebarSettings');
  if (!el) return;
  const isDark = !document.body.classList.contains('light');
  el.innerHTML =
    '<div class="sidebar-settings-row">' +
      '<span class="sidebar-settings-label">' + (isDark ? 'ðŸŒ™' : 'â˜€ï¸') + ' Theme</span>' +
      '<div class="theme-toggle" onclick="toggleTheme();renderSidebarSettings();" style="position:static;transform:none;">' +
        '<span>' + (isDark ? 'DARK' : 'LIGHT') + '</span>' +
        '<div class="theme-toggle-track"><div class="theme-toggle-thumb"></div></div>' +
      '</div>' +
    '</div>' +
    '<div class="sidebar-settings-row">' +
      '<button class="sidebar-btn" onclick="restorePurchases()" style="width:100%;">ðŸ”„ Restore Purchases</button>' +
    '</div>';
}

function renderSidebarAccount() {
  const el = document.getElementById('sidebarAccount');
  if (!el) return;
  if (typeof currentUser !== 'undefined' && currentUser) {
    el.innerHTML =
      '<div class="sidebar-section-title">Account</div>' +
      '<button class="sidebar-account-btn sign-out" onclick="signOut();closeSidebar();">Sign Out</button>' +
      '<button class="sidebar-account-btn delete-account" onclick="deleteAccount()">Delete Account</button>';
  } else {
    el.innerHTML = '';
  }
}

async function savePortfolio() {
  if (holdings.length === 0) { showToast('Add holdings first!'); return; }
  if (typeof currentUser === 'undefined' || !currentUser) {
    showToast('Sign in to save portfolios');
    if (typeof showAuthModalOptimized === 'function') showAuthModalOptimized();
    return;
  }
  const portfolios = getSavedPortfolios();
  if (portfolios.length >= MAX_SLOTS) { showToast('Max ' + MAX_SLOTS + ' portfolios â€” delete one to save a new one.'); return; }
  const name = 'Portfolio ' + (portfolios.length + 1);
  portfolios.push({name, holdings: JSON.parse(JSON.stringify(holdings))});
  savePortfoliosLS(portfolios);
  _activePortfolioIdx = portfolios.length - 1;
  _activePortfolioSnapshot = JSON.stringify(holdings);
  renderSidebarPortfolios();
  showToast('âœ“ Portfolio saved!');
}

function loadPortfolio(idx) {
  const portfolios = getSavedPortfolios();
  if (!portfolios[idx]) return;
  holdings = JSON.parse(JSON.stringify(portfolios[idx].holdings));
  _activePortfolioIdx = idx;
  _activePortfolioSnapshot = JSON.stringify(holdings);
  // Auto-switch to chart view when loading a portfolio with 3+ holdings
  if (holdings.length >= 3) {
    _holdingsView = 'chart';
    document.querySelectorAll('.view-btn').forEach(b => {
      b.classList.toggle('active', b.dataset.view === 'chart');
    });
  }
  renderHoldings();
  if (_holdingsView === 'chart' && holdings.length >= 3) {
    fetchAndRenderSparklines();
  }
  closeSidebar();
  showToast('âœ“ Loaded: ' + escapeHTML(portfolios[idx].name));
}

function deletePortfolio(idx) {
  const portfolios = getSavedPortfolios();
  const name = portfolios[idx]?.name || 'this portfolio';
  if (!confirm('Delete "' + name + '"? This cannot be undone.')) return;
  const deleted = portfolios.splice(idx, 1)[0];
  savePortfoliosLS(portfolios);
  if (_activePortfolioIdx === idx) {
    _activePortfolioIdx = -1;
    _activePortfolioSnapshot = null;
    // Clear loaded holdings since active portfolio was deleted
    holdings.length = 0;
    renderHoldings();
    expandInputSections();
    if (typeof expandHoldingsPanel === 'function') expandHoldingsPanel();
  } else if (_activePortfolioIdx > idx) {
    _activePortfolioIdx--;
  }
  showToast('Portfolio deleted.');
}

function renamePortfolio(idx, newName) {
  const portfolios = getSavedPortfolios();
  if (!portfolios[idx]) return;
  portfolios[idx].name = newName || portfolios[idx].name;
  savePortfoliosLS(portfolios);
}

function startRenameSlot(i, prefix) {
  prefix = prefix || '';
  const nameEl = document.getElementById(prefix + 'slot-name-' + i);
  if (!nameEl) return;
  const current = nameEl.textContent;
  nameEl.outerHTML =
    '<input class="slot-name-input" id="' + prefix + 'slot-name-' + i + '" value="' + escapeHTML(current) + '" maxlength="24"' +
    ' onclick="event.stopPropagation()"' +
    ' onblur="finishRenameSlot(' + i + ', this.value, \'' + prefix + '\')"' +
    ' onkeydown="if(event.key===\'Enter\')this.blur();if(event.key===\'Escape\')this.blur();" />';
  const input = document.getElementById(prefix + 'slot-name-' + i);
  if (input) { input.focus(); input.select(); }
}

function finishRenameSlot(i, newName, prefix) {
  renamePortfolio(i, newName.trim() || ('Portfolio ' + (i + 1)));
  renderSidebarPortfolios();
}


function collapseInputSections() {
  const el = document.getElementById('inputSections');
  if (el) el.style.display = 'none';
}
function expandInputSections() {
  const el = document.getElementById('inputSections');
  if (el) el.style.display = '';
}

function loadExample(key) {
  const example = EXAMPLE_PORTFOLIOS[key];
  if (!example) return;
  holdings = example.map(e => { const info = STOCK_DB[e.ticker] || {name:e.ticker,sector:'Other',beta:1.0,cap:'unknown'}; return {ticker:e.ticker,pct:e.pct,...info}; });
  renderHoldings();
  collapseInputSections();
}

// â”€â”€ SHARE PORTFOLIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sharePortfolio() {
  if (holdings.length === 0) { showToast('Add holdings first!'); return; }
  const encoded = holdings.map(h => h.ticker + '-' + h.pct).join('_');
  const url = window.location.origin + window.location.pathname + '?p=' + encoded;
  const summary = holdings.slice().sort((a, b) => b.pct - a.pct).map(h => h.ticker + ' ' + h.pct + '%').join(', ');
  const text = 'My portfolio: ' + summary;

  if (navigator.share) {
    try {
      await navigator.share({ title: 'Portfolio Compass', text: text, url: url });
      return;
    } catch (e) {
      if (e.name === 'AbortError') return; // user cancelled
    }
  }
  // Clipboard fallback for desktop browsers
  try {
    await navigator.clipboard.writeText(url);
    showToast('Link copied to clipboard!');
  } catch (e) {
    prompt('Copy this link:', url);
  }
}

function showToast(msg) {
  const toast = document.getElementById('shareToast');
  if (!toast) return;
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2800);
}

// Load from URL on page load
(function loadFromURL() {
  const p = new URLSearchParams(window.location.search).get('p');
  if (!p) return;
  try {
    const parsed = p.split('_').map(s => { const [t,pct] = s.split('-'); return {ticker:(t||'').toUpperCase().replace(/[^A-Z0-9.]/g,''), pct:parseFloat(pct)}; }).filter(h=>h.ticker&&h.pct>0).slice(0, 50);
    if (!parsed.length) return;
    holdings = parsed.map(e => { const info = STOCK_DB[e.ticker]||{name:e.ticker,sector:'Other',beta:1.0,cap:'unknown'}; return {ticker:e.ticker,pct:e.pct,...info}; });
    renderHoldings();
    setTimeout(analyze, 400);
  } catch(e) {}
})();

// â”€â”€ EXPORT PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function exportPDF() {
  if (holdings.length === 0) { showToast('Add holdings first!'); return; }

  const profile = getPortfolioProfile();
  const {sectors} = profile;
  const riskNum = Math.round(profile.beta * 50 + (profile.concentration || 0) * 0.3);
  const riskLabel = riskNum >= 75 ? 'Aggressive' : riskNum >= 50 ? 'Moderate-High' : riskNum >= 30 ? 'Moderate' : 'Conservative';

  const hasShares = holdings.some(h => h.shares && h.shares > 0);
  const holdingRows = [...holdings]
    .sort((a, b) => b.pct - a.pct)
    .map(h => {
      const sharesCell = hasShares ? `<td style="text-align:right;color:#8a9ab8">${h.shares ? h.shares.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”'}</td>` : '';
      return `<tr><td style="font-weight:600;color:#00e5a0">${escapeHTML(h.ticker)}</td><td>${escapeHTML(h.name)}</td><td>${escapeHTML(h.sector)}</td>${sharesCell}<td style="text-align:right;font-weight:600">${h.pct}%</td></tr>`;
    })
    .join('');

  const sectorRows = Object.entries(sectors)
    .filter(([,v]) => v > 0)
    .sort((a,b) => b[1] - a[1])
    .map(([name, pct]) => `<tr><td>${escapeHTML(name)}</td><td style="text-align:right;font-weight:600">${pct}%</td><td><div style="background:#1e2430;border-radius:3px;height:8px;width:200px;display:inline-block"><div style="background:${SECTOR_COLORS[name]||'#64748b'};height:100%;border-radius:3px;width:${Math.min(100,pct*2.5)}%"></div></div></td></tr>`)
    .join('');

  const date = new Date().toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'});

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Portfolio Compass Report</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#0a0c10; color:#e8ecf0; font-family:'Inter',sans-serif; padding:40px; }
  .header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #1e2430; padding-bottom:20px; margin-bottom:30px; }
  .logo { display:flex; align-items:center; gap:10px; }
  .logo-text { font-family:'Space Mono',monospace; font-size:22px; font-weight:700; }
  .logo-text span { color:#00e5a0; }
  .compass-icon { width:28px; height:28px; border:1.5px solid #2a3140; border-radius:50%; position:relative; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
  .compass-icon::before { content:''; position:absolute; width:0; height:0; border-left:3px solid transparent; border-right:3px solid transparent; border-bottom:9px solid #00e5a0; top:2px; }
  .compass-icon::after { content:''; position:absolute; width:0; height:0; border-left:3px solid transparent; border-right:3px solid transparent; border-top:9px solid #ff8c42; bottom:2px; opacity:0.55; }
  .compass-dot { width:3px; height:3px; background:#e8ecf0; border-radius:50%; position:absolute; z-index:2; }
  .date { font-family:'Space Mono',monospace; font-size:11px; color:#8a9ab8; }
  h2 { font-family:'Space Mono',monospace; font-size:12px; letter-spacing:2px; text-transform:uppercase; color:#8a9ab8; margin:24px 0 12px; }
  table { width:100%; border-collapse:collapse; font-size:13px; }
  td, th { padding:8px 12px; border-bottom:1px solid #1e2430; text-align:left; }
  th { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:#8a9ab8; }
  .card { background:#111318; border:1px solid #1e2430; border-radius:12px; padding:20px; margin-bottom:16px; }
  .health-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:16px; }
  .health-stat { background:#111318; border:1px solid #1e2430; border-radius:10px; padding:16px; text-align:center; }
  .health-stat .value { font-family:'Space Mono',monospace; font-size:24px; font-weight:700; color:#00e5a0; }
  .health-stat .label { font-family:'Space Mono',monospace; font-size:9px; color:#8a9ab8; letter-spacing:1px; text-transform:uppercase; margin-top:4px; }
  .risk-bar { height:8px; background:#1e2430; border-radius:4px; margin:8px 0; }
  .risk-fill { height:100%; border-radius:4px; }
  .footer { text-align:center; font-family:'Space Mono',monospace; font-size:9px; color:#5a647880; margin-top:40px; padding-top:20px; border-top:1px solid #1e2430; }
  @media print { body { padding:20px; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; } }
</style></head><body>
<div class="header">
  <div class="logo"><div class="compass-icon"><div class="compass-dot"></div></div><div class="logo-text">Portfolio <span>Compass</span></div></div>
  <div class="date">${date}</div>
</div>

<div class="health-grid">
  <div class="health-stat">
    <div class="value">${holdings.length}</div>
    <div class="label">Holdings</div>
  </div>
  <div class="health-stat">
    <div class="value">${Object.keys(sectors).filter(s => sectors[s] > 0).length}</div>
    <div class="label">Sectors</div>
  </div>
  <div class="health-stat">
    <div class="value" style="color:${riskNum >= 65 ? '#ff8c42' : riskNum >= 40 ? '#ffd166' : '#06d6a0'}">${riskLabel}</div>
    <div class="label">Risk Level</div>
  </div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
    <span style="font-family:'Space Mono',monospace;font-size:10px;color:#8a9ab8;letter-spacing:1px;text-transform:uppercase;">Portfolio Risk</span>
    <span style="font-family:'Space Mono',monospace;font-size:14px;font-weight:700;color:${riskNum >= 65 ? '#ff8c42' : riskNum >= 40 ? '#ffd166' : '#06d6a0'}">${riskNum}/100</span>
  </div>
  <div class="risk-bar"><div class="risk-fill" style="width:${riskNum}%;background:linear-gradient(90deg,#06d6a0,#ffd166,#ff8c42)"></div></div>
</div>

<h2>Holdings</h2>
<div class="card">
  <table>
    <tr><th>Ticker</th><th>Name</th><th>Sector</th>${hasShares ? '<th style="text-align:right">Shares</th>' : ''}<th style="text-align:right">Weight</th></tr>
    ${holdingRows}
  </table>
</div>

<h2>Sector Exposure</h2>
<div class="card">
  <table>
    <tr><th>Sector</th><th style="text-align:right">Weight</th><th>Distribution</th></tr>
    ${sectorRows}
  </table>
</div>

<div class="footer">
  Generated by Portfolio Compass Â· pcompass.vercel.app Â· For informational purposes only â€” not financial advice.
</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  setTimeout(() => { win.print(); }, 500);
  showToast('ðŸ“„ PDF report opened!');
}

// â”€â”€ ONBOARDING INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initOnboarding() {
  const banner = document.getElementById('onboardingBanner');
  if (!banner) return;
  if (holdings.length > 0) banner.style.display = 'none';
})();

// Sidebar portfolios are rendered on-demand when sidebar opens

// â”€â”€ PANEL COLLAPSE/EXPAND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePanel(headerEl) {
  const body = headerEl.nextElementSibling;
  if (!body || !body.classList.contains('panel-body')) return;
  const chevron = headerEl.querySelector('.panel-chevron');
  const hint = headerEl.querySelector('.panel-expand-hint');
  body.classList.toggle('panel-body-collapsed');
  if (chevron) chevron.classList.toggle('panel-chevron-open');
  if (hint) hint.textContent = body.classList.contains('panel-body-collapsed') ? 'tap to expand' : 'tap to collapse';
}

// â”€â”€ STRATEGY CARD COLLAPSE/EXPAND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleStrategyCard(headerEl) {
  const list = headerEl.nextElementSibling;
  if (!list) return;
  const chevron = headerEl.querySelector('.strategy-chevron');
  const hint = headerEl.querySelector('.strategy-expand-hint');
  const isCollapsing = !list.classList.contains('strategy-collapsed');
  list.classList.toggle('strategy-collapsed');
  if (chevron) chevron.classList.toggle('strategy-chevron-open');
  if (hint) hint.textContent = isCollapsing ? 'tap to expand' : 'tap to collapse';
  // Reset show-more when collapsing so it reopens at original count
  if (isCollapsing) {
    list.querySelectorAll('.show-more-items').forEach(function(p) { p.classList.remove('open'); });
    list.querySelectorAll('.btn-show-more').forEach(function(b) { b.classList.remove('open'); b.innerHTML = 'âœ¦ See more stocks'; b.dataset.shown = '0'; });
    list.querySelectorAll('.etf-item.show-more-hidden').forEach(function(el) { el.classList.add('show-more-hidden'); });
  }
}

// â”€â”€ SHOW MORE TOGGLE (reveals 5 at a time) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function toggleShowMore(type) {
  const panel = document.getElementById('show-more-' + type);
  const btn   = document.getElementById('show-more-btn-' + type);
  if (!panel || !btn) return;

  // If panel is still empty, fetch extra picks and render them all as hidden
  if (panel.querySelectorAll(':scope > .etf-item').length === 0) {
    btn.innerHTML = '<span class="mini-spinner" style="display:inline-block;width:12px;height:12px;border:2px solid var(--muted);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:6px;vertical-align:middle;"></span> Loading...';
    const proData = await fetchProPicks();
    if (!proData) {
      btn.innerHTML = 'âœ¦ See more stocks';
      showToast('Failed to load extra picks. Try again.');
      return;
    }
    const extraHTML = _renderProPicksForStrategy(type, proData);
    if (extraHTML) {
      panel.insertAdjacentHTML('afterbegin', extraHTML);
      // Hide all initially
      panel.querySelectorAll('.etf-item').forEach(function(el) { el.classList.add('show-more-hidden'); });
    }
    btn.dataset.shown = '0';
  }

  panel.classList.add('open');
  const allItems = panel.querySelectorAll('.etf-item');
  const shown = parseInt(btn.dataset.shown || '0');
  const nextShown = Math.min(shown + 5, allItems.length);

  // Reveal next batch of 5
  for (let i = shown; i < nextShown; i++) {
    allItems[i].classList.remove('show-more-hidden');
  }
  btn.dataset.shown = String(nextShown);

  const remaining = allItems.length - nextShown;
  if (remaining > 0) {
    btn.innerHTML = 'âœ¦ See more stocks (' + remaining + ' more)';
  } else {
    btn.style.display = 'none';
  }
}

// â”€â”€ RENDER PRO PICKS INTO SHOW-MORE CONTAINER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Called after fetching /api/pro-picks to dynamically render extra items
// Reuses the buildItemHTML function from the analyze() closure via a global reference
let _lastBuildItemHTML = null;
let _lastMarketData = null;

function _renderProPicksForStrategy(type, proData) {
  if (!proData || !_lastBuildItemHTML) return '';
  const ownedTickers = holdings.map(h => h.ticker);
  const profile = getPortfolioProfile();
  const ownedSectors = Object.keys(profile.sectors).filter(s => (profile.sectors[s]||0) > 5);

  const riskAllowed = {
    aggressive:['High','Very High','Medium'],
    moderate:['Medium','Low','High'],
    conservative:['Low','Medium'],
  }[type] || ['Medium'];

  // Score and filter pro stock picks
  const picks = (proData.stocks || [])
    .filter(p => !ownedTickers.includes(p.ticker) && !p.avoidIfHeld.some(t => ownedTickers.includes(t)) && riskAllowed.includes(p.risk))
    .map(p => {
      let score = 50;
      if (!ownedSectors.includes(p.sector)) score += 28;
      else if ((profile.sectors[p.sector]||0) < 10) score += 14;
      if (p.risk === 'Low') score += 6;
      if (p.risk === 'Very High') score -= 8;
      const md = _lastMarketData && _lastMarketData[p.ticker];
      if (md) score += Math.round((md.momentum - 50) * 0.3);
      return {...p, score, isStock:true};
    })
    .sort((a,b) => b.score - a.score)
    .slice(0,20);

  // Score and filter pro ETFs for this strategy
  const proEtfs = (proData.etfs && proData.etfs[type]) || [];
  const etfs = proEtfs
    .filter(e => !ownedTickers.includes(e.ticker))
    .map(e => ({...e, score:70, isStock:false}));

  const allExtraRaw = [...etfs, ...picks].slice(0, 20);
  // Round down to multiple of 5 for clean "see more" batches
  const allExtra = allExtraRaw.slice(0, Math.floor(allExtraRaw.length / 5) * 5);
  if (allExtra.length === 0) return '';

  return allExtra.map(item => _lastBuildItemHTML(item, type, _lastMarketData)).join('');
}

// â”€â”€ UPGRADE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showPaywall(trigger) {
  const msgs = {
    ai:        'You\'ve used your 3 free AI explanations.',
    pdf:       'PDF export is a Pro feature.',
    sync:      'Cloud sync is a Pro feature.',
    showmore:  'Expanded picks are a Pro feature.',
    header:    'Upgrade to unlock all Pro features.',
    screenshot:'Screenshot import is a Pro feature.',
  };
  const msgEl = document.getElementById('paywallMsg');
  if (msgEl) msgEl.textContent = msgs[trigger] || 'Upgrade to unlock all Pro features.';
  const modal = document.getElementById('paywallModal');

  // Reset all elements to default (in case iOS mode was set on a previous open)
  modal.querySelectorAll('[id^="tier-"]').forEach(function(el) { el.style.display = ''; });
  modal.querySelectorAll('.pw-features').forEach(function(el) { el.style.display = ''; });
  modal.querySelectorAll('.pw-restore').forEach(function(el) { el.style.display = ''; });
  const confirmBtn = document.getElementById('paywallConfirmBtn');
  if (confirmBtn) {
    confirmBtn.style.background = '';
    confirmBtn.style.color = '';
    confirmBtn.style.cursor = '';
  }

  // Inside iOS app: hide purchase tiers & web payment links (Apple Guideline 3.1.1)
  // But keep Restore Purchases visible (Apple requires it)
  if (typeof _isIOSApp !== 'undefined' && _isIOSApp) {
    modal.querySelectorAll('[id^="tier-"]').forEach(function(el) { el.style.display = 'none'; });
    modal.querySelectorAll('.pw-features').forEach(function(el) { el.style.display = 'none'; });
    if (confirmBtn) {
      confirmBtn.textContent = 'OK';
      confirmBtn.onclick = function() { closePaywall(); };
      confirmBtn.style.background = '#1e2430';
      confirmBtn.style.color = '#8a9ab8';
      confirmBtn.style.cursor = 'default';
    }
    if (msgEl) msgEl.textContent = 'This feature requires a Pro subscription.\nManage subscriptions in Settings \u203a Apple ID \u203a Subscriptions.';
    // Make Restore Purchases more prominent on iOS
    modal.querySelectorAll('.pw-restore').forEach(function(el) { el.classList.add('pw-restore-ios'); });
  }

  modal.style.display = 'flex';
  modal.classList.add('open');
}
function closePaywall() {
  const pm2=document.getElementById('paywallModal');pm2.style.display='none';pm2.classList.remove('open');
}

// â”€â”€ ENTER KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('tickerInput').addEventListener('keydown', e => {
  const dd = document.getElementById('autocompleteDropdown');
  const items = dd.querySelectorAll('.autocomplete-item');
  const selIdx = [...items].findIndex(i => i.classList.contains('selected'));

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    items.forEach(i => i.classList.remove('selected'));
    const next = Math.min(selIdx + 1, items.length - 1);
    if (items[next]) { items[next].classList.add('selected'); items[next].scrollIntoView({block:'nearest'}); }
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    items.forEach(i => i.classList.remove('selected'));
    const prev = Math.max(selIdx - 1, 0);
    if (items[prev]) { items[prev].classList.add('selected'); items[prev].scrollIntoView({block:'nearest'}); }
  } else if (e.key === 'Enter') {
    const sel = dd.querySelector('.autocomplete-item.selected');
    if (sel && dd.classList.contains('open')) {
      e.preventDefault();
      selectAutocomplete(sel.dataset.ticker);
    } else {
      document.getElementById('pctInput').focus();
    }
  } else if (e.key === 'Escape') {
    dd.classList.remove('open');
  }
});
document.getElementById('pctInput').addEventListener('keydown', e => { if (e.key==='Enter') addStock(); });

// â”€â”€ TICKER AUTOCOMPLETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initAutocomplete() {
  const input = document.getElementById('tickerInput');
  const dd = document.getElementById('autocompleteDropdown');
  const dbEntries = Object.entries(STOCK_DB);

  input.addEventListener('input', function() {
    const q = this.value.trim().toUpperCase();
    if (q.length === 0) { dd.classList.remove('open'); return; }

    const matches = dbEntries
      .filter(([ticker, info]) => 
        ticker.startsWith(q) || info.name.toUpperCase().includes(q)
      )
      .slice(0, 8);

    if (matches.length === 0) { dd.classList.remove('open'); return; }

    dd.innerHTML = matches.map(([ticker, info]) =>
      '<div class="autocomplete-item" data-ticker="' + escapeHTML(ticker) + '" onclick="selectAutocomplete(\'' + escapeHTML(ticker) + '\')">' +
      '<span class="autocomplete-item-ticker">' + escapeHTML(ticker) + '</span>' +
      '<span class="autocomplete-item-name">' + escapeHTML(info.name) + '</span>' +
      '</div>'
    ).join('');
    dd.classList.add('open');
  });

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.autocomplete-wrapper')) dd.classList.remove('open');
  });
})();

function selectAutocomplete(ticker) {
  document.getElementById('tickerInput').value = ticker;
  document.getElementById('autocompleteDropdown').classList.remove('open');
  document.getElementById('pctInput').focus();
}

// â”€â”€ SPARKLINE CHART VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function fetchSparklineData(tickers, range) {
  range = range || '1mo';
  var CACHE_KEY = 'pc_sparkline_' + range + '_' + tickers.slice().sort().join(',');
  var CACHE_TTL = 4 * 60 * 60 * 1000; // 4 hours
  try {
    var cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      var parsed = JSON.parse(cached);
      if (Date.now() - parsed.ts < CACHE_TTL) {
        return Promise.resolve(parsed.data);
      }
    }
  } catch(e) { /* ignore */ }
  return fetch('/api/sparkline?tickers=' + tickers.join(',') + '&range=' + range)
    .then(function(res) {
      if (!res.ok) return null;
      return res.json();
    })
    .then(function(data) {
      if (!data || data.error) return null;
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({ data: data, ts: Date.now() }));
      } catch(e) { /* quota exceeded */ }
      return data;
    })
    .catch(function() { return null; });
}

function renderSparklineSVG(closes, width, height, positive) {
  if (!closes || closes.length < 2) return '';
  var min = Infinity, max = -Infinity;
  for (var i = 0; i < closes.length; i++) {
    if (closes[i] < min) min = closes[i];
    if (closes[i] > max) max = closes[i];
  }
  var range = max - min || 1;
  var padY = height * 0.08;
  var usableH = height - padY * 2;
  var stepX = width / (closes.length - 1);

  var points = [];
  for (var i = 0; i < closes.length; i++) {
    var x = Math.round(i * stepX * 100) / 100;
    var y = Math.round((padY + usableH - ((closes[i] - min) / range) * usableH) * 100) / 100;
    points.push(x + ',' + y);
  }
  var polyPoints = points.join(' ');

  var color = positive ? '#22c55e' : '#ef4444';
  var gradId = 'sg' + Math.random().toString(36).substr(2, 6);

  // Build fill polygon (close the path at bottom)
  var fillPoints = polyPoints + ' ' + width + ',' + height + ' 0,' + height;

  var svg = '<svg viewBox="0 0 ' + width + ' ' + height + '" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">' +
    '<defs><linearGradient id="' + gradId + '" x1="0" y1="0" x2="0" y2="1">' +
    '<stop offset="0%" stop-color="' + color + '" stop-opacity="0.2"/>' +
    '<stop offset="100%" stop-color="' + color + '" stop-opacity="0"/>' +
    '</linearGradient></defs>' +
    '<polygon points="' + fillPoints + '" fill="url(#' + gradId + ')"/>' +
    '<polyline points="' + polyPoints + '" fill="none" stroke="' + color + '" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>' +
    '</svg>';

  // Use <img> with data URI for universal iOS/Safari compatibility
  // (raw SVG innerHTML doesn't reliably render on WebKit)
  return '<img src="data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg) + '" style="width:100%;height:100%;display:block;" alt="chart"/>';
}

function fetchAndRenderSparklines() {
  var tickers = holdings.map(function(h) { return h.ticker; });
  if (tickers.length === 0) return;

  // Phase 1: Load market data first (fast â€” usually cached in localStorage)
  // This fills in prices + daily change immediately
  if (typeof fetchMarketDataCached === 'function') {
    fetchMarketDataCached(tickers).then(function(marketData) {
      if (!marketData) return;
      holdings.forEach(function(h) {
        if (!marketData[h.ticker]) return;
        var md = marketData[h.ticker];
        var priceEl = document.getElementById('spark-price-' + h.ticker);
        var changeEl = document.getElementById('spark-change-' + h.ticker);
        if (priceEl) priceEl.textContent = '$' + md.price.toFixed(2);
        if (changeEl) {
          var pct = md.changePct;
          var isUp = pct >= 0;
          changeEl.textContent = (isUp ? '+' : '') + pct.toFixed(1) + '% 1D';
          changeEl.className = 'spark-change ' + (isUp ? 'up' : 'down');
        }
      });
    });
  }

  // Phase 2: Load sparkline chart SVGs async (slower â€” Yahoo Finance API)
  fetchSparklineData(tickers, '1d').then(function(sparkData) {
    if (!sparkData) return;
    holdings.forEach(function(h) {
      if (!sparkData[h.ticker]) return;
      var sd = sparkData[h.ticker];
      var svgEl = document.getElementById('spark-svg-' + h.ticker);
      if (svgEl && sd.closes && sd.closes.length >= 2) {
        var first = sd.closes[0];
        var last = sd.closes[sd.closes.length - 1];
        var positive = last >= first;
        svgEl.innerHTML = renderSparklineSVG(sd.closes, 200, 50, positive);
      }
    });
  });
}

// â”€â”€ EXPANDED CHART MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var _chartModalEl = null;

function _ensureChartModal() {
  if (_chartModalEl) return _chartModalEl;
  var overlay = document.createElement('div');
  overlay.className = 'chart-modal-overlay';
  overlay.id = 'chartModalOverlay';
  overlay.onclick = function(e) {
    if (e.target === overlay) closeExpandedChart();
  };
  overlay.innerHTML =
    '<div class="chart-modal-card">' +
      '<div class="chart-modal-header">' +
        '<div>' +
          '<div class="chart-modal-ticker" id="chartModalTicker"></div>' +
          '<div class="chart-modal-name" id="chartModalName"></div>' +
          '<div class="chart-modal-sector" id="chartModalSector"></div>' +
          '<div class="chart-modal-price-row">' +
            '<span class="chart-modal-price" id="chartModalPrice">--</span>' +
            '<span class="chart-modal-change" id="chartModalChange"></span>' +
          '</div>' +
          '<div class="chart-modal-alloc" id="chartModalAlloc"></div>' +
        '</div>' +
        '<button class="chart-modal-close" onclick="closeExpandedChart()">Ã—</button>' +
      '</div>' +
      '<div class="chart-modal-ranges" id="chartModalRanges">' +
        '<button class="chart-range-btn active" data-range="1d" onclick="loadChartRange(this.parentElement.dataset.ticker,\'1d\')">1D</button>' +
        '<button class="chart-range-btn" data-range="5d" onclick="loadChartRange(this.parentElement.dataset.ticker,\'5d\')">1W</button>' +
        '<button class="chart-range-btn" data-range="1mo" onclick="loadChartRange(this.parentElement.dataset.ticker,\'1mo\')">1M</button>' +
        '<button class="chart-range-btn" data-range="3mo" onclick="loadChartRange(this.parentElement.dataset.ticker,\'3mo\')">3M</button>' +
      '</div>' +
      '<div class="chart-modal-chart" id="chartModalChart">' +
        '<div class="spark-shimmer" style="height:200px"></div>' +
      '</div>' +
      '<div class="chart-modal-stats" id="chartModalStats"></div>' +
    '</div>';
  document.body.appendChild(overlay);
  _chartModalEl = overlay;
  return overlay;
}

function showExpandedChart(ticker) {
  var overlay = _ensureChartModal();
  var holding = holdings.find(function(h) { return h.ticker === ticker; });
  if (!holding) return;
  var dbEntry = STOCK_DB[ticker] || {};
  var sectorColor = SECTOR_COLORS[holding.sector] || SECTOR_COLORS['Other'] || '#475569';

  document.getElementById('chartModalTicker').textContent = ticker;
  document.getElementById('chartModalName').textContent = dbEntry.name || ticker;
  document.getElementById('chartModalSector').textContent = holding.sector;
  document.getElementById('chartModalSector').style.color = sectorColor;
  document.getElementById('chartModalAlloc').textContent = holding.pct + '% of portfolio';
  document.getElementById('chartModalRanges').dataset.ticker = ticker;
  document.getElementById('chartModalChart').innerHTML = '<div class="spark-shimmer" style="height:200px"></div>';
  document.getElementById('chartModalStats').innerHTML = '';

  // Reset range buttons â€” 1M active by default
  document.querySelectorAll('.chart-range-btn').forEach(function(b) {
    b.classList.toggle('active', b.dataset.range === '1d');
  });

  // Set price from market data if available (from sparkline cards)
  var priceEl = document.getElementById('spark-price-' + ticker);
  if (priceEl && priceEl.textContent !== '--') {
    document.getElementById('chartModalPrice').textContent = priceEl.textContent;
  } else {
    document.getElementById('chartModalPrice').textContent = '--';
  }
  var changeEl = document.getElementById('spark-change-' + ticker);
  if (changeEl && changeEl.textContent) {
    var mc = document.getElementById('chartModalChange');
    mc.textContent = changeEl.textContent;
    mc.className = 'chart-modal-change ' + (changeEl.classList.contains('up') ? 'up' : 'down');
  } else {
    document.getElementById('chartModalChange').textContent = '';
    document.getElementById('chartModalChange').className = 'chart-modal-change';
  }

  // Show the modal
  requestAnimationFrame(function() {
    overlay.classList.add('open');
  });

  // Load chart data
  loadChartRange(ticker, '1d');
}

function loadChartRange(ticker, range) {
  var chartEl = document.getElementById('chartModalChart');
  var statsEl = document.getElementById('chartModalStats');
  chartEl.innerHTML = '<div class="spark-shimmer" style="height:200px"></div>';
  statsEl.innerHTML = '';

  // Update active range button
  document.querySelectorAll('.chart-range-btn').forEach(function(b) {
    b.classList.toggle('active', b.dataset.range === range);
  });

  fetchSparklineData([ticker], range).then(function(data) {
    if (!data || !data[ticker] || !data[ticker].closes || data[ticker].closes.length < 2) {
      chartEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:200px;color:var(--muted);font-size:12px;">No data available</div>';
      return;
    }
    var sd = data[ticker];
    var closes = sd.closes;
    var first = closes[0];
    var last = closes[closes.length - 1];
    var positive = last >= first;
    chartEl.innerHTML = renderSparklineSVG(closes, 500, 200, positive);

    // Compute stats
    var high = -Infinity, low = Infinity;
    for (var i = 0; i < closes.length; i++) {
      if (closes[i] > high) high = closes[i];
      if (closes[i] < low) low = closes[i];
    }
    var rangeChange = ((last - first) / first * 100);

    statsEl.innerHTML =
      '<div class="chart-stat"><span class="chart-stat-label">High</span><span class="chart-stat-value">$' + high.toFixed(2) + '</span></div>' +
      '<div class="chart-stat"><span class="chart-stat-label">Low</span><span class="chart-stat-value">$' + low.toFixed(2) + '</span></div>' +
      '<div class="chart-stat"><span class="chart-stat-label">Open</span><span class="chart-stat-value">$' + first.toFixed(2) + '</span></div>' +
      '<div class="chart-stat"><span class="chart-stat-label">Change</span><span class="chart-stat-value" style="color:' + (rangeChange >= 0 ? '#22c55e' : '#ef4444') + '">' + (rangeChange >= 0 ? '+' : '') + rangeChange.toFixed(2) + '%</span></div>';

    // Also update the modal price to last close if market data wasn't available
    var modalPrice = document.getElementById('chartModalPrice');
    if (modalPrice && modalPrice.textContent === '--') {
      modalPrice.textContent = '$' + last.toFixed(2);
    }
  });
}

function closeExpandedChart() {
  var overlay = document.getElementById('chartModalOverlay');
  if (overlay) overlay.classList.remove('open');
}

========== FILE: public/patches.js ==========
document.getElementById('paywallModal').style.display='flex';
document.getElementById('paywallModal').style.display='none';
// re-close on load

// â”€â”€ GOOGLE AUTH REDIRECT HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Handles the return from Google OAuth (code flow for iOS, GIS for web).
(function() {
  // Authorization code flow (iOS native via ASWebAuthenticationSession)
  var sp = new URLSearchParams(window.location.search);
  var code = sp.get('code');
  var state = sp.get('state');
  if (code && state === 'ios_native') {
    history.replaceState(null, '', window.location.pathname);
    fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ code: code }),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.idToken) {
        window.location.href = 'pcompass://auth?id_token=' + encodeURIComponent(data.idToken);
      }
    })
    .catch(function() {});
    return;
  }

  // Legacy hash-based id_token flow (fallback)
  var h = window.location.hash;
  if (!h || !h.includes('id_token')) return;
  var params = new URLSearchParams(h.substring(1));
  var idToken = params.get('id_token');
  if (!idToken || !/^[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+$/.test(idToken)) return;

  if (h.indexOf('state=ios_native') !== -1) {
    history.replaceState(null, '', window.location.pathname + window.location.search);
    window.location.href = 'pcompass://auth?id_token=' + encodeURIComponent(idToken);
    return;
  }

  history.replaceState(null, '', window.location.pathname + window.location.search);
  window.addEventListener('DOMContentLoaded', function() {
    if (typeof handleGoogleResponse === 'function') {
      handleGoogleResponse({ credential: idToken });
    }
  });
})();

// â”€â”€ iOS APP DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Detects if running inside a native iOS WebView (PWABuilder wrapper)
// Used to hide Stripe payment links (Apple Guideline 3.1.1)
function isIOSApp() {
  const ua = navigator.userAgent || '';
  const isIOS = /iPhone|iPad|iPod/.test(ua);
  const isStandalone = window.navigator.standalone === true ||
    window.matchMedia('(display-mode: standalone)').matches;
  // WKWebView doesn't have Safari in the UA string
  const isWebView = isIOS && !(/Safari/.test(ua));
  return isIOS && (isStandalone || isWebView);
}

const _isIOSApp = isIOSApp();

// Hide Stripe purchase buttons and payment references inside iOS app (Apple Guideline 3.1.1)
if (_isIOSApp) {
  document.addEventListener('DOMContentLoaded', function() {
    // Hide upgrade modal pricing tiers and Stripe buttons entirely
    var tiers = document.querySelector('.upgrade-tiers');
    if (tiers) tiers.style.display = 'none';
    var actions = document.querySelector('.upgrade-actions');
    if (actions) {
      actions.innerHTML =
        '<div style="text-align:center;padding:12px 0;">' +
          '<p style="color:#8a9ab8;font-size:12px;margin:0;">This feature requires a Pro subscription.</p>' +
        '</div>';
    }
    // Hide all "Restore Purchases" buttons (upgrade modal + paywall modal + user menu)
    document.querySelectorAll('[onclick*="restorePurchases"]').forEach(function(btn) {
      btn.style.display = 'none';
    });
    // Hide the Pro upgrade button in header entirely
    var btnPro = document.getElementById('btnPro');
    if (btnPro) btnPro.style.display = 'none';
  });
}

let currentUser = null;

// â”€â”€ AUTH GUARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function requireAuth() {
  if (currentUser) return true;
  showAuthModalOptimized();
  return false;
}

// â”€â”€ BOTTOM NAV BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _setActiveTab(tabId) {
  document.querySelectorAll('.bottom-bar-tab').forEach(function(b) {
    b.classList.toggle('active', b.id === tabId);
  });
}

function _closeAllPanels() {
  closePortfolioDrawer();
  _closeNavPanel('marketPanel');
  _closeNavPanel('explorePanel');
  _closeNavPanel('chartsPanel');
}

window.navTo = function(tab) {
  if (tab === 'portfolios') {
    _closeNavPanel('marketPanel');
    _closeNavPanel('explorePanel');
    togglePortfolioDrawer();
  } else if (tab === 'market') {
    _closeAllPanels();
    _setActiveTab('navMarket');
    openMarketPanel();
  } else if (tab === 'charts') {
    _closeAllPanels();
    _setActiveTab('navCharts');
    navToCharts();
  } else if (tab === 'explore') {
    _closeAllPanels();
    _setActiveTab('navExplore');
    openExplorePanel();
  } else if (tab === 'analysis') {
    _closeAllPanels();
    _setActiveTab('navAnalysis');
    navToAnalysis();
  } else if (tab === 'user') {
    _closeAllPanels();
    if (typeof toggleSidebar === 'function') toggleSidebar();
  }
};

// â”€â”€ SHARED NAV PANEL HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _getOrCreatePanel(id) {
  var el = document.getElementById(id);
  if (el) return el;
  el = document.createElement('div');
  el.id = id;
  el.className = 'nav-panel-overlay';
  el.addEventListener('click', function(e) {
    if (e.target === el) _closeNavPanel(id);
  });
  document.body.appendChild(el);
  return el;
}

function _closeNavPanel(id) {
  var el = document.getElementById(id);
  if (el) el.classList.remove('open');
  _setActiveTab('navPortfolios');
}

// â”€â”€ MARKET PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openMarketPanel() {
  var overlay = _getOrCreatePanel('marketPanel');
  var mkt = typeof getMarketStatus === 'function' ? getMarketStatus() : {};
  var mktLabel = mkt.isOpen ? 'Market Open' : mkt.isPrePost ? 'Pre/Post Market' : 'Market Closed';
  var dotCls = mkt.isOpen ? 'live' : '';

  var html = '<div class="nav-panel">'
    + '<div class="nav-panel-header">'
    + '<span class="nav-panel-title">Market Overview</span>'
    + '<button class="nav-panel-close" onclick="_closeNavPanel(\'marketPanel\')">\u2715</button>'
    + '</div>'
    + '<div class="nav-panel-body">'
    + '<div class="market-status-card">'
    + '<div class="market-status-dot ' + dotCls + '"></div>'
    + '<div><div class="market-status-label">' + mktLabel + '</div>'
    + '<div class="market-status-sub">' + new Date().toLocaleDateString([], {weekday:'long', month:'short', day:'numeric'}) + '</div></div>'
    + '</div>'
    + '<div class="market-section-label">' + (mkt.isOpen ? 'Today\'s Movers' : 'Daily Movers (Last Session)') + '</div>'
    + '<div id="marketPanelMovers"><div class="spark-shimmer" style="height:40px;border-radius:8px;margin-bottom:8px;"></div><div class="spark-shimmer" style="height:40px;border-radius:8px;"></div></div>'
    + '</div></div>';

  overlay.innerHTML = html;
  overlay.classList.add('open');

  // Load movers
  fetchTopMovers().then(function(movers) {
    var el = document.getElementById('marketPanelMovers');
    if (!el || !movers) {
      if (el) el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px 0;">No data available</div>';
      return;
    }
    var gainers = movers.gainers || [];
    var losers = movers.losers || [];
    if (gainers.length === 0 && losers.length === 0) {
      el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px 0;">No data available</div>';
      return;
    }
    function moverRow(m) {
      var cls = m.changePct > 0.05 ? 'up' : m.changePct < -0.05 ? 'down' : 'flat';
      var sign = m.changePct > 0 ? '+' : '';
      return '<div class="market-mover-row">'
        + '<span class="market-mover-ticker">' + escapeHTML(m.ticker) + '</span>'
        + '<span class="market-mover-name">' + escapeHTML(m.name || '') + '</span>'
        + (m.price ? '<span class="market-mover-price">$' + m.price.toFixed(2) + '</span>' : '')
        + '<span class="market-mover-change ' + cls + '">' + sign + m.changePct.toFixed(2) + '%</span>'
        + '</div>';
    }
    var rows = '';
    if (gainers.length > 0) {
      rows += '<div class="market-section-label" style="margin-top:0;">Top Gainers</div>';
      for (var i = 0; i < gainers.length; i++) rows += moverRow(gainers[i]);
    }
    if (losers.length > 0) {
      rows += '<div class="market-section-label" style="margin-top:12px;">Top Losers</div>';
      for (var j = 0; j < losers.length; j++) rows += moverRow(losers[j]);
    }
    el.innerHTML = rows;
  });
}

// â”€â”€ CHARTS NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navToCharts() {
  _closeAllPanels();
  _setActiveTab('navCharts');
  // Open a panel with daily movers + portfolio charts
  var overlay = _getOrCreatePanel('chartsPanel');
  var html = '<div class="nav-panel">'
    + '<div class="nav-panel-header">'
    + '<span class="nav-panel-title">Charts</span>'
    + '<button class="nav-panel-refresh" id="chartsPanelRefresh" onclick="refreshPortfolioStrip()" title="Refresh prices">\u21bb</button>'
    + '<button class="nav-panel-close" onclick="_closeNavPanel(\'chartsPanel\')">\u2715</button>'
    + '</div>'
    + '<div class="nav-panel-body">';

  // Portfolio charts shortcut
  if (typeof holdings !== 'undefined' && holdings.length >= 3) {
    html += '<button class="explore-sector-card" style="width:100%;margin-bottom:14px;justify-content:center;" onclick="_closeNavPanel(\'chartsPanel\');if(typeof setHoldingsView===\'function\')setHoldingsView(\'chart\');window.scrollTo({top:0,behavior:\'smooth\'});">'
      + '<span class="explore-sector-name">View My Portfolio Charts</span>'
      + '</button>';
  }

  // Daily movers section
  html += '<div class="market-section-label">Daily Movers</div>'
    + '<div id="chartsPanelMovers"><div class="spark-shimmer" style="height:40px;border-radius:8px;margin-bottom:8px;"></div><div class="spark-shimmer" style="height:40px;border-radius:8px;"></div></div>'
    + '</div></div>';

  overlay.innerHTML = html;
  overlay.classList.add('open');

  // Load movers
  fetchTopMovers().then(function(movers) {
    var el = document.getElementById('chartsPanelMovers');
    if (!el) return;
    if (!movers) {
      el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px 0;">No data available</div>';
      return;
    }
    var gainers = movers.gainers || [];
    var losers = movers.losers || [];
    if (gainers.length === 0 && losers.length === 0) {
      el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px 0;">No data available</div>';
      return;
    }
    function moverRow(m) {
      var cls = m.changePct > 0.05 ? 'up' : m.changePct < -0.05 ? 'down' : 'flat';
      var sign = m.changePct > 0 ? '+' : '';
      return '<div class="market-mover-row">'
        + '<span class="market-mover-ticker">' + escapeHTML(m.ticker) + '</span>'
        + '<span class="market-mover-name">' + escapeHTML(m.name || '') + '</span>'
        + (m.price ? '<span class="market-mover-price">$' + m.price.toFixed(2) + '</span>' : '')
        + '<span class="market-mover-change ' + cls + '">' + sign + m.changePct.toFixed(2) + '%</span>'
        + '</div>';
    }
    var rows = '';
    if (gainers.length > 0) {
      rows += '<div class="market-section-label" style="margin-top:0;">Top Gainers</div>';
      for (var i = 0; i < gainers.length; i++) rows += moverRow(gainers[i]);
    }
    if (losers.length > 0) {
      rows += '<div class="market-section-label" style="margin-top:12px;">Top Losers</div>';
      for (var j = 0; j < losers.length; j++) rows += moverRow(losers[j]);
    }
    el.innerHTML = rows;
  });
}

// â”€â”€ ANALYSIS NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navToAnalysis() {
  var results = document.getElementById('resultsPanel');
  if (results && results.querySelector('.health-panel')) {
    results.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else if (typeof holdings !== 'undefined' && holdings.length > 0) {
    // Trigger analysis if holdings exist but haven't been analyzed
    if (typeof analyze === 'function') analyze();
  } else {
    showToast('Add holdings first, then analyze');
  }
  setTimeout(function() { _setActiveTab('navPortfolios'); }, 300);
}

// â”€â”€ EXPLORE PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _exploreSectorView = null; // which sector is drilled into

function openExplorePanel() {
  _exploreSectorView = null;
  var overlay = _getOrCreatePanel('explorePanel');
  _renderExploreContent(overlay);
  overlay.classList.add('open');
}

function _renderExploreContent(overlay) {
  if (!overlay) overlay = document.getElementById('explorePanel');
  if (!overlay) return;

  var html = '<div class="nav-panel">'
    + '<div class="nav-panel-header">'
    + '<span class="nav-panel-title">Explore Stocks</span>'
    + '<button class="nav-panel-close" onclick="_closeNavPanel(\'explorePanel\')">\u2715</button>'
    + '</div>'
    + '<div class="nav-panel-body">';

  if (_exploreSectorView) {
    // Drill-down: show stocks in this sector
    html += _renderExploreSectorDrill(_exploreSectorView);
  } else {
    // Search bar
    html += '<input class="explore-search-input" id="exploreSearchInput" type="text" placeholder="Search ticker or company..." oninput="_onExploreSearch(this.value)"/>';
    html += '<div id="exploreSearchResults"></div>';
    // Sector grid
    html += '<div class="market-section-label">Browse by Sector</div>';
    html += _renderExploreSectors();
  }

  html += '</div></div>';
  overlay.innerHTML = html;

  // Focus search if visible
  var inp = document.getElementById('exploreSearchInput');
  if (inp) setTimeout(function() { inp.focus(); }, 100);
}

function _renderExploreSectors() {
  if (typeof STOCK_DB === 'undefined' || typeof SECTOR_COLORS === 'undefined') return '';
  // Count stocks per sector
  var counts = {};
  for (var t in STOCK_DB) {
    var s = STOCK_DB[t].sector || 'Other';
    counts[s] = (counts[s] || 0) + 1;
  }
  var sectors = Object.entries(counts).sort(function(a,b) { return b[1] - a[1]; });
  var html = '<div class="explore-sector-grid">';
  for (var i = 0; i < sectors.length; i++) {
    var name = sectors[i][0];
    var count = sectors[i][1];
    var color = (typeof SECTOR_COLORS !== 'undefined' && SECTOR_COLORS[name]) || '#475569';
    html += '<div class="explore-sector-card" onclick="_exploreDrillSector(\'' + escapeHTML(name).replace(/'/g, "\\'") + '\')">'
      + '<div class="explore-sector-dot" style="background:' + color + '"></div>'
      + '<span class="explore-sector-name">' + escapeHTML(name) + '</span>'
      + '<span class="explore-sector-count">' + count + '</span>'
      + '</div>';
  }
  html += '</div>';
  return html;
}

function _exploreDrillSector(sector) {
  _exploreSectorView = sector;
  _renderExploreContent();
}

function _exploreBackToSectors() {
  _exploreSectorView = null;
  _renderExploreContent();
}

function _renderExploreSectorDrill(sector) {
  if (typeof STOCK_DB === 'undefined') return '';
  var color = (typeof SECTOR_COLORS !== 'undefined' && SECTOR_COLORS[sector]) || '#475569';
  var html = '<button class="explore-back-btn" onclick="_exploreBackToSectors()">\u2190 All Sectors</button>';
  html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">'
    + '<div class="explore-sector-dot" style="background:' + color + ';width:10px;height:10px;"></div>'
    + '<span style="font-family:\'DM Sans\',sans-serif;font-size:15px;font-weight:700;color:var(--text);">' + escapeHTML(sector) + '</span>'
    + '</div>';
  // List stocks in this sector
  var stocks = [];
  for (var t in STOCK_DB) {
    if (STOCK_DB[t].sector === sector) {
      stocks.push({ ticker: t, name: STOCK_DB[t].name || t, cap: STOCK_DB[t].cap || '' });
    }
  }
  // Sort: mega > large > mid > small, then alphabetical
  var capOrder = { mega: 0, large: 1, mid: 2, small: 3, unknown: 4 };
  stocks.sort(function(a,b) {
    var ca = capOrder[a.cap] !== undefined ? capOrder[a.cap] : 4;
    var cb = capOrder[b.cap] !== undefined ? capOrder[b.cap] : 4;
    if (ca !== cb) return ca - cb;
    return a.ticker.localeCompare(b.ticker);
  });
  html += '<div class="explore-stock-list">';
  for (var i = 0; i < stocks.length; i++) {
    var s = stocks[i];
    html += '<div class="explore-stock-row" onclick="_exploreAddStock(\'' + escapeHTML(s.ticker) + '\')">'
      + '<span class="explore-stock-ticker">' + escapeHTML(s.ticker) + '</span>'
      + '<span class="explore-stock-name">' + escapeHTML(s.name) + '</span>'
      + (s.cap ? '<span class="explore-stock-sector">' + escapeHTML(s.cap) + '</span>' : '')
      + '</div>';
  }
  html += '</div>';
  return html;
}

function _onExploreSearch(query) {
  var el = document.getElementById('exploreSearchResults');
  if (!el) return;
  query = (query || '').trim().toUpperCase();
  if (query.length < 1) { el.innerHTML = ''; return; }
  if (typeof STOCK_DB === 'undefined') return;
  var results = [];
  for (var t in STOCK_DB) {
    var db = STOCK_DB[t];
    if (t.indexOf(query) === 0 || (db.name && db.name.toUpperCase().indexOf(query) !== -1)) {
      results.push({ ticker: t, name: db.name || t, sector: db.sector || '' });
    }
    if (results.length >= 15) break;
  }
  if (results.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px 0;">No matches</div>';
    return;
  }
  var html = '<div class="explore-stock-list">';
  for (var i = 0; i < results.length; i++) {
    var s = results[i];
    html += '<div class="explore-stock-row" onclick="_exploreAddStock(\'' + escapeHTML(s.ticker) + '\')">'
      + '<span class="explore-stock-ticker">' + escapeHTML(s.ticker) + '</span>'
      + '<span class="explore-stock-name">' + escapeHTML(s.name) + '</span>'
      + '<span class="explore-stock-sector">' + escapeHTML(s.sector) + '</span>'
      + '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function _exploreAddStock(ticker) {
  // If stock is already in holdings, just show toast
  if (typeof holdings !== 'undefined' && holdings.find(function(h) { return h.ticker === ticker; })) {
    showToast(ticker + ' already in portfolio');
    return;
  }
  // Auto-add with default 5% allocation
  var db = (typeof STOCK_DB !== 'undefined' && STOCK_DB[ticker]) || {};
  var total = typeof totalAllocation === 'function' ? totalAllocation() : 0;
  var pct = Math.min(5, Math.round((100 - total) * 10) / 10);
  if (pct <= 0) { showToast('Portfolio is full (100%)'); return; }
  holdings.push({
    ticker: ticker,
    pct: pct,
    name: db.name || ticker,
    sector: db.sector || 'Other',
    beta: db.beta || 1.0,
    cap: db.cap || 'unknown'
  });
  if (typeof renderHoldings === 'function') renderHoldings();
  showToast(ticker + ' added (' + pct + '%)');
  // Close panel
  _closeNavPanel('explorePanel');
}

// â”€â”€ PORTFOLIO DRAWER (popover above Portfolios tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _buildPortfolioDrawer() {
  var drawer = document.getElementById('portfolioDrawer');
  if (drawer) return drawer;
  drawer = document.createElement('div');
  drawer.id = 'portfolioDrawer';
  drawer.className = 'portfolio-drawer';
  document.body.appendChild(drawer);
  drawer.addEventListener('click', function(e) {
    if (e.target === drawer) closePortfolioDrawer();
  });
  return drawer;
}

function renderPortfolioDrawer() {
  var drawer = _buildPortfolioDrawer();
  var portfolios = getSavedPortfolios();
  var html = '<div class="pdrawer-panel">';
  html += '<div class="pdrawer-header"><span class="pdrawer-title">My Portfolios</span>'
    + '<button class="pdrawer-close" onclick="closePortfolioDrawer()">\u2715</button></div>';
  if (portfolios.length === 0) {
    html += '<div class="pdrawer-empty">No saved portfolios yet.<br>Add holdings and tap <strong>Save</strong>.</div>';
  } else {
    html += '<div class="pdrawer-list">';
    for (var i = 0; i < portfolios.length; i++) {
      var p = portfolios[i];
      var count = p.holdings ? p.holdings.length : 0;
      var isActive = (typeof _activePortfolioIdx !== 'undefined' && _activePortfolioIdx === i);
      var riskColor = typeof getPortfolioRiskColor === 'function' ? getPortfolioRiskColor(p.holdings) : 'var(--muted)';
      var perf = _lastPerfMap && _lastPerfMap[i] != null ? _lastPerfMap[i] : null;
      var perfHtml = '';
      if (perf != null) {
        var cls = perf > 0.005 ? 'up' : perf < -0.005 ? 'down' : 'flat';
        var sign = perf > 0 ? '+' : '';
        perfHtml = '<span class="pstrip-change ' + cls + '">' + sign + perf.toFixed(2) + '%</span>';
      }
      html += '<div class="pdrawer-item' + (isActive ? ' active' : '') + '" style="border-left-color:' + riskColor + '">'
        + '<div class="pdrawer-info" onclick="loadPortfolio(' + i + ');closePortfolioDrawer()"><div class="pdrawer-name">' + escapeHTML(p.name) + '</div>'
        + '<div class="pdrawer-count">' + count + ' holding' + (count !== 1 ? 's' : '') + '</div></div>'
        + perfHtml
        + '<button class="pdrawer-delete" onclick="quickDeletePortfolio(' + i + ')" title="Delete">&#128465;</button>'
        + '</div>';
    }
    html += '</div>';
  }
  html += '</div>';
  drawer.innerHTML = html;
}

// Direct delete (for drawer)
function quickDeletePortfolio(idx) {
  var portfolios = getSavedPortfolios();
  if (!portfolios[idx]) { console.warn('[delete] no portfolio at index', idx); return; }
  var name = portfolios[idx].name || 'Portfolio';
  portfolios.splice(idx, 1);
  // Save immediately and verify
  localStorage.setItem('pc_portfolios', JSON.stringify(portfolios));
  console.log('[delete] removed "' + name + '", remaining:', portfolios.length);
  if (typeof _activePortfolioIdx !== 'undefined' && _activePortfolioIdx === idx) {
    _activePortfolioIdx = -1;
    _activePortfolioSnapshot = null;
    // Clear loaded holdings since active portfolio was deleted
    if (typeof holdings !== 'undefined') {
      holdings.length = 0;
      if (typeof renderHoldings === 'function') renderHoldings();
      if (typeof expandInputSections === 'function') expandInputSections();
      if (typeof expandHoldingsPanel === 'function') expandHoldingsPanel();
    }
  } else if (typeof _activePortfolioIdx !== 'undefined' && _activePortfolioIdx > idx) {
    _activePortfolioIdx--;
  }
  // Clear performance cache for deleted portfolio
  if (_lastPerfMap) {
    delete _lastPerfMap[idx];
    // Reindex remaining entries
    var newMap = {};
    var keys = Object.keys(_lastPerfMap).map(Number).sort(function(a,b){return a-b;});
    for (var i = 0; i < keys.length; i++) {
      var k = keys[i];
      if (k > idx) newMap[k - 1] = _lastPerfMap[k];
      else if (k < idx) newMap[k] = _lastPerfMap[k];
    }
    _lastPerfMap = Object.keys(newMap).length > 0 ? newMap : null;
  }
  renderPortfolioDrawer();
  renderPortfolioStrip(_lastPerfMap);
  showToast('Deleted "' + name + '"');
}

function togglePortfolioDrawer() {
  var drawer = _buildPortfolioDrawer();
  if (drawer.classList.contains('open')) {
    closePortfolioDrawer();
  } else {
    renderPortfolioDrawer();
    requestAnimationFrame(function() { drawer.classList.add('open'); });
  }
}

window.closePortfolioDrawer = function() {
  var drawer = document.getElementById('portfolioDrawer');
  if (drawer) drawer.classList.remove('open');
};

// Register service worker for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}

// Restore Purchases â€” requires sign-in, uses authenticated email
function restorePurchases() {
  if (!currentUser || !currentUser.email) {
    showToast('Sign in first to restore your Pro purchase.');
    showAuthModalOptimized();
    return;
  }
  const email = currentUser.email;
  verifyProAccess(email).then(isPro => {
    if (isPro) {
      closePaywall();
      showToast('Pro access restored!');
    } else {
      showToast('No active Pro subscription found for ' + email + '.');
    }
  });
}

// â”€â”€ PRO VERIFICATION SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Pro token now lives in HttpOnly cookie â€” JS checks expiry flag only
function isProUser() {
  return Date.now() < parseInt(localStorage.getItem('pc_pro_expiry') || '0');
}

async function verifyProAccess(email) {
  try {
    const res = await fetch('/api/verify-pro?email=' + encodeURIComponent(email));
    const data = await res.json();
    if (data.pro) {
      localStorage.setItem('pc_pro_email', email.toLowerCase().trim());
      localStorage.setItem('pc_pro_expiry', String(Date.now() + (data.expiresIn || 14400) * 1000));
      localStorage.setItem('pc_pro_plan', data.plan || 'pro');
      updateUserUI();
      return true;
    } else {
      localStorage.removeItem('pc_pro_expiry');
      return false;
    }
  } catch(e) {
    console.warn('Pro verification failed:', e.message);
    // If server is down, honor existing valid expiry
    return isProUser();
  }
}

// Check pro status on page load
(async function checkProStatus() {
  // Legacy cleanup: remove old token-based localStorage keys
  localStorage.removeItem('pc_pro_token');
  localStorage.removeItem('pc_pro_ts');
  localStorage.removeItem('pc_auth_token');
  localStorage.removeItem('pc_auth_ts');
  localStorage.removeItem('pc_pro'); // clear insecure flag

  const email = localStorage.getItem('pc_pro_email');
  const hasUser = localStorage.getItem('pc_user');
  if (email && hasUser) {
    // Re-verify on load (refreshes cookie) â€” only if user is signed in
    await verifyProAccess(email);
  }
})();

// Sticky analyze button for mobile
(function initStickyAnalyze() {
  const sticky = document.createElement('button');
  sticky.className = 'btn-analyze-sticky';
  sticky.textContent = 'Analyze';
  sticky.onclick = function() { analyzeDebounced(); };
  document.body.appendChild(sticky);
  window._stickyAnalyzed = false;

  function checkSticky() {
    if (holdings.length > 0 && !window._stickyAnalyzed) {
      sticky.classList.add('visible');
    } else {
      sticky.classList.remove('visible');
    }
  }

  // Hook analyze to hide sticky permanently until holdings change
  const origAnalyze = window.analyze;
  if (typeof origAnalyze === 'function') {
    window.analyze = function() {
      window._stickyAnalyzed = true;
      sticky.classList.remove('visible');
      return origAnalyze.apply(this, arguments);
    };
  }

  // Check on holdings change
  const origRender = window.renderHoldings;
  if (typeof origRender === 'function') {
    window.renderHoldings = function() {
      origRender();
      checkSticky();
    };
  }

  // Reset analyzed flag when holdings change
  const origAddStock = window.addStock;
  if (typeof origAddStock === 'function') {
    window.addStock = function() {
      window._stickyAnalyzed = false;
      return origAddStock.apply(this, arguments);
    };
  }
  const origRemoveStock = window.removeStock;
  if (typeof origRemoveStock === 'function') {
    window.removeStock = function(t) {
      window._stickyAnalyzed = false;
      return origRemoveStock.apply(this, arguments);
    };
  }

  window.addEventListener('resize', checkSticky);
  checkSticky();
})();

// Pro status checked above in PRO VERIFICATION SYSTEM

// â”€â”€ PURCHASE FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goToPurchase(stripeUrl) {
  if (_isIOSApp) {
    showToast('This feature requires a Pro subscription.');
    return;
  }
  const savedEmail = localStorage.getItem('pc_pro_email') || '';
  const email = prompt('Enter your email to activate Pro after purchase:', savedEmail);
  if (!email || !email.includes('@')) {
    showToast('Please enter a valid email to continue.');
    return;
  }
  localStorage.setItem('pc_pro_email', email.toLowerCase().trim());
  localStorage.setItem('pc_checkout_pending', 'true');
  // Append email to Stripe link as prefill
  const separator = stripeUrl.includes('?') ? '&' : '?';
  window.location.href = stripeUrl + separator + 'prefilled_email=' + encodeURIComponent(email);
}


// Check if returning from Stripe checkout
(async function checkPostCheckout() {
  if (localStorage.getItem('pc_checkout_pending') === 'true') {
    localStorage.removeItem('pc_checkout_pending');
    const email = localStorage.getItem('pc_pro_email');
    if (email) {
      showToast('Verifying your purchase...');
      // Give Stripe webhook a moment to process
      await new Promise(r => setTimeout(r, 3000));
      const isPro = await verifyProAccess(email);
      if (isPro) {
        showToast('Pro activated! Enjoy unlimited access.');
      } else {
        // Webhook might be slow â€” retry once more
        await new Promise(r => setTimeout(r, 5000));
        const retry = await verifyProAccess(email);
        if (retry) {
          showToast('Pro activated! Enjoy unlimited access.');
        } else {
          showToast('Purchase processing â€” Pro will activate shortly. Use Restore Purchases if needed.');
        }
      }
    }
  }
})();

// â”€â”€ GOOGLE SIGN-IN & CLOUD SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GOOGLE_CLIENT_ID = '883221867787-46q3pisnln3qoaqro2smu8jherv3nq43.apps.googleusercontent.com';

// Initialize Google Identity Services
let _googleInitialized = false;
function initGoogleSignIn() {
  if (typeof google === 'undefined' || !google.accounts) {
    setTimeout(initGoogleSignIn, 500);
    return;
  }
  if (_googleInitialized) return;
  _googleInitialized = true;
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleGoogleResponse,
    auto_select: false,
  });
}
initGoogleSignIn();

// OAuth popup for iOS WebView (intercepted by native window.open override)
function openGoogleOAuthPopup() {
  const url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${GOOGLE_CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.origin)}&response_type=code&scope=openid%20email%20profile`;
  window.open(url, 'google-signin', 'width=500,height=600');
}

function _isIPadSafari() {
  return !isIOSApp() && (
    /iPad/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)
  );
}

function googleSignIn() {
  // iOS WebView: GIS doesn't work, use OAuth popup (intercepted by native app)
  if (isIOSApp()) {
    openGoogleOAuthPopup();
    return;
  }

  // iPad Safari: GIS popup/FedCM doesn't work reliably, use redirect flow
  if (_isIPadSafari()) {
    var nonce = Math.random().toString(36).substr(2);
    var url = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=' + GOOGLE_CLIENT_ID
      + '&redirect_uri=' + encodeURIComponent(window.location.origin)
      + '&response_type=id_token'
      + '&scope=openid%20email%20profile'
      + '&nonce=' + nonce
      + '&prompt=select_account';
    window.location.href = url;
    return;
  }

  // Web: use Google Identity Services renderButton (no popup/redirect needed)
  if (typeof google === 'undefined' || !google.accounts) {
    loadGoogleSignInScript().then(() => googleSignIn()).catch(() => {
      showToast('Failed to load Google Sign-In. Please try again.');
    });
    return;
  }
  if (!_googleInitialized) initGoogleSignIn();

  const container = document.getElementById('googleSignInContainer');
  const fallback = document.getElementById('googleSignInFallback');
  if (container) {
    container.innerHTML = '';
    google.accounts.id.renderButton(container, {
      type: 'standard',
      theme: 'filled_black',
      size: 'large',
      width: container.offsetWidth || 300,
      text: 'continue_with',
    });
    container.style.display = 'block';
    if (fallback) fallback.style.display = 'none';
  }
}

async function handleGoogleResponse(response) {
  if (!response.credential) return;

  try {
    const res = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credential: response.credential }),
    });
    const data = await res.json();

    if (data.success && data.user) {
      currentUser = data.user;
      localStorage.setItem('pc_user', JSON.stringify(data.user));
      localStorage.setItem('pc_pro_email', data.user.email);
      closeAuthModal();
      updateUserUI();
      showToast('Signed in as ' + data.user.name + '!');

      // Auto-check Pro status (refreshes cookie, sets pc_pro_expiry)
      await verifyProAccess(data.user.email);
    } else {
      showToast('Sign in failed. Please try again.');
    }
  } catch (err) {
    console.error('Sign in error:', err);
    showToast('Sign in failed. Please try again.');
  }
}

function updateUserUI() {
  const pillName = document.getElementById('userPillName');
  const pillAvatar = document.getElementById('userPillAvatar');

  if (currentUser) {
    // Update pill â€” show first name + avatar
    const fullName = currentUser.name || currentUser.email.split('@')[0];
    const firstName = fullName.split(' ')[0];
    const lastInitial = fullName.split(' ').length > 1 ? ' ' + fullName.split(' ').slice(-1)[0][0] + '.' : '';
    if (pillName) pillName.textContent = firstName + lastInitial;
    if (pillAvatar) {
      if (currentUser.picture) {
        if (pillAvatar.tagName !== 'IMG') {
          const img = document.createElement('img');
          img.id = 'userPillAvatar';
          img.className = 'user-pill-avatar visible';
          img.src = currentUser.picture;
          img.onerror = function() { this.style.display = 'none'; };
          pillAvatar.replaceWith(img);
        } else {
          pillAvatar.className = 'user-pill-avatar visible';
          pillAvatar.src = currentUser.picture;
          pillAvatar.onerror = function() { this.style.display = 'none'; };
        }
      } else {
        const initial = (fullName || '?')[0].toUpperCase();
        if (pillAvatar.tagName === 'IMG') {
          const span = document.createElement('span');
          span.id = 'userPillAvatar';
          span.className = 'user-pill-avatar initials';
          span.textContent = initial;
          pillAvatar.replaceWith(span);
        } else {
          pillAvatar.className = 'user-pill-avatar initials';
          pillAvatar.textContent = initial;
        }
      }
    }
    // Hide Pro button if pro
    if (isProUser()) {
      const pb = document.getElementById('btnPro');
      if (pb) pb.style.display = 'none';
    }
  } else {
    if (pillName) pillName.textContent = 'â˜° Menu';
    if (pillAvatar) {
      if (pillAvatar.tagName === 'IMG') {
        const span = document.createElement('span');
        span.id = 'userPillAvatar';
        span.className = 'user-pill-avatar';
        pillAvatar.replaceWith(span);
      } else {
        pillAvatar.className = 'user-pill-avatar';
        pillAvatar.textContent = '';
      }
    }
    // Show Pro button again
    const pb = document.getElementById('btnPro');
    if (pb) pb.style.display = '';
  }
}

function closeAuthModal() {
  document.getElementById('authModal').style.display = 'none';
}

// Sidebar has its own close mechanisms (backdrop click, close button, Escape key)
// No outside-click handler needed.

function signOut() {
  // 1. Clear in-memory state immediately
  currentUser = null;
  if (typeof holdings !== 'undefined') holdings.length = 0;
  _activePortfolioIdx = -1;
  _activePortfolioSnapshot = null;
  _lastPerfMap = null;
  _topMoversCache = null;
  _proPicksCache = null;

  // 2. Explicitly remove known keys
  var explicitKeys = [
    'pc_portfolios', 'pc_user', 'pc_pro_email', 'pc_pro_expiry',
    'pc_pro_plan', 'pc_checkout_pending', 'currentUser',
    'pc_cached_analysis', 'pc_cached_analysis_ts'
  ];
  explicitKeys.forEach(function(k) { try { localStorage.removeItem(k); } catch(e) {} });

  // 3. Also clear all pc_ prefixed keys (market cache, sparkline cache, etc.)
  var keysToRemove = [];
  for (var i = 0; i < localStorage.length; i++) {
    var key = localStorage.key(i);
    if (key && key.startsWith('pc_') && key !== 'pc_theme' && key !== 'pc_ai_consent') {
      keysToRemove.push(key);
    }
  }
  keysToRemove.forEach(function(k) { try { localStorage.removeItem(k); } catch(e) {} });

  // 4. Clear HttpOnly cookies server-side
  fetch('/api/signout', { method: 'POST' }).catch(function() {});

  // 5. Hard reload to guarantee clean state
  window.location.reload();
}

async function deleteAccount() {
  var email = (currentUser && currentUser.email) || '';
  if (!email) { showToast('Not signed in.'); return; }
  if (!confirm('Delete your account?\n\nThis will permanently delete your profile, all cloud portfolios, and any Pro license. This cannot be undone.')) return;
  if (!confirm('Are you absolutely sure? Type OK in the next prompt to confirm.')) return;
  var typed = prompt('Type DELETE to permanently delete your account:');
  if (typed !== 'DELETE') { showToast('Account deletion cancelled.'); return; }
  try {
    var headers = getAuthHeaders();
    headers['Content-Type'] = 'application/json';
    var res = await fetch('/api/delete-account', {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ email: email }),
    });
    var data = await res.json();
    if (!res.ok) { showToast(data.error || 'Failed to delete account.'); return; }
    currentUser = null;
    localStorage.clear();
    updateUserUI();
    showToast('Account deleted.');
    setTimeout(function() { location.reload(); }, 1500);
  } catch(e) {
    showToast('Error deleting account. Please try again.');
  }
}

// â”€â”€ AUTH HEADERS (kept for API calls that need it) â”€â”€â”€â”€â”€â”€â”€
function getAuthHeaders() {
  return {};
}

// Restore user session on page load
(function restoreUserSession() {
  const saved = localStorage.getItem('pc_user');
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      updateUserUI();
    } catch(e) {
      localStorage.removeItem('pc_user');
    }
  }
})();

// â”€â”€ APPLE SIGN-IN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APPLE_CLIENT_ID = 'com.pcompass.signin';

function loadAppleSignInScript() {
  if (window._appleScriptLoaded) return Promise.resolve();
  if (window._appleScriptLoading) return window._appleScriptLoading;
  window._appleScriptLoading = new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js';
    script.async = true;
    script.onload = () => { window._appleScriptLoaded = true; resolve(); };
    script.onerror = () => { window._appleScriptLoading = null; reject(new Error('Failed to load Apple Sign-In')); };
    document.head.appendChild(script);
  });
  return window._appleScriptLoading;
}

async function appleSignIn() {
  try {
    await loadAppleSignInScript();
    // Generate nonce for replay protection (Apple recommended)
    const nonceBytes = new Uint8Array(32);
    crypto.getRandomValues(nonceBytes);
    const rawNonce = Array.from(nonceBytes, b => b.toString(16).padStart(2, '0')).join('');
    const nonceHash = Array.from(new Uint8Array(await crypto.subtle.digest('SHA-256', new TextEncoder().encode(rawNonce))), b => b.toString(16).padStart(2, '0')).join('');

    AppleID.auth.init({
      clientId: APPLE_CLIENT_ID,
      scope: 'name email',
      redirectURI: window.location.origin,
      usePopup: true,
      nonce: nonceHash,
    });
    const response = await AppleID.auth.signIn();
    const body = { id_token: response.authorization.id_token, nonce: rawNonce };
    // User info (name) is only sent on first sign-in
    if (response.user) body.user = response.user;
    const res = await fetch('/api/auth-apple', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (data.success && data.user) {
      currentUser = data.user;
      localStorage.setItem('pc_user', JSON.stringify(data.user));
      localStorage.setItem('pc_pro_email', data.user.email);
      closeAuthModal();
      updateUserUI();
      showToast('Signed in as ' + data.user.name + '!');
      await verifyProAccess(data.user.email);
    } else {
      showToast('Sign in failed: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    if (err.error === 'popup_closed_by_user') return;
    console.error('Apple Sign-In error:', err);
    showToast('Apple Sign-In failed. Please try again.');
  }
}

// â”€â”€ COLLAPSE HOLDINGS AFTER ANALYZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// After analysis, collapse the holdings editing panel with smooth animation
function collapseHoldingsPanel(mobileOnly) {
  if (mobileOnly && window.innerWidth > 900) return;
  var body = document.getElementById('holdingsBody');
  var link = document.getElementById('editPortfolioLink');
  var chevron = document.getElementById('holdingsChevron');
  if (!body || body.classList.contains('collapsed')) return;
  body.style.maxHeight = body.scrollHeight + 'px';
  body.offsetHeight; // force reflow
  body.classList.add('collapsed');
  body.style.maxHeight = '0';
  if (link) link.style.display = 'inline';
  if (chevron) chevron.textContent = 'â–¸';
}

function expandHoldingsPanel() {
  var body = document.getElementById('holdingsBody');
  var link = document.getElementById('editPortfolioLink');
  var chevron = document.getElementById('holdingsChevron');
  if (!body || !body.classList.contains('collapsed')) return;
  body.classList.remove('collapsed');
  body.style.maxHeight = body.scrollHeight + 'px';
  var done = function() { body.style.maxHeight = ''; body.removeEventListener('transitionend', done); };
  body.addEventListener('transitionend', done);
  if (link) link.style.display = 'none';
  if (chevron) chevron.textContent = 'â–¾';
}

// Briefly highlight the What-If simulator after first analysis
function highlightWhatIf() {
  var panel = document.getElementById('whatifPanel');
  if (!panel || panel.dataset.promoted) return;
  panel.dataset.promoted = '1';
  panel.classList.add('whatif-promoted');
  setTimeout(function() {
    panel.classList.remove('whatif-promoted');
  }, 5000);
}

// Hook into analyze() to highlight what-if after analysis completes
(function() {
  var origAnalyze = window.analyze;
  if (typeof origAnalyze === 'function') {
    window.analyze = function() {
      origAnalyze.apply(this, arguments);
      highlightWhatIf();
    };
  }
})();

// â”€â”€ PATCH 0: FETCH FRESH BETAS & PICKS FROM DAILY CRON â”€â”€â”€â”€â”€â”€â”€
// Merges server-computed betas (Yahoo Finance 6mo) and stock picks
// into the static STOCK_DB and STOCK_PICKS from data.js.
// Falls back silently to static values on any failure.
(async function loadFreshStockData() {
  try {
    const res = await fetch('/api/stock-data');
    if (!res.ok) return;
    const data = await res.json();

    // Merge betas into STOCK_DB
    if (data.betas && typeof data.betas === 'object') {
      let updated = 0;
      for (const [ticker, beta] of Object.entries(data.betas)) {
        if (typeof STOCK_DB !== 'undefined' && STOCK_DB[ticker] && typeof beta === 'number') {
          STOCK_DB[ticker].beta = beta;
          updated++;
        }
      }
      if (updated > 0) console.log('[stock-data] Updated ' + updated + ' betas from server');
    }

    // Merge picks into STOCK_PICKS (replace contents in-place)
    if (data.picks && Array.isArray(data.picks) && data.picks.length > 0 && typeof STOCK_PICKS !== 'undefined') {
      STOCK_PICKS.length = 0;
      for (const pick of data.picks) {
        STOCK_PICKS.push(pick);
      }
      console.log('[stock-data] Loaded ' + data.picks.length + ' fresh picks');
    }
  } catch (e) {
    // Silent fallback â€” static data.js values remain
    console.warn('[stock-data] Failed to load fresh data, using static defaults');
  }
})();

// â”€â”€ PATCH 1: MARKET DATA localStorage CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchMarketDataCached(tickersToFetch) {
  const CACHE_KEY = 'pc_market_' + tickersToFetch.slice().sort().join(',');
  const CACHE_TTL = 60 * 60 * 1000; // 1 hour
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      const { data, ts } = JSON.parse(cached);
      if (Date.now() - ts < CACHE_TTL) {
        console.log('[market-data] serving from localStorage cache');
        return data;
      }
    }
  } catch(e) { /* ignore stale/corrupt cache */ }
  try {
    const res = await fetch('/api/market-data?tickers=' + tickersToFetch.join(','));
    if (!res.ok) {
      console.warn('[market-data] API returned', res.status);
      return null;
    }
    const raw = await res.json();
    if (raw.error) {
      console.warn('[market-data] API error:', raw.error);
      return null;
    }
    const marketData = {};
    for (const [ticker, val] of Object.entries(raw)) {
      if (!val) { marketData[ticker] = null; continue; }
      marketData[ticker] = {
        price:       Number(val.price) || 0,
        changePct:   val.changePct != null ? Number(val.changePct) : (val.change != null ? Number(val.change) : 0),
        momentum:    val.momentum != null ? val.momentum : 50 + Math.min(15, Math.max(-15, Number(val.changePct || val.change || 0) * 5)),
        marketState: val.marketState || 'REGULAR',
        name:        val.name || ticker,
      };
    }
    try {
      localStorage.setItem(CACHE_KEY, JSON.stringify({ data: marketData, ts: Date.now() }));
    } catch(e) { /* localStorage quota exceeded â€” skip cache write */ }
    return Object.keys(marketData).length > 0 ? marketData : null;
  } catch(e) {
    console.warn('[market-data] fetch failed:', e.message);
    return null;
  }
}

// â”€â”€ PATCH 2: ANALYZE DEBOUNCE + BUTTON LOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let analyzeDebounceTimer = null;
let _analyzeLocked = false;
function analyzeDebounced() {
  if (_analyzeLocked) return;
  if (typeof holdings !== 'undefined' && holdings.length === 0) {
    showToast('Please add holdings first');
    return;
  }
  clearTimeout(analyzeDebounceTimer);
  analyzeDebounceTimer = setTimeout(() => {
    _analyzeLocked = true;
    var selectors = ['#analyzeBtn', '.btn-analyze-sticky', '#refreshMarketBtn'];
    var analyzeBtn = document.getElementById('analyzeBtn');
    if (analyzeBtn) analyzeBtn.classList.add('analyzing');
    selectors.forEach(function(s) {
      var el = document.querySelector(s);
      if (el) { el.disabled = true; el.style.opacity = '0.5'; }
    });
    try { analyze(); } catch(e) { console.error(e); }
    // Keep holdings panel open so user can edit after analyzing
    // Unlock after market data fetch completes (max 8s safety timeout)
    setTimeout(function() {
      _analyzeLocked = false;
      if (analyzeBtn) analyzeBtn.classList.remove('analyzing');
      selectors.forEach(function(s) {
        var el = document.querySelector(s);
        if (el) { el.disabled = false; el.style.opacity = ''; }
      });
    }, 8000);
  }, 300);
}

// â”€â”€ SAVE BUTTON LOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function lockSaveButtons() {
  var origSave = window.savePortfolio;
  if (typeof origSave !== 'function') return;
  window.savePortfolio = function() {
    var btns = document.querySelectorAll('#btnQuickSave');
    btns.forEach(function(b) { b.disabled = true; b.style.opacity = '0.5'; });
    try { origSave.apply(this, arguments); } catch(e) { console.error(e); }
    setTimeout(function() {
      btns.forEach(function(b) { b.disabled = false; b.style.opacity = ''; });
    }, 2000);
  };
})();

// â”€â”€ PATCH 4: LAZY GOOGLE SIGN-IN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadGoogleSignInScript() {
  if (window._googleScriptLoaded) return Promise.resolve();
  if (window._googleScriptLoading) return window._googleScriptLoading;
  window._googleScriptLoading = new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.defer = true;
    script.onload = () => {
      window._googleScriptLoaded = true;
      if (typeof initGoogleSignIn === 'function') initGoogleSignIn();
      resolve();
    };
    script.onerror = () => {
      window._googleScriptLoading = null;
      reject(new Error('Failed to load Google Sign-In'));
    };
    document.head.appendChild(script);
  });
  return window._googleScriptLoading;
}
function showAuthModalOptimized() {
  document.getElementById('authModal').style.display = 'flex';
  // Reset: show fallback button, hide GIS container until rendered
  const fallback = document.getElementById('googleSignInFallback');
  const container = document.getElementById('googleSignInContainer');
  if (fallback) fallback.style.display = 'flex';
  if (container) container.style.display = 'none';
  // Load GIS SDK and render Google button
  loadGoogleSignInScript().then(() => googleSignIn()).catch(() => {});
}

// â”€â”€ PATCH 5: callClaudeAPI is defined at the top of the main script block â”€â”€â”€â”€

// â”€â”€ PATCH 6: CLEAR MARKET CACHE (called before manual refresh) â”€
function clearMarketCache() {
  const keysToDelete = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('pc_market_')) keysToDelete.push(key);
  }
  keysToDelete.forEach(k => localStorage.removeItem(k));
  console.log('[market-data] localStorage cache cleared');
}

// â”€â”€ PATCH 7: INTERACTIVE PAYWALL TIER SELECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let selectedPaywallTier = 'monthly';

// Pricing & Stripe URLs injected dynamically on web only (not iOS â€” Apple Guideline 3.1.1)
const paywallTiers = {};

function selectPaywallTier(tier) {
  selectedPaywallTier = tier;
  var keys = ['monthly', 'annual', 'lifetime'];
  keys.forEach(function(k) {
    var el = document.getElementById('tier-' + k);
    if (!el) return;
    if (k === tier) {
      el.classList.add('pw-tier-selected');
    } else {
      el.classList.remove('pw-tier-selected');
    }
  });
  var btn = document.getElementById('paywallConfirmBtn');
  var t = paywallTiers[tier];
  if (btn && t) {
    btn.textContent = t.label;
    btn.onclick = function() { goToPurchase(t.url); };
  }
}

// Event delegation â€” clicks anywhere inside a tier bubble up here
(function() {
  var container = document.getElementById('pwTiers');
  if (!container) return;
  container.addEventListener('click', function(e) {
    var tier = e.target.closest('.pw-tier');
    if (tier && tier.dataset.tier) {
      selectPaywallTier(tier.dataset.tier);
    }
  });
})();

// â”€â”€ PATCH 8: OFFLINE PORTFOLIO VIEWING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function initOfflineSupport() {
  var offlineBanner = null;
  var disabledEls = [];
  var analysisObserver = null;
  var CACHE_KEY = 'pc_cached_analysis';
  var CACHE_TS_KEY = 'pc_cached_analysis_ts';

  function showOfflineBanner() {
    if (offlineBanner) return;
    offlineBanner = document.createElement('div');
    offlineBanner.id = 'offlineBanner';
    offlineBanner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#b8860b;color:#fff;text-align:center;padding:6px 12px;font-family:"Space Mono",monospace;font-size:11px;letter-spacing:0.5px;';
    offlineBanner.textContent = "You\u2019re offline \u2014 viewing saved data";
    document.body.appendChild(offlineBanner);
    // Push body content down
    document.body.style.marginTop = (offlineBanner.offsetHeight || 28) + 'px';
  }

  function hideOfflineBanner() {
    if (!offlineBanner) return;
    offlineBanner.remove();
    offlineBanner = null;
    document.body.style.marginTop = '';
  }

  function disableControls() {
    var selectors = ['#analyzeBtn', '.btn-analyze-sticky', '#refreshMarketBtn'];
    disabledEls = [];
    selectors.forEach(function(sel) {
      var el = document.querySelector(sel);
      if (el) {
        el.dataset.pcWasDisabled = el.disabled ? 'true' : 'false';
        el.disabled = true;
        el.style.opacity = '0.4';
        el.style.pointerEvents = 'none';
        disabledEls.push(el);
      }
    });
  }

  function enableControls() {
    disabledEls.forEach(function(el) {
      if (el.dataset.pcWasDisabled !== 'true') {
        el.disabled = false;
      }
      el.style.opacity = '';
      el.style.pointerEvents = '';
      delete el.dataset.pcWasDisabled;
    });
    disabledEls = [];
  }

  // Cache analysis HTML when it changes
  function startObserving() {
    var panel = document.getElementById('resultsPanel');
    if (!panel || analysisObserver) return;
    analysisObserver = new MutationObserver(function() {
      var html = panel.innerHTML.trim();
      if (html && html.length > 100) {
        try {
          localStorage.setItem(CACHE_KEY, html);
          localStorage.setItem(CACHE_TS_KEY, String(Date.now()));
        } catch(e) { /* quota exceeded */ }
      }
    });
    analysisObserver.observe(panel, { childList: true, subtree: true, characterData: true });
  }

  function restoreCachedAnalysis() {
    var panel = document.getElementById('resultsPanel');
    if (!panel) return;
    // Only restore if panel is currently empty
    if (panel.innerHTML.trim().length > 100) return;
    var cached = localStorage.getItem(CACHE_KEY);
    var ts = parseInt(localStorage.getItem(CACHE_TS_KEY) || '0');
    if (!cached) return;
    var age = Date.now() - ts;
    var ageText = age < 60000 ? 'just now' :
                  age < 3600000 ? Math.round(age / 60000) + 'm ago' :
                  age < 86400000 ? Math.round(age / 3600000) + 'h ago' :
                  Math.round(age / 86400000) + 'd ago';
    var badge = '<div style="background:#b8860b;color:#fff;padding:6px 12px;border-radius:8px;margin-bottom:12px;font-family:\'Space Mono\',monospace;font-size:10px;text-align:center;letter-spacing:0.5px;">Cached analysis from ' + ageText + '</div>';
    panel.innerHTML = badge + cached;
  }

  function goOffline() {
    showOfflineBanner();
    disableControls();
    restoreCachedAnalysis();
  }

  function goOnline() {
    hideOfflineBanner();
    enableControls();
  }

  window.addEventListener('offline', goOffline);
  window.addEventListener('online', goOnline);

  // Start observing once DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      startObserving();
      if (!navigator.onLine) goOffline();
    });
  } else {
    startObserving();
    if (!navigator.onLine) goOffline();
  }
})();

// Sub-bar removed â€” portfolios are now in the sidebar.

// â”€â”€ DYNAMIC PRICING INJECTION (web only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Stripe URLs and dollar amounts are NOT in the HTML source.
// They are injected here at runtime, only on non-iOS platforms,
// so Apple's review does not flag external payment references.
if (!_isIOSApp) {
  document.addEventListener('DOMContentLoaded', function() {
    var S = {
      monthly:  { url: 'https://buy.stripe.com/28E8wPb66b4Y4aj0M96AM03', price: '$1.99', period: '/mo', label: 'Get Pro \u2014 $1.99/mo' },
      annual:   { url: 'https://buy.stripe.com/28EdR94HIc926ir66t6AM05', price: '$14.99', period: '/yr', label: 'Annual \u2014 $14.99/yr (save 37%)' },
      lifetime: { url: 'https://buy.stripe.com/14AeVddeedd64aj3Yl6AM04', price: '$19.99', period: '', label: 'Lifetime \u2014 $19.99' },
    };

    // Populate paywallTiers for selectPaywallTier()
    paywallTiers.monthly  = { url: S.monthly.url,  label: S.monthly.label };
    paywallTiers.annual   = { url: S.annual.url,   label: 'Get Annual \u2014 $14.99/yr' };
    paywallTiers.lifetime = { url: S.lifetime.url,  label: 'Get Lifetime \u2014 $19.99' };

    // Upgrade modal â€” tier prices
    var upPrices = document.querySelectorAll('.upgrade-tier-price');
    if (upPrices[0]) upPrices[0].textContent = '$0';
    if (upPrices[1]) upPrices[1].innerHTML = S.monthly.price + '<span>' + S.monthly.period + '</span>';
    if (upPrices[2]) upPrices[2].innerHTML = S.annual.price + '<span>' + S.annual.period + '</span>';
    if (upPrices[3]) upPrices[3].innerHTML = S.lifetime.price + '<span> one-time</span>';

    // Upgrade modal â€” action buttons
    var upBtns = document.querySelectorAll('.upgrade-actions button');
    if (upBtns[0]) { upBtns[0].textContent = S.monthly.label; upBtns[0].onclick = function() { goToPurchase(S.monthly.url); }; }
    if (upBtns[1]) { upBtns[1].textContent = S.annual.label; upBtns[1].onclick = function() { goToPurchase(S.annual.url); }; }
    if (upBtns[2]) { upBtns[2].textContent = S.lifetime.label; upBtns[2].onclick = function() { goToPurchase(S.lifetime.url); }; }

    // Paywall modal â€” tier prices
    var pwPrices = document.querySelectorAll('.pw-tier-price');
    if (pwPrices[0]) pwPrices[0].innerHTML = S.monthly.price + '<span style="font-size:10px;color:#6b7a90;">' + S.monthly.period + '</span>';
    if (pwPrices[1]) pwPrices[1].innerHTML = S.annual.price + '<span style="font-size:10px;color:#6b7a90;">' + S.annual.period + '</span>';
    if (pwPrices[2]) pwPrices[2].textContent = S.lifetime.price;

    // Sign-in teaser
    var teaser = document.getElementById('signInProTeaser');
    if (teaser) teaser.textContent = 'Free to join \u00b7 Pro from $1.99/mo';

    // Paywall modal â€” confirm button
    var confirmBtn = document.getElementById('paywallConfirmBtn');
    if (confirmBtn) {
      confirmBtn.textContent = S.monthly.label;
      confirmBtn.onclick = function() { goToPurchase(S.monthly.url); };
    }
  });
}

// â”€â”€ PORTFOLIO STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var _lastPerfMap = null; // cache last successful performance data
var _topMoversCache = null; // cached top movers data

// Broad universe of popular high-volume stocks across all sectors
// Split into 2 batches of â‰¤40 (API hard cap) to find actual daily top movers
var _moverTickersA = [
  'NVDA','TSLA','AAPL','MSFT','AMD','META','AMZN','GOOGL','AVGO','ORCL',
  'CRM','ADBE','INTC','CSCO','QCOM','PLTR','MU','MRVL','ARM','SMCI',
  'JPM','GS','V','MA','PYPL','SQ','COIN','HOOD','SOFI','WMT',
  'COST','NKE','DIS','NFLX','ABNB','JNJ','UNH','PFE','LLY','MRK'
];
var _moverTickersB = [
  'XOM','CVX','COP','OXY','AI','SOUN','DDOG','CRWD','PANW','NET',
  'RIVN','LCID','NIO','F','GM','RDDT','SNAP','SPOT','ROKU','MARA',
  'RIOT','MSTR','BA','LMT','CAT','GE','APP','UBER','DASH','RBLX',
  'AFRM','UPST','MRNA','AMGN','ABBV','BMY','SLB','SHOP','SNOW','TXN'
];

function _renderMoversHTML(movers) {
  if (!movers) return '';
  // Support new { gainers, losers } format
  var gainers = movers.gainers || [];
  var losers = movers.losers || [];
  if (gainers.length === 0 && losers.length === 0) return '';
  var html = '';
  function renderRow(m) {
    var cls = m.changePct > 0.05 ? 'up' : m.changePct < -0.05 ? 'down' : 'flat';
    var sign = m.changePct > 0 ? '+' : '';
    return '<div class="pstrip-mover" title="' + escapeHTML(m.name || m.ticker) + '">'
      + '<span class="pstrip-mover-ticker">' + escapeHTML(m.ticker) + '</span>'
      + '<span class="pstrip-change ' + cls + '">' + sign + m.changePct.toFixed(1) + '%</span>'
      + '</div>';
  }
  if (gainers.length > 0) {
    html += '<div class="pstrip-movers-label">Top Gainers</div>';
    for (var i = 0; i < gainers.length; i++) html += renderRow(gainers[i]);
  }
  if (losers.length > 0) {
    html += '<div class="pstrip-movers-label" style="margin-top:4px;">Top Losers</div>';
    for (var j = 0; j < losers.length; j++) html += renderRow(losers[j]);
  }
  return html;
}

function fetchTopMovers() {
  // Use cached data if fresh (15 min)
  if (_topMoversCache && (Date.now() - _topMoversCache.ts < 15 * 60 * 1000)) {
    return Promise.resolve(_topMoversCache.data);
  }
  if (typeof fetchMarketDataCached !== 'function') return Promise.resolve(null);
  // Fetch both batches in parallel through existing market-data cache
  return Promise.all([
    fetchMarketDataCached(_moverTickersA),
    fetchMarketDataCached(_moverTickersB)
  ]).then(function(results) {
    var md = Object.assign({}, results[0] || {}, results[1] || {});
    var gainers = [];
    var losers = [];
    for (var t in md) {
      if (md[t] && md[t].changePct != null) {
        var entry = { ticker: t, changePct: md[t].changePct, name: md[t].name || t, price: md[t].price || 0 };
        if (md[t].changePct > 0.01) gainers.push(entry);
        else if (md[t].changePct < -0.01) losers.push(entry);
      }
    }
    // Sort gainers descending, losers ascending (most negative first)
    gainers.sort(function(a, b) { return b.changePct - a.changePct; });
    losers.sort(function(a, b) { return a.changePct - b.changePct; });
    var top = { gainers: gainers.slice(0, 3), losers: losers.slice(0, 3) };
    _topMoversCache = { data: top, ts: Date.now() };
    return top;
  }).catch(function() { return null; });
}

function renderPortfolioStrip(performanceMap) {
  var strip = document.getElementById('portfolioStrip');
  if (!strip) return;
  var portfolios = getSavedPortfolios();

  // Use last known data as fallback so we don't flash "â€¢â€¢â€¢"
  var pm = performanceMap || _lastPerfMap;
  if (performanceMap) _lastPerfMap = performanceMap;

  var html = '';

  // Top movers section (always shown)
  if (_topMoversCache && _topMoversCache.data && (_topMoversCache.data.gainers || _topMoversCache.data.losers)) {
    html += _renderMoversHTML(_topMoversCache.data);
  }

  // Portfolio cards (if any)
  if (portfolios.length > 0) {
    if (_topMoversCache && _topMoversCache.data && (_topMoversCache.data.gainers || _topMoversCache.data.losers)) {
      html += '<div class="pstrip-divider"></div>';
    }
    for (var i = 0; i < portfolios.length; i++) {
      var p = portfolios[i];
      var count = p.holdings ? p.holdings.length : 0;
      var isActive = (typeof _activePortfolioIdx !== 'undefined' && _activePortfolioIdx === i);
      var riskColor = typeof getPortfolioRiskColor === 'function' ? getPortfolioRiskColor(p.holdings) : 'var(--muted)';
      var changeBadge;
      if (pm && pm[i] != null) {
        var val = pm[i];
        var cls = val > 0.005 ? 'up' : val < -0.005 ? 'down' : 'flat';
        var sign = val > 0 ? '+' : '';
        changeBadge = '<span class="pstrip-change ' + cls + '">' + sign + val.toFixed(2) + '%</span>';
      } else {
        changeBadge = '<span class="pstrip-change loading">\u2022\u2022\u2022</span>';
      }
      html += '<div class="pstrip-card' + (isActive ? ' active' : '') + '" onclick="loadPortfolio(' + i + ')" title="' + escapeHTML(p.name) + '" style="border-left-color:' + riskColor + '">'
        + '<div class="pstrip-info"><div class="pstrip-name">' + escapeHTML(p.name) + '</div>'
        + '<div class="pstrip-count">' + count + ' holding' + (count !== 1 ? 's' : '') + '</div></div>'
        + changeBadge
        + '</div>';
    }
  }

  strip.innerHTML = html;
  strip.classList.add('visible');
}

function _collectPortfolioTickers() {
  var portfolios = getSavedPortfolios();
  var tickerSet = {};
  for (var i = 0; i < portfolios.length; i++) {
    var h = portfolios[i].holdings;
    if (!h) continue;
    for (var j = 0; j < h.length; j++) {
      if (h[j].ticker) tickerSet[h[j].ticker.toUpperCase()] = true;
    }
  }
  return Object.keys(tickerSet);
}

async function fetchPortfolioPerformance(forceRefresh) {
  var portfolios = getSavedPortfolios();
  if (portfolios.length === 0) return null;
  var tickers = _collectPortfolioTickers();
  if (tickers.length === 0) return null;
  // Bust localStorage cache if force-refreshing
  if (forceRefresh) {
    // Clear all chunk caches
    for (var ci = 0; ci < tickers.length; ci += 40) {
      var chunk = tickers.slice(ci, ci + 40);
      var cacheKey = 'pc_market_' + chunk.slice().sort().join(',');
      try { localStorage.removeItem(cacheKey); } catch(e) {}
    }
  }
  // Fetch in batches of 40 (API hard cap)
  var marketData = {};
  for (var ci = 0; ci < tickers.length; ci += 40) {
    var chunk = tickers.slice(ci, ci + 40);
    var chunkData = await fetchMarketDataCached(chunk);
    if (chunkData) Object.assign(marketData, chunkData);
  }
  if (Object.keys(marketData).length === 0) return null;
  // Calculate weighted daily change for each portfolio
  var perfMap = {};
  for (var i = 0; i < portfolios.length; i++) {
    var h = portfolios[i].holdings;
    if (!h || h.length === 0) { perfMap[i] = 0; continue; }
    var totalPct = 0;
    var weightedChange = 0;
    for (var j = 0; j < h.length; j++) {
      var ticker = (h[j].ticker || '').toUpperCase();
      var pct = Number(h[j].pct) || 0;
      var md = marketData[ticker];
      if (md && md.changePct != null) {
        weightedChange += (pct / 100) * md.changePct;
      }
      totalPct += pct;
    }
    perfMap[i] = totalPct > 0 ? weightedChange : 0;
  }
  return perfMap;
}

window.refreshPortfolioStrip = async function() {
  var btn = document.getElementById('pstripRefresh');
  if (btn) {
    btn.classList.remove('spin-once');
    void btn.offsetWidth; // force reflow to restart animation
    btn.classList.add('spin-once');
    btn.disabled = true;
  }
  try {
    // Refresh top movers
    _topMoversCache = null;
    await fetchTopMovers();
    var tickers = _collectPortfolioTickers();
    console.log('[portfolio-strip] refreshing', tickers.length, 'tickers');
    var pm = await fetchPortfolioPerformance(true);
    if (pm) {
      renderPortfolioStrip(pm);
      showToast('\u2713 Prices updated');
    } else {
      renderPortfolioStrip(null);
      showToast('\u2713 Movers updated');
    }
  } catch(e) {
    console.warn('[portfolio-strip] refresh failed:', e);
    showToast('Refresh failed');
  }
  btn = document.getElementById('pstripRefresh');
  if (btn) { btn.classList.remove('spin-once'); btn.disabled = false; }
};

// Initialize portfolio strip on page load
(function initPortfolioStrip() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }
  function boot() {
    renderPortfolioStrip(null);
    // Fetch top movers first (always), then portfolio performance
    fetchTopMovers().then(function() {
      renderPortfolioStrip(null);
      return fetchPortfolioPerformance();
    }).then(function(perfMap) {
      if (perfMap) renderPortfolioStrip(perfMap);
    }).catch(function() {});
  }
})();

// Hook into existing functions to refresh the strip
(function hookPortfolioStrip() {
  // Helper: re-render strip then fetch fresh data in background
  function refreshStrip() {
    renderPortfolioStrip(null); // re-render immediately with cached data
    fetchPortfolioPerformance().then(function(pm) {
      if (pm) renderPortfolioStrip(pm);
    }).catch(function() {});
  }
  // Helper: re-render strip (active highlight etc) without refetching
  function refreshStripCheap() {
    renderPortfolioStrip(null); // uses _lastPerfMap fallback
  }

  // Wrap savePortfolio (already wrapped once for cloud sync)
  var prevSave = window.savePortfolio;
  window.savePortfolio = async function() {
    if (typeof prevSave === 'function') await prevSave();
    refreshStrip();
  };

  // Wrap deletePortfolio
  var prevDelete = window.deletePortfolio;
  window.deletePortfolio = function(idx) {
    if (typeof prevDelete === 'function') prevDelete(idx);
    refreshStrip();
  };

  // Wrap loadPortfolio
  var prevLoad = window.loadPortfolio;
  window.loadPortfolio = function(idx) {
    if (typeof prevLoad === 'function') prevLoad(idx);
    refreshStripCheap();
  };

  // Wrap renamePortfolio
  var prevRename = window.renamePortfolio;
  window.renamePortfolio = function(idx, newName) {
    if (typeof prevRename === 'function') prevRename(idx, newName);
    refreshStripCheap();
  };

  // Wrap clearAllHoldings
  var prevClear = window.clearAllHoldings;
  window.clearAllHoldings = function() {
    if (typeof prevClear === 'function') prevClear();
    renderPortfolioStrip(null);
    fetchPortfolioPerformance().then(function(pm) { renderPortfolioStrip(pm); }).catch(function() {});
  };

})();

========== FILE: public/index.html ==========
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Portfolio Compass</title>
<meta name="description" content="Analyze your stock portfolio, get AI-powered recommendations, and track sector exposure.">
<meta name="theme-color" content="#0a0c10">
<meta property="og:title" content="Portfolio Compass â€” AI Stock Portfolio Analyzer">
<meta property="og:description" content="Enter your holdings, get personalized AI-powered stock & ETF recommendations. See your risk level, diversification score, and sector gaps instantly.">
<meta property="og:image" content="https://pcompass.vercel.app/icons/icon-512.png">
<meta property="og:url" content="https://pcompass.vercel.app">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Portfolio Compass â€” AI Stock Portfolio Analyzer">
<meta name="twitter:description" content="Enter your holdings, get personalized AI-powered stock & ETF recommendations.">
<meta name="twitter:image" content="https://pcompass.vercel.app/icons/icon-512.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-192.png">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PCompass">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/styles.css">
<style>
  .splash-loader{position:fixed;inset:0;background:#0a0c10;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999999;transition:opacity 0.35s ease;}
  .splash-loader.fade-out{opacity:0;pointer-events:none;}
  body.light .splash-loader{background:#f4f6f9;}
  .splash-spinner{width:36px;height:36px;border:3px solid rgba(0,229,160,0.15);border-top-color:#00e5a0;border-radius:50%;animation:splashSpin 0.7s linear infinite;}
  @keyframes splashSpin{to{transform:rotate(360deg)}}
  .splash-text{margin-top:14px;font-family:'Space Mono',monospace;font-size:11px;color:#5a6478;letter-spacing:1px;}
</style>
</head>
<body>
<div class="splash-loader" id="splashLoader">
  <div class="splash-spinner"></div>
  <div class="splash-text">Loading...</div>
</div>

<header class="header-compact" onclick="window.scrollTo({top:0,behavior:'smooth'})" style="cursor:pointer;">
  <div class="logo">
    <div class="logo-icon">
      <div class="logo-icon-center"></div>
    </div>
    <h1>Portfolio <span>Compass</span></h1>
    <span class="tagline" style="display:none;">Portfolio Diversification &amp; Strategy Analyzer</span>
  </div>
  <div class="header-actions" style="display:none;">
    <button onclick="showPaywall('header')" id="btnPro" style="display:none;">âœ¦ Get Pro</button>
    <button class="user-pill" id="userPill" onclick="event.stopPropagation();toggleSidebar()" style="display:none;">
      <span class="user-pill-name" id="userPillName">â˜° Menu</span>
      <span class="user-pill-avatar" id="userPillAvatar"></span>
      <span class="user-pill-chevron">â–¸</span>
    </button>
  </div>
</header>

<!-- Sidebar backdrop + panel -->
<div class="sidebar-backdrop" id="sidebarBackdrop" onclick="closeSidebar()"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button class="sidebar-close" onclick="closeSidebar()">âœ•</button>
  </div>
  <div class="sidebar-user" id="sidebarUser"></div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">Quick Access</div>
    <div class="sidebar-nav-links" id="sidebarNavLinks">
      <button class="sidebar-nav-btn" onclick="closeSidebar();navTo('market')"><span class="sidebar-nav-icon">&#9679;</span> Market Overview</button>
      <button class="sidebar-nav-btn" onclick="closeSidebar();navTo('charts')"><span class="sidebar-nav-icon">&#9651;</span> Charts</button>
      <button class="sidebar-nav-btn" onclick="closeSidebar();navTo('explore')"><span class="sidebar-nav-icon">&#9733;</span> Explore Stocks</button>
      <button class="sidebar-nav-btn" onclick="closeSidebar();navTo('analysis')"><span class="sidebar-nav-icon">&#9670;</span> Analysis</button>
      <button class="sidebar-nav-btn" onclick="closeSidebar();navTo('portfolios')"><span class="sidebar-nav-icon">&#9776;</span> My Portfolios</button>
    </div>
  </div>
  <div class="sidebar-section">
    <div class="sidebar-section-title">Settings</div>
    <div class="sidebar-settings" id="sidebarSettings"></div>
  </div>
  <div class="sidebar-section" id="sidebarAccount"></div>
  <div class="sidebar-footer">
    <a href="/privacy.html">Privacy</a> Â· <a href="/terms.html">Terms</a> Â· <a href="/support.html">Support</a>
  </div>
</div>

<div class="main-grid container">
  <!-- Left: Input Panel -->
  <div>
    <div class="panel">
      <div class="panel-header" style="display:flex;align-items:center;justify-content:space-between;">
        <h2 class="section-title">Your Holdings</h2>
        <div style="display:flex;gap:6px;align-items:center;">
          <button class="slot-btn" id="btnClearAll" onclick="clearAllHoldings()" title="Clear all holdings">ðŸ—‘</button>
          <button class="slot-btn" id="btnQuickSave" onclick="savePortfolio()" title="Save portfolio" style="display:none;">ðŸ’¾</button>
          <button class="slot-btn" onclick="sharePortfolio()" title="Share portfolio link">ðŸ”—</button>
          <button class="slot-btn" onclick="exportPDF()" title="Export PDF">â¬‡</button>
        </div>
      </div>

      <div class="portfolio-strip" id="portfolioStrip"></div>

      <div id="holdingsBody">
      <!-- Onboarding banner (hidden after first use) -->
      <div class="onboarding-banner" id="onboardingBanner" style="position:relative;">
        <div class="onboarding-text">ðŸ‘‹ <strong>Welcome!</strong> Add your stock holdings below, or try an example portfolio to see how it works.</div>
        <div class="onboarding-examples">
          <button class="btn-example" onclick="loadExample('tech')">ðŸš€ Aggressive</button>
          <button class="btn-example" onclick="loadExample('balanced')">âš–ï¸ Balanced</button>
          <button class="btn-example" onclick="loadExample('conservative')">ðŸ›¡ï¸ Conservative</button>
          <button class="btn-example" onclick="loadExample('crypto')">â‚¿ Crypto Mix</button>
        </div>
        <button onclick="document.getElementById('onboardingBanner').style.display='none'" style="position:absolute;top:8px;right:10px;background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;line-height:1;padding:2px 5px;border-radius:3px;transition:color 0.15s;" onmouseover="this.style.color='var(--text)'" onmouseout="this.style.color='var(--muted)'">Ã—</button>
      </div>


      <!-- Screenshot upload (collapsible) -->
      <div id="inputSections">
      <div class="upload-compact-trigger" onclick="expandUploadZone(this)">
        <span class="upload-compact-icon">ðŸ“·</span>
        <span>Import from screenshots</span>
        <span class="upload-compact-chevron">â–¸</span>
      </div>
      <div class="upload-expanded" id="uploadExpanded">
      <div class="upload-zone" id="uploadZone">
        <input type="file" accept="image/*" multiple onchange="handleScreenshot(event)" />
        <div class="upload-icon">ðŸ“·</div>
        <div class="upload-text"><strong>Drop or tap to upload screenshots</strong><br>Large portfolios? Just snap several pics!</div>
        <div class="scanning-overlay" id="scanningOverlay">
          <div class="scan-spinner"></div>
          <div class="scan-text" id="scanText">Scanning portfolio...</div>
        </div>
      </div>
      </div>

      <!-- Import preview -->
      <div class="import-preview" id="importPreview">
        <div class="import-preview-header">
          <span class="import-note" id="importNote"></span>
          <button class="btn-import-all" onclick="importAll()">Add All</button>
        </div>
        <div class="preview-items" id="previewItems"></div>
      </div>

      <!-- Manual input -->
      <div style="padding:0 24px;"><div style="font-family:'Space Mono',monospace;font-size:10px;color:#5a6478;letter-spacing:0.5px;text-transform:uppercase;margin-bottom:6px;">Or enter manually</div></div>
      <div class="stock-form">
        <div class="input-row">
          <div class="autocomplete-wrapper" style="position:relative;flex:1;">
            <input type="text" id="tickerInput" placeholder="Ticker (e.g. AAPL)" maxlength="6" style="text-transform:uppercase" autocomplete="off" />
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
          </div>
          <input type="number" id="pctInput" placeholder="%" min="0.1" max="100" step="0.1" />
        </div>
        <button class="btn-add" onclick="addStock()">+</button>
        <div class="error-msg" id="errorMsg"></div>
      </div>
      </div>

      <div class="holdings-view-toggle" id="holdingsViewToggle" style="display:none">
        <button class="view-btn" onclick="setHoldingsView('list')" data-view="list">List</button>
        <button class="view-btn active" onclick="setHoldingsView('chart')" data-view="chart">Charts</button>
      </div>
      <div class="stock-list" id="stockList"></div>

      <div class="portfolio-summary">
        <span class="summary-chip" id="summaryChip">0% allocated</span>
      </div>

      <!-- Risk score -->
      <div class="risk-score-bar" id="riskScoreBar" style="display:none">
        <span class="risk-score-label">Portfolio Risk</span>
        <div class="risk-score-track"><div class="risk-score-fill" id="riskScoreFill"></div></div>
        <span class="risk-score-num" id="riskScoreNum"></span>
      </div>

      <!-- Correlation warnings -->
      <div class="correlation-warnings" id="corrWarnings"></div>

      <!-- What-if simulator -->
      <div class="whatif-panel" id="whatifPanel" style="display:none">
        <div class="whatif-header" onclick="toggleWhatIf()">
          <span class="whatif-title">âš¡ What-If Simulator â€” test a new position</span>
          <span class="whatif-toggle" id="whatifToggleIcon">â–¸ expand</span>
        </div>
        <div class="whatif-body" id="whatifBody">
          <div class="whatif-row">
            <div class="autocomplete-wrapper" style="position:relative;flex:1;">
              <input type="text" id="whatifTicker" placeholder="Add ticker..." maxlength="6" style="text-transform:uppercase" autocomplete="off" />
              <div class="autocomplete-dropdown" id="whatifAutocompleteDropdown"></div>
            </div>
            <input type="number" id="whatifPct" placeholder="%" min="0.1" max="100" step="0.1" />
          </div>
          <div class="whatif-result" id="whatifResult">Enter a ticker to preview its impact on your portfolio.</div>
        </div>
      </div>

      <button class="btn-analyze" id="analyzeBtn" onclick="analyzeDebounced()" disabled>
        Analyze
      </button>
      </div><!-- /holdingsBody -->
    </div>
  </div>

  <!-- Right: Results Panel -->
  <div>
    <div class="results-panel" id="resultsPanel">
      <div class="empty-state">
        <div class="empty-compass">
          <div class="empty-compass-ring"></div>
          <div class="empty-compass-needle"></div>
          <div class="empty-compass-center"></div>
        </div>
        <div class="empty-state-title">Ready to analyze</div>
        <div class="empty-state-hint">Add your US stock holdings on the left, then click<br><strong>Analyze</strong></div>
      </div>
    </div>
  </div>
</div>


<!-- Bottom Nav Bar -->
<nav class="bottom-bar" id="bottomBar">
  <button class="bottom-bar-tab active" onclick="navTo('portfolios')" id="navPortfolios">
    <svg class="bottom-bar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
    <span>Portfolios</span>
  </button>
  <button class="bottom-bar-tab" onclick="navTo('market')" id="navMarket">
    <svg class="bottom-bar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22,7 13.5,15.5 8.5,10.5 2,17"/><polyline points="16,7 22,7 22,13"/></svg>
    <span>Market</span>
  </button>
  <button class="bottom-bar-tab" onclick="navTo('charts')" id="navCharts">
    <svg class="bottom-bar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><polyline points="7,16 11,11 14,14 17,8"/></svg>
    <span>Charts</span>
  </button>
  <button class="bottom-bar-tab" onclick="navTo('explore')" id="navExplore">
    <svg class="bottom-bar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="16.24,7.76 14.12,14.12 7.76,16.24 9.88,9.88"/></svg>
    <span>Explore</span>
  </button>
  <button class="bottom-bar-tab" onclick="navTo('analysis')" id="navAnalysis">
    <svg class="bottom-bar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="12" width="4" height="9"/><rect x="10" y="8" width="4" height="13"/><rect x="17" y="3" width="4" height="18"/></svg>
    <span>Analysis</span>
  </button>
  <button class="bottom-bar-tab" onclick="navTo('user')" id="navUser">
    <svg class="bottom-bar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    <span>Account</span>
  </button>
</nav>

  <div class="share-toast" id="shareToast">ðŸ”— Link copied to clipboard!</div>

<!-- AUTH MODAL -->
<div id="authModal" style="display:none;position:fixed;inset:0;z-index:200000;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);" onclick="if(event.target===this)closeAuthModal()">
  <div style="background:#0f1318;border:1px solid #1e2430;border-radius:16px;padding:36px 32px;max-width:360px;width:90%;font-family:Inter,sans-serif;position:relative;">
    <button onclick="closeAuthModal()" style="position:absolute;top:14px;right:16px;background:none;border:none;color:#8a9ab8;font-size:18px;cursor:pointer;">Ã—</button>
    <div style="text-align:center;margin-bottom:20px;">
      <h2 style="color:#e8ecf0;font-size:20px;font-weight:700;margin:0 0 6px;">Sign In</h2>
      <p style="color:#8a9ab8;font-size:12px;margin:0;">Save portfolios & sync across devices</p>
    </div>
    <!-- Google Sign In â€” GIS renders its own button here -->
    <div id="googleSignInContainer" style="display:none;width:100%;min-height:44px;margin-bottom:0;"></div>
    <button id="googleSignInFallback" onclick="googleSignIn()" style="width:100%;padding:11px;border-radius:10px;border:1px solid #2a2f3e;background:#1a1f2e;color:#e8ecf0;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-family:Inter,sans-serif;">
      <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>
    <!-- Apple Sign In -->
    <button onclick="closeAuthModal();appleSignIn()" style="width:100%;padding:11px;border-radius:10px;border:1px solid #2a2f3e;background:#000;color:#fff;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;font-family:Inter,sans-serif;margin-top:8px;">
      <svg width="16" height="16" viewBox="0 0 24 24"><path fill="#fff" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/></svg>
      Continue with Apple
    </button>
  </div>
</div>

<!-- PAYWALL MODAL -->
<div id="paywallModal" style="display:none;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);" onclick="if(event.target===this)closePaywall()">
  <div class="pw-card">
    <button onclick="closePaywall()" class="pw-close">Ã—</button>

    <!-- Hero -->
    <div class="pw-hero">
      <div class="pw-icon-ring">
        <svg width="24" height="24" viewBox="0 0 48 48" fill="none">
          <polygon points="24,6 28,22 24,19 20,22" fill="#00e5a0"/>
          <polygon points="24,42 28,26 24,29 20,26" fill="#a78bfa" opacity="0.7"/>
          <circle cx="24" cy="24" r="2.5" fill="#fff"/>
        </svg>
      </div>
      <h2 class="pw-title">Upgrade to Pro</h2>
      <p id="paywallMsg" class="pw-subtitle"></p>
    </div>

    <!-- Features -->
    <div class="pw-features">
      <div class="pw-feat"><span class="pw-check">&#10003;</span>Unlimited AI analysis</div>
      <div class="pw-feat"><span class="pw-check">&#10003;</span>Screenshot import</div>
      <div class="pw-feat"><span class="pw-check">&#10003;</span>Expanded stock &amp; ETF picks</div>
      <div class="pw-feat"><span class="pw-check">&#10003;</span>PDF export &amp; sharing</div>
      <div class="pw-feat"><span class="pw-check">&#10003;</span>Cloud sync</div>
      <div class="pw-feat"><span class="pw-check">&#10003;</span>Unlimited portfolios</div>
    </div>

    <!-- Tiers -->
    <div class="pw-tiers" id="pwTiers">
      <div id="tier-monthly" class="pw-tier pw-tier-selected" data-tier="monthly">
        <div class="pw-tier-badge">Popular</div>
        <div class="pw-tier-name">Monthly</div>
        <div class="pw-tier-price"></div>
        <div class="pw-tier-note">Cancel anytime</div>
      </div>
      <div id="tier-annual" class="pw-tier" data-tier="annual">
        <div class="pw-tier-badge pw-tier-badge-save">Save 37%</div>
        <div class="pw-tier-name">Annual</div>
        <div class="pw-tier-price"></div>
        <div class="pw-tier-note">Billed yearly</div>
      </div>
      <div id="tier-lifetime" class="pw-tier" data-tier="lifetime">
        <div class="pw-tier-badge pw-tier-badge-deal">Best Deal</div>
        <div class="pw-tier-name">Lifetime</div>
        <div class="pw-tier-price"></div>
        <div class="pw-tier-note">Pay once, own forever</div>
      </div>
    </div>

    <!-- CTA -->
    <button id="paywallConfirmBtn" class="pw-cta"></button>
    <button onclick="restorePurchases()" class="pw-restore">Restore Purchases</button>
  </div>
</div>

<footer style="text-align:center;padding:24px 0 12px;font-family:'Space Mono',monospace;font-size:9px;color:#5a6478;">
  <a href="/privacy.html" style="color:#5a6478;text-decoration:none;">Privacy Policy</a> &middot; <a href="/terms.html" style="color:#5a6478;text-decoration:none;">Terms of Service</a> &middot; <a href="/support.html" style="color:#5a6478;text-decoration:none;">Support</a>
</footer>

<script src="/data.js"></script>
<script src="/app.js"></script>
<script src="/patches.js"></script>
<script>
(function(){
  var splash = document.getElementById('splashLoader');
  if (!splash) return;
  function dismiss() {
    splash.classList.add('fade-out');
    setTimeout(function(){ splash.remove(); }, 400);
  }
  if (document.readyState === 'complete') dismiss();
  else window.addEventListener('load', dismiss);
})();
</script>
</body>
</html>

========== FILE: public/styles.css ==========
  :root {
    --bg: #0a0c10;
    --surface: #111318;
    --surface2: #181c24;
    --border: #1e2430;
    --accent: #00e5a0;
    --text: #e8ecf0;
    --muted: #9aabc4;
    --aggressive: #ff8c42;
    --moderate: #ffd166;
    --conservative: #06d6a0;
    /* Glassmorphism */
    --glass-bg: rgba(17,19,24,0.65);
    --glass-border: rgba(255,255,255,0.06);
    --glass-blur: 16px;
    --glass-shadow: 0 4px 24px rgba(0,0,0,0.4), 0 1px 0 rgba(255,255,255,0.04) inset;
    /* Glow */
    --accent-glow: 0 0 20px rgba(0,229,160,0.25);
    --accent-glow-strong: 0 0 30px rgba(0,229,160,0.4), 0 0 60px rgba(0,229,160,0.15);
    --accent-glow-subtle: 0 0 12px rgba(0,229,160,0.12);
    --aggressive-glow: 0 0 20px rgba(255,140,66,0.3);
    --moderate-glow: 0 0 20px rgba(255,209,102,0.3);
    --conservative-glow: 0 0 20px rgba(6,214,160,0.3);
    /* Gradients */
    --accent-gradient: linear-gradient(135deg, #00e5a0, #00d4ff);
    --accent-gradient-text: linear-gradient(135deg, #00e5a0, #a78bfa);
    /* Transitions */
    --transition-fast: 0.15s cubic-bezier(0.4,0,0.2,1);
    --transition-med: 0.25s cubic-bezier(0.4,0,0.2,1);
    --transition-slow: 0.4s cubic-bezier(0.4,0,0.2,1);
  }

  body.light {
    --bg: #f4f6f9;
    --surface: #ffffff;
    --surface2: #eef1f6;
    --border: #dde2ec;
    --text: #0f1623;
    --muted: #8a9ab8;
    --aggressive: #d06820;
    --moderate: #c49500;
    --conservative: #00a87a;
    --glass-bg: rgba(255,255,255,0.7);
    --glass-border: rgba(0,0,0,0.06);
    --glass-blur: 16px;
    --glass-shadow: 0 4px 24px rgba(0,0,0,0.06), 0 1px 0 rgba(255,255,255,0.8) inset;
    --accent-glow: 0 0 16px rgba(0,168,122,0.15);
    --accent-glow-strong: 0 0 24px rgba(0,168,122,0.2);
    --accent-glow-subtle: 0 0 10px rgba(0,168,122,0.08);
    --aggressive-glow: 0 0 16px rgba(208,104,32,0.15);
    --moderate-glow: 0 0 16px rgba(196,149,0,0.15);
    --conservative-glow: 0 0 16px rgba(0,168,122,0.15);
  }

  
  /* Theme toggle button */
  .theme-toggle {
    position: absolute;
    right: 5%;
    top: 12px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 5px 5px 5px 10px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: background var(--transition-fast), border-color var(--transition-fast), box-shadow var(--transition-fast);
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    user-select: none;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  }
  .theme-toggle:hover { border-color: var(--accent); color: var(--text); box-shadow:var(--accent-glow-subtle); }
  .theme-toggle-track {
    width: 28px;
    height: 16px;
    background: var(--border);
    border-radius: 8px;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  body.light .theme-toggle-track { background: var(--accent); }
  .theme-toggle-thumb {
    width: 12px;
    height: 12px;
    background: var(--muted);
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: transform 0.2s, background 0.2s;
  }
  body.light .theme-toggle-thumb { transform: translateX(12px); background: #000; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; min-height:100vh; overflow-x:hidden; padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom); touch-action:pan-x pan-y; }
  body::before {
    content:''; position:fixed; inset:0;
    background-image:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0,229,160,0.07) 0%, transparent 60%),
      linear-gradient(rgba(0,229,160,0.03) 1px,transparent 1px),
      linear-gradient(90deg,rgba(0,229,160,0.03) 1px,transparent 1px);
    background-size:100% 100%, 40px 40px, 40px 40px; pointer-events:none; z-index:0;
  }
  body.light::before { display:none; }
  body.light .panel, body.light .strategy-card, body.light .health-panel, body.light .rebalance-panel, body.light .position-panel { box-shadow:var(--glass-shadow); background:var(--glass-bg); }
  body.light .strategy-card:hover { box-shadow:0 4px 18px rgba(0,0,0,0.12), var(--accent-glow-subtle); }
  .container { max-width:1400px; margin:0 auto; padding:0 24px; }
  header {
    padding:28px 5% 20px;
    display:flex; flex-direction:column; gap:6px;
    border-bottom:1px solid var(--glass-border);
    position:sticky; top:0; z-index:10001;
    background:var(--glass-bg);
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    box-shadow:0 4px 30px rgba(0,0,0,0.3);
    transition:padding 0.25s ease, gap 0.25s ease;
  }
  header::after {
    content:''; position:absolute; bottom:-1px; left:0; right:0; height:1px;
    background:linear-gradient(90deg, transparent 0%, rgba(0,229,160,0.4) 30%, rgba(0,229,160,0.6) 50%, rgba(0,229,160,0.4) 70%, transparent 100%);
    pointer-events:none;
  }
  header.header-compact {
    padding:10px 5% 10px;
    gap:0;
  }
  header.header-compact .tagline { font-size:10px; margin-left:0; opacity:0.5; }
  header.header-compact .logo-icon { width:28px; height:28px; }
  header.header-compact .logo-icon::before { border-bottom-width:9px; top:2px; border-left-width:3px; border-right-width:3px; }
  header.header-compact .logo-icon::after { border-top-width:9px; bottom:2px; border-left-width:3px; border-right-width:3px; }
  header.header-compact .logo-icon-center { width:3px; height:3px; }
  header.header-compact .logo h1 { font-size:22px; }
  header.header-compact .logo { gap:8px; }
  .header-actions {
    position:absolute; right:5%; top:12px;
    display:flex; align-items:center; gap:8px;
  }
  /* User pill in header */
  .user-pill {
    display:flex; align-items:center; gap:6px;
    background:var(--surface2); border:1px solid var(--border); border-radius:20px;
    padding:4px 12px 4px 10px; cursor:pointer;
    font-family:'DM Sans',sans-serif; font-size:12px; font-weight:600;
    color:var(--text); transition:border-color 0.2s, background 0.2s;
    white-space:nowrap;
  }
  .user-pill:hover { border-color:var(--accent); }
  .user-pill-avatar {
    width:22px; height:22px; border-radius:50%; display:none;
    border:1.5px solid var(--accent); object-fit:cover;
  }
  .user-pill-avatar.visible { display:block; }
  .user-pill-avatar.initials {
    display:flex; align-items:center; justify-content:center;
    background:var(--surface2); color:var(--accent);
    font-size:10px; font-weight:700; font-family:'DM Sans',sans-serif;
    border:1.5px solid var(--accent); width:22px; height:22px; border-radius:50%;
  }
  .user-pill-chevron { font-size:10px; color:var(--muted); }
  .switcher-save-btn {
    background: rgba(0,229,160,0.1); border: 1px solid rgba(0,229,160,0.3); border-radius: 8px;
    padding: 5px 12px; cursor: pointer;
    font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700; color: var(--accent);
    letter-spacing: 0.5px; transition: border-color 0.2s, background 0.2s;
    white-space: nowrap;
  }
  .switcher-save-btn:hover { border-color: var(--accent); background: rgba(0,229,160,0.18); }
  .logo { display:flex; align-items:center; gap:12px; }
  .logo-icon {
    width:42px; height:42px;
    border:1.5px solid #2a3140;
    border-radius:50%;
    position:relative;
    display:flex; align-items:center; justify-content:center;
    background:var(--bg);
    flex-shrink:0;
  }
  .logo-icon::before {
    content:'';
    position:absolute;
    width:0; height:0;
    border-left:4px solid transparent;
    border-right:4px solid transparent;
    border-bottom:13px solid var(--accent);
    top:4px;
    filter:drop-shadow(0 0 4px rgba(0,229,160,0.6));
  }
  .logo-icon::after {
    content:'';
    position:absolute;
    width:0; height:0;
    border-left:4px solid transparent;
    border-right:4px solid transparent;
    border-top:13px solid var(--aggressive);
    bottom:4px;
    opacity:0.55;
  }
  .logo-icon-center {
    width:4px; height:4px;
    background:var(--text);
    border-radius:50%;
    position:absolute;
    z-index:2;
  }

  .logo h1 { font-size:32px; font-weight:400; letter-spacing:2px; color:var(--text); font-family:'Bebas Neue',sans-serif; line-height:1; text-transform:uppercase; }
  .logo h1 span { background:var(--accent-gradient-text); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-family:'Bebas Neue',sans-serif; letter-spacing:2px; }
  .tagline { color:var(--muted); font-family:'Space Mono',monospace; font-size:11px; letter-spacing:0.3px; margin-left:0; white-space:nowrap; }
  .main-grid { display:grid; grid-template-columns:1fr; gap:24px; padding:28px 2%; position:relative; max-width:800px; margin:0 auto; }
  .panel, .strategy-card, .health-panel, .rebalance-panel, .position-panel { background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:16px; overflow:hidden; box-shadow:var(--glass-shadow); backdrop-filter:blur(var(--glass-blur)); -webkit-backdrop-filter:blur(var(--glass-blur)); transition:transform var(--transition-med), box-shadow var(--transition-med); }
  .panel-header { padding:16px 20px 12px; border-bottom:1px solid var(--border); }
  .section-title { font-size:13px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); font-family:'Space Mono',monospace; }
  
  /* Stock input */
  .stock-form { padding:20px 24px; }
  .input-row { display:grid; grid-template-columns:1fr 80px; gap:8px; margin-bottom:12px; }
  input[type="text"],input[type="number"] {
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    padding:10px 14px; color:var(--text); font-family:'Space Mono',monospace; font-size:13px;
    outline:none; transition:border-color 0.2s; width:100%;
  }
  input[type="text"]:focus,input[type="number"]:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,229,160,0.2), var(--accent-glow-subtle); background:rgba(0,229,160,0.02); }
  input::placeholder { color:var(--muted); }
  .btn-add {
    background:var(--accent); color:#000; border:none; border-radius:8px;
    padding:10px 14px; font-family:'DM Sans',sans-serif; font-weight:600; font-size:18px;
    cursor:pointer; transition:opacity var(--transition-fast),transform var(--transition-fast),box-shadow var(--transition-fast); line-height:1;
  }
  .btn-add:hover { opacity:0.85; transform:scale(1.05); box-shadow:var(--accent-glow); }
  .btn-add:active { transform:scale(0.94); box-shadow:none; }
  .error-msg { color:var(--aggressive); font-size:11px; font-family:'Space Mono',monospace; padding:4px 0 8px; }

  /* Stocks list */
  .stock-list { padding:16px 24px 12px; display:flex; flex-direction:column; gap:4px; min-height:40px; }
  .stock-item {
    display:flex; align-items:center; justify-content:space-between;
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    padding:7px 14px; animation:slideIn 0.2s ease;
  }
  @keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
  .stock-info { display:flex; align-items:center; gap:12px; }
  .stock-ticker { font-family:'DM Sans',sans-serif; font-size:15px; font-weight:700; color:var(--text); letter-spacing:0.3px; }
  .stock-company { font-size:12px; color:var(--muted); font-family:'DM Sans',sans-serif; opacity:0.7; }
  .stock-sector { font-size:10px; color:var(--muted); font-family:'DM Sans',sans-serif; letter-spacing:0.2px; }
  .stock-weight { font-family:'Space Mono',monospace; font-size:12px; color:var(--accent); font-weight:700; }
  .btn-remove { background:none; border:none; color:var(--muted); cursor:pointer; padding:0 2px; font-size:16px; transition:color 0.2s; }
  .btn-remove:hover { color:var(--aggressive); }

  /* Portfolio summary */
  .portfolio-summary { padding:16px 24px 20px; border-top:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; }
  .summary-chip { background:var(--surface2); border:1px solid var(--border); border-radius:6px; padding:6px 12px; font-size:11px; font-family:'Space Mono',monospace; color:var(--muted); }

  /* Analyze button */
  .btn-analyze {
    margin:0 24px 20px; padding:14px; width:calc(100% - 48px);
    background:linear-gradient(135deg,var(--accent),#00b87a); color:#000; border:none; border-radius:12px;
    font-family:'DM Sans',sans-serif; font-weight:600; font-size:13px; letter-spacing:0.5px; cursor:pointer;
    transition:opacity var(--transition-fast),transform 0.1s,box-shadow var(--transition-med);
    box-shadow:var(--accent-glow);
    position:relative; overflow:hidden;
  }
  .btn-analyze::before {
    content:''; position:absolute; top:0; left:-100%; width:60%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition:none; pointer-events:none;
  }
  .btn-analyze:hover { transform:translateY(-1px); box-shadow:var(--accent-glow-strong); }
  .btn-analyze:hover::before { left:120%; transition:left 0.6s ease; }
  .btn-analyze:active { transform:scale(0.97); box-shadow:0 2px 10px rgba(0,229,160,0.15); }
  .btn-analyze:disabled { opacity:0.4; cursor:not-allowed; box-shadow:none; }
  .btn-analyze:disabled::before { display:none; }
  .btn-analyze.analyzing { animation:analyzingPulse 1.5s ease-in-out infinite; }
  @keyframes analyzingPulse {
    0%,100% { box-shadow:0 0 20px rgba(0,229,160,0.3); }
    50% { box-shadow:0 0 40px rgba(0,229,160,0.6), 0 0 80px rgba(0,229,160,0.2); }
  }

  /* Empty state */
  .empty-state { padding:60px 24px; text-align:center; }
  .placeholder-icon { font-size:48px; margin-bottom:16px; opacity:0.3; }
  .placeholder-text { color:var(--muted); font-family:'Space Mono',monospace; font-size:13px; line-height:1.7; }

  /* Strategy card */
  .strategy-card { animation:fadeUp 0.4s ease backwards; transition:transform var(--transition-med),box-shadow var(--transition-med),border-color var(--transition-med); }
  .strategy-card:hover { transform:translateY(-3px); box-shadow:var(--glass-shadow), var(--accent-glow-subtle); }
  .strategy-card:has(.badge-aggressive):hover { border-color:rgba(255,140,66,0.4); box-shadow:var(--glass-shadow), var(--aggressive-glow); }
  .strategy-card:has(.badge-moderate):hover { border-color:rgba(255,209,102,0.4); box-shadow:var(--glass-shadow), var(--moderate-glow); }
  .strategy-card:has(.badge-conservative):hover { border-color:rgba(6,214,160,0.4); box-shadow:var(--glass-shadow), var(--conservative-glow); }
  @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .strategy-card:nth-child(2){animation-delay:0.1s}
  .strategy-card:nth-child(3){animation-delay:0.2s}
  .strategy-header {
    padding:18px 24px; display:flex; align-items:center; justify-content:space-between;
    border-bottom:1px solid var(--border);
  }
  .strategy-label { display:flex; align-items:flex-start; gap:6px; flex-wrap:wrap; max-width:65%; }
  .strategy-best-match-slot { display:block; width:100%; margin-top:-2px; }
  .strategy-badge {
    padding:4px 10px; border-radius:20px; font-size:10px; font-weight:600;
    letter-spacing:1.5px; text-transform:uppercase; font-family:'Space Mono',monospace;
  }
  .badge-aggressive { background:rgba(255,140,66,0.15); color:var(--aggressive); border:1px solid rgba(255,140,66,0.3); box-shadow:0 0 8px rgba(255,140,66,0.15); }
  .badge-moderate { background:rgba(255,209,102,0.15); color:var(--moderate); border:1px solid rgba(255,209,102,0.3); box-shadow:0 0 8px rgba(255,209,102,0.15); }
  .badge-conservative { background:rgba(6,214,160,0.15); color:var(--conservative); border:1px solid rgba(6,214,160,0.3); box-shadow:0 0 8px rgba(6,214,160,0.15); }
  .strategy-desc { font-size:12px; color:var(--muted); font-family:'Space Mono',monospace; max-width:200px; text-align:right; line-height:1.5; }
  .strategy-toggle { cursor:pointer; user-select:none; }
  .strategy-chevron { font-size:12px; color:var(--muted); transition:transform 0.25s ease; display:inline-block; }
  .strategy-chevron-open { transform:rotate(180deg); }
  .strategy-expand-hint { font-size:10px; color:var(--muted); margin-left:6px; font-weight:400; }
  .panel-toggle { cursor:pointer; user-select:none; display:flex; align-items:center; gap:0; }
  .panel-toggle .section-title { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .panel-chevron { font-size:12px; color:var(--muted); transition:transform 0.25s ease; display:inline-block; }
  .panel-chevron-open { transform:rotate(180deg); }
  .panel-expand-hint { font-size:10px; color:var(--muted); margin-left:6px; font-weight:400; white-space:nowrap; }
  .panel-body { transition:all 0.25s ease; }
  .panel-body-collapsed { display:none; }
  .etf-list { padding:12px 16px 16px; display:flex; flex-direction:column; gap:8px; }
  .etf-list.strategy-collapsed { display:none; }

  /* ETF / Stock items */
  .etf-item {
    background:var(--surface2); border:1px solid var(--border); border-radius:10px;
    overflow:hidden; transition:border-color var(--transition-fast),box-shadow var(--transition-fast),transform var(--transition-fast); cursor:pointer;
  }
  .etf-item:hover { border-color:var(--accent); box-shadow:var(--accent-glow); transform:translateY(-1px); }
  .etf-item:active { transform:scale(0.99); }
  .etf-item.open { border-color:var(--accent); }
  .etf-item-header { padding:11px 14px; display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
  .ticker-name-group { display:flex; align-items:center; gap:10px; }
  .ticker-with-tag { display:flex; flex-direction:column; align-items:flex-start; gap:3px; min-width:60px; }
  .etf-ticker, .pick-ticker { font-family:'Space Mono',monospace; font-size:14px; font-weight:700; color:var(--text); }
    .item-type-tag { font-family:'Space Mono',monospace; font-size:8px; font-weight:700; letter-spacing:1px; padding:1px 5px; border-radius:3px; }
  .tag-etf { background:rgba(77,159,255,0.15); color:#4d9fff; border:1px solid rgba(77,159,255,0.3); }
  .tag-stock { background:rgba(255,140,66,0.12); color:var(--aggressive); border:1px solid rgba(255,140,66,0.25); }
  .etf-details h4, .pick-details h4 { font-size:13px; font-weight:600; color:var(--text); margin-bottom:2px; }
  .etf-details p,.pick-details p { font-size:12px; color:var(--muted); font-family:'Space Mono',monospace; }
    .etf-meta,.pick-meta { text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
    .match-score { font-family:'Space Mono',monospace; font-size:11px; padding:2px 8px; border-radius:4px; font-weight:700; }
  .match-high { background:rgba(0,229,160,0.15); color:var(--accent); box-shadow:0 0 6px rgba(0,229,160,0.2); }
  .match-med { background:rgba(255,209,102,0.15); color:var(--moderate); box-shadow:0 0 6px rgba(255,209,102,0.15); }
  .pick-sector-tag { font-family:'Space Mono',monospace; font-size:10px; padding:2px 7px; border-radius:4px; display:inline-block; }
  .etf-meta .pick-sector-tag { background:rgba(77,159,255,0.15); color:#4d9fff; border:1px solid rgba(77,159,255,0.3); }
  .pick-meta .pick-sector-tag { background:rgba(255,140,66,0.1); color:var(--aggressive); border:1px solid rgba(255,140,66,0.25); }
  .pick-risk { font-family:'Space Mono',monospace; font-size:12px; font-weight:700; }
  
  /* Why hint */
  .etf-hint, .pick-hint {
    padding:0 14px 9px; font-family:'Space Mono',monospace; font-size:10px;
    color:var(--accent); opacity:0.55; letter-spacing:0.5px;
    display:flex; align-items:center; gap:5px; transition:opacity 0.2s;
  }
  .etf-item:hover .etf-hint, .etf-item:hover .pick-hint { opacity:1; }
  .etf-item.open .etf-hint, .etf-item.open .pick-hint { display:none; }

  /* Drawer */
  .etf-drawer,.pick-drawer { max-height:0; overflow:hidden; transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1); }
  .etf-item.open .etf-drawer,.etf-item.open .pick-drawer { max-height:300px; }
  .etf-drawer-inner,.pick-drawer-inner {
    margin:0 12px 12px; background:rgba(0,229,160,0.05);
    border:1px solid rgba(0,229,160,0.15); border-radius:8px; padding:12px 14px;
  }
  .pick-drawer-inner { background:rgba(255,140,66,0.05); border-color:rgba(255,140,66,0.15); }
  .etf-drawer-label,.pick-drawer-label {
    font-family:'Space Mono',monospace; font-size:10px; font-weight:700;
    color:var(--accent); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:7px;
  }
  .pick-drawer-label { color:var(--aggressive); }
  .etf-drawer-text,.pick-drawer-text { font-family:'Space Mono',monospace; font-size:12px; color:var(--text); line-height:1.7; opacity:0.85; }
  .etf-drawer-loading { display:flex; align-items:center; gap:8px; font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); }
  .mini-spinner { width:12px; height:12px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; flex-shrink:0; }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Analysis bar */
  .analysis-bar { background:var(--glass-bg); border:1px solid var(--glass-border); border-radius:16px; padding:20px 24px 16px; animation:fadeUp 0.3s ease; backdrop-filter:blur(var(--glass-blur)); -webkit-backdrop-filter:blur(var(--glass-blur)); box-shadow:var(--glass-shadow); }
  .analysis-bar-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:10px; }
  .analysis-bar-header h2 { margin:0; }
  .breakdown-legend { display:flex; gap:8px; align-items:center; flex-wrap:nowrap; overflow-x:auto; }
  .legend-item { display:flex; align-items:center; gap:5px; font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; }
  .legend-hint { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); opacity:0.45; font-style:italic; margin-left:2px; }
  .legend-dot { width:10px; height:6px; border-radius:2px; flex-shrink:0; }
  .legend-dot-current { background:#64748b; }
  .legend-tick { width:2px; height:12px; border-radius:1px; flex-shrink:0; }
  .legend-tick-agg { background:var(--aggressive); }
  .legend-tick-mod { background:var(--moderate); }
  .legend-tick-con { background:var(--conservative); }

  /* Hoverable legend */
  .legend-item.hoverable {
    cursor:pointer; padding:3px 7px; border-radius:6px;
    border:1px solid transparent; transition:background 0.15s,border-color 0.15s,color 0.15s;
    position:relative;
  }
  .legend-item.hoverable:hover,.legend-item.hoverable.active { background:rgba(255,255,255,0.05); border-color:var(--border); }
  .legend-item.hoverable.active-agg { color:var(--aggressive); border-color:rgba(255,140,66,0.3); background:rgba(255,140,66,0.08); }
  .legend-item.hoverable.active-mod { color:var(--moderate); border-color:rgba(255,209,102,0.3); background:rgba(255,209,102,0.08); }
  .legend-item.hoverable.active-con { color:var(--conservative); border-color:rgba(6,214,160,0.3); background:rgba(6,214,160,0.08); }

  /* Strategy tooltips */
  .strategy-tooltip {
    position:absolute; bottom:calc(100% + 10px); left:50%;
    transform:translateX(-50%) translateY(4px);
    width:220px; background:rgba(26,31,46,0.85); border:1px solid var(--glass-border);
    border-radius:10px; padding:12px 14px; pointer-events:none;
    opacity:0; transition:opacity 0.18s ease,transform 0.18s ease;
    z-index:100; box-shadow:0 8px 32px rgba(0,0,0,0.5);
    backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
  }
  .legend-item.hoverable:hover .strategy-tooltip,
  .legend-item.hoverable.active .strategy-tooltip { opacity:1; transform:translateX(-50%) translateY(0); }
  .strategy-tooltip::after {
    content:''; position:absolute; top:100%; left:50%; transform:translateX(-50%);
    border:5px solid transparent; border-top-color:var(--border);
  }
  .tooltip-label { font-family:'Space Mono',monospace; font-size:9px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:6px; }
  .tooltip-label.agg { color:var(--aggressive); }
  .tooltip-label.mod { color:var(--moderate); }
  .tooltip-label.con { color:var(--conservative); }
  .tooltip-body { font-family:'Space Mono',monospace; font-size:11px; color:var(--text); line-height:1.65; opacity:0.8; }
  .tooltip-note { margin-top:8px; padding-top:8px; border-top:1px solid var(--border); font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); font-style:italic; line-height:1.5; }

  /* Sector bars */
  .sector-bars { display:flex; flex-direction:column; gap:7px; }
  .sector-row { display:grid; grid-template-columns:140px 1fr 32px; align-items:center; gap:10px; }
  .sector-name { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sector-pct { font-family:'Space Mono',monospace; font-size:10px; color:var(--text); text-align:right; font-weight:700; }
  .sector-row.missing .sector-name { opacity:0.45; }
  .sector-row.missing .sector-pct { color:var(--muted); font-weight:400; }
  .sector-bar-track { position:relative; background:var(--surface2); height:8px; border-radius:4px; overflow:visible; }
  .sector-bar-track.empty { background:rgba(255,255,255,0.04); border:1px dashed rgba(255,255,255,0.08); }
  .sector-bar-fill { height:100%; border-radius:4px; transition:width 0.9s cubic-bezier(0.4,0,0.2,1); position:relative; z-index:1; }
  /* Target tick markers â€” vertical line at target % position */
  .sector-tick { position:absolute; top:-3px; width:3px; height:14px; border-radius:2px; opacity:0; transition:opacity 0.25s ease, left 0.9s cubic-bezier(0.4,0,0.2,1); pointer-events:none; z-index:3; transform:translateX(-50%); }
  .sector-tick.agg { background:var(--aggressive); box-shadow:0 0 6px rgba(255,140,66,0.8); }
  .sector-tick.mod { background:var(--moderate); box-shadow:0 0 6px rgba(255,209,102,0.8); }
  .sector-tick.con { background:var(--conservative); box-shadow:0 0 6px rgba(6,214,160,0.8); }
  .sector-bars.show-agg .sector-tick.agg { opacity:1; }
  .sector-bars.show-mod .sector-tick.mod { opacity:1; }
  .sector-bars.show-con .sector-tick.con { opacity:1; }
  .sector-divider { display:flex; align-items:center; gap:8px; margin:14px 0 10px; }
  .sector-divider::before,.sector-divider::after { content:''; flex:1; height:1px; background:var(--border); }
  .sector-divider span { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); letter-spacing:1.5px; text-transform:uppercase; white-space:nowrap; }

  /* Screenshot upload */
  .upload-zone {
    margin:0 24px 16px; border:1.5px dashed var(--border); border-radius:12px;
    padding:18px 16px; text-align:center; cursor:pointer;
    transition:border-color 0.2s,background 0.2s; position:relative; overflow:hidden;
  }
  .upload-zone:hover,.upload-zone.drag-over { border-color:var(--accent); background:rgba(0,229,160,0.04); box-shadow:var(--accent-glow-subtle), 0 0 20px rgba(0,229,160,0.06) inset; }
  .upload-zone input[type="file"] { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .upload-icon { font-size:20px; margin-bottom:6px; opacity:0.5; }
  .upload-text { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); line-height:1.6; }
  .upload-text strong { color:var(--accent); }
  .scanning-overlay {
    position:absolute; inset:0; background:rgba(10,12,16,0.9); display:flex;
    flex-direction:column; align-items:center; justify-content:center; gap:10px;
    opacity:0; pointer-events:none; transition:opacity 0.2s; border-radius:10px;
  }
  .scanning-overlay.active { opacity:1; pointer-events:all; }
  .scan-spinner { width:24px; height:24px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.7s linear infinite; }
  .scan-text { font-family:'Space Mono',monospace; font-size:10px; color:var(--accent); letter-spacing:1px; }
  .import-preview { display:none; margin:0 24px 16px; }
  .import-preview.visible { display:block; }
  .import-preview-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .import-note { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); }
  .btn-import-all {
    background:var(--accent); color:#000; border:none; border-radius:6px;
    padding:6px 14px; font-family:'Space Mono',monospace; font-size:11px; font-weight:700;
    cursor:pointer; transition:opacity 0.15s;
  }
  .btn-import-all:hover { opacity:0.85; }
  .preview-items { display:flex; flex-direction:column; gap:5px; max-height:160px; overflow-y:auto; }
  .preview-item { display:grid; grid-template-columns:52px 1fr 70px 20px; align-items:center; gap:8px; background:var(--surface2); border-radius:6px; padding:7px 10px; }
  .preview-ticker { font-family:'Space Mono',monospace; font-size:12px; font-weight:700; color:var(--accent); }
  .preview-name { font-size:11px; color:var(--muted); font-family:'Space Mono',monospace; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .preview-pct-wrapper { display:flex; align-items:center; gap:2px; }
  .preview-pct-input { background:var(--surface); border:1px solid var(--border); border-radius:4px; padding:3px 4px; font-family:'Space Mono',monospace; font-size:12px; color:var(--text); width:48px; outline:none; text-align:right; }
  .preview-pct-input:focus { border-color:var(--accent); }
  .preview-pct-symbol { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); }
  .btn-preview-remove { background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px; padding:0; transition:color 0.15s; }
  .btn-preview-remove:hover { color:var(--aggressive); }

  /* Results panel */
  .results-panel { display:flex; flex-direction:column; gap:20px; }

  /* â”€â”€ PORTFOLIO HEALTH PANEL â”€â”€â”€ */
  .health-alert { display:flex; align-items:center; gap:10px; padding:12px 20px; background:rgba(255,209,102,0.06); border-bottom:1px solid var(--border); font-family:'Space Mono',monospace; font-size:12px; color:var(--moderate); }
  .health-cards { display:grid; grid-template-columns:1fr 1fr; gap:0; }
  .health-card { padding:20px 24px; text-align:center; }
  .health-card:first-child { border-right:1px solid var(--border); }
  .health-card-label { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
  .health-card-value { font-family:'DM Sans',sans-serif; font-size:26px; font-weight:700; color:var(--text); }
  .health-card-value.moderate { color:var(--moderate); }
  .health-card-value.conservative { color:var(--conservative); }
  .health-card-value.aggressive { color:var(--aggressive); }
  .health-card-sub { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); margin-top:4px; }
  .health-card-bar { width:60px; height:4px; border-radius:2px; background:var(--border); margin:8px auto 0; }
  .health-card-bar-fill { height:100%; border-radius:2px; }
  .health-compare { padding:16px 20px; border-top:1px solid var(--border); }
  .health-compare-title { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-bottom:12px; }
  .health-compare-row { display:grid; grid-template-columns:140px 1fr 100px 60px; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid rgba(30,36,48,0.5); font-family:'Space Mono',monospace; font-size:12px; }
  .health-compare-row:last-child { border-bottom:none; }
  .health-compare-label { color:var(--muted); }
  .health-compare-val { color:var(--text); font-weight:700; text-align:center; }
  .health-compare-spy { color:var(--muted); font-size:10px; text-align:center; }
  .health-compare-diff { font-size:10px; font-weight:700; text-align:right; }
  .health-compare-diff.good { color:var(--conservative); }
  .health-compare-diff.warn { color:var(--moderate); }
  .health-compare-diff.bad { color:var(--aggressive); }

  /* â”€â”€ REBALANCING SUGGESTIONS â”€â”€â”€ */
  .rebalance-list { padding:12px 20px 16px; display:flex; flex-direction:column; gap:8px; }
  .rebalance-item { font-family:'Space Mono',monospace; font-size:13px; color:var(--text); display:flex; align-items:center; gap:8px; }
  .rebalance-item .sector-link { color:var(--accent); cursor:default; }
  .rebalance-item .rebalance-note { color:var(--muted); font-size:12px; }

  /* â”€â”€ POSITION SIZING â”€â”€â”€ */
  .position-input-row { padding:16px 20px; display:flex; align-items:center; gap:10px; }
  .position-input-row label { font-family:'Space Mono',monospace; font-size:13px; color:var(--muted); font-weight:700; }
  .position-input-row input { flex:1; }
  .position-input-row .btn-calc { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 12px; color:var(--accent); cursor:pointer; font-size:14px; transition:border-color 0.2s; }
  .position-input-row .btn-calc:hover { border-color:var(--accent); }
  .position-table { width:100%; padding:0 20px 16px; }
  .position-table table { width:100%; border-collapse:collapse; }
  .position-table th { font-family:'Space Mono',monospace; font-size:10px; letter-spacing:1px; text-transform:uppercase; color:var(--muted); text-align:left; padding:8px 8px 10px; border-bottom:1px solid var(--border); }
  .position-table th:nth-child(n+2) { text-align:right; }
  .position-table td { font-family:'Space Mono',monospace; font-size:12px; color:var(--text); padding:8px; border-bottom:1px solid rgba(30,36,48,0.4); }
  .position-table td:nth-child(n+2) { text-align:right; }
  .position-table .ticker-cell { font-weight:700; }
  .position-table .sector-cell { font-size:10px; color:var(--muted); }
  .position-table .amount-cell { color:var(--muted); }
  .position-table .shares-cell { color:var(--accent); font-weight:700; }

  /* Live market data badges */
  .market-inline { display:inline-flex; align-items:center; gap:5px; vertical-align:middle; margin-left:6px; }
  .market-inline-price { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); font-weight:400; }
  .market-inline-price .currency { font-family:'DM Sans',sans-serif; font-size:9px; font-weight:700; color:var(--text); vertical-align:0.5px; margin-right:1px; }
  .market-badge {
    display:inline-flex; align-items:center; gap:3px;
    font-family:'Space Mono',monospace; font-size:9px; font-weight:700;
    padding:1px 5px; border-radius:3px; white-space:nowrap; flex-shrink:0;
  }
  .market-badge.up      { background:rgba(0,229,160,0.12); color:var(--conservative); border:1px solid rgba(0,229,160,0.25); box-shadow:0 0 6px rgba(0,229,160,0.12); }
  .market-badge.down    { background:rgba(255,140,66,0.12); color:var(--aggressive);   border:1px solid rgba(255,140,66,0.25); box-shadow:0 0 6px rgba(255,140,66,0.12); }
  .market-badge.flat    { background:rgba(90,100,120,0.15); color:var(--muted);        border:1px solid var(--border); }
  .market-badge.loading { background:var(--surface2); color:var(--muted); border:1px solid var(--border); animation:pulse 1.4s ease infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  @keyframes slideUp { from{transform:translateY(16px);opacity:0} to{transform:translateY(0);opacity:1} }

  /* â”€â”€ SHOW MORE â”€â”€â”€ */
  .show-more-items { display:none; flex-direction:column; gap:8px; }
  .show-more-items.open { display:flex; }
  .show-more-hidden { display:none !important; }
  .btn-show-more {
    margin:6px 0 2px; width:100%;
    background:none; border:1px dashed var(--border); border-radius:8px;
    padding:9px 14px; cursor:pointer; transition:border-color 0.2s, color 0.2s;
    display:flex; align-items:center; justify-content:center; gap:6px;
    font-family:'Space Mono',monospace; font-size:10px; letter-spacing:0.5px;
    color:var(--muted);
  }
  .btn-show-more:hover { border-color:var(--accent); color:var(--accent); }
  .btn-show-more.open  { border-style:solid; border-color:var(--border); color:var(--muted); }
  .market-close-label { font-family:'Space Mono',monospace; font-size:8px; color:var(--muted); opacity:0.6; letter-spacing:0.3px; }
  .market-refresh-row {
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 0 4px; margin:0 0 8px;
  }
  .market-status { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); }
  .market-status.live  { color:var(--conservative); }
  .market-status.error { color:var(--aggressive); }
  .btn-refresh-market {
    background:none; border:1px solid var(--border); border-radius:6px;
    padding:4px 10px; font-family:'Space Mono',monospace; font-size:9px;
    color:var(--muted); cursor:pointer; transition:border-color 0.2s,color 0.2s;
    display:flex; align-items:center; gap:5px;
  }
  .btn-refresh-market:hover { border-color:var(--accent); color:var(--text); }
  .btn-refresh-market.spinning svg { animation:spin 0.7s linear infinite; }

  /* Disclaimer */
  .disclaimer-footer {
    text-align:center; font-family:'Space Mono',monospace; font-size:10px;
    color:var(--muted); opacity:0.5; padding:12px 8px 4px;
    line-height:1.6; border-top:1px solid var(--border); margin-top:4px;
  }

  /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /* Large desktop (1400px+) */
  @media (min-width: 1400px) {
    .main-grid { gap: 32px; padding: 36px 2%; }
    .panel-header { padding: 20px 28px 14px; }
    .stock-form { padding: 24px 28px; }
    .stock-list { padding: 16px 28px 14px; }
    .portfolio-summary { padding: 18px 28px 22px; }
    .btn-analyze { margin: 0 28px 24px; width: calc(100% - 56px); padding: 16px; font-size: 14px; }
    .upload-zone { margin: 0 28px 18px; }
    .import-preview { margin: 0 28px 18px; }
    .strategy-header { padding: 20px 28px; }
    .etf-list { padding: 14px 20px 20px; }
    .analysis-bar { padding: 24px 28px 20px; }
    .sector-row { grid-template-columns: 160px 1fr 36px; }
  }

  /* Medium-large desktop (1100â€“1400px) */
  @media (min-width: 1100px) and (max-width: 1399px) {
    .main-grid { gap: 28px; padding: 32px 2%; }
    .sector-row { grid-template-columns: 150px 1fr 34px; }
  }

  /* Small desktop / large tablet (900â€“1100px) */
  @media (min-width: 901px) and (max-width: 1099px) {
    .main-grid { gap: 20px; padding: 24px 2%; }
    .sector-row { grid-template-columns: 120px 1fr 32px; }
    .strategy-desc { max-width: 150px; font-size: 10px; }
  }

  /* Sticky analyze button (all screen sizes) */
  .btn-analyze-sticky {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 900;
    background: var(--accent);
    color: #000;
    border: none;
    padding: 16px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.5px;
    cursor: pointer;
    display: none;
    text-align: center;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
    padding-bottom: calc(16px + env(safe-area-inset-bottom));
  }
  .btn-analyze-sticky.visible { display: block; }
  .btn-analyze-sticky:active { opacity: 0.85; }

  /* Tablet (max 900px) */
  @media (max-width: 900px) {
    .main-grid {
      grid-template-columns: 1fr;
      padding: 20px 16px;
      gap: 20px;
    }
    .container { padding: 0 16px; }
    header {
      padding: 20px 20px 16px;
      flex-direction: row; flex-wrap: wrap; align-items: center;
    }
    header.header-compact { padding: 10px 20px 10px; }
    .logo { flex: 1; min-width: 0; }
    .tagline { font-size:9px; opacity:0.5; }
    .header-actions {
      position: static; transform: none;
      order: 0;
    }
    .user-pill { font-size:11px; padding:3px 10px 3px 8px; }
    .sector-row { grid-template-columns: 110px 1fr 32px; }
    .strategy-desc { max-width: 160px; }
    /* (sticky analyze button moved to global scope) */
    body { padding-bottom: 56px; }
  }

  /* Mobile (max 600px) */
  @media (max-width: 600px) {
    header {
      padding: 14px 16px 12px;
      gap: 6px;
    }
    header.header-compact { padding: 8px 16px 8px; }
    header.header-compact .logo h1 { font-size: 15px; }
    header.header-compact .logo-icon { width: 24px; height: 24px; }
    .logo h1 { font-size: 17px; }
    .logo-icon { width: 30px; height: 30px; }
    .tagline { font-size:8px; opacity:0.4; }
    .header-actions { gap: 6px; }
    .user-pill { font-size:10px; padding:3px 8px 3px 7px; }
    .user-pill-avatar { width:18px; height:18px; }
    .sidebar { width:100%; right:-100%; }
    .theme-toggle {
      padding: 4px 4px 4px 8px;
      font-size: 9px;
    }
    .theme-toggle-track { width: 24px; height: 14px; }
    .theme-toggle-thumb { width: 10px; height: 10px; }
    body.light .theme-toggle-thumb { transform: translateX(10px); }

    .main-grid { padding: calc(8px + env(safe-area-inset-top, 0px)) 12px 14px; gap: 16px; }
    .container { padding: 0 12px; }

    .panel-header { padding: 12px 16px 10px; }
    .section-title { font-size: 11px; letter-spacing: 1.2px; }

    .stock-form { padding: 14px 16px; }
    .input-row { grid-template-columns: 1fr 70px; gap: 6px; margin-bottom: 10px; }
    input[type="text"], input[type="number"] { padding: 9px 10px; font-size: 12px; }
    .btn-add { padding: 9px 12px; font-size: 16px; }

    .stock-list { padding: 16px 16px 10px; gap: 3px; }
    .stock-item { padding: 6px 12px 4px; }
    .stock-info { gap: 8px; }
    .stock-ticker { font-size: 14px; }
    .stock-company { font-size: 11px; }
    .stock-sector { font-size: 9px; }

    .portfolio-summary { padding: 12px 16px 14px; }
    .btn-analyze { margin: 0 16px 16px; width: calc(100% - 32px); padding: 13px; font-size: 12px; }

    .upload-compact-trigger { margin: 0 16px 10px; padding: 9px 12px; font-size: 10px; }
    .upload-zone { margin: 0 16px 14px; padding: 14px 12px; }
    .upload-text { font-size: 9px; }
    .holdings-grid { padding: 10px 16px; }
    .holdings-view-toggle { padding: 10px 16px 6px; }
    .import-preview { margin: 0 16px 14px; }
    .preview-item { grid-template-columns: 44px 1fr 60px 18px; gap: 6px; padding: 6px 8px; }
    .preview-ticker { font-size: 11px; }
    .preview-name { font-size: 10px; }
    .preview-pct-input { width: 40px; font-size: 11px; }

    /* Analysis bar */
    .analysis-bar { padding: 14px 16px 12px; }
    .analysis-bar-header { flex-direction: column; align-items: flex-start; gap: 8px; margin-bottom: 12px; }
    .breakdown-legend { gap: 6px; }
    .sector-row { grid-template-columns: 90px 1fr 28px; gap: 8px; }
    .sector-name { font-size: 9px; }
    .sector-pct { font-size: 9px; }

    /* Strategy cards */
    .strategy-header { padding: 14px 16px; flex-wrap: wrap; gap: 8px; }
    .strategy-desc { max-width: 100%; text-align: left; font-size: 10px; }
    .etf-list { padding: 10px 12px 14px; gap: 6px; }
    .etf-item-header { padding: 10px 12px; }
    .etf-ticker, .pick-ticker { font-size: 13px; }
    .etf-details h4, .pick-details h4 { font-size: 11px; }
    .etf-details p, .pick-details p { font-size: 10px; }

    /* Strategy tooltip: reposition on mobile */
    .strategy-tooltip {
      left: auto;
      right: 0;
      transform: translateY(4px);
      width: 190px;
    }
    .legend-item.hoverable:hover .strategy-tooltip,
    .legend-item.hoverable.active .strategy-tooltip {
      transform: translateY(0);
    }

    /* Drawer text */
    .etf-drawer-inner, .pick-drawer-inner { padding: 10px 12px; margin: 0 10px 10px; }
    .etf-drawer-text, .pick-drawer-text { font-size: 10px; }

    /* Empty state */
    .empty-state { padding: 40px 16px; }
    .placeholder-icon { font-size: 36px; }
    .placeholder-text { font-size: 11px; }

    /* Disclaimer */
    .disclaimer-footer { font-size: 9px; padding: 10px 4px 4px; }
  }

  /* Very small screens */
  @media (max-width: 360px) {
    .logo h1 { font-size: 15px; }
    .sector-row { grid-template-columns: 78px 1fr 26px; }
    .input-row { grid-template-columns: 1fr 60px; }
  }

  @media (min-width: 901px) {
    .btn-analyze-sticky { display: none !important; }
  }

  /* â”€â”€ SIDEBAR â”€â”€â”€ */
  .sidebar-backdrop {
    position:fixed; inset:0; background:rgba(0,0,0,0.5);
    z-index:20000; opacity:0; pointer-events:none;
    transition:opacity 0.3s ease;
  }
  .sidebar-backdrop.open { opacity:1; pointer-events:auto; }
  .sidebar {
    position:fixed; top:0; right:-320px; bottom:0; width:300px;
    background:var(--glass-bg); border-left:1px solid var(--glass-border);
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    box-shadow:-8px 0 40px rgba(0,0,0,0.4);
    z-index:20001; overflow-y:auto;
    transition:right 0.3s ease;
    display:flex; flex-direction:column;
  }
  .sidebar.open { right:0; }
  .sidebar-header {
    display:flex; justify-content:flex-end; padding:16px 16px 0;
  }
  .sidebar-close {
    background:none; border:none; color:var(--muted); font-size:18px;
    cursor:pointer; padding:4px 8px; border-radius:6px;
    transition:color 0.15s, background 0.15s;
  }
  .sidebar-close:hover { color:var(--text); background:var(--surface2); }
  .sidebar-user {
    padding:8px 20px 16px; border-bottom:1px solid var(--border);
  }
  .sidebar-user-info {
    display:flex; align-items:center; gap:12px;
  }
  .sidebar-user-avatar {
    width:40px; height:40px; border-radius:50%; border:2px solid var(--accent);
    flex-shrink:0; object-fit:cover;
  }
  .sidebar-user-avatar.initials {
    display:flex; align-items:center; justify-content:center;
    background:var(--surface2); color:var(--accent);
    font-size:16px; font-weight:700; font-family:'DM Sans',sans-serif;
  }
  .sidebar-user-details { min-width:0; }
  .sidebar-user-name {
    font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600;
    color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .sidebar-user-email {
    font-family:'Space Mono',monospace; font-size:10px; color:var(--muted);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .sidebar-pro-badge {
    display:inline-block; margin-top:6px;
    font-family:'Space Mono',monospace; font-size:10px; color:#00e5a0;
    background:rgba(0,229,160,0.1); border:1px solid rgba(0,229,160,0.25);
    border-radius:6px; padding:3px 8px;
    animation:proGlow 2s ease-in-out infinite;
  }
  @keyframes proGlow {
    0%,100% { box-shadow:0 0 6px rgba(0,229,160,0.2); }
    50% { box-shadow:0 0 14px rgba(0,229,160,0.4); }
  }
  .sidebar-signin-btn {
    width:100%; margin-top:8px; padding:10px; border-radius:8px;
    border:1px solid var(--border); background:var(--surface2);
    color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px;
    font-weight:600; cursor:pointer; transition:border-color 0.2s;
    display:flex; align-items:center; justify-content:center; gap:6px;
  }
  .sidebar-signin-btn:hover { border-color:var(--accent); }
  .sidebar-section {
    padding:12px 20px; border-bottom:1px solid var(--border);
  }
  .sidebar-section:empty { display:none; }
  .sidebar-section-title {
    font-family:'Space Mono',monospace; font-size:9px; font-weight:700;
    color:var(--muted); letter-spacing:1.5px; text-transform:uppercase;
    margin-bottom:8px;
  }
  .sidebar-portfolios {
    display:flex; flex-direction:column; gap:4px; margin-bottom:6px;
  }
  .sidebar-slot {
    display:flex; align-items:center; gap:6px;
    background:var(--surface2); border:1px solid var(--border);
    border-radius:8px; padding:7px 10px; cursor:pointer;
    transition:border-color 0.2s; position:relative;
  }
  .sidebar-slot:hover { border-color:var(--accent); }
  .sidebar-slot.active { border-color:var(--accent); background:rgba(0,229,160,0.06); }
  .sidebar-slot.active::before {
    content:'âœ“'; position:absolute; left:-2px; top:50%; transform:translate(-50%, -50%);
    background:var(--accent); color:#000; width:14px; height:14px; border-radius:50%;
    font-size:9px; display:flex; align-items:center; justify-content:center; font-weight:700;
  }
  .sidebar-empty {
    padding:10px; text-align:center;
    font-family:'Space Mono',monospace; font-size:10px; color:var(--muted);
  }
  .sidebar-portfolio-actions {
    display:flex; flex-direction:column; gap:4px;
  }
  .sidebar-btn {
    width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:7px;
    padding:7px 10px; font-family:'Space Mono',monospace; font-size:10px; color:var(--muted);
    cursor:pointer; transition:border-color 0.2s, color 0.2s; text-align:left;
  }
  .sidebar-btn:hover { border-color:var(--accent); color:var(--text); }
  .sidebar-btn-danger { border-color:transparent; }
  .sidebar-btn-danger:hover { border-color:var(--aggressive) !important; color:var(--aggressive) !important; }
  .sidebar-nav-links { display:flex; flex-direction:column; gap:2px; }
  .sidebar-nav-btn {
    width:100%; background:transparent; border:1px solid transparent; border-radius:8px;
    padding:10px 12px; font-family:'DM Sans',sans-serif; font-size:13px; color:var(--text);
    cursor:pointer; transition:background 0.2s, border-color 0.2s; text-align:left;
    display:flex; align-items:center; gap:10px;
  }
  .sidebar-nav-btn:hover { background:var(--surface2); border-color:var(--border); }
  .sidebar-nav-icon { color:var(--accent); font-size:10px; width:16px; text-align:center; }
  .sidebar-settings-row {
    display:flex; align-items:center; justify-content:space-between;
    padding:6px 0;
  }
  .sidebar-settings-label {
    font-family:'Space Mono',monospace; font-size:11px; color:var(--text);
    display:flex; align-items:center; gap:6px;
  }
  .sidebar-account-btn {
    display:block; width:100%; text-align:left; padding:8px 0; background:none; border:none;
    font-family:'Space Mono',monospace; font-size:11px; cursor:pointer;
    transition:color 0.15s;
  }
  .sidebar-account-btn.sign-out { color:var(--aggressive); }
  .sidebar-account-btn.sign-out:hover { color:#ff6b82; }
  .sidebar-account-btn.delete-account { color:var(--muted); font-size:10px; opacity:0.6; }
  .sidebar-account-btn.delete-account:hover { color:var(--aggressive); opacity:1; }
  .sidebar-footer {
    margin-top:auto; padding:16px 20px;
    font-family:'Space Mono',monospace; font-size:9px; color:var(--muted);
    text-align:center;
  }
  .sidebar-footer a { color:var(--muted); text-decoration:none; }
  .sidebar-footer a:hover { color:var(--text); }
  .slot-name { font-family:'Space Mono',monospace; font-size:11px; color:var(--text); flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .slot-name-input {
    font-family:'Space Mono',monospace; font-size:11px; color:var(--text);
    background:none; border:none; outline:none; flex:1; cursor:text;
  }
  .slot-count { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); }
  .slot-actions { display:flex; gap:4px; }
  .slot-btn {
    background:none; border:none; color:var(--muted); cursor:pointer;
    font-size:16px; padding:3px 6px; border-radius:4px; transition:color 0.15s, background 0.15s;
    line-height:1;
  }
  .slot-btn:hover { color:var(--accent); background:var(--border); }
  .slot-btn.danger:hover { color:var(--aggressive); background:var(--border); }

  /* Ticker autocomplete */
  .autocomplete-wrapper { position:relative; }
  .autocomplete-dropdown {
    display:none; position:absolute; top:100%; left:0; right:0; z-index:100;
    background:var(--glass-bg); border:1px solid var(--glass-border); border-top:none;
    border-radius:0 0 8px 8px; max-height:200px; overflow-y:auto;
    box-shadow:0 8px 32px rgba(0,0,0,0.5);
    backdrop-filter:blur(var(--glass-blur)); -webkit-backdrop-filter:blur(var(--glass-blur));
  }
  .autocomplete-dropdown.open { display:block; }
  .autocomplete-item {
    padding:8px 12px; cursor:pointer; display:flex; justify-content:space-between;
    align-items:center; font-family:'Space Mono',monospace; font-size:11px;
    border-bottom:1px solid var(--border);
  }
  .autocomplete-item:last-child { border-bottom:none; }
  .autocomplete-item:hover, .autocomplete-item.selected { background:var(--surface2); }
  .autocomplete-item-ticker { color:var(--accent); font-weight:700; }
  .autocomplete-item-name { color:var(--muted); font-size:10px; text-align:right; max-width:60%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* â”€â”€ RISK SCORE â”€â”€â”€ */
  .risk-score-bar {
    margin: 0 24px 14px;
    background: var(--glass-bg); border: 1px solid var(--glass-border);
    border-radius: 10px; padding: 10px 14px;
    display: flex; align-items: center; gap: 12px;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  }
  .risk-score-label { font-family:'Space Mono',monospace; font-size:9px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; white-space:nowrap; }
  .risk-score-track { flex:1; height:6px; background:var(--border); border-radius:3px; overflow:hidden; }
  .risk-score-fill { height:100%; border-radius:3px; transition:width 0.6s cubic-bezier(0.4,0,0.2,1), background 0.6s; }
  .risk-score-num { font-family:'Space Mono',monospace; font-size:13px; font-weight:700; min-width:28px; text-align:right; }

  /* â”€â”€ CORRELATION WARNINGS â”€â”€â”€ */
  .correlation-warnings {
    margin: 0 24px 10px; display: flex; flex-direction: column; gap: 5px;
  }
  .corr-warn {
    display: flex; align-items: flex-start; gap: 7px;
    background: rgba(255,209,102,0.07); border: 1px solid rgba(255,209,102,0.2);
    border-radius: 7px; padding: 7px 10px; animation: slideIn 0.2s ease;
  }
  .corr-icon { font-size:11px; flex-shrink:0; margin-top:1px; }
  .corr-text { font-family:'Space Mono',monospace; font-size:10px; color:var(--moderate); line-height:1.5; }
  .corr-text strong { color:var(--text); }

  /* â”€â”€ SLIDER on holdings â”€â”€â”€ */
  .stock-item { flex-direction: column; align-items: stretch; gap: 3px; padding: 7px 14px 5px; }
  .stock-item-top { display:flex; align-items:center; justify-content:space-between; }
  .stock-slider-row { display:flex; align-items:center; gap:8px; }
  .stock-slider {
    flex:1; -webkit-appearance:none; appearance:none;
    height:3px; border-radius:2px; background:var(--border); outline:none; cursor:pointer;
  }
  .stock-slider::-webkit-slider-thumb {
    -webkit-appearance:none; appearance:none;
    width:12px; height:12px; border-radius:50%;
    background:var(--accent); cursor:pointer;
    box-shadow: 0 0 8px rgba(0,229,160,0.6), 0 0 16px rgba(0,229,160,0.2);
    transition: transform 0.1s, box-shadow 0.15s;
  }
  .stock-slider::-webkit-slider-thumb:hover { transform: scale(1.3); box-shadow: 0 0 12px rgba(0,229,160,0.8), 0 0 24px rgba(0,229,160,0.3); }
  .stock-slider::-moz-range-thumb {
    width:12px; height:12px; border-radius:50%;
    background:var(--accent); cursor:pointer; border:none;
  }
  .slider-pct { font-family:'Space Mono',monospace; font-size:11px; color:var(--accent); font-weight:700; min-width:36px; text-align:right; }

  /* â”€â”€ WHAT-IF SIMULATOR â”€â”€â”€ */
  .whatif-panel {
    margin: 0 24px 14px; background:var(--surface2);
    border:1px solid var(--border); border-radius:10px;
  }
  .whatif-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:9px 14px; cursor:pointer; transition:background 0.15s;
  }
  .whatif-header:hover { background:rgba(255,255,255,0.03); }
  .whatif-title { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
  .whatif-toggle { font-size:10px; color:var(--muted); }
  .whatif-body { padding:0 14px 16px; display:none; }
  .whatif-body.open { display:block; }
  .whatif-row { display:grid; grid-template-columns:1fr 70px; gap:6px; margin-bottom:8px; }
  .whatif-result { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); line-height:1.6; }
  .whatif-result strong { color:var(--accent); }
  .whatif-result .wi-new { color:var(--moderate); }
  .btn-whatif-add { margin-top:8px; background:rgba(0,229,160,0.1); border:1px solid rgba(0,229,160,0.3); border-radius:6px; padding:6px 12px; font-family:'Space Mono',monospace; font-size:10px; font-weight:600; color:var(--accent); cursor:pointer; transition:background 0.15s; }
  .btn-whatif-add:hover { background:rgba(0,229,160,0.2); }

  /* â”€â”€ ONBOARDING â”€â”€â”€ */
  .onboarding-banner {
    margin: 16px 24px 14px; background: rgba(0,229,160,0.05);
    border:1px solid rgba(0,229,160,0.15); border-left:3px solid var(--accent); border-radius:10px; padding:12px 14px;
    backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
    box-shadow:var(--accent-glow-subtle);
  }
  .onboarding-text { font-family:'Space Mono',monospace; font-size:10px; color:var(--muted); line-height:1.7; margin-bottom:10px; }
  .onboarding-text strong { color:var(--accent); }
  .onboarding-examples { display:flex; flex-wrap:wrap; gap:6px; }
  .btn-example {
    background:var(--surface); border:1px solid var(--border); border-radius:6px;
    padding:5px 10px; font-family:'Space Mono',monospace; font-size:10px; color:var(--text);
    cursor:pointer; transition:border-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
  }
  .btn-example:hover { border-color:var(--accent); color:var(--accent); transform:translateY(-2px); box-shadow:var(--accent-glow-subtle); }
  .btn-example:active { transform:scale(0.95); box-shadow:none; }

  /* â”€â”€ SHARE BUTTON â”€â”€â”€ */
  .share-export-row {
    display:flex; gap:8px;
  }
  .btn-share, .btn-export-pdf {
    flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    padding:9px; font-family:'Space Mono',monospace; font-size:10px; color:var(--muted);
    cursor:pointer; transition:border-color 0.2s, color 0.2s;
    display:flex; align-items:center; justify-content:center; gap:6px;
  }
  .btn-share:hover { border-color:var(--accent); color:var(--accent); }
  .btn-export-pdf:hover { border-color:#a78bfa; color:#a78bfa; }
  .share-toast {
    position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(10px);
    background:var(--glass-bg); border:1px solid var(--accent); border-radius:8px;
    padding:10px 20px; font-family:'Space Mono',monospace; font-size:11px; color:var(--accent);
    opacity:0; transition:opacity 0.2s, transform 0.2s; pointer-events:none; z-index:999999;
    white-space:nowrap;
    backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
    box-shadow:var(--accent-glow);
  }
  .share-toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

  /* â”€â”€ PDF EXPORT â”€â”€â”€ */
  @media print {
    header, .upload-zone, .import-preview, .stock-form,
    .risk-score-bar, .whatif-panel, .share-export-row, .onboarding-banner,
    .btn-analyze, .btn-remove, .btn-refresh-market, .theme-toggle,
    .pick-hint, .etf-hint, .etf-drawer, .pick-drawer,
    .market-refresh-row, .sidebar, .sidebar-backdrop { display:none !important; }
    body { background:#fff !important; color:#000 !important; }
    .main-grid { grid-template-columns: 1fr !important; }
    .panel, .strategy-card, .analysis-bar { border:1px solid #ddd !important; }
  }

  /* â”€â”€ PAYWALL MODAL â”€â”€â”€ */
  .pw-card {
    background: linear-gradient(165deg, rgba(20,24,32,0.9) 0%, rgba(13,16,21,0.95) 100%);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 28px 24px 22px;
    max-width: 380px; width: 92%;
    max-height: 88vh; overflow-y: auto;
    font-family: Inter, sans-serif;
    position: relative;
    box-shadow: 0 24px 80px rgba(0,0,0,0.6), var(--accent-glow-subtle);
    backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
  }
  .pw-close {
    position: absolute; top: 14px; right: 16px;
    background: none; border: none; color: #5a6478;
    font-size: 20px; cursor: pointer; z-index: 1;
    transition: color 0.15s;
  }
  .pw-close:hover { color: #e8ecf0; }

  .pw-hero { text-align: center; margin-bottom: 18px; }
  .pw-icon-ring {
    width: 48px; height: 48px; border-radius: 50%;
    background: linear-gradient(135deg, rgba(0,229,160,0.12), rgba(167,139,250,0.12));
    border: 1.5px solid rgba(0,229,160,0.25);
    display: inline-flex; align-items: center; justify-content: center;
    margin-bottom: 12px;
  }
  .pw-title {
    color: #e8ecf0; font-size: 22px; font-weight: 700;
    margin: 0 0 4px; letter-spacing: -0.3px;
  }
  .pw-subtitle {
    color: #6b7a90; font-size: 12px; margin: 0;
    font-family: 'Space Mono', monospace;
    white-space: pre-line;
  }

  .pw-features {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 6px 16px; margin-bottom: 20px;
    padding: 14px 16px;
    background: rgba(0,229,160,0.03);
    border: 1px solid rgba(0,229,160,0.08);
    border-radius: 12px;
  }
  .pw-feat {
    font-family: 'Space Mono', monospace; font-size: 10px;
    color: #c4cdd8; display: flex; align-items: center; gap: 6px;
  }
  .pw-check { color: #00e5a0; font-size: 11px; font-weight: 700; }

  .pw-tiers {
    display: grid; grid-template-columns: 1fr 1fr 1fr;
    gap: 8px; margin-bottom: 16px;
  }
  .pw-tier {
    border: 2px solid #1e2430; border-radius: 12px;
    padding: 12px 10px; text-align: center; cursor: pointer;
    transition: border-color 0.2s, background 0.2s, transform 0.15s;
    position: relative; opacity: 0.6;
  }
  .pw-tier:hover { background: rgba(255,255,255,0.02); transform: translateY(-2px); opacity: 0.85; box-shadow:var(--accent-glow-subtle); }
  .pw-tier:active { transform:scale(0.97); }
  .pw-tier-selected {
    border-color: #00e5a0 !important;
    background: rgba(0,229,160,0.05);
    opacity: 1;
    box-shadow:var(--accent-glow);
  }
  .pw-tier-badge {
    position: absolute; top: -9px; left: 50%; transform: translateX(-50%);
    background: #00e5a0; color: #000; font-size: 8px; font-weight: 700;
    padding: 2px 8px; border-radius: 4px;
    font-family: 'Space Mono', monospace; letter-spacing: 0.3px;
    text-transform: uppercase; white-space: nowrap;
    pointer-events: none;
  }
  .pw-tier-badge-save { background: #a78bfa; color: #fff; }
  .pw-tier-badge-deal { background: linear-gradient(135deg, #00e5a0, #a78bfa); color: #000; }
  .pw-tier > * { pointer-events: none; }
  .pw-tier-name {
    color: #e8ecf0; font-weight: 600; font-size: 13px;
    margin-top: 4px;
  }
  .pw-tier-price {
    color: #00e5a0; font-weight: 700; font-size: 18px;
    margin: 6px 0 2px; font-family: 'Space Mono', monospace;
  }
  .pw-tier-note {
    color: #5a6478; font-size: 9px;
    font-family: 'Space Mono', monospace;
  }

  .pw-cta {
    background: linear-gradient(135deg, #00e5a0, #00c98b);
    color: #000; border: none; border-radius: 12px;
    padding: 13px; font-size: 14px; font-weight: 700;
    cursor: pointer; width: 100%;
    font-family: Inter, sans-serif;
    transition: opacity var(--transition-fast), transform 0.1s, box-shadow var(--transition-med);
    box-shadow: var(--accent-glow);
    position:relative; overflow:hidden;
  }
  .pw-cta::before {
    content:''; position:absolute; top:0; left:-100%; width:60%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transition:none; pointer-events:none;
  }
  .pw-cta:hover { opacity: 0.92; transform: translateY(-1px); box-shadow:var(--accent-glow-strong); }
  .pw-cta:hover::before { left:120%; transition:left 0.6s ease; }
  .pw-cta:active { transform: translateY(0); }
  .pw-restore {
    background: none; color: #5a6478; border: none;
    padding: 8px; font-size: 10px; cursor: pointer;
    width: 100%; font-family: 'Space Mono', monospace;
    transition: color 0.15s;
  }
  .pw-restore:hover { color: #8a9ab8; }
  .pw-restore-ios {
    color: #00e5a0; font-size: 13px; font-weight: 600;
    border: 1px solid rgba(0,229,160,0.3); border-radius: 10px;
    padding: 11px; margin-top: 4px;
  }
  .pw-restore-ios:hover { color: #00e5a0; opacity: 0.85; }

  /* Paywall light mode */
  body.light .pw-card {
    background: linear-gradient(165deg, #ffffff 0%, #f4f6f9 100%);
    border-color: #dde2ec;
    box-shadow: 0 24px 80px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,229,160,0.08);
  }
  body.light .pw-close { color: #8a9ab8; }
  body.light .pw-close:hover { color: #0f1623; }
  body.light .pw-title { color: #0f1623; }
  body.light .pw-subtitle { color: #8a9ab8; }
  body.light .pw-features {
    background: rgba(0,229,160,0.04);
    border-color: rgba(0,229,160,0.12);
  }
  body.light .pw-feat { color: #3a4558; }
  body.light .pw-tier {
    border-color: #dde2ec;
    background: #fff;
  }
  body.light .pw-tier:hover { background: #f8f9fb; }
  body.light .pw-tier-selected {
    border-color: #00a87a !important;
    background: rgba(0,229,160,0.06);
  }
  body.light .pw-tier-name { color: #0f1623; }
  body.light .pw-tier-price { color: #00a87a; }
  body.light .pw-tier-note { color: #8a9ab8; }
  body.light .pw-cta {
    background: linear-gradient(135deg, #00a87a, #00c98b);
    box-shadow: 0 4px 20px rgba(0,168,122,0.2);
  }
  body.light .pw-restore { color: #8a9ab8; }
  body.light .pw-restore:hover { color: #3a4558; }

  @media (max-width: 420px) {
    .pw-features { grid-template-columns: 1fr; }
    .pw-tiers { grid-template-columns: 1fr; }
    .pw-tier { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; }
    .pw-tier-badge { left: 12px; transform: none; }
    .pw-tier-name { margin: 0; text-align: left; }
    .pw-tier-price { margin: 0; font-size: 16px; }
    .pw-tier-note { display: none; }
  }

  /* â”€â”€ UI IMPROVEMENTS â”€â”€â”€ */

  /* 1. Smooth holdings collapse animation */
  #holdingsBody {
    overflow: hidden;
    transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.2s ease;
  }
  #holdingsBody.collapsed {
    max-height: 0 !important;
    opacity: 0;
  }

  /* 2. Best match strategy label + card glow */
  .strategy-card:has(.strategy-best-match) { border-color:rgba(0,229,160,0.2); box-shadow:var(--glass-shadow), var(--accent-glow-subtle); }
  .strategy-best-match {
    display: inline-block;
    font-family: 'Space Mono', monospace;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent);
    background: rgba(0,229,160,0.1);
    border: 1px solid rgba(0,229,160,0.25);
    border-radius: 4px;
    padding: 1px 6px;
    margin-left: 0;
  }

  /* 3. Compact upload zone */
  .upload-compact-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 0 24px 12px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }
  .upload-compact-trigger:hover { border-color: var(--accent); color: var(--text); }
  .upload-compact-trigger .upload-compact-icon { font-size: 14px; }
  .upload-compact-trigger .upload-compact-chevron {
    margin-left: auto;
    font-size: 10px;
    color: var(--muted);
    transition: transform 0.25s ease;
  }
  .upload-compact-trigger.expanded .upload-compact-chevron { transform: rotate(90deg); }
  .upload-expanded { display: none; }
  .upload-expanded.expanded { display: block; }

  /* 4. Staggered fade-in on result sections */
  .health-panel { animation: fadeUp 0.4s ease backwards; animation-delay: 0.05s; }
  .rebalance-panel { animation: fadeUp 0.4s ease backwards; animation-delay: 0.1s; }
  .position-panel { animation: fadeUp 0.4s ease backwards; animation-delay: 0.25s; }

  /* 5. Improved empty state */
  .empty-compass {
    position: relative;
    width: 88px;
    height: 88px;
    margin: 0 auto 18px;
  }
  .empty-compass-ring {
    width: 72px;
    height: 72px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: emptyPulse 3s ease-in-out infinite;
    box-shadow: 0 0 20px rgba(0,229,160,0.2), 0 0 40px rgba(0,229,160,0.05);
  }
  .empty-compass-needle {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 2px;
    height: 28px;
    background: linear-gradient(to top, var(--aggressive) 50%, var(--accent) 50%);
    border-radius: 1px;
    transform-origin: bottom center;
    transform: translate(-50%, -100%) rotate(0deg);
    animation: emptyNeedleSway 4s ease-in-out infinite;
    filter: drop-shadow(0 0 4px rgba(0,229,160,0.5));
  }
  .empty-compass-center {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 6px;
    height: 6px;
    background: var(--text);
    border-radius: 50%;
    transform: translate(-50%, -50%);
  }
  @keyframes emptyPulse {
    0%, 100% { border-top-color: var(--accent); opacity: 0.6; box-shadow: 0 0 20px rgba(0,229,160,0.2); }
    50% { border-top-color: var(--moderate); opacity: 1; box-shadow: 0 0 25px rgba(255,209,102,0.25); }
  }
  @keyframes emptyNeedleSway {
    0%, 100% { transform: translate(-50%, -100%) rotate(-20deg); }
    50% { transform: translate(-50%, -100%) rotate(20deg); }
  }
  .empty-state-title {
    font-family: 'DM Sans', sans-serif;
    font-size: 18px;
    font-weight: 600;
    background: var(--accent-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 6px;
  }
  .empty-state-hint {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    line-height: 1.7;
  }
  .empty-state-hint strong { color: var(--text); }

  /* 7. What-If Simulator promotion */
  .whatif-promoted {
    animation: whatifGlow 2s ease-in-out;
    position: relative;
  }
  @keyframes whatifGlow {
    0% { border-color: var(--border); box-shadow: none; }
    20% { border-color: var(--accent); box-shadow: 0 0 12px rgba(0,229,160,0.3); }
    80% { border-color: var(--accent); box-shadow: 0 0 12px rgba(0,229,160,0.3); }
    100% { border-color: var(--border); box-shadow: none; }
  }
  .whatif-promoted::after {
    content: 'NEW';
    position: absolute;
    top: -8px;
    right: 12px;
    background: var(--accent);
    color: #000;
    font-family: 'Space Mono', monospace;
    font-size: 8px;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 2px 6px;
    border-radius: 4px;
    animation: fadeIn 0.3s ease, fadeOut 0.5s ease 4.5s forwards;
  }
  @keyframes fadeOut { to { opacity: 0; } }

  /* 8. Compact holdings grid view */
  .holdings-view-toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 10px 24px 8px;
  }
  .view-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 3px 8px;
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
  }
  .view-btn:hover { border-color: var(--accent); color: var(--text); }
  .view-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.08); }
  .holdings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
    gap: 6px;
    padding: 12px 24px;
  }
  .holdings-grid-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 10px;
    text-align: center;
    cursor: pointer;
    transition: border-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
    animation: slideIn 0.2s ease;
  }
  .holdings-grid-item:hover { border-color: var(--aggressive); transform:translateY(-2px); box-shadow:var(--aggressive-glow); }
  .grid-ticker {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
  }
  .grid-pct {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    font-weight: 700;
    margin-top: 2px;
  }

  /* 9. ETF vs Stock visual distinction */
  .etf-type-etf { border-left: 3px solid rgba(77,159,255,0.4); }
  .etf-type-stock { border-left: 3px solid rgba(255,140,66,0.3); }

  /* 10. Gradient text on result section titles */
  .results-panel .section-title {
    background: var(--accent-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* 11. Custom scrollbar */
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.1); border-radius:3px; }
  ::-webkit-scrollbar-thumb:hover { background:rgba(255,255,255,0.2); }
  body.light ::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.12); }
  body.light ::-webkit-scrollbar-thumb:hover { background:rgba(0,0,0,0.2); }

  /* 12. Sector bar fills glow */
  .sector-bar-fill { box-shadow:0 0 6px currentColor; }

  /* 13. Mobile sticky button enhanced glow */
  @media (max-width: 900px) {
    .btn-analyze-sticky.visible {
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5), 0 -8px 30px rgba(0,229,160,0.2);
    }
  }

  /* 14. Portfolio Strip */
  .portfolio-strip {
    display: none;
    gap: 6px;
    padding: 10px 20px;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    border-bottom: 1px solid var(--border);
  }
  .portfolio-strip.visible { display: flex; }
  .portfolio-strip::-webkit-scrollbar { display: none; }

  .pstrip-card {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 10px 5px 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    border-left: 3px solid var(--muted);
    cursor: pointer;
    transition: border-color var(--transition-fast), background var(--transition-fast);
    white-space: nowrap;
    position: relative;
  }
  .pstrip-card:hover { border-color: var(--accent); }
  .pstrip-card.active {
    border-color: var(--accent);
    background: rgba(0,229,160,0.06);
  }
  .pstrip-card.active .pstrip-name {
    background: var(--accent-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .pstrip-info { padding-left: 10px; }
  .pstrip-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    max-width: 90px;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.2;
  }
  .pstrip-count {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    line-height: 1.2;
  }
  .pstrip-change {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    line-height: 1;
    margin-left: auto;
  }
  .pstrip-change.up { color: #00e5a0; }
  .pstrip-change.down { color: #ff4d6d; }
  .pstrip-change.flat { color: var(--muted); }
  .pstrip-change.loading {
    color: var(--muted);
    font-size: 9px;
    animation: pstrip-pulse 1.4s ease-in-out infinite;
  }
  @keyframes pstrip-pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.8; }
  }
  body.light .pstrip-change.up { color: #00a87a; }
  body.light .pstrip-change.down { color: #e02a4a; }

  .pstrip-refresh {
    flex: 0 0 auto;
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--muted);
    font-size: 14px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast);
    align-self: center;
  }
  .pstrip-refresh:hover { color: var(--accent); border-color: var(--accent); }
  .pstrip-refresh.spinning {
    animation: pstrip-spin 0.8s linear infinite;
    color: var(--accent);
    pointer-events: none;
  }
  .pstrip-refresh.spin-once {
    animation: pstrip-spin 0.6s ease-out;
    color: var(--accent);
    pointer-events: none;
  }
  @keyframes pstrip-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .pstrip-status {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 1px;
    flex: 0 0 auto;
    align-self: center;
    margin-left: auto;
  }
  .pstrip-market {
    font-family: 'Space Mono', monospace;
    font-size: 8px;
    color: var(--muted);
    white-space: nowrap;
  }
  .pstrip-market.live { color: #22c55e; }
  .pstrip-updated {
    font-family: 'Space Mono', monospace;
    font-size: 7px;
    color: var(--muted);
    opacity: 0.6;
  }

  .pstrip-movers-label {
    font-family: 'Space Mono', monospace;
    font-size: 8px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    align-self: center;
    white-space: nowrap;
    opacity: 0.6;
  }
  .pstrip-mover {
    flex: 0 0 auto;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    white-space: nowrap;
    font-size: 11px;
  }
  .pstrip-mover-ticker {
    font-family: 'DM Sans', sans-serif;
    font-weight: 700;
    font-size: 11px;
    color: var(--text);
  }
  .pstrip-divider {
    width: 1px;
    height: 24px;
    background: var(--border);
    flex-shrink: 0;
    align-self: center;
    margin: 0 2px;
  }

  @media (max-width: 900px) {
    .portfolio-strip { padding: 8px 16px; gap: 6px; }
  }

  /* 15. Navigation Bar */
  .bottom-bar {
    position: fixed;
    left: 0;
    right: 0;
    z-index: 10002;
    display: flex;
    justify-content: space-around;
    align-items: stretch;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
  .bottom-bar::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent 0%, rgba(0,229,160,0.3) 50%, transparent 100%);
    pointer-events: none;
  }
  .bottom-bar-tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 3px;
    padding: 8px 0 6px;
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    transition: color var(--transition-fast);
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }
  .bottom-bar-tab span {
    font-family: 'Space Mono', monospace;
    font-size: 8px;
    letter-spacing: 0.3px;
  }
  .bottom-bar-tab:hover { color: var(--text); }
  .bottom-bar-tab.active { color: var(--accent); }
  .bottom-bar-icon {
    width: 19px;
    height: 19px;
  }

  /* Bottom bar â€” all screen sizes */
  .bottom-bar {
    bottom: 0;
    top: auto;
    border-top: 1px solid var(--glass-border);
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .bottom-bar::before { top: -1px; bottom: auto; }
  .bottom-bar-tab.active::after {
    content: '';
    position: absolute;
    top: 0; bottom: auto;
    left: 25%; right: 25%;
    height: 2px;
    background: var(--accent);
    border-radius: 0 0 2px 2px;
  }
  body { padding-bottom: 56px; }

  /* Hide old sticky analyze button â€” replaced by nav bar */
  .btn-analyze-sticky { display: none !important; }

  /* 16. Portfolio Drawer (popover above Portfolios tab) */
  .portfolio-drawer {
    position: fixed;
    inset: 0;
    z-index: 10001;
    background: rgba(0,0,0,0);
    pointer-events: none;
    transition: background var(--transition-med);
  }
  .portfolio-drawer.open {
    background: rgba(0,0,0,0.4);
    pointer-events: auto;
  }
  .pdrawer-panel {
    position: absolute;
    bottom: calc(52px + env(safe-area-inset-bottom, 0px));
    left: 12px;
    width: 280px;
    max-height: 50vh;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow-y: auto;
    box-shadow: 0 -8px 40px rgba(0,0,0,0.4);
    opacity: 0;
    transform: translateY(8px) scale(0.97);
    transition: opacity var(--transition-fast), transform var(--transition-fast);
  }
  .portfolio-drawer.open .pdrawer-panel {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  .pdrawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px 12px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 1;
  }
  .pdrawer-title {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    color: var(--muted);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }
  .pdrawer-close {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 16px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: color var(--transition-fast), background var(--transition-fast);
  }
  .pdrawer-close:hover { color: var(--text); background: var(--surface2); }
  .pdrawer-list { padding: 8px 12px; display: flex; flex-direction: column; gap: 4px; }
  .pdrawer-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    border-left: 3px solid var(--muted);
    cursor: pointer;
    transition: border-color var(--transition-fast), background var(--transition-fast);
  }
  .pdrawer-item:hover { border-color: var(--accent); }
  .pdrawer-item.active {
    border-color: var(--accent);
    background: rgba(0,229,160,0.06);
  }
  .pdrawer-info { flex: 1; min-width: 0; }
  .pdrawer-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .pdrawer-delete {
    background: rgba(255,100,100,0.08);
    border: 1px solid rgba(255,100,100,0.15);
    color: #ff6b6b;
    font-size: 14px;
    cursor: pointer;
    min-width: 36px;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2px 6px;
    border-radius: 4px;
    line-height: 1;
    transition: color 0.15s, background 0.15s;
    flex-shrink: 0;
  }
  .pdrawer-delete:hover, .pdrawer-delete:active { color: #fff; background: rgba(255,100,100,0.25); border-color: rgba(255,100,100,0.4); }
  .pdrawer-item.active .pdrawer-name {
    background: var(--accent-gradient-text);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .pdrawer-count {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
  }
  .pdrawer-empty {
    padding: 24px 20px;
    text-align: center;
    font-size: 13px;
    color: var(--muted);
    line-height: 1.6;
  }

  /* â”€â”€ SPARKLINE CHART GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sparkline-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
    padding: 12px 24px;
  }
  .sparkline-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 10px 12px 8px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    box-shadow: var(--glass-shadow);
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    animation: slideIn 0.25s ease backwards;
  }
  .sparkline-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--glass-shadow), var(--accent-glow-subtle);
    border-color: var(--accent);
  }
  .spark-card-header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 4px;
    margin-bottom: 2px;
  }
  .spark-card-ticker {
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
  }
  .spark-card-alloc {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    font-weight: 600;
    color: var(--muted);
    opacity: 0.7;
    cursor: pointer;
    border-radius: 3px;
    padding: 1px 3px;
    transition: background 0.15s, color 0.15s;
  }
  .spark-card-alloc:hover { background: var(--surface2); color: var(--text); opacity: 1; }
  .spark-card-alloc-input {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    font-weight: 600;
    width: 40px;
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 4px;
    padding: 1px 3px;
    color: var(--text);
    outline: none;
    text-align: right;
  }
  .spark-card-remove {
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(0,0,0,0.5);
    border: none;
    color: var(--muted);
    font-size: 12px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.15s, color 0.15s, background 0.15s;
    z-index: 2;
    line-height: 1;
    padding: 0;
  }
  .sparkline-card:hover .spark-card-remove { opacity: 1; }
  .spark-card-remove:hover { color: var(--aggressive); background: rgba(255,140,66,0.2); }
  @media (hover: none) {
    .spark-card-remove { opacity: 0.7; }
  }
  .spark-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 9px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 6px;
  }
  .spark-chart {
    width: 100%;
    height: 50px;
    overflow: hidden;
    position: relative;
  }
  .spark-chart svg {
    display: block;
    width: 100%;
    height: 100%;
  }
  .spark-shimmer {
    width: 100%;
    height: 50px;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--surface2) 25%, var(--border) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s ease-in-out infinite;
  }
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  .spark-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 4px;
  }
  .spark-price {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    font-weight: 700;
    color: var(--text);
  }
  .spark-change {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 4px;
  }
  .spark-change.up {
    color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
  }
  .spark-change.down {
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }
  .spark-sector-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    position: absolute;
    bottom: 8px;
    left: 12px;
  }

  /* â”€â”€ EXPANDED CHART MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chart-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 10002;
    background: rgba(0, 0, 0, 0);
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    transition: background 0.25s;
    padding: 16px;
  }
  .chart-modal-overlay.open {
    background: rgba(0, 0, 0, 0.55);
    pointer-events: auto;
  }
  .chart-modal-card {
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 24px 20px 20px;
    max-width: 520px;
    width: 100%;
    box-shadow: 0 24px 80px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transform: translateY(12px) scale(0.97);
    transition: opacity 0.25s, transform 0.25s;
  }
  .chart-modal-overlay.open .chart-modal-card {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
  .chart-modal-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .chart-modal-ticker {
    font-family: 'DM Sans', sans-serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
  }
  .chart-modal-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }
  .chart-modal-sector {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
  }
  .chart-modal-price-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-top: 4px;
  }
  .chart-modal-price {
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
  }
  .chart-modal-change {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .chart-modal-change.up { color: #22c55e; background: rgba(34,197,94,0.1); }
  .chart-modal-change.down { color: #ef4444; background: rgba(239,68,68,0.1); }
  .chart-modal-alloc {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    margin-top: 4px;
  }
  .chart-modal-close {
    background: none;
    border: 1px solid var(--border);
    border-radius: 8px;
    width: 32px;
    height: 32px;
    font-size: 18px;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, color 0.2s;
  }
  .chart-modal-close:hover {
    border-color: var(--accent);
    color: var(--text);
  }
  .chart-modal-ranges {
    display: flex;
    gap: 4px;
    margin-bottom: 12px;
  }
  .chart-range-btn {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    padding: 4px 10px;
    border: 1px solid var(--border);
    border-radius: 5px;
    background: none;
    color: var(--muted);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
  }
  .chart-range-btn:hover { border-color: var(--accent); color: var(--text); }
  .chart-range-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,160,0.08); }
  .chart-modal-chart {
    width: 100%;
    height: 200px;
    overflow: hidden;
    margin-bottom: 12px;
    position: relative;
  }
  .chart-modal-chart svg {
    display: block;
    width: 100%;
    height: 100%;
  }
  .chart-modal-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 16px;
  }
  .chart-stat {
    display: flex;
    justify-content: space-between;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
  }
  .chart-stat-label { color: var(--muted); }
  .chart-stat-value { color: var(--text); font-weight: 700; }

  /* â”€â”€ SPARKLINE MOBILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 600px) {
    .sparkline-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
      padding: 10px 16px;
    }
    .sparkline-card { padding: 8px 10px 6px; }
    .spark-chart, .spark-shimmer { height: 40px; }
    .chart-modal-card {
      padding: 18px 14px 14px;
      border-radius: 12px;
    }
    .chart-modal-ticker { font-size: 18px; }
    .chart-modal-price { font-size: 15px; }
    .chart-modal-chart { height: 160px; }
    .chart-modal-overlay { padding: 10px; }
  }

  /* â”€â”€ NAV PANEL (shared overlay for Market, Explore) â”€â”€â”€â”€â”€â”€â”€ */
  .nav-panel-overlay {
    position: fixed;
    inset: 0;
    z-index: 10001;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: flex-end;
    justify-content: center;
  }
  .nav-panel-overlay.open { display: flex; }
  .nav-panel {
    width: 100%;
    max-width: 520px;
    max-height: 75vh;
    background: var(--surface);
    border: 1px solid var(--glass-border);
    border-radius: 16px 16px 0 0;
    overflow-y: auto;
    padding: 0 0 calc(60px + env(safe-area-inset-bottom, 0px));
    animation: navPanelSlideUp 0.25s ease;
  }
  @keyframes navPanelSlideUp {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .nav-panel-header {
    position: sticky;
    top: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 16px 18px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--glass-border);
    z-index: 1;
  }
  .nav-panel-title {
    flex: 1;
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }
  .nav-panel-close {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
  }
  .nav-panel-close:hover { color: var(--text); background: var(--glass-bg); }
  .nav-panel-refresh {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    font-size: 16px;
    width: 28px;
    height: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.15s, border-color 0.15s;
    margin-right: 8px;
  }
  .nav-panel-refresh:hover { color: var(--accent); border-color: var(--accent); }
  .nav-panel-refresh.spinning { animation: pstrip-spin 0.8s linear infinite; color: var(--accent); pointer-events: none; }
  .nav-panel-body { padding: 14px 18px; }

  /* â”€â”€ Market Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .market-section-label {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    margin: 16px 0 8px;
  }
  .market-section-label:first-child { margin-top: 0; }
  .market-mover-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    border-bottom: 1px solid var(--glass-border);
  }
  .market-mover-row:last-child { border-bottom: none; }
  .market-mover-ticker {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--text);
    min-width: 50px;
  }
  .market-mover-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: var(--muted);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .market-mover-price {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    color: var(--text);
    min-width: 60px;
    text-align: right;
  }
  .market-mover-change {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    min-width: 55px;
    text-align: right;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .market-mover-change.up { color: #22c55e; background: rgba(34,197,94,0.1); }
  .market-mover-change.down { color: #ef4444; background: rgba(239,68,68,0.1); }
  .market-mover-change.flat { color: var(--muted); }
  .market-status-card {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    margin-bottom: 12px;
  }
  .market-status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
  }
  .market-status-dot.live { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.5); }
  .market-status-label {
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: var(--text);
    font-weight: 600;
  }
  .market-status-sub {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: var(--muted);
  }

  /* â”€â”€ Explore Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .explore-sector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
  }
  .explore-sector-card {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  .explore-sector-card:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
  }
  .explore-sector-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .explore-sector-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    color: var(--text);
    font-weight: 600;
  }
  .explore-sector-count {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    margin-left: auto;
  }
  .explore-stock-list { margin-top: 10px; }
  .explore-stock-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 0;
    border-bottom: 1px solid var(--glass-border);
    cursor: pointer;
  }
  .explore-stock-row:hover { background: var(--glass-bg); margin: 0 -18px; padding: 7px 18px; border-radius: 6px; }
  .explore-stock-ticker {
    font-family: 'Space Mono', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    min-width: 48px;
  }
  .explore-stock-name {
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    color: var(--muted);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .explore-stock-sector {
    font-family: 'Space Mono', monospace;
    font-size: 9px;
    color: var(--muted);
    padding: 1px 5px;
    border: 1px solid var(--glass-border);
    border-radius: 4px;
  }
  .explore-back-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    color: var(--accent);
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    cursor: pointer;
    padding: 6px 0;
    margin-bottom: 8px;
  }
  .explore-back-btn:hover { text-decoration: underline; }
  .explore-search-input {
    width: 100%;
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--glass-border);
    background: var(--glass-bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    outline: none;
    margin-bottom: 12px;
    box-sizing: border-box;
  }
  .explore-search-input::placeholder { color: var(--muted); }
  .explore-search-input:focus { border-color: var(--accent); }

  @media print {
    .bottom-bar, .portfolio-drawer, .nav-panel-overlay { display: none !important; }
  }

========== FILE: public/vercel.json ==========
{
  "functions": {
    "api/market-data.js": { "maxDuration": 15 },
    "api/claude.js": { "maxDuration": 30 },
    "api/auth.js": { "maxDuration": 10 },
    "api/verify-pro.js": { "maxDuration": 10 },
    "api/portfolios.js": { "maxDuration": 10 },
    "api/stripe-webhook.js": { "maxDuration": 10 },
"api/check-feature.js": { "maxDuration": 10 },
    "api/pro-picks.js": { "maxDuration": 10 },
    "api/delete-account.js": { "maxDuration": 10 },
    "api/auth-apple.js": { "maxDuration": 10 },
    "api/signout.js": { "maxDuration": 10 },
    "api/register-push.js": { "maxDuration": 10 },
    "api/send-notifications.js": { "maxDuration": 30 },
    "api/refresh-stock-data.js": { "maxDuration": 60 },
    "api/stock-data.js": { "maxDuration": 10 },
    "api/sparkline.js": { "maxDuration": 15 },
    "api/top-movers.js": { "maxDuration": 30 }
  },
  "crons": [
    {
      "path": "/api/send-notifications",
      "schedule": "30 14 * * 1-5"
    },
    {
      "path": "/api/refresh-stock-data",
      "schedule": "0 11 * * 1-5"
    }
  ],
  "headers": [
    {
      "source": "/data.js",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=0, must-revalidate" }
      ]
    },
    {
      "source": "/app.js",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=0, must-revalidate" }
      ]
    },
    {
      "source": "/patches.js",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=0, must-revalidate" }
      ]
    },
    {
      "source": "/styles.css",
      "headers": [
        { "key": "Cache-Control", "value": "public, max-age=0, must-revalidate" }
      ]
    },
    {
      "source": "/api/market-data",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "s-maxage=3600, stale-while-revalidate=600"
        }
      ]
    },
    {
      "source": "/api/sparkline",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "s-maxage=14400, stale-while-revalidate=1800"
        }
      ]
    },
    {
      "source": "/api/top-movers",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "s-maxage=900, stale-while-revalidate=300"
        }
      ]
    },
    {
      "source": "/api/verify-pro",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "no-store, no-cache, must-revalidate"
        }
      ]
    },
    {
      "source": "/public/(.*)",
      "headers": [
        {
          "key": "Cache-Control",
          "value": "public, max-age=31536000, immutable"
        }
      ]
    },
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" },
        { "key": "Cross-Origin-Opener-Policy", "value": "same-origin-allow-popups" },
        { "key": "Strict-Transport-Security", "value": "max-age=63072000; includeSubDomains; preload" },
        { "key": "Permissions-Policy", "value": "camera=(), microphone=(), geolocation=()" },
        { "key": "Content-Security-Policy", "value": "default-src 'self'; script-src 'self' 'unsafe-inline' https://accounts.google.com https://appleid.cdn-apple.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com; font-src https://fonts.gstatic.com; img-src 'self' data: https://lh3.googleusercontent.com https://accounts.google.com; connect-src 'self' https://accounts.google.com https://appleid.apple.com https://exp.host; frame-src https://accounts.google.com https://appleid.cdn-apple.com; frame-ancestors 'none'; form-action 'self' https://buy.stripe.com; base-uri 'self'" }
      ]
    }
  ]
}

========== FILE: public/sw.js ==========
const CACHE_NAME = 'pcompass-v8';
const PRECACHE = [
  '/',
  '/index.html',
  '/styles.css',
  '/data.js',
  '/app.js',
  '/patches.js',
  '/privacy.html',
  '/terms.html',
  '/support.html'
];

// Install: cache the app shell
self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => cache.addAll(PRECACHE))
      .then(() => self.skipWaiting())
  );
});

// Activate: clean old caches and take control immediately
self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys =>
      Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k)))
    ).then(() => self.clients.claim())
  );
});

// Fetch: network-first for everything (API and assets)
// This ensures users always get fresh code
self.addEventListener('fetch', e => {
  const url = new URL(e.request.url);

  // Always go to network for API calls
  if (url.pathname.startsWith('/api/')) return;

  e.respondWith(
    fetch(e.request)
      .then(res => {
        // Cache successful GET responses
        if (res.ok && e.request.method === 'GET') {
          const clone = res.clone();
          caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
        }
        return res;
      })
      .catch(() => caches.match(e.request))
  );
});

========== FILE: public/data.js ==========
// â”€â”€ DATA â€” Static databases and lookup tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Extracted from index.html to keep the main file lean

const SECTOR_COLORS = {
  'Big Tech':'#4d9fff','Semiconductors':'#a855f7','AI & Robotics':'#ec4899',
  'Software / SaaS':'#3b82f6','Social Media':'#f97316','Fintech':'#00e5a0',
  'Crypto / Bitcoin':'#f59e0b','Banking':'#6366f1','Healthcare':'#22c55e',
  'Biotech':'#84cc16','E-Commerce':'#06b6d4','Retail':'#8b5cf6',
  'Apparel':'#f43f5e','Food & Beverage':'#fb923c','Consumer Staples':'#a3e635',
  'EVs & Autos':'#34d399','Entertainment':'#c084fc','Sports Betting':'#fb7185',
  'Travel & Mobility':'#38bdf8','Pets & Specialty':'#fdba74',
  'China / Emerging':'#f87171','International':'#60a5fa','Oil & Gas':'#fbbf24',
  'Clean Energy':'#4ade80','Gold & Metals':'#fcd34d','Defense':'#94a3b8',
  'Industrials':'#cbd5e1','Real Estate':'#f9a8d4','Utilities':'#86efac',
  'Materials':'#6ee7b7','Broad Market':'#64748b','Small-Caps':'#a78bfa',
  'Dividends':'#fca5a5','Bonds':'#93c5fd','Insurance':'#818cf8',
  'Cybersecurity':'#f472b6',
  'Telecom':'#0ea5e9','Aerospace':'#7c3aed','Media':'#e879f9',
  'Pharma':'#10b981','Transportation':'#d97706','Agriculture':'#65a30d',
  'Other':'#475569',
};

const STOCK_DB = {
  // Big Tech
  AAPL:{name:'Apple',sector:'Big Tech',beta:1.2,cap:'mega'},
  MSFT:{name:'Microsoft',sector:'Big Tech',beta:0.9,cap:'mega'},
  GOOGL:{name:'Alphabet',sector:'Big Tech',beta:1.1,cap:'mega'},
  GOOG:{name:'Alphabet C',sector:'Big Tech',beta:1.1,cap:'mega'},
  META:{name:'Meta',sector:'Big Tech',beta:1.3,cap:'mega'},
  AMZN:{name:'Amazon',sector:'E-Commerce',beta:1.2,cap:'mega'},
  // Semis
  NVDA:{name:'NVIDIA',sector:'Semiconductors',beta:1.8,cap:'mega'},
  AMD:{name:'AMD',sector:'Semiconductors',beta:1.7,cap:'large'},
  INTC:{name:'Intel',sector:'Semiconductors',beta:0.9,cap:'large'},
  TSM:{name:'TSMC',sector:'Semiconductors',beta:1.1,cap:'mega'},
  AVGO:{name:'Broadcom',sector:'Semiconductors',beta:1.2,cap:'mega'},
  QCOM:{name:'Qualcomm',sector:'Semiconductors',beta:1.2,cap:'large'},
  MU:{name:'Micron',sector:'Semiconductors',beta:1.5,cap:'large'},
  // Software
  CRM:{name:'Salesforce',sector:'Software / SaaS',beta:1.2,cap:'large'},
  ORCL:{name:'Oracle',sector:'Software / SaaS',beta:1.0,cap:'mega'},
  NOW:{name:'ServiceNow',sector:'Software / SaaS',beta:1.3,cap:'large'},
  SNOW:{name:'Snowflake',sector:'Software / SaaS',beta:1.6,cap:'large'},
  PLTR:{name:'Palantir',sector:'AI & Robotics',beta:1.5,cap:'large'},
  // Social
  HOOD:{name:'Robinhood',sector:'Fintech',beta:1.8,cap:'mid'},
  SOFI:{name:'SoFi',sector:'Fintech',beta:1.9,cap:'mid'},
  COIN:{name:'Coinbase',sector:'Crypto / Bitcoin',beta:2.0,cap:'large'},
  DKNG:{name:'DraftKings',sector:'Sports Betting',beta:1.7,cap:'mid'},
  // Finance
  JPM:{name:'JPMorgan',sector:'Banking',beta:1.1,cap:'mega'},
  BAC:{name:'Bank of America',sector:'Banking',beta:1.2,cap:'mega'},
  GS:{name:'Goldman Sachs',sector:'Banking',beta:1.3,cap:'large'},
  V:{name:'Visa',sector:'Banking',beta:0.9,cap:'mega'},
  MA:{name:'Mastercard',sector:'Banking',beta:1.0,cap:'mega'},
  // Healthcare
  JNJ:{name:"J&J",sector:'Pharma',beta:0.6,cap:'mega'},
  UNH:{name:'UnitedHealth',sector:'Healthcare',beta:0.7,cap:'mega'},
  PFE:{name:'Pfizer',sector:'Pharma',beta:0.7,cap:'mega'},
  LLY:{name:'Eli Lilly',sector:'Pharma',beta:0.7,cap:'mega'},
  ABBV:{name:'AbbVie',sector:'Pharma',beta:0.65,cap:'mega'},
  MRNA:{name:'Moderna',sector:'Biotech',beta:1.3,cap:'large'},
  // Consumer
  TSLA:{name:'Tesla',sector:'EVs & Autos',beta:2.0,cap:'mega'},
  RIVN:{name:'Rivian',sector:'EVs & Autos',beta:1.8,cap:'mid'},
  NIO:{name:'NIO',sector:'EVs & Autos',beta:1.9,cap:'mid'},
  LULU:{name:'Lululemon',sector:'Apparel',beta:1.4,cap:'large'},
  NKE:{name:'Nike',sector:'Apparel',beta:1.0,cap:'large'},
  COST:{name:'Costco',sector:'Retail',beta:0.8,cap:'mega'},
  WMT:{name:'Walmart',sector:'Consumer Staples',beta:0.5,cap:'mega'},
  PG:{name:'P&G',sector:'Consumer Staples',beta:0.6,cap:'mega'},
  KO:{name:'Coca-Cola',sector:'Consumer Staples',beta:0.6,cap:'mega'},
  MCD:{name:"McDonald's",sector:'Food & Beverage',beta:0.8,cap:'mega'},
  SBUX:{name:'Starbucks',sector:'Food & Beverage',beta:0.9,cap:'large'},
  // Entertainment
  DIS:{name:'Disney',sector:'Entertainment',beta:1.1,cap:'large'},
  NFLX:{name:'Netflix',sector:'Entertainment',beta:1.3,cap:'mega'},
  SPOT:{name:'Spotify',sector:'Entertainment',beta:1.4,cap:'large'},
  // Travel
  UBER:{name:'Uber',sector:'Travel & Mobility',beta:1.5,cap:'large'},
  ABNB:{name:'Airbnb',sector:'Travel & Mobility',beta:1.6,cap:'large'},
  // Energy
  XOM:{name:'ExxonMobil',sector:'Oil & Gas',beta:0.9,cap:'mega'},
  CVX:{name:'Chevron',sector:'Oil & Gas',beta:0.9,cap:'mega'},
  NEE:{name:'NextEra Energy',sector:'Clean Energy',beta:0.7,cap:'mega'},
  // International
  BABA:{name:'Alibaba',sector:'China / Emerging',beta:1.3,cap:'large'},
  BIDU:{name:'Baidu',sector:'China / Emerging',beta:1.2,cap:'large'},
  // Pets
  CHWY:{name:'Chewy',sector:'Pets & Specialty',beta:1.5,cap:'mid'},
  // Misc
  AMC:{name:'AMC',sector:'Entertainment',beta:2.0,cap:'small'},
  GME:{name:'GameStop',sector:'Retail',beta:1.8,cap:'small'},
  // Education & Consumer Tech
  DUOL:{name:'Duolingo',sector:'Software / SaaS',beta:1.6,cap:'mid'},
  RBLX:{name:'Roblox',sector:'Entertainment',beta:1.7,cap:'mid'},
  U:{name:'Unity',sector:'Software / SaaS',beta:1.5,cap:'mid'},
  APP:{name:'AppLovin',sector:'Software / SaaS',beta:1.8,cap:'large'},
  PINS:{name:'Pinterest',sector:'Social Media',beta:1.3,cap:'mid'},
  SNAP:{name:'Snap',sector:'Social Media',beta:1.6,cap:'mid'},
  TWTR:{name:'Twitter/X',sector:'Social Media',beta:1.4,cap:'mid'},
  RDDT:{name:'Reddit',sector:'Social Media',beta:1.7,cap:'mid'},
  // Fintech & Crypto
  PYPL:{name:'PayPal',sector:'Fintech',beta:1.3,cap:'large'},
  AFRM:{name:'Affirm',sector:'Fintech',beta:1.9,cap:'mid'},
  UPST:{name:'Upstart',sector:'Fintech',beta:2.0,cap:'small'},
  NU:{name:'Nubank',sector:'Fintech',beta:1.5,cap:'large'},
  MSTR:{name:'MicroStrategy',sector:'Crypto / Bitcoin',beta:2.2,cap:'mid'},
  MARA:{name:'Marathon Digital',sector:'Crypto / Bitcoin',beta:2.3,cap:'small'},
  RIOT:{name:'Riot Platforms',sector:'Crypto / Bitcoin',beta:2.3,cap:'small'},
  // AI & Software
  AI:{name:'C3.ai',sector:'AI & Robotics',beta:1.8,cap:'small'},
  BBAI:{name:'BigBear.ai',sector:'AI & Robotics',beta:1.9,cap:'small'},
  PATH:{name:'UiPath',sector:'AI & Robotics',beta:1.5,cap:'mid'},
  SOUN:{name:'SoundHound AI',sector:'AI & Robotics',beta:2.1,cap:'small'},
  IONQ:{name:'IonQ',sector:'AI & Robotics',beta:2.0,cap:'small'},
  ANET:{name:'Arista Networks',sector:'Software / SaaS',beta:1.3,cap:'large'},
  DDOG:{name:'Datadog',sector:'Software / SaaS',beta:1.5,cap:'large'},
  ZS:{name:'Zscaler',sector:'Cybersecurity',beta:1.4,cap:'large'},
  CRWD:{name:'CrowdStrike',sector:'Cybersecurity',beta:1.4,cap:'large'},
  PANW:{name:'Palo Alto Networks',sector:'Cybersecurity',beta:1.3,cap:'large'},
  OKTA:{name:'Okta',sector:'Cybersecurity',beta:1.4,cap:'mid'},
  MDB:{name:'MongoDB',sector:'Software / SaaS',beta:1.5,cap:'mid'},
  NET:{name:'Cloudflare',sector:'Cybersecurity',beta:1.5,cap:'large'},
  HCP:{name:'HashiCorp',sector:'Software / SaaS',beta:1.3,cap:'mid'},
  // Healthcare & Biotech
  ISRG:{name:'Intuitive Surgical',sector:'Healthcare',beta:1.0,cap:'large'},
  DXCM:{name:'DexCom',sector:'Healthcare',beta:1.2,cap:'large'},
  TDOC:{name:'Teladoc',sector:'Healthcare',beta:1.5,cap:'mid'},
  HIMS:{name:'Hims & Hers',sector:'Healthcare',beta:1.8,cap:'mid'},
  RXRX:{name:'Recursion Pharma',sector:'Biotech',beta:1.7,cap:'small'},
  BEAM:{name:'Beam Therapeutics',sector:'Biotech',beta:1.6,cap:'small'},
  CRSP:{name:'CRISPR Therapeutics',sector:'Biotech',beta:1.5,cap:'mid'},
  // Consumer & Retail
  SHOP:{name:'Shopify',sector:'E-Commerce',beta:1.6,cap:'large'},
  ETSY:{name:'Etsy',sector:'E-Commerce',beta:1.4,cap:'mid'},
  W:{name:'Wayfair',sector:'E-Commerce',beta:1.8,cap:'mid'},
  ONON:{name:'On Running',sector:'Apparel',beta:1.5,cap:'mid'},
  DECK:{name:'Deckers (Hoka/UGG)',sector:'Apparel',beta:1.3,cap:'large'},
  CELH:{name:'Celsius Holdings',sector:'Food & Beverage',beta:1.8,cap:'mid'},
  MNST:{name:'Monster Beverage',sector:'Food & Beverage',beta:0.9,cap:'large'},
  // Travel & Mobility
  LYFT:{name:'Lyft',sector:'Travel & Mobility',beta:1.7,cap:'mid'},
  BKNG:{name:'Booking Holdings',sector:'Travel & Mobility',beta:1.2,cap:'large'},
  EXPE:{name:'Expedia',sector:'Travel & Mobility',beta:1.4,cap:'large'},
  LUV:{name:'Southwest Airlines',sector:'Travel & Mobility',beta:1.3,cap:'mid'},
  DAL:{name:'Delta Air Lines',sector:'Travel & Mobility',beta:1.4,cap:'large'},
  // EVs & Autos
  GM:{name:'General Motors',sector:'EVs & Autos',beta:1.3,cap:'large'},
  F:{name:'Ford',sector:'EVs & Autos',beta:1.3,cap:'large'},
  LCID:{name:'Lucid Motors',sector:'EVs & Autos',beta:1.9,cap:'small'},
  // Energy & Materials
  OXY:{name:'Occidental Petroleum',sector:'Oil & Gas',beta:1.1,cap:'large'},
  COP:{name:'ConocoPhillips',sector:'Oil & Gas',beta:1.1,cap:'large'},
  SLB:{name:'SLB (Schlumberger)',sector:'Oil & Gas',beta:1.2,cap:'large'},
  FCX:{name:'Freeport-McMoRan',sector:'Materials',beta:1.4,cap:'large'},
  AA:{name:'Alcoa',sector:'Materials',beta:1.5,cap:'mid'},
  // Defense & Industrials
  RTX:{name:'RTX (Raytheon)',sector:'Defense',beta:0.9,cap:'mega'},
  NOC:{name:'Northrop Grumman',sector:'Defense',beta:0.8,cap:'large'},
  GD:{name:'General Dynamics',sector:'Defense',beta:0.9,cap:'large'},
  BA:{name:'Boeing',sector:'Aerospace',beta:1.3,cap:'large'},
  GE:{name:'GE Aerospace',sector:'Industrials',beta:1.2,cap:'large'},
  DE:{name:'Deere & Co',sector:'Industrials',beta:1.1,cap:'large'},
  // Real Estate & Finance
  AMT:{name:'American Tower REIT',sector:'Real Estate',beta:0.8,cap:'large'},
  O:{name:'Realty Income',sector:'Real Estate',beta:0.7,cap:'large'},
  BX:{name:'Blackstone',sector:'Banking',beta:1.4,cap:'mega'},
  KKR:{name:'KKR',sector:'Banking',beta:1.4,cap:'large'},
  SCHW:{name:'Charles Schwab',sector:'Banking',beta:1.2,cap:'large'},
  MS:{name:'Morgan Stanley',sector:'Banking',beta:1.3,cap:'mega'},
  // Insurance & Other Finance
  BRK:{name:'Berkshire Hathaway',sector:'Banking',beta:0.9,cap:'mega'},
  BRKB:{name:'Berkshire Hathaway B',sector:'Banking',beta:0.9,cap:'mega'},
  AXP:{name:'American Express',sector:'Banking',beta:1.2,cap:'mega'},
  // Consumer Staples
  PEP:{name:'PepsiCo',sector:'Consumer Staples',beta:0.6,cap:'mega'},
  MDLZ:{name:'Mondelez',sector:'Consumer Staples',beta:0.7,cap:'large'},
  CL:{name:'Colgate-Palmolive',sector:'Consumer Staples',beta:0.6,cap:'large'},
  // More Big Tech & Software
  IBM:{name:'IBM',sector:'Software / SaaS',beta:0.9,cap:'large'},
  ADBE:{name:'Adobe',sector:'Software / SaaS',beta:1.3,cap:'mega'},
  SAP:{name:'SAP',sector:'Software / SaaS',beta:1.0,cap:'mega'},
  INTU:{name:'Intuit',sector:'Software / SaaS',beta:1.2,cap:'large'},
  WDAY:{name:'Workday',sector:'Software / SaaS',beta:1.3,cap:'large'},
  ZM:{name:'Zoom',sector:'Software / SaaS',beta:1.1,cap:'mid'},
  DOCU:{name:'DocuSign',sector:'Software / SaaS',beta:1.3,cap:'mid'},
  TWLO:{name:'Twilio',sector:'Software / SaaS',beta:1.5,cap:'mid'},
  BOX:{name:'Box',sector:'Software / SaaS',beta:1.0,cap:'mid'},
  GTLB:{name:'GitLab',sector:'Software / SaaS',beta:1.4,cap:'mid'},
  TTD:{name:'The Trade Desk',sector:'Software / SaaS',beta:1.6,cap:'large'},
  FROG:{name:'JFrog',sector:'Software / SaaS',beta:1.3,cap:'mid'},
  SMAR:{name:'Smartsheet',sector:'Software / SaaS',beta:1.2,cap:'mid'},
  // More AI & Robotics
  ACHR:{name:'Archer Aviation',sector:'Aerospace',beta:2.0,cap:'small'},
  JOBY:{name:'Joby Aviation',sector:'Aerospace',beta:1.9,cap:'small'},
  EXAI:{name:'Exscientia',sector:'AI & Robotics',beta:1.7,cap:'small'},
  // More Social & Consumer Tech
  MTCH:{name:'Match Group',sector:'Social Media',beta:1.4,cap:'mid'},
  IAC:{name:'IAC',sector:'Social Media',beta:1.3,cap:'mid'},

... (truncated after 200 lines) ...

========== FILE: api/auth-apple.js ==========
import * as jose from 'jose';
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

// â”€â”€ APPLE JWKS (cached) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APPLE_JWKS = jose.createRemoteJWKSet(new URL('https://appleid.apple.com/auth/keys'));

export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);

  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }

  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  // â”€â”€ Rate limit â”€â”€
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'auth-apple', 20)) {
    return res.status(429).json({ error: 'Too many authentication attempts' });
  }

  const { id_token, nonce: rawNonce, user: appleUser } = req.body;

  if (!id_token) {
    return res.status(400).json({ error: 'No id_token provided' });
  }

  try {
    // Verify Apple id_token JWT against Apple's public keys
    const { payload } = await jose.jwtVerify(id_token, APPLE_JWKS, {
      issuer: 'https://appleid.apple.com',
      audience: process.env.APPLE_SERVICE_ID,
    });

    const appleId = payload.sub;
    const email = payload.email;

    if (!appleId || !email) {
      return res.status(401).json({ error: 'Token missing user info' });
    }

    // Verify nonce to prevent replay attacks
    // Nonce is mandatory for native app builds (iOS), optional for web Sign-in with Apple
    const isNativeApp = (req.headers['user-agent'] || '').includes('pcompass-ios');
    if (isNativeApp && (!rawNonce || !payload.nonce)) {
      return res.status(401).json({ error: 'Nonce required for native app authentication' });
    }
    if (rawNonce && payload.nonce) {
      const enc = new TextEncoder();
      const hashBuf = await crypto.subtle.digest('SHA-256', enc.encode(rawNonce));
      const expectedNonce = Array.from(new Uint8Array(hashBuf), b => b.toString(16).padStart(2, '0')).join('');
      if (payload.nonce !== expectedNonce) {
        return res.status(401).json({ error: 'Nonce mismatch â€” possible replay' });
      }
    }

    // Apple requires email_verified check
    if (payload.email_verified === false || payload.email_verified === 'false') {
      return res.status(401).json({ error: 'Unverified email' });
    }

    // Name is only sent on first sign-in (from the user object, not the JWT)
    let name = email.split('@')[0];
    if (appleUser && appleUser.name) {
      const first = appleUser.name.firstName || '';
      const last = appleUser.name.lastName || '';
      name = (first + ' ' + last).trim() || name;
    }

    // Upsert user â€” try apple_id first, then fall back to email match.
    // This avoids edge cases where two Apple IDs share an email alias.
    let users = await neonSQL(
      `UPDATE users SET last_login = NOW() WHERE apple_id = $1
       RETURNING id, email, name, picture, COALESCE(session_version, 1) AS session_version`,
      [appleId]
    );

    if (users.length === 0) {
      // Not found by apple_id â€” upsert by email (new Apple user or Google user adding Apple)
      users = await neonSQL(
        `INSERT INTO users (apple_id, email, name, picture, last_login)
         VALUES ($1, $2, $3, '', NOW())
         ON CONFLICT (email) DO UPDATE SET
           apple_id = COALESCE(users.apple_id, $1),
           last_login = NOW(),
           name = CASE WHEN users.name IS NULL OR users.name = '' THEN $3 ELSE users.name END
         RETURNING id, email, name, picture, COALESCE(session_version, 1) AS session_version`,
        [appleId, email, name]
      );
    }

    const user = users[0];
    const sv = String(user.session_version || 1);

    // Generate HMAC-signed auth token (4hr expiry)
    // Bound to userId + email + session_version to prevent identity confusion and enable revocation
    const authTs = Math.floor(Date.now() / 1000);
    const secret = process.env.AUTH_TOKEN_SECRET;
    if (!secret) throw new Error('AUTH_TOKEN_SECRET not configured');
    const enc = new TextEncoder();
    const authKey = await crypto.subtle.importKey(
      'raw', enc.encode(secret),
      { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
    );
    const authSig = await crypto.subtle.sign(
      'HMAC', authKey,
      enc.encode(`auth:${user.id}:${email.toLowerCase().trim()}:${sv}:${authTs}`)
    );
    const authToken = Array.from(new Uint8Array(authSig))
      .map(b => b.toString(16).padStart(2, '0')).join('');

    // Set HttpOnly auth cookie (format: userId|email|sv|ts|token)
    const cookieVal = encodeURIComponent(`${user.id}|${email.toLowerCase().trim()}|${sv}|${authTs}|${authToken}`);
    const secure = process.env.NODE_ENV === 'development' ? '' : '; Secure';
    res.setHeader('Set-Cookie', `pc_auth=${cookieVal}; HttpOnly${secure}; SameSite=Strict; Path=/api; Max-Age=14400`);

    res.status(200).json({
      success: true,
      user: { id: user.id, email: user.email, name: user.name, picture: user.picture || '' },
    });
  } catch (err) {
    console.error('Apple auth error:', err.message);
    res.status(401).json({ error: 'Apple authentication failed' });
  }
}

========== FILE: api/auth.js ==========
import * as jose from 'jose';
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

// â”€â”€ GOOGLE JWKS (cached) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GOOGLE_JWKS = jose.createRemoteJWKSet(new URL('https://www.googleapis.com/oauth2/v3/certs'));
const GOOGLE_CLIENT_ID = process.env.GOOGLE_CLIENT_ID;

export default async function handler(req, res) {
  if (!GOOGLE_CLIENT_ID) {
    console.error('GOOGLE_CLIENT_ID not configured');
    return res.status(500).json({ error: 'Server misconfiguration' });
  }
  // â”€â”€ CORS with origin allowlist â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);

  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }

  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  // â”€â”€ Rate limit by IP â”€â”€
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'auth', 20)) {
    return res.status(429).json({ error: 'Too many authentication attempts' });
  }

  const { credential, code } = req.body;

  let googleId, email, name, picture;
  let rawIdToken = null; // For iOS native relay

  try {
    if (code) {
      // Authorization code flow (iOS) â€” exchange code for tokens
      const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
      if (!clientSecret) throw new Error('GOOGLE_CLIENT_SECRET not configured');

      const tokenRes = await fetch('https://oauth2.googleapis.com/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          code,
          client_id: GOOGLE_CLIENT_ID,
          client_secret: clientSecret,
          redirect_uri: 'https://pcompass.vercel.app',
          grant_type: 'authorization_code',
        }),
      });
      const tokenData = await tokenRes.json();
      if (!tokenData.id_token) {
        console.error('Code exchange failed:', tokenData);
        return res.status(400).json({ error: 'Code exchange failed' });
      }
      rawIdToken = tokenData.id_token;

      // Verify the exchanged ID token
      const { payload } = await jose.jwtVerify(rawIdToken, GOOGLE_JWKS, {
        issuer: ['https://accounts.google.com', 'accounts.google.com'],
        audience: GOOGLE_CLIENT_ID,
      });
      if (!payload.sub || !payload.email) {
        return res.status(401).json({ error: 'Token missing user info' });
      }
      googleId = payload.sub;
      email = payload.email;
      name = payload.name || payload.email;
      picture = payload.picture || '';

    } else if (credential) {
      // GIS credential flow (web) â€” verify ID token directly
      const { payload } = await jose.jwtVerify(credential, GOOGLE_JWKS, {
        issuer: ['https://accounts.google.com', 'accounts.google.com'],
        audience: GOOGLE_CLIENT_ID,
      });

      if (!payload.sub || !payload.email) {
        return res.status(401).json({ error: 'Token missing user info' });
      }
      googleId = payload.sub;
      email = payload.email;
      name = payload.name || payload.email;
      picture = payload.picture || '';
    } else {
      return res.status(400).json({ error: 'No credential provided' });
    }

    const users = await neonSQL(
      `INSERT INTO users (google_id, email, name, picture, last_login)
       VALUES ($1, $2, $3, $4, NOW())
       ON CONFLICT (google_id) DO UPDATE SET last_login = NOW(), name = $3, picture = $4
       RETURNING id, email, name, picture, COALESCE(session_version, 1) AS session_version`,
      [googleId, email, name, picture]
    );

    const user = users[0];
    const sv = String(user.session_version || 1);

    // Generate HMAC-signed auth token (4hr expiry)
    // Bound to userId + email + session_version to prevent identity confusion and enable revocation
    const authTs = Math.floor(Date.now() / 1000);
    const secret = process.env.AUTH_TOKEN_SECRET;
    if (!secret) throw new Error('AUTH_TOKEN_SECRET not configured');
    const enc = new TextEncoder();
    const authKey = await crypto.subtle.importKey(
      'raw', enc.encode(secret),
      { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
    );
    const authSig = await crypto.subtle.sign(
      'HMAC', authKey,
      enc.encode(`auth:${user.id}:${email.toLowerCase().trim()}:${sv}:${authTs}`)
    );
    const authToken = Array.from(new Uint8Array(authSig))
      .map(b => b.toString(16).padStart(2, '0')).join('');

    // Set HttpOnly auth cookie (format: userId|email|sv|ts|token)
    const cookieVal = encodeURIComponent(`${user.id}|${email.toLowerCase().trim()}|${sv}|${authTs}|${authToken}`);
    const secure = process.env.NODE_ENV === 'development' ? '' : '; Secure';
    res.setHeader('Set-Cookie', `pc_auth=${cookieVal}; HttpOnly${secure}; SameSite=Strict; Path=/api; Max-Age=14400`);

    res.status(200).json({
      success: true,
      user: { id: user.id, email: user.email, name: user.name, picture: user.picture },
      ...(rawIdToken && { idToken: rawIdToken }),
    });
  } catch (err) {
    console.error('Auth error:', err.message);
    res.status(500).json({ error: 'Authentication failed' });
  }
}

========== FILE: api/check-feature.js ==========
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { extractAuth, getProFromCookie, verifyAuthToken, verifyProToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

const VALID_FEATURES = ['pdf', 'picks', 'slots', 'showmore'];

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Pro-Token, X-Pro-Email, X-Pro-Ts, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  // â”€â”€ Require valid auth token (cookie-first, header fallback) â”€â”€
  const auth = extractAuth(req);
  const isAuthenticated = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);
  if (!isAuthenticated) {
    return res.status(401).json({ error: 'Authentication required' });
  }

  // â”€â”€ Validate feature param â”€â”€
  const { feature } = req.body || {};
  if (!feature || !VALID_FEATURES.includes(feature)) {
    return res.status(400).json({ error: 'Invalid feature. Must be one of: ' + VALID_FEATURES.join(', ') });
  }

  // â”€â”€ Rate limit: 20/hr per email â”€â”€
  const clientKey = `email:${auth.email}`;
  try {
    if (!await checkRateLimit(clientKey, 'check-feature', 20)) {
      return res.status(429).json({ error: 'Rate limit exceeded' });
    }
  } catch (err) {
    console.error('[check-feature] rate limit error:', err.message);
    return res.status(503).json({ error: 'Service temporarily unavailable' });
  }

  // â”€â”€ Verify Pro status (cookie-first, header fallback) â”€â”€
  const proCk = getProFromCookie(req);
  const proToken = proCk?.token || req.headers['x-pro-token'] || '';
  const proEmail = (proCk?.email || req.headers['x-pro-email'] || '').toLowerCase().trim();
  const proTs    = proCk?.ts || req.headers['x-pro-ts'] || '';
  let isPro = await verifyProToken(proEmail, proToken, proTs);
  // Prevent privilege escalation: pro token email must match authenticated user
  if (isPro && proEmail !== auth.email) isPro = false;
  if (isPro) {
    try {
      const lic = await neonSQL(`SELECT active FROM pro_licenses WHERE LOWER(email) = $1 AND active = true LIMIT 1`, [proEmail]);
      if (lic.length === 0) isPro = false;
    } catch { isPro = false; }
  }

  return res.status(200).json({ allowed: isPro });
}

========== FILE: api/claude.js ==========
import Anthropic from '@anthropic-ai/sdk';
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { extractAuth, getProFromCookie, verifyAuthToken, verifyProToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';

const client = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });

// â”€â”€ DB-BACKED RATE LIMITER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LIMITS = {
  free:      { requests: 3,  windowMs: 60 * 60 * 1000 },       // 3/hr
  pro:       { requests: 50, windowMs: 60 * 60 * 1000 },       // 50/hr
  screenshot:{ requests: 3,  windowMs: 24 * 60 * 60 * 1000 },  // 3/day free
};

async function checkRateLimitDB(clientKey, endpoint, limitKey) {
  const limit = LIMITS[limitKey] || LIMITS.free;
  const windowStart = new Date(Date.now() - limit.windowMs).toISOString();

  // Single atomic CTE: insert + count in one statement (no race condition)
  const countResult = await neonSQL(
    `WITH ins AS (
      INSERT INTO api_usage (client_key, endpoint) VALUES ($1, $2)
      RETURNING created_at
    )
    SELECT COUNT(*)::int AS cnt FROM api_usage
    WHERE client_key = $1 AND endpoint = $2 AND created_at > $3`,
    [clientKey, endpoint, windowStart]
  );
  const count = countResult[0]?.cnt || 0;

  // Lazy cleanup (1 in 50 chance) â€” delete rows older than 48 hours
  if (Math.random() < 0.02) {
    neonSQL(`DELETE FROM api_usage WHERE created_at < NOW() - INTERVAL '48 hours'`).catch(() => {});
  }

  if (count > limit.requests) {
    return { allowed: false, remaining: 0, used: count };
  }

  return { allowed: true, remaining: limit.requests - count, used: count };
}

function getClientKey(req, isPro, proEmail, authEmail) {
  // Always prefer verified email over IP for rate limiting
  if (isPro && proEmail) return `email:${proEmail.toLowerCase().trim()}`;
  if (authEmail) return `email:${authEmail.toLowerCase().trim()}`;
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  return `ip:${ip}`;
}

// â”€â”€ DETECT SCREENSHOT REQUESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isScreenshotRequest(messages) {
  return messages?.some(m =>
    Array.isArray(m.content) &&
    m.content.some(c => c.type === 'image')
  );
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // â”€â”€ CORS with origin allowlist â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);

  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Pro-Token, X-Pro-Email, X-Pro-Ts, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }

  // Block requests with an Origin header that isn't in the allowlist
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req, 10_000_000)) return res.status(413).json({ error: 'Request body too large' });

  // â”€â”€ Auth check (cookie-first, header fallback) â”€â”€
  // All requests are allowed without auth (rate-limited by IP for free users)
  const auth = extractAuth(req);
  const isAuthenticated = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);

  // â”€â”€ Verify Pro server-side (cookie-first, header fallback) â”€â”€
  const proCk = getProFromCookie(req);
  const proToken = proCk?.token || req.headers['x-pro-token'] || '';
  const proEmail = (proCk?.email || req.headers['x-pro-email'] || '').toLowerCase().trim();
  const proTs    = proCk?.ts || req.headers['x-pro-ts'] || '';
  let isPro = await verifyProToken(proEmail, proToken, proTs);
  // Prevent privilege escalation: pro token email must match authenticated user
  if (isPro && proEmail !== auth.email) isPro = false;
  if (isPro) {
    // DB validation: confirm license is still active (handles cancellations)
    try {
      const lic = await neonSQL(`SELECT active FROM pro_licenses WHERE LOWER(email) = $1 AND active = true LIMIT 1`, [proEmail]);
      if (lic.length === 0) isPro = false;
    } catch { isPro = false; }
  }

  const { messages } = req.body;

  // â”€â”€ Message validation â”€â”€
  if (!messages || !Array.isArray(messages) || messages.length === 0) {
    return res.status(400).json({ error: 'messages must be a non-empty array' });
  }
  if (messages.length > 1) {
    return res.status(400).json({ error: 'Only single-message requests are supported' });
  }
  const msg = messages[0];
  if (!msg || (msg.role !== 'user' && msg.role !== 'assistant')) {
    return res.status(400).json({ error: 'Each message must have role "user" or "assistant"' });
  }

  // â”€â”€ Content length limits â”€â”€
  const MAX_TEXT_LENGTH = 2000;
  const MAX_IMAGE_B64_BYTES = 5 * 1024 * 1024;
  if (typeof msg.content === 'string') {
    if (msg.content.length > MAX_TEXT_LENGTH) {
      return res.status(400).json({ error: 'Message content exceeds ' + MAX_TEXT_LENGTH + ' character limit' });
    }
  } else if (Array.isArray(msg.content)) {
    for (const block of msg.content) {
      if (block.type === 'text' && block.text && block.text.length > MAX_TEXT_LENGTH) {
        return res.status(400).json({ error: 'Text block exceeds ' + MAX_TEXT_LENGTH + ' character limit' });
      }
      if (block.type === 'image' && block.source?.type === 'base64') {
        const mime = block.source.media_type || '';
        if (!['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/gif'].includes(mime)) {
          return res.status(400).json({ error: 'Unsupported image type. Use PNG, JPEG, WebP, or GIF.' });
        }
        const b64 = block.source.data || '';
        const decodedSize = Math.ceil(b64.length * 3 / 4);
        if (decodedSize > MAX_IMAGE_B64_BYTES) {
          return res.status(400).json({ error: 'Image exceeds 5 MB size limit' });
        }
      }
    }
  }

  // Screenshot requests have their own stricter rate limit for free users
  const isScreenshot = isScreenshotRequest(messages);
  const limitKey = isPro ? 'pro' : isScreenshot ? 'screenshot' : 'free';
  const endpoint = isScreenshot ? 'screenshot' : 'analysis';

  const clientKey = getClientKey(req, isPro, proEmail, auth.email);

  let rateCheck;
  try {
    rateCheck = await checkRateLimitDB(clientKey, endpoint, limitKey);
  } catch (err) {
    console.error('Rate limit DB error:', err.message);
    return res.status(503).json({ error: 'Service temporarily unavailable. Please try again shortly.' });
  }

  if (!rateCheck.allowed) {
    return res.status(429).json({
      error: 'Rate limit exceeded',
      message: 'Too many requests. Please try again later.',
      remaining: rateCheck.remaining,
      used: rateCheck.used,
    });
  }

  // Server decides model and tokens â€” client has no say
  const resolvedModel = isPro ? 'claude-sonnet-4-5-20250929' : 'claude-haiku-4-5-20251001';
  const resolvedMaxTokens = isScreenshot ? 1000 : 200;

  try {
    const response = await client.messages.create({
      model: resolvedModel,
      max_tokens: resolvedMaxTokens,
      system: 'You are a stock portfolio analysis assistant for Portfolio Compass. Only answer questions related to stock portfolio analysis, investment allocation, sector exposure, diversification, and market data. Refuse any requests unrelated to portfolio analysis.',
      messages,
    });

    res.setHeader('X-RateLimit-Remaining', rateCheck.remaining ?? 0);
    res.setHeader('X-RateLimit-Used', rateCheck.used ?? 0);
    return res.status(200).json(response);

  } catch (err) {
    console.error('Claude API error:', err.message);
    if (err.status === 429) {
      return res.status(429).json({ error: 'Anthropic rate limit hit. Try again shortly.' });
    }
    return res.status(500).json({ error: 'Claude API error' });
  }
}

========== FILE: api/delete-account.js ==========
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { extractAuth, verifyAuthToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);

  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Pro-Token, X-Pro-Email, X-Pro-Ts, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }

  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  try {
    // â”€â”€ Rate limit by IP + email â”€â”€
    const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
    if (!await checkRateLimit(ip, 'delete-account', 10)) {
      return res.status(429).json({ error: 'Too many attempts â€” try again later' });
    }

    // â”€â”€ Verify auth token (cookie-first, header fallback) â”€â”€
    const auth = extractAuth(req);
    const bodyEmail = (req.body.email || '').toLowerCase().trim();

    // Rate limit: 5 attempts per hour per email
    if (bodyEmail && !await checkRateLimit('email:' + bodyEmail, 'delete-account', 5)) {
      return res.status(429).json({ error: 'Too many attempts â€” try again later' });
    }

    if (!bodyEmail) return res.status(400).json({ error: 'Email required' });

    // Auth token must match the email being deleted
    if (auth.email.toLowerCase().trim() !== bodyEmail) {
      return res.status(403).json({ error: 'Email mismatch' });
    }

    if (!await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv)) {
      return res.status(401).json({ error: 'Invalid or expired auth token' });
    }

    // â”€â”€ Invalidate all sessions before deleting â”€â”€
    // Increment session_version so any outstanding tokens become invalid immediately
    await neonSQL(`UPDATE users SET session_version = COALESCE(session_version, 1) + 1 WHERE LOWER(email) = $1`, [bodyEmail]);

    // â”€â”€ Delete user data â”€â”€
    // portfolios are ON DELETE CASCADE from users table
    // Delete pro license first (no FK)
    await neonSQL(`DELETE FROM pro_licenses WHERE LOWER(email) = $1`, [bodyEmail]);

    // Delete api_usage records for this user
    await neonSQL(`DELETE FROM api_usage WHERE client_key = $1`, ['email:' + bodyEmail]);

    // Delete user (cascades to portfolios)
    const deleted = await neonSQL(
      `DELETE FROM users WHERE LOWER(email) = $1 RETURNING id`,
      [bodyEmail]
    );

    if (deleted.length === 0) {
      return res.status(404).json({ error: 'Account not found' });
    }

    // Clear auth cookie so it can't be reused
    const secure = process.env.NODE_ENV === 'development' ? '' : '; Secure';
    res.setHeader('Set-Cookie', `pc_auth=; HttpOnly${secure}; SameSite=Strict; Path=/api; Max-Age=0`);

    res.status(200).json({ success: true });
  } catch (err) {
    console.error('Delete account error:', err.message);
    res.status(500).json({ error: 'Failed to delete account' });
  }
}

========== FILE: api/frontend-patches.js ==========
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PORTFOLIO COMPASS â€” FRONTEND OPTIMIZATION PATCHES
// Drop these script blocks into index.html as described below
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ PATCH 1: MARKET DATA localStorage CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Replace the fetchMarketData() call inside analyze() with this version.
// Saves API calls when user clicks Analyze multiple times or refreshes.
// Cache key includes the tickers so different portfolios get different caches.

async function fetchMarketDataCached(tickersToFetch) {
  const CACHE_KEY = 'pc_market_' + tickersToFetch.slice().sort().join(',');
  const CACHE_TTL = 60 * 60 * 1000; // 1 hour

  // Check localStorage cache first
  try {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
      const { data, ts } = JSON.parse(cached);
      if (Date.now() - ts < CACHE_TTL) {
        console.log('[market-data] serving from localStorage cache');
        return data;
      }
    }
  } catch(e) { /* ignore parse errors */ }

  // Fetch fresh
  try {
    const res = await fetch('/api/market-data?tickers=' + tickersToFetch.join(','));
    const raw = await res.json();
    const marketData = {};

    for (const [ticker, val] of Object.entries(raw)) {
      if (!val) { marketData[ticker] = null; continue; }
      marketData[ticker] = {
        price:       Number(val.price) || 0,
        changePct:   val.changePct != null ? Number(val.changePct) : Number(val.change || 0),
        momentum:    val.momentum != null ? val.momentum : 50 + Math.min(15, Math.max(-15, Number(val.changePct || val.change || 0) * 5)),
        marketState: val.marketState || 'REGULAR',
        name:        val.name || ticker,
      };
    }

    // Save to localStorage
    try {
      localStorage.setItem(CACHE_KEY, JSON.stringify({ data: marketData, ts: Date.now() }));
    } catch(e) { /* quota exceeded â€” skip cache */ }

    return Object.keys(marketData).length > 0 ? marketData : null;
  } catch(e) {
    console.warn('[market-data] fetch failed:', e.message);
    return null;
  }
}

// â”€â”€ PATCH 2: ANALYZE DEBOUNCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Prevents double-firing if user clicks Analyze rapidly.
// Wrap the existing analyze() call with this debounce.

let analyzeDebounceTimer = null;

function analyzeDebounced() {
  clearTimeout(analyzeDebounceTimer);
  analyzeDebounceTimer = setTimeout(() => {
    analyze();
  }, 300);
}
// Then in your HTML, change: onclick="analyze()"
// To: onclick="analyzeDebounced()"
// Same for the sticky mobile button.

// â”€â”€ PATCH 3: WHAT-IF DEBOUNCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Replace the existing what-if input listeners with these debounced versions.
// Prevents runWhatIf() from firing on every single keypress.

(function initWhatIfDebounced() {
  let whatifTimer = null;
  function debouncedWhatIf() {
    clearTimeout(whatifTimer);
    whatifTimer = setTimeout(runWhatIf, 300);
  }
  // Wait for DOM
  document.addEventListener('DOMContentLoaded', function() {
    const wt = document.getElementById('whatifTicker');
    const wp = document.getElementById('whatifPct');
    if (wt) { wt.removeEventListener('input', runWhatIf); wt.addEventListener('input', debouncedWhatIf); }
    if (wp) { wp.removeEventListener('input', runWhatIf); wp.addEventListener('input', debouncedWhatIf); }
  });
})();

// â”€â”€ PATCH 4: LAZY GOOGLE SIGN-IN SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Remove the <script src="https://accounts.google.com/gsi/client"> tag from <head>
// and use this instead â€” loads Google only when auth modal opens.

function loadGoogleSignInScript() {
  if (window._googleScriptLoaded) return Promise.resolve();
  return new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.async = true;
    script.defer = true;
    script.onload = () => {
      window._googleScriptLoaded = true;
      initGoogleSignIn(); // your existing function
      resolve();
    };
    document.head.appendChild(script);
  });
}

// Replace your existing showAuthModal() with this version:
function showAuthModalOptimized() {
  authMode = 'login';
  const modal = document.getElementById('authModal');
  modal.style.display = 'flex';
  document.getElementById('authEmail').value = '';
  document.getElementById('authPassword').value = '';
  document.getElementById('authPasswordConfirm').value = '';
  document.getElementById('authPasswordConfirm').style.display = 'none';
  document.getElementById('authError').style.display = 'none';
  document.getElementById('authSubmitBtn').textContent = 'Sign In';
  document.getElementById('authToggleText').textContent = "Don't have an account? ";
  document.getElementById('authToggleLink').textContent = 'Sign Up';

  // Load Google script lazily â€” only when auth modal is opened
  loadGoogleSignInScript();
}

// â”€â”€ PATCH 5: SEND PRO HEADERS TO API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// claude.js now verifies pro server-side. Update your fetch calls to send
// the email and timestamp alongside the token.
// Replace existing fetchClaude calls with this helper:

async function callClaudeAPI(body) {
  const proToken = localStorage.getItem('pc_pro_token') || '';
  const proEmail = localStorage.getItem('pc_pro_email') || '';
  const proTs    = localStorage.getItem('pc_pro_ts')    || '';

  const res = await fetch('/api/claude', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Pro-Token':  proToken,
      'X-Pro-Email':  proEmail,
      'X-Pro-Ts':     proTs,
    },
    body: JSON.stringify(body),
  });
  return res;
}

// â”€â”€ PATCH 6: CLEAR STALE MARKET CACHE ON MANUAL REFRESH â”€â”€â”€â”€â”€â”€
// Call this in refreshMarketData() before calling analyze()

function clearMarketCache() {
  const keysToDelete = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('pc_market_')) keysToDelete.push(key);
  }
  keysToDelete.forEach(k => localStorage.removeItem(k));
  console.log('[market-data] cache cleared');
}

========== FILE: api/market-data.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';
import { checkRateLimit } from './lib/rate-limit.js';

// â”€â”€ SIMPLE IN-MEMORY CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cache = new Map();
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 min in-function cache (edge handles the 1hr)

function getCached(key) {
  const entry = cache.get(key);
  if (!entry) return null;
  if (Date.now() - entry.ts > CACHE_TTL_MS) { cache.delete(key); return null; }
  return entry.data;
}

function setCached(key, data) {
  cache.set(key, { data, ts: Date.now() });
}

// â”€â”€ FETCH QUOTES VIA FMP STABLE API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FMP deprecated the v3 batch endpoint for free-tier keys (Aug 2025).
// Use stable/quote per ticker (stocks), with stable/profile fallback (ETFs).
function parseQuote(quote) {
  if (!quote || quote.price == null) return null;
  const changePct = quote.changePercentage ?? 0;
  const momentum = Math.min(100, Math.max(0, 50 + changePct * 5));
  return {
    price: Math.round(quote.price * 100) / 100,
    changePct: Math.round(changePct * 100) / 100,
    change: Math.round(changePct * 100) / 100,
    momentum: Math.round(momentum),
    marketState: 'REGULAR',
    name: quote.name || quote.companyName || quote.symbol || '',
  };
}

async function fetchOne(ticker, apiKey) {
  try {
    // Try stable/quote first (works for stocks on free tier)
    const url = `https://financialmodelingprep.com/stable/quote?symbol=${ticker}&apikey=${apiKey}`;
    const r = await fetch(url, { signal: AbortSignal.timeout(6000) });
    if (r.ok) {
      const data = await r.json();
      if (Array.isArray(data) && data.length > 0) {
        const result = parseQuote(data[0]);
        if (result) return result;
      }
    }
    // Fallback to stable/profile (works for ETFs on free tier)
    const pUrl = `https://financialmodelingprep.com/stable/profile?symbol=${ticker}&apikey=${apiKey}`;
    const pr = await fetch(pUrl, { signal: AbortSignal.timeout(6000) });
    if (!pr.ok) return null;
    const pData = await pr.json();
    if (!Array.isArray(pData) || pData.length === 0) return null;
    return parseQuote(pData[0]);
  } catch {
    return null;
  }
}

async function fetchBatch(tickerList) {
  const apiKey = process.env.FMP_API_KEY;
  if (!apiKey) {
    console.error('[market-data] FMP_API_KEY not set');
    return {};
  }

  // Check cache first â€” return cached results and only fetch uncached
  const results = {};
  const uncached = [];
  for (const ticker of tickerList) {
    const cached = getCached(ticker);
    if (cached) {
      results[ticker] = cached;
    } else {
      uncached.push(ticker);
    }
  }

  if (uncached.length === 0) return results;

  // Fetch uncached tickers in parallel (individual stable/quote calls)
  const settled = await Promise.allSettled(
    uncached.map(async (ticker) => {
      const result = await fetchOne(ticker, apiKey);
      if (result) {
        setCached(ticker, result);
        results[ticker] = result;
      } else {
        results[ticker] = null;
      }
    })
  );

  const failed = settled.filter(s => s.status === 'rejected').length;
  if (failed > 0) console.warn(`[market-data] ${failed}/${uncached.length} FMP calls failed`);

  return results;
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  // Rate limit by IP
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'market-data', 30)) {
    return res.status(429).json({ error: 'Too many requests. Please try again later.' });
  }

  const { tickers } = req.query;
  if (!tickers) return res.status(400).json({ error: 'No tickers provided' });

  // Deduplicate and sanitize
  const tickerList = [...new Set(
    tickers.split(',')
      .map(t => t.trim().toUpperCase().replace(/[^A-Z0-9.]/g, ''))
      .filter(t => t.length >= 1 && t.length <= 6 && /^[A-Z]{1,5}(\.[A-Z]{1,2})?$/.test(t))
  )];

  // Hard cap â€” don't let someone request 500 tickers
  if (tickerList.length > 40) {
    return res.status(400).json({ error: 'Too many tickers. Max 40 per request.' });
  }

  // Fetch all via single FMP batch call
  const output = await fetchBatch(tickerList);

  // Cache headers â€” Vercel edge will cache this response per unique ticker combo
  res.setHeader('Cache-Control', 's-maxage=3600, stale-while-revalidate=600');
  return res.status(200).json(output);
}

========== FILE: api/portfolios.js ==========
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { extractAuth, getProFromCookie, verifyAuthToken, verifyProToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

// â”€â”€ VERIFY USER IS WHO THEY CLAIM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uses AUTH token (not Pro) â€” any signed-in user can access their own portfolios.
// Pro token only controls limits (portfolio count), not ownership.
async function verifyUser(req, claimedUserId) {
  const auth = extractAuth(req);

  if (!auth.email || !auth.token || !auth.ts) return false;

  // Verify the HMAC token matches the email
  if (!await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv)) return false;

  // Confirm this token's email matches the claimed userId
  const rows = await neonSQL(
    `SELECT id FROM users WHERE id = $1 AND LOWER(email) = $2 LIMIT 1`,
    [parseInt(claimedUserId), auth.email]
  );
  return rows.length > 0;
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Pro-Token, X-Pro-Email, X-Pro-Ts, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }
  if ((req.method === 'POST' || req.method === 'DELETE') && !checkBodySize(req)) {
    return res.status(413).json({ error: 'Request body too large' });
  }

  // â”€â”€ Require valid auth token (cookie-first, header fallback) â”€â”€
  const auth = extractAuth(req);
  const isAuthenticated = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);
  if (!isAuthenticated) {
    return res.status(401).json({ error: 'Authentication required' });
  }

  if (req.method === 'GET') {
    if (!await checkRateLimit('email:' + auth.email, 'portfolios-read', 60)) {
      return res.status(429).json({ error: 'Too many requests' });
    }
    const userId = req.query.userId;
    if (!userId) return res.status(400).json({ error: 'userId required' });

    const authorized = await verifyUser(req, userId);
    if (!authorized) return res.status(401).json({ error: 'Unauthorized' });

    try {
      const portfolios = await neonSQL(
        `SELECT id, name, holdings, updated_at FROM portfolios
         WHERE user_id = $1 ORDER BY updated_at DESC`,
        [parseInt(userId)]
      );
      return res.status(200).json({ portfolios });
    } catch (err) {
      console.error('[portfolios GET]', err.message);
      return res.status(500).json({ error: 'Server error' });
    }
  }

  if (req.method === 'POST') {
    if (!await checkRateLimit('email:' + auth.email, 'portfolios-write', 5)) {
      return res.status(429).json({ error: 'Too many saves â€” try again later' });
    }
    const { userId, name, holdings, portfolioId } = req.body;
    if (!userId || !name || !holdings) {
      return res.status(400).json({ error: 'userId, name, and holdings required' });
    }

    const authorized = await verifyUser(req, userId);
    if (!authorized) return res.status(401).json({ error: 'Unauthorized' });

    // Validate name length
    if (typeof name !== 'string' || name.length > 100) {
      return res.status(400).json({ error: 'Name must be a string under 100 characters' });
    }

    // Validate holdings is an array with proper structure
    if (!Array.isArray(holdings)) {
      return res.status(400).json({ error: 'holdings must be an array' });
    }
    if (holdings.length > 100) {
      return res.status(400).json({ error: 'Too many holdings (max 100)' });
    }
    for (const h of holdings) {
      if (!h || typeof h.ticker !== 'string' || h.ticker.length > 10 || typeof h.pct !== 'number') {
        return res.status(400).json({ error: 'Each holding must have ticker (string) and pct (number)' });
      }
      if (!Number.isFinite(h.pct) || h.pct < 0 || h.pct > 100) {
        return res.status(400).json({ error: 'Each holding pct must be a finite number between 0 and 100' });
      }
    }

    try {
      if (portfolioId) {
        const result = await neonSQL(
          `UPDATE portfolios SET name = $1, holdings = $2, updated_at = NOW()
           WHERE id = $3 AND user_id = $4
           RETURNING id, name, holdings, updated_at`,
          [name, JSON.stringify(holdings), parseInt(portfolioId), parseInt(userId)]
        );
        if (result.length === 0) return res.status(404).json({ error: 'Portfolio not found' });
        return res.status(200).json({ portfolio: result[0] });
      } else {
        // â”€â”€ Enforce portfolio count limit â”€â”€
        const countRows = await neonSQL(
          `SELECT COUNT(*)::int AS cnt FROM portfolios WHERE user_id = $1`,
          [parseInt(userId)]
        );
        const currentCount = countRows[0]?.cnt || 0;

        // Pro check only for limits, not ownership
        const proCk = getProFromCookie(req);
        const proToken = proCk?.token || req.headers['x-pro-token'] || '';
        const proEmail = (proCk?.email || req.headers['x-pro-email'] || '').toLowerCase().trim();
        const proTs    = proCk?.ts || req.headers['x-pro-ts'] || '';
        let isPro = await verifyProToken(proEmail, proToken, proTs);
        // Prevent privilege escalation: pro token email must match authenticated user
        if (isPro && proEmail !== auth.email) isPro = false;
        if (isPro) {
          try {
            const lic = await neonSQL(`SELECT active FROM pro_licenses WHERE LOWER(email) = $1 AND active = true LIMIT 1`, [proEmail]);
            if (lic.length === 0) isPro = false;
          } catch { isPro = false; }
        }

        const maxPortfolios = isPro ? 50 : 3;
        if (currentCount >= maxPortfolios) {
          return res.status(403).json({ error: 'Portfolio limit reached' });
        }

        const result = await neonSQL(
          `INSERT INTO portfolios (user_id, name, holdings)
           VALUES ($1, $2, $3)
           RETURNING id, name, holdings, updated_at`,
          [parseInt(userId), name, JSON.stringify(holdings)]
        );
        return res.status(201).json({ portfolio: result[0] });
      }
    } catch (err) {
      console.error('[portfolios POST]', err.message);
      return res.status(500).json({ error: 'Server error' });
    }
  }

  if (req.method === 'DELETE') {
    if (!await checkRateLimit('email:' + auth.email, 'portfolios-write', 5)) {
      return res.status(429).json({ error: 'Too many deletes â€” try again later' });
    }
    const { userId, portfolioId } = req.query;
    if (!userId || !portfolioId) {
      return res.status(400).json({ error: 'userId and portfolioId required' });
    }

    const authorized = await verifyUser(req, userId);
    if (!authorized) return res.status(401).json({ error: 'Unauthorized' });

    try {
      if (portfolioId === 'all') {
        await neonSQL(`DELETE FROM portfolios WHERE user_id = $1`, [parseInt(userId)]);
      } else {
        await neonSQL(
          `DELETE FROM portfolios WHERE id = $1 AND user_id = $2`,
          [parseInt(portfolioId), parseInt(userId)]
        );
      }
      return res.status(200).json({ success: true });
    } catch (err) {
      console.error('[portfolios DELETE]', err.message);
      return res.status(500).json({ error: 'Server error' });
    }
  }

  return res.status(405).json({ error: 'Method not allowed' });
}

========== FILE: api/pro-picks.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';
import { checkRateLimit } from './lib/rate-limit.js';

// â”€â”€ PRO-ONLY STOCK PICKS (indices 5-25 from original STOCK_PICKS) â”€â”€
const PRO_STOCK_PICKS = [
  {ticker:'V',   name:'Visa',           sector:'Banking',          risk:'Low',    desc:'Global payments network, recession-lite', avoidIfHeld:['V','MA','XLF']},
  {ticker:'COIN',name:'Coinbase',       sector:'Crypto / Bitcoin', risk:'Very High',desc:'Crypto exchange, direct crypto exposure',avoidIfHeld:['COIN','IBIT','BITO']},
  {ticker:'SQ',  name:'Block (Square)', sector:'Fintech',          risk:'High',   desc:'Payments + Bitcoin ecosystem play',       avoidIfHeld:['SQ','HOOD','FINX']},
  {ticker:'LLY', name:'Eli Lilly',      sector:'Healthcare',       risk:'Medium', desc:'GLP-1 weight loss drugs, massive growth', avoidIfHeld:['LLY','XLV']},
  {ticker:'UNH', name:'UnitedHealth',   sector:'Healthcare',       risk:'Low',    desc:'Largest US health insurer, stable cash',  avoidIfHeld:['UNH','XLV']},
  {ticker:'MRNA',name:'Moderna',        sector:'Biotech',          risk:'High',   desc:'mRNA platform beyond COVID vaccines',     avoidIfHeld:['MRNA','XBI']},
  {ticker:'AMZN',name:'Amazon',         sector:'E-Commerce',       risk:'Medium', desc:'E-commerce + AWS cloud dominance',        avoidIfHeld:['AMZN','QQQ']},
  {ticker:'COST',name:'Costco',         sector:'Retail',           risk:'Low',    desc:'Membership retail, recession-resistant',  avoidIfHeld:['COST','XLP']},
  {ticker:'SBUX',name:'Starbucks',      sector:'Food & Beverage',  risk:'Medium', desc:'Brand recovery + international expansion',avoidIfHeld:['SBUX']},
  {ticker:'XOM', name:'ExxonMobil',     sector:'Oil & Gas',        risk:'Medium', desc:'Dividend king, energy price hedge',       avoidIfHeld:['XOM','XLE']},
  {ticker:'NEE', name:'NextEra Energy', sector:'Clean Energy',     risk:'Low',    desc:'Largest renewable energy utility in US',  avoidIfHeld:['NEE','ICLN']},
  {ticker:'NEM', name:'Newmont',        sector:'Gold & Metals',    risk:'Medium', desc:'Gold mining hedge against inflation',     avoidIfHeld:['NEM','GLD','GDX']},
  {ticker:'LMT', name:'Lockheed Martin',sector:'Defense',          risk:'Low',    desc:'Defense spending, geopolitical hedge',   avoidIfHeld:['LMT','XLI']},
  {ticker:'CAT', name:'Caterpillar',    sector:'Industrials',      risk:'Medium', desc:'Infrastructure spending + global demand', avoidIfHeld:['CAT','XLI']},
  {ticker:'JNJ', name:'J&J',           sector:'Healthcare',        risk:'Low',    desc:'Diversified pharma + medtech, steady div',avoidIfHeld:['JNJ','XLV']},
  {ticker:'KO',  name:'Coca-Cola',      sector:'Consumer Staples', risk:'Low',    desc:'Recession-proof consumer staple',        avoidIfHeld:['KO','XLP']},
  {ticker:'PLD', name:'Prologis',       sector:'Real Estate',      risk:'Low',    desc:'E-commerce warehouse REIT, stable income',avoidIfHeld:['PLD','XLRE']},
  {ticker:'BABA',name:'Alibaba',        sector:'China / Emerging', risk:'High',   desc:'Chinese e-commerce at deep discount',    avoidIfHeld:['BABA','VWO','KWEB']},
  {ticker:'ABNB',name:'Airbnb',         sector:'Travel & Mobility',risk:'Medium', desc:'Asset-light travel platform, high margins',avoidIfHeld:['ABNB']},
  {ticker:'UBER',name:'Uber',           sector:'Travel & Mobility',risk:'Medium', desc:'Ride-share + delivery global network',   avoidIfHeld:['UBER']},
];

// â”€â”€ PRO-ONLY ETFs (beyond the first 4 per strategy) â”€â”€
const PRO_ETFS = {
  aggressive: [
    {ticker:'QQQ',name:'Invesco QQQ',desc:'Nasdaq-100 mega-cap tech',exp:'0.20%',sectors:['Big Tech','Software / SaaS']},
    {ticker:'SOXX',name:'iShares Semis',desc:'Broad semiconductor ETF',exp:'0.35%',sectors:['Semiconductors']},
    {ticker:'IWM',name:'Russell 2000',desc:'Small-cap growth exposure',exp:'0.19%',sectors:['Small-Caps']},
    {ticker:'CIBR',name:'Cybersecurity ETF',desc:'Pure-play cyber leaders',exp:'0.60%',sectors:['Cybersecurity']},
  ],
  moderate: [
    {ticker:'IGV',name:'iShares Software',desc:'Software & SaaS companies',exp:'0.41%',sectors:['Software / SaaS']},
    {ticker:'RSP',name:'Equal Weight S&P',desc:'S&P 500 with equal weighting',exp:'0.20%',sectors:['Broad Market']},
  ],
  conservative: [
    {ticker:'VNQ',name:'Vanguard REIT',desc:'Real estate investment trusts',exp:'0.12%',sectors:['Real Estate']},
    {ticker:'GLD',name:'SPDR Gold Shares',desc:'Physical gold price tracking',exp:'0.40%',sectors:['Gold & Metals']},
    {ticker:'AGG',name:'Core Bond ETF',desc:'Broad investment-grade bonds',exp:'0.03%',sectors:['Bonds']},
    {ticker:'IAK',name:'Insurance ETF',desc:'US property & life insurers',exp:'0.40%',sectors:['Insurance']},
  ],
};

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Pro-Token, X-Pro-Email, X-Pro-Ts, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'GET') return res.status(405).json({ error: 'Method not allowed' });

  // Rate limit by IP (30 req/hr)
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit('ip:' + ip, 'pro-picks', 30)) {
    return res.status(429).json({ error: 'Too many requests' });
  }

  return res.status(200).json({
    stocks: PRO_STOCK_PICKS,
    etfs: PRO_ETFS,
  });
}

========== FILE: api/refresh-stock-data.js ==========
import { neonSQL } from './lib/neon.js';

// â”€â”€ ALL TICKERS FROM STOCK_DB (excluding ETFs â€” they don't have meaningful betas) â”€â”€
const STOCK_TICKERS = [
  'AAPL','MSFT','GOOGL','GOOG','META','AMZN','NVDA','AMD','INTC','TSM','AVGO','QCOM','MU',
  'CRM','ORCL','NOW','SNOW','PLTR','HOOD','SOFI','COIN','DKNG','JPM','BAC','GS','V','MA',
  'JNJ','UNH','PFE','LLY','ABBV','MRNA','TSLA','RIVN','NIO','LULU','NKE','COST','WMT',
  'PG','KO','MCD','SBUX','DIS','NFLX','SPOT','UBER','ABNB','XOM','CVX','NEE','BABA','BIDU',
  'CHWY','AMC','GME','DUOL','RBLX','U','APP','PINS','SNAP','RDDT','PYPL','AFRM','UPST','NU',
  'MSTR','MARA','RIOT','AI','BBAI','PATH','SOUN','IONQ','ANET','DDOG','ZS','CRWD','PANW',
  'OKTA','MDB','NET','HCP','ISRG','DXCM','TDOC','HIMS','RXRX','BEAM','CRSP','SHOP','ETSY',
  'W','ONON','DECK','CELH','MNST','LYFT','BKNG','EXPE','LUV','DAL','GM','F','LCID','OXY',
  'COP','SLB','FCX','AA','RTX','NOC','GD','BA','GE','DE','AMT','O','BX','KKR','SCHW','MS',
  'BRK','BRKB','AXP','PEP','MDLZ','CL','IBM','ADBE','SAP','INTU','WDAY','ZM','DOCU','TWLO',
  'BOX','GTLB','TTD','FROG','SMAR','ACHR','JOBY','EXAI','MTCH','IAC','BMBL','LYV','WBD',
  'PARA','EA','TTWO','ATVI','FIS','FISV','GPN','SQ','CVS','CI','HCA','TMO','DHR','SYK',
  'MDT','BSX','REGN','VRTX','BIIB','GILD','ILMN','TGT','HD','LOW','TJX','ULTA','ROST','DG',
  'YUM','CMG','DPZ','HSY','GIS','K','EL','PSX','MPC','VLO','HAL','FSLR','ENPH','SEDG','RUN',
  'HON','MMM','EMR','ITW','UPS','FDX','URI','CARR','LDOS','KTOS','AXON','WFC','C','USB','TFC',
  'COF','DFS','ICE','CME','SPGI','MCO','SPG','EQR','AVB','DLR','EQIX','DUK','SO','AEP','EXC',
  'PCG','NUE','X','CLF','MP','MELI','SE','PDD','JD','TCOM','HUT','CLSK','PGR','ALL','MET',
  'AFL','PRU','CB','TRV','AON','MMC','S','CYBR','FTNT','CHKP','RPD',
  // New additions
  'T','VZ','TMUS','ON','SMCI','ARM','DELL','HPQ','HPE','LRCX','KLAC','AMAT','MRVL','ADI',
  'NXPI','TXN','ASML','MSCI','TEAM','HUBS','VEEV','BILL','PCTY','PAYC','FOUR','ZTS','A',
  'BDX','EW','GEHC','IQV','IDXX','ALGN','HOLX','MOH','CNC','HUM','DLTR','BBY','AZO','ORLY',
  'CMCSA','CHTR','FOXA','CAT','ETN','PH','ROK','AME','IR','GWW','FAST','WAB','XYL','WM',
  'RSG','VRSK','BR','EOG','PXD','DVN','CTRA','BKR','PNC','MTB','FITB','HBAN','KEY','ALLY',
  'NDAQ','CBOE','PSA','WELL','ARE','CBRE','MAA','STZ','SYY','KHC','TAP','LMT','LHX','HII',
  'TDG','HWM','TLRY','CGC','RKLB','LUNR','RDW','FLUT','MGM','WYNN','LVS','CZR','LI','XPEV',
  'BILI','GRAB','GLOB','ZIM','LIN','APD','DOW','DD','SHW','ECL','PPG','ADM','MOS','CF',
  'RH','CPRT',
];

// â”€â”€ YAHOO FINANCE FETCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchHistorical(ticker, range = '6mo') {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?interval=1d&range=${range}`;
  const r = await fetch(url, {
    headers: {
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
      'Accept': 'application/json',
    },
    signal: AbortSignal.timeout(8000),
  });
  if (!r.ok) return null;
  const data = await r.json();
  const result = data?.chart?.result?.[0];
  if (!result) return null;
  const closes = result.indicators?.quote?.[0]?.close;
  if (!closes || closes.length < 20) return null;
  // Filter out null values (holidays/missing data)
  return closes.filter(c => c != null);
}

// â”€â”€ COMPUTE DAILY RETURNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function dailyReturns(closes) {
  const returns = [];
  for (let i = 1; i < closes.length; i++) {
    if (closes[i - 1] === 0) continue;
    returns.push((closes[i] - closes[i - 1]) / closes[i - 1]);
  }
  return returns;
}

// â”€â”€ COMPUTE BETA VS SPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeBeta(stockReturns, spyReturns) {
  // Align lengths (use the shorter of the two)
  const len = Math.min(stockReturns.length, spyReturns.length);
  if (len < 15) return null; // Need enough data points
  const sr = stockReturns.slice(-len);
  const mr = spyReturns.slice(-len);

  const avgStock = sr.reduce((a, b) => a + b, 0) / len;
  const avgMarket = mr.reduce((a, b) => a + b, 0) / len;

  let covariance = 0;
  let variance = 0;
  for (let i = 0; i < len; i++) {
    const dStock = sr[i] - avgStock;
    const dMarket = mr[i] - avgMarket;
    covariance += dStock * dMarket;
    variance += dMarket * dMarket;
  }
  covariance /= len;
  variance /= len;

  if (variance === 0) return null;
  const beta = covariance / variance;
  // Clamp to reasonable range and round to 2 decimals
  return Math.round(Math.max(-1, Math.min(4, beta)) * 100) / 100;
}

// â”€â”€ FETCH 1-DAY DATA FOR PICKS SCORING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchQuote(ticker) {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?interval=1d&range=5d`;
  try {
    const r = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json',
      },
      signal: AbortSignal.timeout(5000),
    });
    if (!r.ok) return null;
    const data = await r.json();
    const result = data?.chart?.result?.[0];
    if (!result) return null;
    const meta = result.meta;
    const volume = result.indicators?.quote?.[0]?.volume;
    const closes = result.indicators?.quote?.[0]?.close;
    const avgVolume = volume && volume.length > 1
      ? volume.slice(0, -1).reduce((a, b) => a + (b || 0), 0) / (volume.length - 1)
      : 0;
    const latestVolume = volume ? volume[volume.length - 1] || 0 : 0;
    const price = meta?.regularMarketPrice || 0;
    const prev = meta?.chartPreviousClose || 0;
    const changePct = prev > 0 ? ((price - prev) / prev) * 100 : 0;
    // 5-day momentum: first close vs last close
    const validCloses = closes ? closes.filter(c => c != null) : [];
    const momentum5d = validCloses.length >= 2
      ? ((validCloses[validCloses.length - 1] - validCloses[0]) / validCloses[0]) * 100
      : 0;
    return { price, changePct, momentum5d, latestVolume, avgVolume };
  } catch {
    return null;
  }
}

// â”€â”€ STOCK_DB STATIC INFO (sector, name, cap) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Minimal copy for picks generation (matches public/data.js)
const STOCK_INFO = {
  AAPL:{name:'Apple',sector:'Big Tech',cap:'mega'},MSFT:{name:'Microsoft',sector:'Big Tech',cap:'mega'},
  GOOGL:{name:'Alphabet',sector:'Big Tech',cap:'mega'},META:{name:'Meta',sector:'Big Tech',cap:'mega'},
  AMZN:{name:'Amazon',sector:'E-Commerce',cap:'mega'},NVDA:{name:'NVIDIA',sector:'Semiconductors',cap:'mega'},
  AMD:{name:'AMD',sector:'Semiconductors',cap:'large'},INTC:{name:'Intel',sector:'Semiconductors',cap:'large'},
  TSM:{name:'TSMC',sector:'Semiconductors',cap:'mega'},AVGO:{name:'Broadcom',sector:'Semiconductors',cap:'mega'},
  QCOM:{name:'Qualcomm',sector:'Semiconductors',cap:'large'},MU:{name:'Micron',sector:'Semiconductors',cap:'large'},
  CRM:{name:'Salesforce',sector:'Software / SaaS',cap:'large'},ORCL:{name:'Oracle',sector:'Software / SaaS',cap:'mega'},
  NOW:{name:'ServiceNow',sector:'Software / SaaS',cap:'large'},SNOW:{name:'Snowflake',sector:'Software / SaaS',cap:'large'},
  PLTR:{name:'Palantir',sector:'AI & Robotics',cap:'large'},HOOD:{name:'Robinhood',sector:'Fintech',cap:'mid'},
  SOFI:{name:'SoFi',sector:'Fintech',cap:'mid'},COIN:{name:'Coinbase',sector:'Crypto / Bitcoin',cap:'large'},
  DKNG:{name:'DraftKings',sector:'Sports Betting',cap:'mid'},JPM:{name:'JPMorgan',sector:'Banking',cap:'mega'},
  BAC:{name:'Bank of America',sector:'Banking',cap:'mega'},GS:{name:'Goldman Sachs',sector:'Banking',cap:'large'},
  V:{name:'Visa',sector:'Banking',cap:'mega'},MA:{name:'Mastercard',sector:'Banking',cap:'mega'},
  JNJ:{name:"J&J",sector:'Healthcare',cap:'mega'},UNH:{name:'UnitedHealth',sector:'Healthcare',cap:'mega'},
  PFE:{name:'Pfizer',sector:'Healthcare',cap:'mega'},LLY:{name:'Eli Lilly',sector:'Healthcare',cap:'mega'},
  ABBV:{name:'AbbVie',sector:'Healthcare',cap:'large'},MRNA:{name:'Moderna',sector:'Biotech',cap:'large'},
  TSLA:{name:'Tesla',sector:'EVs & Autos',cap:'mega'},RIVN:{name:'Rivian',sector:'EVs & Autos',cap:'mid'},
  NIO:{name:'NIO',sector:'EVs & Autos',cap:'mid'},LULU:{name:'Lululemon',sector:'Apparel',cap:'large'},
  NKE:{name:'Nike',sector:'Apparel',cap:'large'},COST:{name:'Costco',sector:'Retail',cap:'mega'},
  WMT:{name:'Walmart',sector:'Consumer Staples',cap:'mega'},PG:{name:'P&G',sector:'Consumer Staples',cap:'mega'},
  KO:{name:'Coca-Cola',sector:'Consumer Staples',cap:'mega'},MCD:{name:"McDonald's",sector:'Food & Beverage',cap:'mega'},
  SBUX:{name:'Starbucks',sector:'Food & Beverage',cap:'large'},DIS:{name:'Disney',sector:'Entertainment',cap:'large'},
  NFLX:{name:'Netflix',sector:'Entertainment',cap:'mega'},SPOT:{name:'Spotify',sector:'Entertainment',cap:'large'},
  UBER:{name:'Uber',sector:'Travel & Mobility',cap:'large'},ABNB:{name:'Airbnb',sector:'Travel & Mobility',cap:'large'},
  XOM:{name:'ExxonMobil',sector:'Oil & Gas',cap:'mega'},CVX:{name:'Chevron',sector:'Oil & Gas',cap:'mega'},
  NEE:{name:'NextEra Energy',sector:'Clean Energy',cap:'mega'},BABA:{name:'Alibaba',sector:'China / Emerging',cap:'large'},
  BIDU:{name:'Baidu',sector:'China / Emerging',cap:'large'},CHWY:{name:'Chewy',sector:'Pets & Specialty',cap:'mid'},
  DUOL:{name:'Duolingo',sector:'Software / SaaS',cap:'mid'},RBLX:{name:'Roblox',sector:'Entertainment',cap:'mid'},
  U:{name:'Unity',sector:'Software / SaaS',cap:'mid'},APP:{name:'AppLovin',sector:'Software / SaaS',cap:'large'},
  PINS:{name:'Pinterest',sector:'Social Media',cap:'mid'},SNAP:{name:'Snap',sector:'Social Media',cap:'mid'},
  RDDT:{name:'Reddit',sector:'Social Media',cap:'mid'},PYPL:{name:'PayPal',sector:'Fintech',cap:'large'},
  AFRM:{name:'Affirm',sector:'Fintech',cap:'mid'},UPST:{name:'Upstart',sector:'Fintech',cap:'small'},
  NU:{name:'Nubank',sector:'Fintech',cap:'large'},MSTR:{name:'MicroStrategy',sector:'Crypto / Bitcoin',cap:'mid'},
  AI:{name:'C3.ai',sector:'AI & Robotics',cap:'small'},SOUN:{name:'SoundHound AI',sector:'AI & Robotics',cap:'small'},
  IONQ:{name:'IonQ',sector:'AI & Robotics',cap:'small'},ANET:{name:'Arista Networks',sector:'Software / SaaS',cap:'large'},
  DDOG:{name:'Datadog',sector:'Software / SaaS',cap:'large'},ZS:{name:'Zscaler',sector:'Cybersecurity',cap:'large'},
  CRWD:{name:'CrowdStrike',sector:'Cybersecurity',cap:'large'},PANW:{name:'Palo Alto Networks',sector:'Cybersecurity',cap:'large'},
  NET:{name:'Cloudflare',sector:'Cybersecurity',cap:'large'},MDB:{name:'MongoDB',sector:'Software / SaaS',cap:'mid'},
  ISRG:{name:'Intuitive Surgical',sector:'Healthcare',cap:'large'},SHOP:{name:'Shopify',sector:'E-Commerce',cap:'large'},
  MELI:{name:'MercadoLibre',sector:'E-Commerce',cap:'large'},SE:{name:'Sea Limited',sector:'E-Commerce',cap:'large'},
  HD:{name:'Home Depot',sector:'Retail',cap:'mega'},LOW:{name:"Lowe's",sector:'Retail',cap:'large'},
  TGT:{name:'Target',sector:'Retail',cap:'large'},ADBE:{name:'Adobe',sector:'Software / SaaS',cap:'mega'},
  INTU:{name:'Intuit',sector:'Software / SaaS',cap:'large'},IBM:{name:'IBM',sector:'Software / SaaS',cap:'large'},
  BA:{name:'Boeing',sector:'Industrials',cap:'large'},GE:{name:'GE Aerospace',sector:'Industrials',cap:'large'},
  HON:{name:'Honeywell',sector:'Industrials',cap:'mega'},RTX:{name:'RTX (Raytheon)',sector:'Defense',cap:'mega'},
  NOC:{name:'Northrop Grumman',sector:'Defense',cap:'large'},AXON:{name:'Axon Enterprise',sector:'Defense',cap:'large'},
  SQ:{name:'Block (Square)',sector:'Fintech',cap:'large'},TTD:{name:'The Trade Desk',sector:'Software / SaaS',cap:'large'},
  CELH:{name:'Celsius Holdings',sector:'Food & Beverage',cap:'mid'},ONON:{name:'On Running',sector:'Apparel',cap:'mid'},
  DECK:{name:'Deckers (Hoka/UGG)',sector:'Apparel',cap:'large'},CMG:{name:'Chipotle',sector:'Food & Beverage',cap:'large'},
  FSLR:{name:'First Solar',sector:'Clean Energy',cap:'large'},ENPH:{name:'Enphase Energy',sector:'Clean Energy',cap:'mid'},
  BX:{name:'Blackstone',sector:'Banking',cap:'mega'},KKR:{name:'KKR',sector:'Banking',cap:'large'},
  WFC:{name:'Wells Fargo',sector:'Banking',cap:'mega'},C:{name:'Citigroup',sector:'Banking',cap:'large'},
  COF:{name:'Capital One',sector:'Banking',cap:'large'},SPGI:{name:'S&P Global',sector:'Banking',cap:'mega'},
  PGR:{name:'Progressive',sector:'Insurance',cap:'large'},CB:{name:'Chubb',sector:'Insurance',cap:'mega'},
  FTNT:{name:'Fortinet',sector:'Cybersecurity',cap:'large'},CYBR:{name:'CyberArk',sector:'Cybersecurity',cap:'mid'},
  BKNG:{name:'Booking Holdings',sector:'Travel & Mobility',cap:'large'},HIMS:{name:'Hims & Hers',sector:'Healthcare',cap:'mid'},
};

// â”€â”€ GENERATE STOCK PICKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Score stocks by momentum, volume surge, sector diversity, and cap size
async function generatePicks(betas) {
  // Pick candidates: large/mega cap stocks only (more reliable, more relevant)
  const candidates = STOCK_TICKERS.filter(t => {
    const info = STOCK_INFO[t];
    return info && (info.cap === 'mega' || info.cap === 'large');
  });

  // Fetch recent quotes for top candidates (batch of 20)
  const topCandidates = candidates.slice(0, 40);
  const quotes = {};
  const BATCH = 10;
  for (let i = 0; i < topCandidates.length; i += BATCH) {
    const batch = topCandidates.slice(i, i + BATCH);
    const results = await Promise.all(batch.map(async t => [t, await fetchQuote(t)]));
    for (const [t, q] of results) {
      if (q) quotes[t] = q;
    }
  }

  // Score each candidate
  const scored = [];
  const seenSectors = new Set();

  for (const ticker of topCandidates) {
    const info = STOCK_INFO[ticker];
    const quote = quotes[ticker];
    if (!info || !quote) continue;

    let score = 50;
    // Momentum boost (5-day)
    score += Math.min(20, Math.max(-10, quote.momentum5d * 2));
    // Volume surge (above average = interesting)
    if (quote.avgVolume > 0 && quote.latestVolume > quote.avgVolume * 1.2) {
      score += 10;
    }
    // Mega cap slight boost (stability)
    if (info.cap === 'mega') score += 5;
    // Penalize extreme volatility
    const beta = betas[ticker];
    if (beta && beta > 2.0) score -= 10;

    scored.push({ ticker, score, sector: info.sector, beta: beta || 1.0 });
  }

  // Sort by score descending
  scored.sort((a, b) => b.score - a.score);

  // Pick top 5 across different sectors
  const picks = [];
  for (const item of scored) {
    if (picks.length >= 5) break;
    if (seenSectors.has(item.sector)) continue;
    seenSectors.add(item.sector);

    const info = STOCK_INFO[item.ticker];
    const beta = item.beta;
    const risk = beta < 0.8 ? 'Low' : beta < 1.2 ? 'Medium' : beta < 1.6 ? 'High' : 'Very High';

    // Build avoidIfHeld list: same ticker + related ETFs
    const avoidIfHeld = [item.ticker];
    const sectorETFs = {
      'Semiconductors': ['SMH', 'SOXX'],
      'Big Tech': ['QQQ', 'XLK'],
      'Software / SaaS': ['IGV', 'QQQ'],
      'AI & Robotics': ['ARKK'],
      'Banking': ['XLF'],
      'Healthcare': ['XLV'],
      'Oil & Gas': ['XLE'],
      'Fintech': ['FINX'],
      'Biotech': ['XBI', 'ARKG'],
      'EVs & Autos': ['ARKK'],
      'Crypto / Bitcoin': ['IBIT', 'BITO'],
      'Cybersecurity': ['IGV'],
    };
    if (sectorETFs[info.sector]) avoidIfHeld.push(...sectorETFs[info.sector]);

    // Generate a brief description
    const descs = {
      'Big Tech': 'Mega-cap tech leader with strong moat',
      'Semiconductors': 'Chip industry momentum play',
      'Software / SaaS': 'Cloud/SaaS growth with recurring revenue',
      'AI & Robotics': 'AI sector exposure with growth potential',
      'Banking': 'Financial sector strength',
      'Healthcare': 'Healthcare sector stability and growth',
      'Fintech': 'Financial innovation and disruption',
      'Oil & Gas': 'Energy sector cash flow play',
      'Clean Energy': 'Renewable energy transition play',
      'Entertainment': 'Consumer media and entertainment',
      'E-Commerce': 'Digital commerce growth',
      'Consumer Staples': 'Defensive positioning with dividends',
      'Retail': 'Consumer spending momentum',
      'EVs & Autos': 'Electric vehicle transition play',
      'Apparel': 'Consumer brand strength',
      'Travel & Mobility': 'Travel recovery momentum',
      'Defense': 'Defense spending tailwind',
      'Industrials': 'Industrial infrastructure build',
      'Cybersecurity': 'Cybersecurity demand growth',
      'Biotech': 'Biotech innovation pipeline',
      'Food & Beverage': 'Consumer staples with growth',
      'Insurance': 'Insurance sector stability',
    };
    const desc = descs[info.sector] || 'Strong momentum and fundamentals';

    picks.push({
      ticker: item.ticker,
      name: info.name,
      sector: info.sector,
      risk,
      desc,
      avoidIfHeld,
    });
  }

  return picks;
}

// â”€â”€ BATCH PROCESSING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchBetasInBatches(spyReturns) {
  const betas = {};
  const BATCH = 10;
  let fetched = 0;
  let failed = 0;

  for (let i = 0; i < STOCK_TICKERS.length; i += BATCH) {
    const batch = STOCK_TICKERS.slice(i, i + BATCH);
    const results = await Promise.all(
      batch.map(async ticker => {
        try {
          const closes = await fetchHistorical(ticker);
          if (!closes) return [ticker, null];
          const returns = dailyReturns(closes);
          const beta = computeBeta(returns, spyReturns);
          return [ticker, beta];
        } catch {
          return [ticker, null];
        }
      })
    );
    for (const [ticker, beta] of results) {
      if (beta != null) {
        betas[ticker] = beta;
        fetched++;
      } else {
        failed++;
      }
    }
  }

  console.log(`[refresh-stock-data] Betas: ${fetched} fetched, ${failed} failed`);
  return betas;
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // Only allow GET (Vercel cron sends GET)
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Verify this is a Vercel cron call or authorized manual trigger
  // In production, Vercel sets x-vercel-cron for cron invocations (stripped from external requests)
  // Manual triggers must provide CRON_SECRET in Authorization header
  const isCron = req.headers['x-vercel-cron'] === '1';
  const cronSecret = process.env.CRON_SECRET;
  const authHeader = req.headers.authorization || '';
  const isManual = cronSecret && authHeader === `Bearer ${cronSecret}`;
  if (process.env.VERCEL_ENV === 'production' && !isCron && !isManual) {
    return res.status(403).json({ error: 'Forbidden' });
  }

  const startTime = Date.now();
  console.log('[refresh-stock-data] Starting refresh...');

  try {
    // Step 1: Fetch SPY historical data (benchmark)
    const spyCloses = await fetchHistorical('SPY');
    if (!spyCloses) {
      return res.status(500).json({ error: 'Failed to fetch SPY data' });
    }
    const spyReturns = dailyReturns(spyCloses);
    console.log(`[refresh-stock-data] SPY: ${spyReturns.length} daily returns`);

    // Step 2: Fetch all stock betas in batches
    const betas = await fetchBetasInBatches(spyReturns);

    // Step 3: Generate fresh stock picks
    const picks = await generatePicks(betas);

    // Step 4: Store in DB (upsert)
    await neonSQL(
      `INSERT INTO stock_data (key, data, updated_at) VALUES ($1, $2, NOW())
       ON CONFLICT (key) DO UPDATE SET data = $2, updated_at = NOW()`,
      ['betas', JSON.stringify(betas)]
    );

    await neonSQL(
      `INSERT INTO stock_data (key, data, updated_at) VALUES ($1, $2, NOW())
       ON CONFLICT (key) DO UPDATE SET data = $2, updated_at = NOW()`,
      ['picks', JSON.stringify(picks)]
    );

    const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
    console.log(`[refresh-stock-data] Done in ${elapsed}s â€” ${Object.keys(betas).length} betas, ${picks.length} picks`);

    return res.status(200).json({
      success: true,
      betas: Object.keys(betas).length,
      picks: picks.length,
      elapsed: `${elapsed}s`,
    });
  } catch (err) {
    console.error('[refresh-stock-data] Error:', err.message);
    return res.status(500).json({ error: 'Refresh failed', message: err.message });
  }
}

========== FILE: api/register-push.js ==========
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { extractAuth, verifyAuthToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

export default async function handler(req, res) {
  // CORS
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(204).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  // â”€â”€ Require valid auth token (cookie-first, header fallback) â”€â”€
  const auth = extractAuth(req);
  const isAuthenticated = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);
  if (!isAuthenticated) {
    return res.status(401).json({ error: 'Authentication required' });
  }

  try {
    // Rate limit by IP
    const ip = req.headers['x-real-ip'] || req.headers['x-forwarded-for']?.split(',').pop()?.trim() || 'unknown';
    if (!await checkRateLimit(ip, 'register-push', 20)) {
      return res.status(429).json({ error: 'Too many requests' });
    }

    const { token, email, platform } = req.body || {};

    // Validate token format
    if (!token || typeof token !== 'string' || !token.startsWith('ExponentPushToken[')) {
      return res.status(400).json({ error: 'Invalid push token format' });
    }

    // Validate token length (ExponentPushToken[...] is typically ~50 chars)
    if (token.length > 100) {
      return res.status(400).json({ error: 'Token too long' });
    }

    // Use authenticated email, not client-provided email
    const cleanEmail = auth.email || (email ? String(email).toLowerCase().trim().slice(0, 255) : null);
    const cleanPlatform = (platform && typeof platform === 'string') ? platform.slice(0, 20) : 'ios';

    // Upsert token
    await neonSQL(
      `INSERT INTO push_tokens (token, email, platform, updated_at)
       VALUES ($1, $2, $3, NOW())
       ON CONFLICT (token) DO UPDATE SET
         email = COALESCE($2, push_tokens.email),
         platform = $3,
         updated_at = NOW()`,
      [token, cleanEmail, cleanPlatform]
    );

    return res.status(200).json({ success: true });
  } catch (err) {
    console.error('[register-push] error:', err.message);
    return res.status(500).json({ error: 'Internal server error' });
  }
}

========== FILE: api/send-notifications.js ==========
import { timingSafeEqual } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';

export default async function handler(req, res) {
  // Auth via CRON_SECRET (Vercel sets this for cron jobs) â€” timing-safe
  const authHeader = req.headers.authorization || '';
  const cronSecret = process.env.CRON_SECRET;
  if (!cronSecret || !timingSafeEqual(authHeader, `Bearer ${cronSecret}`)) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  // Skip weekends (UTC day check)
  const day = new Date().getUTCDay();
  if (day === 0 || day === 6) {
    return res.status(200).json({ skipped: true, reason: 'weekend' });
  }

  try {
    // Fetch tokens updated in last 30 days
    const result = await neonSQL(
      `SELECT token FROM push_tokens WHERE updated_at > NOW() - INTERVAL '30 days'`
    );
    const tokens = result.map(r => r.token).filter(Boolean);

    if (tokens.length === 0) {
      return res.status(200).json({ sent: 0, reason: 'no tokens' });
    }

    // Build messages
    const messages = tokens.map(token => ({
      to: token,
      sound: 'default',
      title: 'Markets are open!',
      body: 'Check your portfolio and see today\u2019s picks.',
    }));

    // Send in batches of 100
    const tokensToRemove = [];
    for (let i = 0; i < messages.length; i += 100) {
      const batch = messages.slice(i, i + 100);
      const pushRes = await fetch('https://exp.host/--/api/v2/push/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(batch),
      });
      const pushData = await pushRes.json();

      // Check for DeviceNotRegistered errors and collect tokens to prune
      const tickets = pushData.data || pushData || [];
      tickets.forEach((ticket, idx) => {
        if (ticket.details && ticket.details.error === 'DeviceNotRegistered') {
          tokensToRemove.push(batch[idx].to);
        }
      });
    }

    // Auto-prune invalid tokens
    if (tokensToRemove.length > 0) {
      const placeholders = tokensToRemove.map((_, i) => `$${i + 1}`).join(',');
      await neonSQL(
        `DELETE FROM push_tokens WHERE token IN (${placeholders})`,
        tokensToRemove
      );
    }

    return res.status(200).json({
      sent: tokens.length,
      pruned: tokensToRemove.length,
    });
  } catch (err) {
    console.error('[send-notifications] error:', err.message);
    return res.status(500).json({ error: 'Internal server error' });
  }
}

========== FILE: api/signout.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';
import { extractAuth, verifyAuthToken } from './lib/auth.js';
import { checkRateLimit } from './lib/rate-limit.js';
import { neonSQL } from './lib/neon.js';

export default async function handler(req, res) {
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);

  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }

  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });

  // Rate limit by IP
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'signout', 20)) {
    return res.status(429).json({ error: 'Too many requests' });
  }

  // Verify auth token before performing DB write to prevent forced logout of other users
  const auth = extractAuth(req);
  if (auth.userId && auth.token && auth.email && auth.ts) {
    const valid = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);
    if (valid) {
      try {
        await neonSQL(
          'UPDATE users SET session_version = COALESCE(session_version, 1) + 1 WHERE id = $1',
          [auth.userId]
        );
      } catch (e) { /* best-effort â€” cookie is cleared regardless */ }
    }
  }

  const secure = process.env.NODE_ENV === 'development' ? '' : '; Secure';
  res.setHeader('Set-Cookie', [
    `pc_auth=; HttpOnly${secure}; SameSite=Strict; Path=/api; Max-Age=0`,
    `pc_pro=; HttpOnly${secure}; SameSite=Strict; Path=/api; Max-Age=0`,
  ]);

  return res.status(200).json({ success: true });
}

========== FILE: api/sparkline.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';
import { checkRateLimit } from './lib/rate-limit.js';

// â”€â”€ IN-MEMORY CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cache = new Map();
const CACHE_TTL_MS = 30 * 60 * 1000; // 30 min

function getCached(key) {
  const entry = cache.get(key);
  if (!entry) return null;
  if (Date.now() - entry.ts > CACHE_TTL_MS) { cache.delete(key); return null; }
  return entry.data;
}

function setCached(key, data) {
  cache.set(key, { data, ts: Date.now() });
}

// â”€â”€ VALID RANGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VALID_RANGES = new Set(['1d', '5d', '1mo', '3mo']);

// â”€â”€ FETCH SPARKLINE FROM YAHOO FINANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSparkline(ticker, range) {
  const cacheKey = `${ticker}:${range}`;
  const cached = getCached(cacheKey);
  if (cached) return cached;

  try {
    const interval = range === '1d' ? '5m' : '1d';
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?interval=${interval}&range=${range}`;
    const r = await fetch(url, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
        'Accept': 'application/json',
      },
      signal: AbortSignal.timeout(6000),
    });
    if (!r.ok) return null;
    const data = await r.json();
    const result = data?.chart?.result?.[0];
    if (!result) return null;

    const closes = result.indicators?.quote?.[0]?.close;
    const timestamps = result.timestamp;
    if (!closes || !timestamps || closes.length < 2) return null;

    // Filter out null values while keeping timestamps aligned
    const filtered = { closes: [], timestamps: [] };
    for (let i = 0; i < closes.length; i++) {
      if (closes[i] != null) {
        filtered.closes.push(Math.round(closes[i] * 100) / 100);
        filtered.timestamps.push(timestamps[i]);
      }
    }

    if (filtered.closes.length < 2) return null;
    setCached(cacheKey, filtered);
    return filtered;
  } catch {
    return null;
  }
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // CORS
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  // Rate limit by IP
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'sparkline', 20)) {
    return res.status(429).json({ error: 'Too many requests. Please try again later.' });
  }

  const { tickers, range = '1mo' } = req.query;
  if (!tickers) return res.status(400).json({ error: 'No tickers provided' });

  // Validate range
  if (!VALID_RANGES.has(range)) {
    return res.status(400).json({ error: 'Invalid range. Use: 5d, 1mo, 3mo' });
  }

  // Deduplicate and sanitize tickers
  const tickerList = [...new Set(
    tickers.split(',')
      .map(t => t.trim().toUpperCase().replace(/[^A-Z0-9.]/g, ''))
      .filter(t => t.length >= 1 && t.length <= 6 && /^[A-Z]{1,5}(\.[A-Z]{1,2})?$/.test(t))
  )];

  if (tickerList.length === 0) {
    return res.status(400).json({ error: 'No valid tickers provided' });
  }
  if (tickerList.length > 40) {
    return res.status(400).json({ error: 'Too many tickers. Max 40 per request.' });
  }

  // Fetch in parallel, batches of 10
  const output = {};
  for (let i = 0; i < tickerList.length; i += 10) {
    const batch = tickerList.slice(i, i + 10);
    const results = await Promise.allSettled(
      batch.map(async (ticker) => {
        const data = await fetchSparkline(ticker, range);
        output[ticker] = data;
      })
    );
  }

  // Edge cache: 4hr on CDN, 30min stale-while-revalidate
  res.setHeader('Cache-Control', 's-maxage=14400, stale-while-revalidate=1800');
  return res.status(200).json(output);
}

========== FILE: api/start-trial.js ==========
import { getAllowedOrigin, setSecurityHeaders, checkBodySize } from './lib/cors.js';
import { extractAuth, verifyAuthToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

export default async function handler(req, res) {
  res.setHeader('Cache-Control', 'no-store');

  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  const email = (req.body?.email || '').toLowerCase().trim();
  if (!email || !email.includes('@')) {
    return res.status(400).json({ error: 'Valid email required' });
  }

  // â”€â”€ Require valid auth token (cookie-first, header fallback) â”€â”€
  const auth = extractAuth(req);
  const isAuthenticated = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);
  if (!isAuthenticated) {
    return res.status(401).json({ error: 'Authentication required' });
  }
  if (auth.email.toLowerCase().trim() !== email) {
    return res.status(403).json({ error: 'Token email mismatch' });
  }

  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'start-trial', 10)) {
    return res.status(429).json({ error: 'Too many attempts. Try again later.' });
  }

  try {
    // Check if this email already has a trial
    const existing = await neonSQL(
      `SELECT trial_start FROM trials WHERE email = $1 LIMIT 1`,
      [email]
    );

    if (existing.length > 0) {
      const trialStart = existing[0].trial_start;
      const now = Math.floor(Date.now() / 1000);
      const SEVEN_DAYS = 7 * 24 * 60 * 60;

      if (now - trialStart > SEVEN_DAYS) {
        return res.status(200).json({ error: 'trial_used', message: 'Trial already used' });
      }
      // Still active â€” return existing
      return res.status(200).json({ success: true, trialStart });
    }

    // Start new trial
    const trialStart = Math.floor(Date.now() / 1000);
    await neonSQL(
      `INSERT INTO trials (email, trial_start) VALUES ($1, $2)`,
      [email, trialStart]
    );

    return res.status(200).json({ success: true, trialStart });

  } catch (err) {
    console.error('[start-trial] error:', err.message);
    return res.status(500).json({ error: 'Server error' });
  }
}

========== FILE: api/stock-data.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // Rate limit by IP (30 req/hr â€” this endpoint is edge-cached so mostly warm hits)
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit('ip:' + ip, 'stock-data', 30)) {
    return res.status(429).json({ error: 'Too many requests' });
  }

  try {
    const rows = await neonSQL(`SELECT key, data, updated_at FROM stock_data WHERE key IN ('betas', 'picks')`);

    const result = {};
    for (const row of rows) {
      result[row.key] = typeof row.data === 'string' ? JSON.parse(row.data) : row.data;
      result[row.key + '_updated'] = row.updated_at;
    }

    // Only edge-cache when we have actual data; don't cache empty responses
    if (rows.length > 0) {
      res.setHeader('Cache-Control', 's-maxage=3600, stale-while-revalidate=600');
    } else {
      res.setHeader('Cache-Control', 'no-store');
    }
    return res.status(200).json(result);
  } catch (err) {
    console.error('[stock-data] Error:', err.message);
    return res.status(500).json({ error: 'Failed to fetch stock data' });
  }
}

========== FILE: api/stripe-webhook.js ==========
import { neonSQL } from './lib/neon.js';
import { checkBodySize } from './lib/cors.js';

export const config = { api: { bodyParser: false } };

async function getRawBody(req) {
  const chunks = [];
  for await (const chunk of req) {
    chunks.push(typeof chunk === 'string' ? Buffer.from(chunk) : chunk);
  }
  return Buffer.concat(chunks);
}

// â”€â”€ STRIPE SIGNATURE VERIFICATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Prevents anyone from faking a checkout.session.completed event
// and getting free Pro access. This is critical.
async function verifyStripeSignature(rawBody, sigHeader, secret) {
  if (!sigHeader || !secret) {
    throw new Error('Missing Stripe webhook secret or signature header');
  }

  // Parse Stripe-Signature header: t=timestamp,v1=signature
  const parts = sigHeader.split(',');
  const tPart = parts.find(p => p.startsWith('t='));
  const v1Part = parts.find(p => p.startsWith('v1='));
  if (!tPart || !v1Part) throw new Error('Invalid Stripe-Signature header');

  const timestamp = tPart.slice(2);
  const receivedSig = v1Part.slice(3);

  // Reject webhooks older than 5 minutes (replay attack prevention)
  const now = Math.floor(Date.now() / 1000);
  if (Math.abs(now - parseInt(timestamp)) > 300) {
    throw new Error('Webhook timestamp too old â€” possible replay attack');
  }

  // Compute expected signature: HMAC-SHA256(timestamp.rawBody, secret)
  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw', encoder.encode(secret),
    { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
  );
  const payload = `${timestamp}.${rawBody.toString()}`;
  const sig = await crypto.subtle.sign('HMAC', key, encoder.encode(payload));
  const expected = Array.from(new Uint8Array(sig))
    .map(b => b.toString(16).padStart(2, '0')).join('');

  // Constant-time comparison to prevent timing attacks
  if (receivedSig.length !== expected.length) throw new Error('Signature mismatch');
  let mismatch = 0;
  for (let i = 0; i < receivedSig.length; i++) {
    mismatch |= receivedSig.charCodeAt(i) ^ expected.charCodeAt(i);
  }
  if (mismatch !== 0) throw new Error('Signature mismatch');

  return true;
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' });
  if (!checkBodySize(req)) return res.status(413).json({ error: 'Request body too large' });

  const rawBody = await getRawBody(req);

  // Verify signature BEFORE processing anything
  const sigHeader = req.headers['stripe-signature'];
  const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET;

  try {
    await verifyStripeSignature(rawBody, sigHeader, webhookSecret);
  } catch (err) {
    console.error('Stripe signature verification failed:', err.message);
    return res.status(400).json({ error: 'Webhook signature verification failed' });
  }

  let event;
  try {
    event = JSON.parse(rawBody.toString());
  } catch {
    return res.status(400).json({ error: 'Invalid JSON' });
  }

  try {
    // â”€â”€ Payment succeeded â†’ activate Pro â”€â”€
    if (event.type === 'checkout.session.completed') {
      const session = event.data.object;
      const email = (session.customer_email || session.customer_details?.email || '').toLowerCase().trim();
      const customerId = session.customer || '';
      // subscription = monthly/annual, payment = lifetime (one-time)
      const plan = session.mode === 'subscription' ? 'monthly' : 'lifetime';

      if (email) {
        await neonSQL(
          `INSERT INTO pro_licenses (email, active, plan, customer_id, session_id, purchased_at)
           VALUES ($1, true, $2, $3, $4, NOW())
           ON CONFLICT (email) DO UPDATE
             SET active = true, plan = $2, customer_id = $3, session_id = $4,
                 purchased_at = NOW(), cancelled_at = NULL, failed_at = NULL`,
          [email, plan, customerId, session.id]
        );
        console.log(`[stripe] Pro activated: ${email} (${plan})`);
      }
    }

    // â”€â”€ Subscription cancelled â”€â”€
    if (event.type === 'customer.subscription.deleted') {
      const customerId = event.data.object.customer;
      if (customerId) {
        await neonSQL(
          `UPDATE pro_licenses SET active = false, cancelled_at = NOW()
           WHERE customer_id = $1 AND plan != 'lifetime'`,
          [customerId]
        );
        console.log(`[stripe] Subscription cancelled for customer: ${customerId}`);
      }
    }

    // â”€â”€ Payment failed â”€â”€
    if (event.type === 'invoice.payment_failed') {
      const customerId = event.data.object.customer;
      // Only deactivate after multiple failures (Stripe retries 3-4 times)
      const attemptCount = event.data.object.attempt_count || 1;
      if (customerId && attemptCount >= 3) {
        await neonSQL(
          `UPDATE pro_licenses SET active = false, failed_at = NOW()
           WHERE customer_id = $1 AND plan != 'lifetime'`,
          [customerId]
        );
        console.log(`[stripe] Pro deactivated after ${attemptCount} failed payments: ${customerId}`);
      }
    }

    // â”€â”€ Subscription reactivated (e.g. after payment method update) â”€â”€
    if (event.type === 'invoice.paid') {
      const customerId = event.data.object.customer;
      if (customerId) {
        await neonSQL(
          `UPDATE pro_licenses SET active = true, failed_at = NULL
           WHERE customer_id = $1 AND plan != 'lifetime'`,
          [customerId]
        );
      }
    }

  } catch (err) {
    console.error('[stripe] Webhook processing error:', err);
    return res.status(500).json({ error: 'Processing failed' });
  }

  return res.status(200).json({ received: true });
}

========== FILE: api/top-movers.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';

// â”€â”€ IN-MEMORY CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _cache = null;
let _cacheTs = 0;
const CACHE_TTL_MS = 15 * 60 * 1000; // 15 min

// â”€â”€ BROAD UNIVERSE OF MAJOR STOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ~100 high-volume tickers covering all major sectors to find true daily top movers.
// These are the most-traded names across sectors; actual "top movers" are sorted by |changePct|.
const UNIVERSE = [
  // Big Tech
  'AAPL','MSFT','GOOGL','AMZN','META','NVDA','TSLA','AVGO','ORCL','CRM',
  'ADBE','INTC','CSCO','IBM','QCOM','TXN','NOW','SHOP','SNOW','PLTR',
  // Semiconductors
  'AMD','MU','MRVL','LRCX','KLAC','AMAT','ARM','SMCI','ON','MCHP',
  // Fintech / Finance
  'JPM','GS','MS','V','MA','PYPL','SQ','COIN','HOOD','SOFI',
  // Consumer / Retail
  'AMZN','WMT','COST','TGT','NKE','SBUX','MCD','DIS','NFLX','ABNB',
  // Healthcare / Biotech
  'JNJ','UNH','PFE','ABBV','LLY','MRK','BMY','GILD','AMGN','MRNA',
  // Energy
  'XOM','CVX','COP','SLB','OXY','MPC','VLO','DVN','FANG','HAL',
  // AI / Software
  'AI','SOUN','PATH','DDOG','NET','ZS','CRWD','PANW','FTNT','OKTA',
  // EV / Auto
  'RIVN','LCID','F','GM','NIO','LI','XPEV',
  // Social / Media
  'RDDT','SNAP','PINS','SPOT','ROKU',
  // Crypto-adjacent
  'MARA','RIOT','MSTR','CLSK',
  // Industrial / Defense
  'BA','LMT','RTX','GE','CAT','DE','HON',
  // Other popular / high-vol
  'APP','UBER','LYFT','DASH','RBLX','U','AFRM','UPST',
];

// Deduplicate
const TICKERS = [...new Set(UNIVERSE)];

// â”€â”€ FETCH QUOTES VIA FMP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchQuotes(tickers) {
  const apiKey = process.env.FMP_API_KEY;
  if (!apiKey) return {};

  const results = {};

  // Fetch in parallel batches of 15 to avoid overwhelming FMP
  for (let i = 0; i < tickers.length; i += 15) {
    const batch = tickers.slice(i, i + 15);
    const settled = await Promise.allSettled(
      batch.map(async (ticker) => {
        try {
          const url = `https://financialmodelingprep.com/stable/quote?symbol=${ticker}&apikey=${apiKey}`;
          const r = await fetch(url, { signal: AbortSignal.timeout(5000) });
          if (!r.ok) return;
          const data = await r.json();
          if (Array.isArray(data) && data.length > 0 && data[0].price != null) {
            results[ticker] = {
              price: Math.round(data[0].price * 100) / 100,
              changePct: Math.round((data[0].changePercentage ?? 0) * 100) / 100,
              name: data[0].name || data[0].companyName || ticker,
            };
          }
        } catch { /* skip */ }
      })
    );
  }

  return results;
}

// â”€â”€ HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default async function handler(req, res) {
  // CORS
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  // Return cached result if fresh
  if (_cache && (Date.now() - _cacheTs < CACHE_TTL_MS)) {
    res.setHeader('Cache-Control', 's-maxage=900, stale-while-revalidate=300');
    return res.status(200).json(_cache);
  }

  try {
    const quotes = await fetchQuotes(TICKERS);
    const movers = [];
    for (const [ticker, q] of Object.entries(quotes)) {
      if (q && q.changePct != null) {
        movers.push({ ticker, changePct: q.changePct, name: q.name, price: q.price });
      }
    }

    // Sort by absolute change descending, take top 8
    movers.sort((a, b) => Math.abs(b.changePct) - Math.abs(a.changePct));
    const top = movers.slice(0, 8);

    _cache = top;
    _cacheTs = Date.now();

    res.setHeader('Cache-Control', 's-maxage=900, stale-while-revalidate=300');
    return res.status(200).json(top);
  } catch (e) {
    console.error('[top-movers] error:', e);
    return res.status(500).json({ error: 'Failed to fetch top movers' });
  }
}

========== FILE: api/verify-pro.js ==========
import { getAllowedOrigin, setSecurityHeaders } from './lib/cors.js';
import { extractAuth, verifyAuthToken } from './lib/auth.js';
import { neonSQL } from './lib/neon.js';
import { checkRateLimit } from './lib/rate-limit.js';

export default async function handler(req, res) {
  // â”€â”€ CORS â”€â”€
  const origin = req.headers.origin || '';
  const allowedOrigin = getAllowedOrigin(req);
  setSecurityHeaders(res);
  if (allowedOrigin) {
    res.setHeader('Access-Control-Allow-Origin', allowedOrigin);
    res.setHeader('Vary', 'Origin');
  }
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, X-Auth-Token, X-Auth-Email, X-Auth-Ts');
  res.setHeader('Access-Control-Allow-Credentials', 'true');

  if (req.method === 'OPTIONS') {
    if (!allowedOrigin && origin) return res.status(403).json({ error: 'Origin not allowed' });
    return res.status(200).end();
  }
  if (origin && !allowedOrigin) {
    return res.status(403).json({ error: 'Origin not allowed' });
  }

  // Allow both GET (restore purchases) and POST (checkout verification)
  if (req.method !== 'GET' && req.method !== 'POST') {
    return res.status(405).json({ pro: false, error: 'Method not allowed' });
  }

  const email = ((req.query.email || req.body?.email) || '').toLowerCase().trim();
  if (!email || !email.includes('@')) {
    return res.status(400).json({ pro: false, error: 'Valid email required' });
  }

  // â”€â”€ Require valid auth token (cookie-first, header fallback) â”€â”€
  const auth = extractAuth(req);
  const isAuthenticated = await verifyAuthToken(auth.email, auth.token, auth.ts, auth.userId, auth.sv);
  if (!isAuthenticated) {
    return res.status(401).json({ pro: false, error: 'Authentication required' });
  }
  // Ensure caller can only check their own email
  if (auth.email.toLowerCase().trim() !== email) {
    return res.status(403).json({ pro: false, error: 'Token email mismatch' });
  }

  // Rate limit by IP (secondary defense)
  const ip = req.headers['x-real-ip'] || (req.headers['x-forwarded-for'] || '').split(',').pop().trim() || 'unknown';
  if (!await checkRateLimit(ip, 'verify-pro', 30)) {
    return res.status(429).json({ pro: false, error: 'Too many verification attempts' });
  }

  try {
    // Uses idx_pro_licenses_email index
    const rows = await neonSQL(
      `SELECT active, plan FROM pro_licenses WHERE email = $1 LIMIT 1`,
      [email]
    );

    if (rows.length === 0 || !rows[0].active) {
      return res.status(200).json({ pro: false });
    }

    const license = rows[0];

    // Generate signed HMAC token â€” expires in 4 hours
    const timestamp = Math.floor(Date.now() / 1000);
    const secret = process.env.PRO_TOKEN_SECRET;
    if (!secret) throw new Error('PRO_TOKEN_SECRET not configured');

    const encoder = new TextEncoder();
    const key = await crypto.subtle.importKey(
      'raw', encoder.encode(secret),
      { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
    );
    const sig = await crypto.subtle.sign(
      'HMAC', key,
      encoder.encode(`${email}:${timestamp}`)
    );
    const token = Array.from(new Uint8Array(sig))
      .map(b => b.toString(16).padStart(2, '0')).join('');

    // Set HttpOnly pro cookie
    const cookieVal = encodeURIComponent(`${email}|${timestamp}|${token}`);
    const secure = process.env.NODE_ENV === 'development' ? '' : '; Secure';
    res.setHeader('Set-Cookie', `pc_pro=${cookieVal}; HttpOnly${secure}; SameSite=Strict; Path=/api; Max-Age=14400`);

    // Don't cache this â€” it contains a fresh signed token each time
    res.setHeader('Cache-Control', 'no-store');
    return res.status(200).json({ pro: true, plan: license.plan, expiresIn: 14400 });

  } catch (err) {
    console.error('[verify-pro] error:', err.message);
    return res.status(500).json({ pro: false, error: 'Server error' });
  }
}

========== FILE: api/lib/auth.js ==========
export function parseCookies(req) {
  const cookies = {};
  (req.headers.cookie || '').split(';').forEach(c => {
    const [key, ...rest] = c.trim().split('=');
    if (key) cookies[key.trim()] = decodeURIComponent(rest.join('='));
  });
  return cookies;
}

export function getAuthFromCookie(req) {
  const c = parseCookies(req);
  if (c.pc_auth) {
    const parts = c.pc_auth.split('|');
    // New format: userId|email|sv|ts|token
    if (parts.length === 5) {
      const [uid, e, sv, t, tk] = parts;
      if (uid && e && sv && t && tk) return { userId: uid, email: e, sv, ts: t, token: tk };
    }
    // Legacy format: email|ts|token (auto-expires within 4hr)
    if (parts.length === 3) {
      const [e, t, tk] = parts;
      if (e && t && tk) return { userId: '', email: e, sv: '', ts: t, token: tk };
    }
  }
  return null;
}

// Extract all auth fields from cookie (or header fallback)
export function extractAuth(req) {
  const authCk = getAuthFromCookie(req);
  return {
    userId: authCk?.userId || '',
    email: (authCk?.email || '').toLowerCase().trim(),
    sv: authCk?.sv || '',
    ts: authCk?.ts || '',
    token: authCk?.token || '',
  };
}

export function getProFromCookie(req) {
  const c = parseCookies(req);
  if (c.pc_pro) {
    const [e, t, tk] = c.pc_pro.split('|');
    if (e && t && tk) return { email: e, ts: t, token: tk };
  }
  return null;
}

export function timingSafeEqual(a, b) {
  if (typeof a !== 'string' || typeof b !== 'string') return false;
  const maxLen = Math.max(a.length, b.length);
  const aPad = a.padEnd(maxLen, '\0');
  const bPad = b.padEnd(maxLen, '\0');
  let mismatch = a.length ^ b.length;
  for (let i = 0; i < maxLen; i++) {
    mismatch |= aPad.charCodeAt(i) ^ bPad.charCodeAt(i);
  }
  return mismatch === 0;
}

export async function verifyAuthToken(email, token, timestamp, userId, sessionVersion) {
  if (!email || !token || !timestamp) return false;
  const now = Math.floor(Date.now() / 1000);
  const ts = parseInt(timestamp);
  if (isNaN(ts) || now - ts > 14400 || ts - now > 300) return false;

  const secret = process.env.AUTH_TOKEN_SECRET;
  if (!secret) return false;

  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw', encoder.encode(secret),
    { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
  );

  // New format: auth:userId:email:sv:ts (bound to user identity + session version)
  if (userId && sessionVersion) {
    const sig = await crypto.subtle.sign('HMAC', key,
      encoder.encode(`auth:${userId}:${email.toLowerCase().trim()}:${sessionVersion}:${ts}`));
    const expected = Array.from(new Uint8Array(sig))
      .map(b => b.toString(16).padStart(2, '0')).join('');
    return timingSafeEqual(token, expected);
  }

  // Legacy format: auth:email:ts (backwards-compatible, auto-expires within 4hr)
  const sig = await crypto.subtle.sign('HMAC', key, encoder.encode(`auth:${email.toLowerCase().trim()}:${ts}`));
  const expected = Array.from(new Uint8Array(sig))
    .map(b => b.toString(16).padStart(2, '0')).join('');
  return timingSafeEqual(token, expected);
}

export async function verifyProToken(email, token, timestamp) {
  if (!email || !token || !timestamp) return false;
  const now = Math.floor(Date.now() / 1000);
  const ts = parseInt(timestamp);
  if (isNaN(ts) || now - ts > 14400 || ts - now > 300) return false;

  const secret = process.env.PRO_TOKEN_SECRET;
  if (!secret) return false;

  const encoder = new TextEncoder();
  const key = await crypto.subtle.importKey(
    'raw', encoder.encode(secret),
    { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
  );
  const sig = await crypto.subtle.sign('HMAC', key, encoder.encode(`${email.toLowerCase().trim()}:${ts}`));
  const expected = Array.from(new Uint8Array(sig))
    .map(b => b.toString(16).padStart(2, '0')).join('');

  return timingSafeEqual(token, expected);
}

========== FILE: api/lib/cors.js ==========
export const ALLOWED_ORIGINS = [
  'https://pcompass.vercel.app',
  'https://portalyze.app',
  'https://www.portalyze.app',
];

export function getAllowedOrigin(req) {
  const origin = req.headers.origin || '';
  if (ALLOWED_ORIGINS.includes(origin)) return origin;
  return null;
}

// Request body size guard â€” call at top of POST handlers
// Checks both Content-Length header AND actual parsed body size
export function checkBodySize(req, maxBytes = 1_000_000) {
  const headerLen = parseInt(req.headers['content-length'] || '0');
  if (headerLen > maxBytes) return false;
  if (req.body) {
    const bodyStr = typeof req.body === 'string' ? req.body : JSON.stringify(req.body);
    if (bodyStr.length > maxBytes) return false;
  }
  return true;
}

// Security headers â€” call at top of every handler
export function setSecurityHeaders(res) {
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  res.setHeader('Content-Security-Policy', [
    "default-src 'self'",
    "script-src 'self' 'unsafe-inline' https://accounts.google.com https://apis.google.com https://appleid.cdn-apple.com",
    "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com",
    "font-src 'self' https://fonts.gstatic.com",
    "connect-src 'self' https://financialmodelingprep.com https://appleid.apple.com",
    "img-src 'self' data: blob: https://*.googleusercontent.com",
    "frame-src https://accounts.google.com https://appleid.apple.com",
  ].join('; '));
  if (process.env.VERCEL_ENV) {
    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  }
}

========== FILE: api/lib/neon.js ==========
import { neon } from '@neondatabase/serverless';

export async function neonSQL(sql, params = []) {
  const connStr = process.env.POSTGRES_URL;
  if (!connStr) throw new Error('POSTGRES_URL not set');
  const query = neon(connStr);
  return await query.query(sql, params);
}

========== FILE: api/lib/rate-limit.js ==========
import { neonSQL } from './neon.js';

export async function checkRateLimit(clientKey, endpoint, maxRequests) {
  try {
    // Single atomic CTE: insert + count in one statement (no race condition)
    const result = await neonSQL(
      `WITH ins AS (
        INSERT INTO api_usage (client_key, endpoint) VALUES ($1, $2)
        RETURNING created_at
      )
      SELECT COUNT(*)::int AS cnt FROM api_usage
      WHERE client_key = $1 AND endpoint = $2 AND created_at > NOW() - INTERVAL '1 hour'`,
      [clientKey, endpoint]
    );

    // Probabilistic cleanup: ~2% of requests prune old entries (all endpoints)
    if (Math.random() < 0.02) {
      neonSQL(`DELETE FROM api_usage WHERE created_at < NOW() - INTERVAL '48 hours'`, []).catch(() => {});
    }

    return (result[0]?.cnt || 0) <= maxRequests;
  } catch (e) {
    return false; // fail closed
  }
}

========== FILE: api/lib/security.js ==========
// â”€â”€ SECURITY HEADERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Applied to all API responses
export function setSecurityHeaders(res) {
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  if (process.env.VERCEL_ENV) {
    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  }
}

// â”€â”€ REQUEST SIZE CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Rejects oversized POST bodies (1MB max)
export function checkRequestSize(req, res, maxBytes = 1_000_000) {
  const len = parseInt(req.headers['content-length'] || '0');
  if (len > maxBytes) {
    res.status(413).json({ error: 'Request too large' });
    return false;
  }
  return true;
}

========== FILE: package.json ==========
{
  "type": "module",
  "dependencies": {
    "@anthropic-ai/sdk": "^0.78.0",
    "@neondatabase/serverless": "^1.0.2",
    "jose": "^6.1.3",
    "stripe": "^20.3.1"
  }
}

========== FILE: CLAUDE.md ==========
# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Portfolio Compass is a full-stack web application for AI-powered stock portfolio analysis. It's a PWA built with vanilla JavaScript (no build step, no bundler), Node.js serverless APIs on Vercel, and a Neon PostgreSQL backend.

**Production URL:** https://pcompass.vercel.app

## Development & Deployment

- **No build step** â€” pure vanilla JS served as static files
- **No test framework** â€” no automated tests exist
- **Package manager:** npm (`npm install` for dependencies)
- **Deployment:** Vercel serverless (auto-deploys from git)
- **Local dev:** `npx vercel dev` to run locally with serverless function emulation
- **ES modules:** `"type": "module"` in package.json â€” all files use `import`/`export`

## Architecture

### Frontend (Single-Page App)

`public/index.html` â€” the entire frontend is a single ~3700-line HTML file containing all markup, CSS, and JavaScript inline. There is no component framework or templating.

`public/data.js` â€” static stock database, sector colors, example portfolios, correlated pairs, and risk configuration. Imported by the frontend.

`public/sw.js` â€” service worker for PWA offline support.

### Backend (Vercel Serverless Functions)

All API endpoints live in `api/` as individual JS files. Each exports a default async handler `(req, res)`.

| Endpoint | Purpose |
|----------|---------|
| `api/claude.js` | Claude AI analysis & screenshot OCR (vision). Rate-limited. |
| `api/auth.js` | Google OAuth token verification + user creation |
| `api/portfolios.js` | Cloud portfolio CRUD (Pro only) |
| `api/verify-pro.js` | Pro subscription status check, issues HMAC tokens |
| `api/market-data.js` | Stock prices via Yahoo Finance scraping |
| `api/stripe-webhook.js` | Stripe payment webhook with signature verification |
| `api/db-setup.js` | PostgreSQL schema initialization |
| `api/validate-token.js` | Supabase token validation |

### Database

Neon PostgreSQL accessed via direct HTTP API (not a driver library). Tables: `users`, `portfolios`, `pro_licenses`.

### Authentication & Authorization

- **Pro tokens:** HMAC-SHA256 signed tokens (email + timestamp, 24hr expiry) generated by `verify-pro.js`, verified in `claude.js` and `portfolios.js`
- **Rate limiting:** DB-backed (api_usage table) in `claude.js` â€” 3 req/hr free, 50 req/hr Pro
- **AI model tier:** Claude Haiku 4.5 for free users, Claude Sonnet 4.5 for Pro

### Environment Variables (set in Vercel)

`ANTHROPIC_API_KEY`, `POSTGRES_URL`, `PRO_TOKEN_SECRET`, `STRIPE_WEBHOOK_SECRET`, `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`

## Key Patterns

- Database queries use raw SQL via `fetch()` to the Neon HTTP endpoint â€” there is no ORM
- Function timeout config is in `public/vercel.json` (30s for claude/db-setup, 10s for others)
- Edge caching headers are configured per-route in `public/vercel.json`
- Client-side portfolio data is cached in localStorage

